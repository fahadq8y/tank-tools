<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PLCR - Tank Calculator</title>
  <link href="icon.png" rel="icon" type="image/png"/>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#003366">
  <script src="permissions.js"></script>
  
  <!-- Firebase v9 SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Make Firebase functions globally available
    window.db = db;
    window.collection = collection;
    window.addDoc = addDoc;
    window.getDocs = getDocs;
    window.query = query;
    window.where = where;
    window.orderBy = orderBy;
    window.limit = limit;
    window.serverTimestamp = serverTimestamp;
  </script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,sans-serif;margin:0;padding:20px;background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;color:white;direction:ltr;min-height:100vh}
    h2{color:white;text-align:center}
    .nav-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(0,0,0,0.5);border-radius:10px;margin-bottom:20px;flex-wrap:wrap}
    .nav-logo{font-size:24px;font-weight:bold;color:white}
    .nav-links{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .nav-link{color:white;text-decoration:none;padding:8px 16px;border-radius:8px;transition:all 0.3s ease;background:rgba(255,255,255,0.1);font-weight:500;border:1px solid rgba(255,255,255,0.2)}
    .nav-link:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px)}
    .nav-link.active{background:rgba(255,255,255,0.3);font-weight:bold;border:1px solid rgba(255,255,255,0.4)}
    .nav-admin{background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366;font-weight:bold;border-radius:8px;padding:8px 16px;text-decoration:none;transition:all 0.3s ease;border:1px solid #FFA500;font-size:inherit}
    .nav-admin:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,215,0,0.3)}
    .nav-user{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.1);padding:5px 15px;border-radius:20px;backdrop-filter:blur(10px)}
    .user-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(45deg,#4CAF50,#45a049);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px}
    .logout-btn{background:rgba(255,0,0,0.2);border:1px solid rgba(255,0,0,0.5);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:12px;transition:all 0.3s ease}
    .font-controls{display:flex;gap:5px;margin-right:10px}
    .font-btn{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.3s ease;min-width:30px}
    .font-btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-1px)}
    .container{background:rgba(255,255,255,0.1);padding:20px;border-radius:10px;max-width:600px;margin:auto;box-shadow:0 0 10px rgba(0,0,0,0.3);backdrop-filter:blur(10px)}
    label,input,select{display:block;width:100%;margin:10px 0;text-align:left}
    input,select{padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.9);color:#003366;box-shadow:0 2px 5px rgba(0,0,0,0.3)}
    .result{margin-top:20px;font-weight:bold;text-align:center;color:#00ffff;padding:15px;background:rgba(0,0,0,0.3);border-radius:8px}
    footer{margin-top:40px;color:#ccc;text-align:center}
    .whatsapp-link{color:#25D366;text-decoration:none;font-weight:bold;transition:all 0.3s ease;cursor:pointer}
    .whatsapp-link:hover{color:#128C7E;text-shadow:0 0 5px rgba(37,211,102,0.5);transform:scale(1.05)}
    .action-button{position:fixed;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.3);border:none;font-size:20px;color:white;box-shadow:0 2px 5px rgba(0,0,0,0.3);cursor:pointer;display:flex;align-items:center;justify-content:center;top:10px;right:10px}
    .dark-mode{background:linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url('background.jpg')!important}
    .dark-mode .result{color:#ffcc00!important}
    .dark-mode input,.dark-mode select{background:rgba(50,50,70,0.9)!important;color:#eee!important}
    .dark-mode .container{background:rgba(40,40,60,0.3)!important}
    .access-denied{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url('background.jpg');background-size:cover;background-position:center;display:flex;justify-content:center;align-items:center;z-index:9999}
    .access-denied-content{text-align:center;background:rgba(255,255,255,0.1);padding:40px;border-radius:20px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2)}
    .access-denied-icon{font-size:5rem;color:#f44336;margin-bottom:20px}
    .access-denied-title{font-size:2rem;color:#f44336;margin-bottom:15px}
    .access-denied-text{font-size:1.2rem;margin-bottom:20px;opacity:0.8}
    .login-btn{padding:12px 25px;background:linear-gradient(45deg,#4CAF50,#45a049);color:white;border:none;border-radius:10px;cursor:pointer;font-size:16px;transition:all 0.3s ease;margin:5px}
    .security-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;backdrop-filter:blur(5px)}
    .security-modal.show{display:flex;justify-content:center;align-items:center}
    .security-modal-content{background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;max-width:500px;width:90%;color:#003366;text-align:center;animation:modalSlideIn 0.5s ease}
    @keyframes modalSlideIn{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}
    .security-icon{font-size:3rem;margin-bottom:15px}
    .security-title{font-size:1.5rem;margin-bottom:15px;font-weight:bold}
    .security-text{margin-bottom:20px;line-height:1.5}
    .attempt-counter{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#f57c00;padding:10px;border-radius:8px;margin:15px 0;font-weight:bold}
    .security-buttons{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .modal-btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s ease}
    .modal-btn-primary{background:#4CAF50;color:white}
    .modal-btn-secondary{background:#2196F3;color:white}
    .modal-btn-danger{background:#f44336;color:white}
    .modal-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.3)}
    
    /* Ø¥Ø¶Ø§ÙØ© CSS Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…Ø«Ù„ PBCR */
    .lt-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;backdrop-filter:blur(5px)}
    .lt-modal.show{display:flex;justify-content:center;align-items:center}
    .lt-modal-content{background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;max-width:500px;width:90%;color:#003366}
    .close-btn{background:none;border:none;font-size:28px;cursor:pointer;color:#666;font-weight:bold;float:right}
    .form-group{margin-bottom:15px}
    .form-row{margin-bottom:15px}
    .form-label{display:block;margin-bottom:6px;font-weight:600;color:#003366;font-size:13px}
    
    /* ØªØ­Ø³ÙŠÙ† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø«Ù„ PBCR */
    #tankTable{
      margin: 20px auto;
      background: rgba(255,255,255,0.95);
      color: #003366;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 15px;
      overflow: hidden;
      min-width: 90%;
      max-width: 600px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
    }
    #tankTable th{
      padding: 15px 10px;
      background: linear-gradient(45deg, #2196F3, #1976D2);
      color: white;
      font-weight: 600;
      text-align: center;
      border-bottom: none;
      font-size: 14px;
    }
    #tankTable td{
      padding: 12px 10px;
      text-align: center;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      font-weight: 500;
    }
    #tankTable tr:last-child td{
      border-bottom: none;
    }
    #tankTable tr:nth-child(even){
      background: rgba(0,0,0,0.05);
    }
    /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„ØµÙÙˆÙ Ø­Ø³Ø¨ Ø§Ù„Ø´ÙØª */
    #tankTable tr.same-shift{
      background: rgba(255,0,0,0.1) !important;
      color: #d32f2f;
    }
    #tankTable tr.next-shift{
      background: rgba(76,175,80,0.1) !important;
      color: #388e3c;
    }
    /* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Delete */
    #tankTable .delete-btn{
      background: linear-gradient(45deg, #f44336, #d32f2f);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.3s ease;
    }
    #tankTable .delete-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(244,67,54,0.3);
    }
    .form-input,.form-select{width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:13px}
    .form-textarea{width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:13px;min-height:60px}
    .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;display:inline-flex;align-items:center;gap:6px}
    .btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
    .btn-secondary{background:linear-gradient(45deg,#6c757d,#5a6268);color:white}
    .modal-buttons{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
    
    @media (max-width:600px){
      .nav-bar{flex-direction:column;gap:15px;padding:15px}
      .nav-links{order:1;justify-content:center;width:100%}
      .nav-user{order:2;width:100%;justify-content:space-between}
      .nav-link{padding:10px 15px;font-size:14px}
      .nav-admin{padding:10px 15px;font-size:14px;display:inline-flex;align-items:center}
      .container{padding:15px;margin:10px}
      .security-buttons{flex-direction:column}
      .modal-btn{width:100%}
      .lt-modal-content{padding:15px;max-width:350px}
      .form-group{margin-bottom:12px}
      .form-row{margin-bottom:12px}
      .form-label{font-size:12px}
      .form-input,.form-select{padding:8px;font-size:12px}
      .btn{padding:8px 16px;font-size:12px}
      .modal-buttons{gap:8px;margin-top:15px}
    }
  </style>
</head>
<body>
  <!-- Security Modal -->
  <div id="securityModal" class="security-modal">
    <div class="security-modal-content">
      <div class="security-icon" id="securityIcon">âš ï¸</div>
      <div class="security-title" id="securityTitle">Security Warning</div>
      <div class="security-text" id="securityText">We detected you trying to access developer tools.</div>
      <div class="attempt-counter" id="attemptCounter">Attempts: <span id="attemptCount">1</span>/3</div>
      <div class="security-buttons">
        <button class="modal-btn modal-btn-primary" onclick="acknowledgeWarning()">I Understand</button>
        <button class="modal-btn modal-btn-secondary" onclick="resetPage()">Reset Page</button>
        <button class="modal-btn modal-btn-danger" onclick="learnMore()">Learn More</button>
      </div>
    </div>
  </div>

  <!-- Access Denied -->
  <div id="accessDenied" class="access-denied" style="display:none">
    <div class="access-denied-content">
      <div class="access-denied-icon">ğŸ”’</div>
      <div class="access-denied-title">Login Required</div>
      <div class="access-denied-text">You need to login to access PLCR Calculator.<br>Please login with your KNPC credentials.</div>
      <button class="login-btn" onclick="goToLogin()">Go to Login</button>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent">
    <div class="nav-bar">
      <div class="nav-logo">Tank Tools</div>
      <div class="nav-links">
        <a class="nav-link" href="index.html">PBCR</a>
        <a class="nav-link active" href="plcr.html">PLCR</a>
        <a class="nav-link" href="NMOGASBL.html">NMOGAS</a>
        <a class="nav-link" href="live-tanks.html" id="live-tanks-btn" style="display:none">ğŸ”´ Live Tanks</a>
        <a class="nav-admin" href="dashboard.html" id="adminLink" style="display:none">ğŸ” Dashboard</a>
      </div>
      <div class="nav-user" id="navUser">
        <div class="font-controls">
          <button class="font-btn" onclick="decreaseFontSize()" title="ØªØµØºÙŠØ± Ø§Ù„Ø®Ø·">-</button>
          <button class="font-btn" onclick="increaseFontSize()" title="ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø·">+</button>
        </div>
        <div class="user-avatar" id="userAvatar">U</div>
        <div id="userName">User</div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="container">
      <h2>PLCR - Tank Calculator</h2>
      
      <label for="mode">Select Mode:</label>
      <select id="mode">
        <option value="levelToBarrels">Level to Barrels</option>
        <option value="barrelsToLevel">Barrels to Level</option>
        <option value="tonToLevel">Metric Ton to Level</option>
        <option value="levelToTon">Level to Metric Ton</option>
      </select>
      
      <label for="tk">Tank Number:</label>
      <input type="number" id="tk" placeholder="e.g. 424" oninput="calculate()">

      <label id="inputLabel" for="value">Enter Value:</label>
      <input type="number" id="value" placeholder="Enter number" oninput="calculate()">

      <div class="result" id="result"></div>
      
      <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… -->
      <div id="advancedFields" style="display:none;">
        <div id="currentWeight" style="margin:10px 0;font-weight:bold;color:#00ffff;text-align:center;padding:10px;background:rgba(0,0,0,0.3);border-radius:8px;"></div>
        
        <label for="amountToWithdraw">Request Quantity (MT):</label>
        <input type="number" id="amountToWithdraw" placeholder="Enter amount to withdraw" oninput="calculateAdvanced()">
        
        <label for="withdrawalRate">Rate (MT/hr):</label>
        <input type="number" id="withdrawalRate" placeholder="Enter withdrawal rate" oninput="calculateAdvanced()">
        
        <div id="finalLevel" style="margin:10px 0;font-weight:bold;text-align:center;padding:10px;background:rgba(0,0,0,0.3);border-radius:8px;"></div>
        <div id="timeNeeded" style="margin:10px 0;font-weight:bold;text-align:center;padding:10px;background:rgba(0,0,0,0.3);border-radius:8px;"></div>
        <div id="finishTime" style="margin:10px 0;font-weight:bold;text-align:center;padding:10px;background:rgba(0,0,0,0.3);border-radius:8px;"></div>
      </div>
      
      <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
      <div id="buttonsSection" style="display:none;margin-top:20px;">
        <button id="addToLiveTanksBtn" onclick="showAddToLiveTanksModal()" style="background:linear-gradient(45deg,#f44336,#d32f2f);color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;margin:5px;font-weight:bold;transition:all 0.3s ease;width:100%;display:none;">ğŸ”´ Add to Live Tanks</button>
        <button id="addReminderBtn" onclick="addReminder()" style="background:linear-gradient(45deg,#2196F3,#1976D2);color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;margin:5px;font-weight:bold;transition:all 0.3s ease;width:100%;">ğŸ“… Add Reminder</button>
        <button id="addToTableBtn" onclick="addToPersonalTable()" style="background:linear-gradient(45deg,#4CAF50,#388E3C);color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;margin:5px;font-weight:bold;transition:all 0.3s ease;width:100%;">ğŸ“Š Add to Table</button>
      </div>
      
      <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ø®ØµÙŠ -->
      <div id="personalTable" style="display:none;margin-top:20px;">
        <h3 style="color:#00ffff;text-align:center;margin-bottom:15px;">Your tanks finishing in current shift</h3>
        <table id="tankTable">
          <thead>
            <tr>
              <th>Tank Number</th>
              <th>Finish Date</th>
              <th>Finish Time</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <button id="darkModeButton" class="action-button" title="Dark Mode">ğŸŒ™</button>
    
    <footer>
      By <a href="#" class="whatsapp-link" onclick="openWhatsApp(); return false;">Fahad - 17877</a> â€“ Version v5
      <br><small style="color:#999;font-size:10px;margin-top:5px;display:block">ğŸ“± WhatsApp: +965 55222550</small>
    </footer>
  </div>
  
  <script>
    // ğŸ”’ Smart Security System - iPhone Optimized
    (function(){
      let attempts=0,modalOpen=false,isTyping=false,typingTimer=null;
      
      function initSecurity(){
        // Enhanced iPhone detection and typing tracking
        const isIPhone=/iPad|iPhone|iPod/.test(navigator.userAgent);
        
        // Multiple event listeners for comprehensive input tracking
        ['focusin','focus','input','keydown','keyup','touchstart'].forEach(eventType=>{
          document.addEventListener(eventType,e=>{
            if(e.target.matches('input,textarea,select')){
              isTyping=true;
              clearTimeout(typingTimer);
              typingTimer=setTimeout(()=>isTyping=false,isIPhone?1500:800);
            }
          },true);
        });
        
        // Additional safety for form interactions
        document.addEventListener('change',e=>{
          if(e.target.matches('input,textarea,select')){
            isTyping=true;
            clearTimeout(typingTimer);
            typingTimer=setTimeout(()=>isTyping=false,1000);
          }
        });
        
        // Enhanced event blocking when typing
        document.addEventListener('contextmenu',e=>{
          if(isTyping||e.target.matches('input,textarea,select')||e.target.closest('input,textarea,select'))return;
          handleViolation('context-menu')(e);
        });
        
        document.addEventListener('selectstart',e=>{
          if(isTyping||e.target.matches('input,textarea,select')||e.target.closest('input,textarea,select'))return;
          handleViolation('text-selection')(e);
        });
        
        document.addEventListener('keydown',e=>{
          if(isTyping||e.target.matches('input,textarea,select')||e.target.closest('input,textarea,select'))return;
          const dangerous=[(e.ctrlKey&&e.key==='u'),(e.ctrlKey&&e.key==='s'),(e.ctrlKey&&e.shiftKey&&e.key==='I'),(e.key==='F12'),(e.ctrlKey&&e.shiftKey&&e.key==='C'),(e.ctrlKey&&e.shiftKey&&e.key==='J')];
          if(dangerous.some(c=>c))handleViolation('keyboard-shortcut')(e);
        });
        
        // DevTools detection with typing check
        let devOpen=false;
        setInterval(()=>{
          if(isTyping)return;
          const threshold=160,wDiff=window.outerWidth-window.innerWidth,hDiff=window.outerHeight-window.innerHeight;
          if(wDiff>threshold||hDiff>threshold){
            if(!devOpen){devOpen=true;setTimeout(()=>{if(!isTyping)handleViolation('devtools-detected')()},500)}
          }else{devOpen=false}
        },isIPhone?5000:3000);
      }
      function handleViolation(type){
        return function(e){
          if(e&&e.preventDefault)e.preventDefault();
          attempts++;
          if(attempts===1)showWarning('first');
          else if(attempts===2)showWarning('second');
          else if(attempts>=3)showWarning('final');
          return false
        }
      }
      function showWarning(level){
        if(modalOpen)return;
        const modal=document.getElementById('securityModal'),icon=document.getElementById('securityIcon'),title=document.getElementById('securityTitle'),text=document.getElementById('securityText'),counter=document.getElementById('attemptCounter'),countSpan=document.getElementById('attemptCount');
        modalOpen=true;countSpan.textContent=attempts;
        if(level==='first'){
          icon.textContent='ğŸ‘€';title.textContent='Security Notice';
          text.innerHTML='<p>We noticed you tried to access developer tools on PLCR Calculator.</p><p><strong>If this was accidental:</strong> No problem! Click "I Understand" to continue.</p><p><strong>Note:</strong> This calculator contains KNPC tank conversion data.</p>';
          counter.style.background='rgba(33,150,243,0.2)';counter.style.borderColor='rgba(33,150,243,0.5)';counter.style.color='#2196F3'
        }else if(level==='second'){
          icon.textContent='âš ï¸';title.textContent='Security Warning';
          text.innerHTML='<p><strong>Second attempt detected on PLCR Calculator.</strong></p><p>Please note this system contains:</p><ul style="text-align:left;margin:10px 0"><li>Proprietary tank conversion algorithms</li><li>KNPC operational data</li><li>Protected calculation methods</li></ul><p>One more attempt will activate security measures.</p>';
          counter.style.background='rgba(255,193,7,0.2)';counter.style.borderColor='rgba(255,193,7,0.5)';counter.style.color='#ffc107'
        }else{
          icon.textContent='ğŸš«';title.textContent='PLCR Security Lock';
          text.innerHTML='<p><strong>Maximum attempts exceeded on PLCR Calculator.</strong></p><p>Enhanced monitoring activated for:</p><ul style="text-align:left;margin:10px 0"><li>Tank calculation protection</li><li>KNPC data security</li><li>System integrity maintenance</li></ul><p>Use "Reset Page" to continue normally.</p>';
          counter.style.background='rgba(244,67,54,0.2)';counter.style.borderColor='rgba(244,67,54,0.5)';counter.style.color='#f44336';
          setTimeout(()=>{if(attempts>=3)implementRestrictions()},5000)
        }
        modal.classList.add('show')
      }
      function implementRestrictions(){
        document.body.style.filter='blur(3px)';
        const overlay=document.createElement('div');
        overlay.innerHTML='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);color:white;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10000;text-align:center;padding:20px"><div style="font-size:4rem;margin-bottom:20px">âš—ï¸</div><h2 style="color:#FFD700;margin-bottom:15px">PLCR Calculator Protected</h2><p style="margin-bottom:30px;max-width:500px;line-height:1.5">Security monitoring active for tank conversion calculations and KNPC operational data.</p><button onclick="window.location.reload()" style="padding:12px 24px;background:#FFD700;color:#003366;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold">ğŸ”„ Reset Calculator</button></div>';
        document.body.appendChild(overlay)
      }
      window.acknowledgeWarning=()=>{document.getElementById('securityModal').classList.remove('show');modalOpen=false;showMessage(attempts>=3?'âš ï¸ Enhanced monitoring active':'âœ… Continue using PLCR normally','success')};
      window.resetPage=()=>window.location.reload();
      window.learnMore=()=>{showMessage('ğŸ”’ PLCR protects KNPC tank conversion data and calculation algorithms. Contact Fahad - 17877 for support.','info');document.getElementById('securityModal').classList.remove('show');modalOpen=false};
      initSecurity()
    })();

    // PLCR Application - Compact Version
    const WHATSAPP_NUMBER="96555222550";
    let currentUser=null;
    
    // Tank conversion data (compressed)
    const tankConversions={"101":{factor:0.206,gross:7.746},"204":{factor:0.605,gross:7.266},"255":{factor:1.528,gross:9.047},"256":{factor:1.528,gross:9.047},"272":{factor:0.759,gross:9.506},"273":{factor:0.437,gross:9.506},"274":{factor:0.437,gross:9.506},"275":{factor:0.999,gross:8.874},"281":{factor:0.282,gross:7.881},"282":{factor:0.282,gross:7.881},"424":{factor:2.272,gross:9.843},"425":{factor:2.414,gross:9.047},"426":{factor:2.414,gross:9.047},"456":{factor:1.321,gross:8.873},"460":{factor:1.640,gross:8.860},"461":{factor:1.640,gross:8.860},"462":{factor:1.494,gross:8.874},"467":{factor:1.358,gross:9.054},"468":{factor:1.358,gross:9.054},"469":{factor:1.358,gross:9.054},"470":{factor:1.358,gross:9.054},"521":{factor:0.508,gross:8.168},"522":{factor:1.476,gross:8.168},"531":{factor:1.506,gross:8.168},"532":{factor:1.506,gross:8.168},"533":{factor:1.506,gross:8.168},"534":{factor:1.506,gross:8.168},"600":{factor:1.227,gross:7.736},"601":{factor:1.227,gross:7.736},"603":{factor:1.519,gross:7.700},"620":{factor:4.560,gross:7.640},"621":{factor:4.560,gross:7.640},"622":{factor:0.645,gross:7.764},"664":{factor:0.914,gross:7.727},"665":{factor:0.914,gross:7.727},"668":{factor:2.154,gross:7.740},"669":{factor:2.154,gross:7.740},"670":{factor:2.154,gross:7.740},"671":{factor:2.011,gross:7.830},"672":{factor:2.011,gross:7.830},"702":{factor:1.917,gross:6.763},"703":{factor:1.917,gross:6.763},"757":{factor:1.626,gross:7.000},"758":{factor:3.040,gross:6.787},"833":{factor:0.960,gross:7.768},"834":{factor:0.960,gross:7.768},"302":{factor:0.860,gross:7.758},"301":{factor:0.860,gross:7.758},"835":{factor:0.960,gross:7.748},"836":{factor:0.960,gross:7.748}};

    // Core Functions
    window.addEventListener('load',()=>checkLoginStatus());
    
    function checkLoginStatus(){
      const session=sessionStorage.getItem('tanktools_session'),userData=localStorage.getItem('tanktools_current_user');
      if(session!=='active'||!userData){showAccessDenied();return}
      try{currentUser=JSON.parse(userData);initializeApp();logActivity('plcr_accessed',currentUser.username)}catch{showAccessDenied()}
    }
    
    function showAccessDenied(){document.getElementById('mainContent').style.display='none';document.getElementById('accessDenied').style.display='flex'}
    
    window.goToLogin=()=>{sessionStorage.setItem('tanktools_redirect','plcr.html');window.location.href='login.html'};
    
    function initializeApp(){
      document.getElementById('mainContent').style.display='block';
      document.getElementById('accessDenied').style.display='none';
      loadUserInfo();loadDataFromLocalStorage();setupDarkMode();
      
      // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Firebase
      checkFirebaseReady();
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Firebase
    function checkFirebaseReady() {
      let checkCount = 0;
      const maxChecks = 10;
      
      const checkInterval = setInterval(() => {
        checkCount++;
        
        if (window.db && window.addDoc && window.collection) {
          console.log('Firebase is ready!');
          clearInterval(checkInterval);
          return;
        }
        
        if (checkCount >= maxChecks) {
          console.warn('Firebase took too long to load');
          clearInterval(checkInterval);
        }
      }, 500);
    }
    
    function loadUserInfo(){
      console.log('loadUserInfo called, currentUser:', currentUser);
      if(!currentUser)return;
      
      const userNameElement = document.getElementById('userName');
      const userAvatarElement = document.getElementById('userAvatar');
      const adminLinkElement = document.getElementById('adminLink');
      const liveTanksLinkElement = document.getElementById('live-tanks-btn');
      
      console.log('userNameElement:', userNameElement);
      console.log('userAvatarElement:', userAvatarElement);
      
      if(userNameElement) {
        console.log('Updating username to:', currentUser.fullName || currentUser.username);
        userNameElement.textContent = currentUser.fullName || currentUser.username;
      }
      
      if(userAvatarElement) {
        const displayName = currentUser.fullName || currentUser.username;
        console.log('Updating avatar to:', displayName.charAt(0).toUpperCase());
        userAvatarElement.textContent = displayName.charAt(0).toUpperCase();
      }
      
      if(adminLinkElement && (currentUser.username==='fam030'||currentUser.role==='admin')) {
        adminLinkElement.style.display='inline-block';
      }
      
      // Show Live Tanks link for allowed roles
      const allowedRoles = ["admin", "panel_operator", "supervisor", "section_head", "operator", "planning"];
      if(liveTanksLinkElement && allowedRoles.includes(currentUser.role)) {
        liveTanksLinkElement.style.display='inline-block';
      }
    }
    
    window.logout=()=>{logActivity('user_logout',currentUser.username);sessionStorage.removeItem('tanktools_session');localStorage.removeItem('tanktools_current_user');window.location.href='login.html'};
    
    function showMessage(message,type){
      const div=document.createElement('div');
      div.innerHTML=message;
      div.style.cssText=`position:fixed;top:20px;right:20px;background:${type==='success'?'#4CAF50':type==='warning'?'#ff9800':'#2196F3'};color:white;padding:15px 20px;border-radius:8px;z-index:10000;max-width:400px;box-shadow:0 4px 12px rgba(0,0,0,0.3)`;
      document.body.appendChild(div);
      setTimeout(()=>div.remove(),5000)
    }

    const modeSelect=document.getElementById("mode"),inputLabel=document.getElementById("inputLabel");
    
    modeSelect.addEventListener("change",()=>{
      const mode=modeSelect.value;
      const labelMap={levelToBarrels:"Current Level:",barrelsToLevel:"Current Barrels:",tonToLevel:"Weight (MT):",levelToTon:"Current Level:"};
      inputLabel.textContent=labelMap[mode]||"Enter value:";
      calculate()
    });

    window.calculate=()=>{
      const tk=document.getElementById("tk").value.trim(),value=parseFloat(document.getElementById("value").value),resultDiv=document.getElementById("result");
      if(!tankConversions[tk]){resultDiv.textContent="Tank number not found in database.";return}
      const tank=tankConversions[tk],mode=modeSelect.value;
      let metricTon,barrels,level;
      switch(mode){
        case "levelToBarrels":
          metricTon=value*tank.factor;barrels=metricTon*tank.gross;
          resultDiv.textContent=`Weight: ${metricTon.toFixed(2)} MT | Barrels: ${barrels.toFixed(2)} BBL`;
          break;
        case "barrelsToLevel":
          metricTon=value/tank.gross;level=metricTon/tank.factor;
          resultDiv.textContent=`Weight: ${metricTon.toFixed(2)} MT | Approx. Level: ${level.toFixed(2)}`;
          break;
        case "tonToLevel":
          level=value/tank.factor;
          resultDiv.textContent=`Approx. Level: ${level.toFixed(2)}`;
          break;
        case "levelToTon":
          metricTon=value*tank.factor;
          resultDiv.textContent=`Weight: ${metricTon.toFixed(2)} MT`;
          break;
        default:
          resultDiv.textContent="Please select a valid mode and enter data."
      }
      saveDataToLocalStorage();
      logActivity('plcr_calculation',currentUser.username)
    };
    
    function saveDataToLocalStorage(){
      const data = {
        tk: document.getElementById("tk").value,
        value: document.getElementById("value").value,
        mode: document.getElementById("mode").value,
        // Ø­ÙØ¸ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        currentLevel: document.getElementById("currentLevel") ? document.getElementById("currentLevel").value : '',
        amountToWithdraw: document.getElementById("amountToWithdraw") ? document.getElementById("amountToWithdraw").value : '',
        withdrawalRate: document.getElementById("withdrawalRate") ? document.getElementById("withdrawalRate").value : ''
      };
      localStorage.setItem('plcrData', JSON.stringify(data));
    }

    function loadDataFromLocalStorage(){
      const dataStr = localStorage.getItem('plcrData');
      if(dataStr){
        const data = JSON.parse(dataStr);
        
        // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        document.getElementById("tk").value = data.tk || '';
        document.getElementById("value").value = data.value || '';
        document.getElementById("mode").value = data.mode || 'levelToBarrels';
        
        // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        if (document.getElementById("currentLevel")) {
          document.getElementById("currentLevel").value = data.currentLevel || '';
        }
        if (document.getElementById("amountToWithdraw")) {
          document.getElementById("amountToWithdraw").value = data.amountToWithdraw || '';
        }
        if (document.getElementById("withdrawalRate")) {
          document.getElementById("withdrawalRate").value = data.withdrawalRate || '';
        }
        
        const mode = data.mode;
        const labelMap = {
          levelToBarrels: "Current Level:",
          barrelsToLevel: "Current Barrels:",
          tonToLevel: "Weight (MT):",
          levelToTon: "Current Level:"
        };
        inputLabel.textContent = labelMap[mode] || "Enter value:";
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆÙØ±Ø©
        if(data.tk && data.value) {
          calculate();
        }
      }
    }

    window.openWhatsApp=()=>{
      const message="Ù…Ø±Ø­Ø¨Ø§ØŒ Ø£ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù…Ù† Ø®Ù„Ø§Ù„ ØªØ·Ø¨ÙŠÙ‚ PLCR Tank Calculator",whatsappURL=`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
      try{const newWindow=window.open(whatsappURL,'_blank','noopener,noreferrer');if(!newWindow)window.location.href=whatsappURL}
      catch{navigator.clipboard.writeText(whatsappURL).then(()=>alert(`ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:\n${whatsappURL}`)).catch(()=>alert(`Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:\n${whatsappURL}`))}
    };

    function setupDarkMode(){
      let isDarkMode=localStorage.getItem('darkMode')==='true';
      const darkModeButton=document.getElementById('darkModeButton');
      function updateColorMode(){
        if(isDarkMode){document.body.classList.add('dark-mode');darkModeButton.innerHTML='â˜€ï¸'}
        else{document.body.classList.remove('dark-mode');darkModeButton.innerHTML='ğŸŒ™'}
      }
      darkModeButton.addEventListener('click',()=>{isDarkMode=!isDarkMode;localStorage.setItem('darkMode',isDarkMode);updateColorMode()});
      updateColorMode()
    }

    function logActivity(action,username){
      const activities=JSON.parse(localStorage.getItem('tanktools_activities')||'[]');
      activities.unshift({id:Date.now(),action,username,timestamp:new Date().toISOString(),ip:'local',userAgent:navigator.userAgent.substring(0,100)});
      activities.splice(100);
      localStorage.setItem('tanktools_activities',JSON.stringify(activities))
    }
    
    // Auto-save and PWA - ØªØ­Ø¯ÙŠØ« Ù„Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.addEventListener('input', e => {
      if(e.target.matches('#tk,#value,#currentLevel,#amountToWithdraw,#withdrawalRate')) {
        saveDataToLocalStorage();
      }
    });
    
    // Ø­ÙØ¸ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¶Ø¹
    document.addEventListener('change', e => {
      if(e.target.matches('#mode')) {
        saveDataToLocalStorage();
      }
    });
    
    if('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js'));
    }
    
    // Font size control functions
    let currentFontSize = parseInt(localStorage.getItem('tanktools_font_size_plcr') || '16');
    
    function increaseFontSize() {
      if (currentFontSize < 24) {
        currentFontSize += 2;
        applyFontSize();
        localStorage.setItem('tanktools_font_size_plcr', currentFontSize);
        showFontMessage(`ğŸ“ˆ Font size increased to ${currentFontSize}px`);
      }
    }
    
    function decreaseFontSize() {
      if (currentFontSize > 12) {
        currentFontSize -= 2;
        applyFontSize();
        localStorage.setItem('tanktools_font_size_plcr', currentFontSize);
        showFontMessage(`ğŸ“‰ Font size decreased to ${currentFontSize}px`);
      }
    }
    
    function applyFontSize() {
      const style = document.createElement('style');
      style.id = 'dynamic-font-style';
      
      const existingStyle = document.getElementById('dynamic-font-style');
      if (existingStyle) {
        existingStyle.remove();
      }
      
      style.textContent = `
        input, select { font-size: ${currentFontSize}px !important; }
        label { font-size: ${currentFontSize}px !important; }
        .result { font-size: ${currentFontSize}px !important; }
        h2 { font-size: ${currentFontSize + 8}px !important; }
        .container { font-size: ${currentFontSize}px !important; }
      `;
      
      document.head.appendChild(style);
    }
    
    function showFontMessage(message) {
      const msgDiv = document.createElement('div');
      msgDiv.style.cssText = 'position:fixed;top:80px;right:20px;background:rgba(76,175,80,0.9);color:white;padding:10px 15px;border-radius:8px;font-size:12px;z-index:1000;animation:slideIn 0.3s ease';
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);
      setTimeout(() => msgDiv.remove(), 3000);
    }
    
    // Apply saved font size on page load
    applyFontSize();
    
    window.increaseFontSize = increaseFontSize;
    window.decreaseFontSize = decreaseFontSize;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù€ PLCR
    let calcData = null;

    // ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© calculate Ù„ØªØ´Ù…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const originalCalculate = window.calculate;
    window.calculate = () => {
      originalCalculate();
      
      const mode = document.getElementById('mode').value;
      const advancedFields = document.getElementById('advancedFields');
      const buttonsSection = document.getElementById('buttonsSection');
      const personalTable = document.getElementById('personalTable');
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø· ÙÙŠ ÙˆØ¶Ø¹ Level to Metric Ton
      if (mode === 'levelToTon') {
        advancedFields.style.display = 'block';
        buttonsSection.style.display = 'block';
        personalTable.style.display = 'block';
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ
        const tk = document.getElementById("tk").value.trim();
        const currentLevel = parseFloat(document.getElementById("value").value);
        
        if (tankConversions[tk] && !isNaN(currentLevel)) {
          const tank = tankConversions[tk];
          const currentWeight = currentLevel * tank.factor;
          
          // Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø®ØµØµ
          document.getElementById('currentWeight').textContent = `Current Weight: ${currentWeight.toFixed(2)} MT`;
          
          // Ø­Ø³Ø§Ø¨ Ù…ØªÙ‚Ø¯Ù… Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          calculateAdvanced();
        }
      } else {
        advancedFields.style.display = 'none';
        buttonsSection.style.display = 'none';
        personalTable.style.display = 'none';
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ø®ØµÙŠ
      updatePersonalTable();
    };

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
    window.calculateAdvanced = () => {
      const tk = document.getElementById("tk").value.trim();
      const currentLevel = parseFloat(document.getElementById("value").value);
      const amountToWithdraw = parseFloat(document.getElementById("amountToWithdraw").value);
      const withdrawalRate = parseFloat(document.getElementById("withdrawalRate").value);
      
      if (!tankConversions[tk] || isNaN(currentLevel) || isNaN(amountToWithdraw) || isNaN(withdrawalRate)) {
        document.getElementById('finalLevel').textContent = '';
        document.getElementById('timeNeeded').textContent = '';
        document.getElementById('finishTime').textContent = '';
        return;
      }
      
      const tank = tankConversions[tk];
      const currentWeight = currentLevel * tank.factor;
      const finalWeight = currentWeight - amountToWithdraw;
      const finalLevel = finalWeight / tank.factor;
      const timeNeededHours = amountToWithdraw / withdrawalRate;
      
      // Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
      const now = new Date();
      const finishTime = new Date(now.getTime() + timeNeededHours * 60 * 60 * 1000);
      
      const hours = Math.floor(timeNeededHours);
      const minutes = Math.round((timeNeededHours - hours) * 60);
      
      const date = finishTime.toLocaleDateString('en-GB');
      const time = finishTime.toLocaleTimeString('en-GB', { hour12: false, hour: '2-digit', minute: '2-digit' });
      
      // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙØª
      const isCurrentShift = isSameShift(now, finishTime);
      const color = isCurrentShift ? '#ff4444' : '#44ff44';
      
      try {
        ft = `${date} ${time}`;
      } catch {
        ft = `${date} ${time}`;
      }
      
      document.getElementById('finalLevel').innerHTML = `<span style="color:${color}">Final Level: ${finalLevel.toFixed(2)} m</span>`;
      document.getElementById('timeNeeded').innerHTML = `<span style="color:${color}">Time Needed: ${hours}h ${minutes}min</span>`;
      document.getElementById('finishTime').innerHTML = `<span style="color:${color}">Finish Time: ${ft}</span>`;
      
      // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      calcData = {
        tankNumber: tk,
        currentLevel: currentLevel,
        currentWeight: currentWeight,
        amountToWithdraw: amountToWithdraw,
        withdrawalRate: withdrawalRate,
        finalLevel: finalLevel,
        timeNeeded: timeNeededHours,
        finishTime: finishTime,
        finishTimeString: ft
      };
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Add to Live Tanks
      checkAddToLiveTanksPermission();
    };

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´ÙØª - Ù†ÙØ³ PBCR
    function isSameShift(now, finish) {
      console.log('isSameShift called:');
      console.log('Now:', now.toLocaleString());
      console.log('Finish:', finish.toLocaleString());
      
      const getShift = h => {
        const m = h.getHours() * 60 + h.getMinutes();
        return m >= 360 && m < 840 ? "morning" : m >= 840 && m < 1320 ? "evening" : "night";
      };
      
      const currentShift = getShift(now);
      const finishShift = getShift(finish);
      
      console.log('Current shift:', currentShift);
      console.log('Finish shift:', finishShift);
      
      if (currentShift !== finishShift) {
        console.log('Different shifts, returning false');
        return false;
      }
      
      if (currentShift === "night") {
        const nowHour = now.getHours();
        const finishHour = finish.getHours();
        
        if (nowHour >= 0 && nowHour < 6) {
          if (finishHour >= 0 && finishHour < 6) 
            return Math.floor((finish.getTime() - now.getTime()) / (24 * 60 * 60 * 1000)) <= 1;
          else if (finishHour >= 22) 
            return Math.floor((finish.getTime() - now.getTime()) / (24 * 60 * 60 * 1000)) === 0;
        } else if (nowHour >= 22) {
          if (finishHour >= 22) 
            return now.toDateString() === finish.toDateString();
          else if (finishHour >= 0 && finishHour < 6) 
            return Math.floor((finish.getTime() - now.getTime()) / (24 * 60 * 60 * 1000)) === 1;
        }
        return false;
      }
      
      const sameDate = now.toDateString() === finish.toDateString();
      console.log('Same date:', sameDate);
      return sameDate;
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© ØªØ°ÙƒÙŠØ±
    window.addReminder = () => {
      if (!calcData) {
        alert('Please complete the calculation first');
        return;
      }
      
      const title = `Tank ${calcData.tankNumber} - Withdrawal Complete`;
      const details = `Tank: ${calcData.tankNumber}\\nWithdrawal: ${calcData.amountToWithdraw} MT\\nFinal Level: ${calcData.finalLevel.toFixed(2)} m`;
      const startDate = calcData.finishTime.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      const endDate = new Date(calcData.finishTime.getTime() + 30 * 60 * 1000).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      
      const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDate}/${endDate}&details=${encodeURIComponent(details)}`;
      
      window.open(googleCalendarUrl, '_blank');
    };

    // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ø®ØµÙŠ
    window.addToPersonalTable = () => {
      if (!calcData) {
        alert('Please complete the calculation first');
        return;
      }
      
      const personalData = JSON.parse(localStorage.getItem('plcr_personal_table') || '[]');
      const newEntry = {
        id: Date.now(),
        tankNumber: calcData.tankNumber,
        currentLevel: calcData.currentLevel,
        amountToWithdraw: calcData.amountToWithdraw,
        finalLevel: calcData.finalLevel,
        finishTime: calcData.finishTimeString,
        timestamp: new Date().toISOString()
      };
      
      personalData.unshift(newEntry);
      personalData.splice(10); // Keep only last 10 entries
      localStorage.setItem('plcr_personal_table', JSON.stringify(personalData));
      
      updatePersonalTable();
      alert('Added to personal table successfully!');
    };

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ø®ØµÙŠ
    function updatePersonalTable() {
      const personalData = JSON.parse(localStorage.getItem('plcr_personal_table') || '[]');
      const table = document.getElementById('tankTable').getElementsByTagName('tbody')[0];
      
      // Ù…Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      table.innerHTML = '';
      
      if (personalData.length === 0) {
        document.getElementById('personalTable').style.display = 'none';
        return;
      }
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„
      document.getElementById('personalTable').style.display = 'block';
      
      personalData.forEach((entry, index) => {
        const row = table.insertRow();
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† ØµÙŠØºØ© DD/MM/YYYY HH:MM Ø¥Ù„Ù‰ ØµÙŠØºØ© ØµØ­ÙŠØ­Ø©
        let finishDateTime;
        console.log('Original entry.finishTime:', entry.finishTime);
        try {
          if (entry.finishTime && entry.finishTime.includes('/')) {
            // ØªØ­ÙˆÙŠÙ„ Ù…Ù† "15/06/2025 17:51" Ø¥Ù„Ù‰ "2025-06-15T17:51:00"
            const [datePart, timePart] = entry.finishTime.split(' ');
            const [day, month, year] = datePart.split('/');
            const isoString = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${timePart}:00`;
            console.log('Converted to ISO:', isoString);
            finishDateTime = new Date(isoString);
            console.log('Final Date object:', finishDateTime);
          } else {
            finishDateTime = new Date(entry.finishTime);
            console.log('Direct conversion:', finishDateTime);
          }
        } catch (error) {
          console.log('Error parsing date:', entry.finishTime, error);
          finishDateTime = new Date(); // fallback to current time
        }
        
        const now = new Date();
        const sameShift = isSameShift(now, finishDateTime);
        
        // ØªØ·Ø¨ÙŠÙ‚ Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù†
        row.className = sameShift ? 'same-shift' : 'next-shift';
        
        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
        const finishDate = finishDateTime.toLocaleDateString('en-GB');
        const finishTime = entry.finishTimeString || finishDateTime.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit', hour12: false});
        
        row.innerHTML = `
          <td>${entry.tankNumber}</td>
          <td>${finishDate}</td>
          <td>${finishTime}</td>
          <td><button class="delete-btn" onclick="removeFromPersonalTable(${index})">Delete</button></td>
        `;
      });
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø®Ø²Ø§Ù† Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ø®ØµÙŠ
    window.removeFromPersonalTable = (index) => {
      if (confirm('Are you sure you want to remove this tank from the table?')) {
        const personalData = JSON.parse(localStorage.getItem('plcr_personal_table') || '[]');
        personalData.splice(index, 1);
        localStorage.setItem('plcr_personal_table', JSON.stringify(personalData));
        updatePersonalTable();
        
        // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
        const msgDiv = document.createElement('div');
        msgDiv.style.cssText = 'position:fixed;top:80px;right:20px;background:rgba(76,175,80,0.9);color:white;padding:10px 15px;border-radius:8px;font-size:12px;z-index:1000;animation:slideIn 0.3s ease';
        msgDiv.textContent = 'âœ… Tank removed successfully!';
        document.body.appendChild(msgDiv);
        setTimeout(() => msgDiv.remove(), 3000);
      }
    };

    // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Live Tanks
    async function checkAddToLiveTanksPermission() {
      try {
        console.log('ğŸ” Checking Add to Live Tanks permission...');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
        if (!calcData || !calcData.tankNumber) {
          console.log('checkAddToLiveTanksPermission: No calculation data available');
          return;
        }
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© hasPermission Ù…Ù† permissions.js
        const canAddToLiveTanks = await hasPermission('canAddToLiveTanks');
        
        console.log('checkAddToLiveTanksPermission: Can add to Live Tanks:', canAddToLiveTanks);
        
        const addButton = document.getElementById('addToLiveTanksBtn');
        
        if (canAddToLiveTanks) {
          if (addButton) {
            addButton.style.display = 'block';
            addButton.disabled = false;
          }
          console.log('âœ… Add to Live Tanks button enabled');
        } else {
          if (addButton) {
            addButton.style.display = 'none';
            addButton.disabled = true;
          }
          console.log('âŒ Add to Live Tanks button disabled - no permission');
        }
      } catch (error) {
        console.error('âŒ Error checking Add to Live Tanks permission:', error);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ù„Ù„Ø£Ù…Ø§Ù†
        const addButton = document.getElementById('addToLiveTanksBtn');
        if (addButton) {
          addButton.style.display = 'none';
          addButton.disabled = true;
        }
      }
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Add to Live Tanks
    window.showAddToLiveTanksModal = async () => {
      if (!calcData) {
        alert('Please complete the calculation first');
        return;
      }
      
      // ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª - ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙØ­Øµ
      try {
        if (!currentUser) {
          alert('User information not available. Please refresh the page.');
          return;
        }
        
        // ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ø­Ø³Ù†Ø©
        let hasAddPermission = false;
        
        // ÙØ­Øµ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
        const allowedRoles = ['admin', 'control_panel', 'panel_operator'];
        if (allowedRoles.includes(currentUser.role) || allowedRoles.includes(currentUser.specialization)) {
          hasAddPermission = true;
        }
        
        // ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… hasPermission Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø©
        if (typeof window.hasPermission === 'function') {
          try {
            const permissionResult = await window.hasPermission('canAddToLiveTanks');
            if (permissionResult) {
              hasAddPermission = true;
            }
          } catch (error) {
            console.log('Permission check failed, using role-based check:', error);
          }
        }
        
        // ÙØ­Øµ Ø®Ø§Øµ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… fam030
        if (currentUser.username === 'fam030') {
          hasAddPermission = true;
        }
        
        if (!hasAddPermission) {
          alert('You do not have permission to add to Live Tanks');
          return;
        }
        
      } catch (error) {
        console.error('Error checking permissions:', error);
        alert('Error checking permissions. Please try again.');
        return;
      }
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¨Ù†ÙØ³ ØªØµÙ…ÙŠÙ… PBCR
      const modal = document.createElement('div');
      modal.id = 'ltModal';
      modal.className = 'lt-modal show';
      
      const products = ["NAPHA", "PCNA", "HSD-EGO", "EGO", "F.OIL", "MOGAS", "VGO", "KKERO", "ARDR", "METHANOL", "OTHER"];
      let productOptions = '';
      products.forEach(product => {
        productOptions += `<option value="${product}">${product}</option>`;
      });
      
      modal.innerHTML = `
        <div class="lt-modal-content">
          <button class="close-btn" onclick="closeLTModal()">&times;</button>
          <h3>ğŸ”´ Add to Live Tanks</h3>
          <form id="ltForm">
            <div class="form-group">
              <label class="form-label">ğŸ­ Department:</label>
              <select class="form-select" id="ltDept" required>
                <option value="PLCR">PLCR</option>
              </select>
            </div>
            
            <div class="form-row" style="display:flex;gap:10px">
              <div class="form-group" style="flex:1">
                <label class="form-label">ğŸ·ï¸ Tank Number:</label>
                <input type="text" class="form-input" id="ltTank" value="${calcData.tankNumber}" readonly style="background:#f5f5f5">
              </div>
              <div class="form-group" style="flex:1">
                <label class="form-label">ğŸ›¢ï¸ Product Type:</label>
                <select class="form-select" id="ltProduct" required>
                  <option value="">Select Product</option>
                  ${productOptions}
                </select>
              </div>
            </div>
            
            <div class="form-row" style="display:flex;gap:10px">
              <div class="form-group" style="flex:1">
                <label class="form-label">ğŸ“Š Request Quantity (MT):</label>
                <input type="number" step="any" class="form-input" id="ltTargetValue" value="${calcData.amountToWithdraw}" readonly style="background:#f5f5f5">
              </div>
              <div class="form-group" style="flex:1">
                <label class="form-label">ğŸ¯ Target Type:</label>
                <input type="text" class="form-input" id="ltTargetType" value="Quantity MT" readonly style="background:#f5f5f5">
              </div>
            </div>
            
            <div class="form-row" style="display:flex;gap:10px">
              <div class="form-group" style="flex:1">
                <label class="form-label">âš¡ Flow Rate:</label>
                <input type="number" step="any" class="form-input" id="ltRate" value="${calcData.withdrawalRate}" readonly style="background:#f5f5f5">
              </div>
              <div class="form-group" style="flex:1">
                <label class="form-label">ğŸ“ Rate Unit:</label>
                <input type="text" class="form-input" id="ltRateUnit" value="MT/hr" readonly style="background:#f5f5f5">
              </div>
            </div>
            
            <div class="form-row" style="display:flex;gap:10px">
              <div class="form-group" style="flex:1">
                <label class="form-label">ğŸ“… Finish Date:</label>
                <input type="text" class="form-input" id="ltDate" value="${calcData.finishTime.toLocaleDateString('en-GB')}" readonly style="background:#f5f5f5">
              </div>
              <div class="form-group" style="flex:1">
                <label class="form-label">â° Finish Time:</label>
                <input type="text" class="form-input" id="ltTime" value="${calcData.finishTime.toLocaleTimeString('en-GB', { hour12: false, hour: '2-digit', minute: '2-digit' })}" readonly style="background:#f5f5f5">
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">ğŸ“ Notes (Optional):</label>
              <textarea class="form-textarea" id="ltNotes" placeholder="Additional information..."></textarea>
            </div>
            
            <div class="modal-buttons">
              <button type="button" class="btn btn-secondary" onclick="closeLTModal()">âŒ Cancel</button>
              <button type="submit" class="btn btn-primary">ğŸ’¾ Add to Live Tanks</button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ù…Ù†ØªØ¬ OTHER
      document.getElementById('ltProduct').addEventListener('change', function() {
        const otherDiv = document.getElementById('otherProductDiv');
        if (this.value === 'OTHER') {
          if (!otherDiv) {
            const newOtherDiv = document.createElement('div');
            newOtherDiv.id = 'otherProductDiv';
            newOtherDiv.className = 'form-group';
            newOtherDiv.innerHTML = `
              <label class="form-label">ğŸ“ Specify Product:</label>
              <input type="text" class="form-input" id="ltOtherProduct" placeholder="Enter product name">
            `;
            this.parentNode.parentNode.insertAdjacentElement('afterend', newOtherDiv);
          } else {
            otherDiv.style.display = 'block';
          }
        } else {
          if (otherDiv) {
            otherDiv.style.display = 'none';
          }
        }
      });
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
      document.getElementById('ltForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitToLiveTanks();
      });
    };

    // Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
    window.closeLTModal = () => {
      const modal = document.getElementById('ltModal');
      if (modal) {
        modal.remove();
      }
    };

    // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Live Tanks
    window.submitToLiveTanks = async () => {
      try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Firebase Ù…Ø¹ Ø§Ù†ØªØ¸Ø§Ø± Ø£Ø·ÙˆÙ„
        let retryCount = 0;
        const maxRetries = 5;
        
        while ((!window.db || !window.addDoc || !window.collection) && retryCount < maxRetries) {
          console.log(`Waiting for Firebase to load... Attempt ${retryCount + 1}`);
          await new Promise(resolve => setTimeout(resolve, 1000));
          retryCount++;
        }
        
        if (!window.db || !window.addDoc || !window.collection) {
          alert('Firebase is not loaded. Please refresh the page and try again.');
          return;
        }
        
        const product = document.getElementById('ltProduct').value;
        const finalProduct = product === 'OTHER' ? document.getElementById('ltOtherProduct')?.value : product;
        
        if (!finalProduct) {
          alert('Please specify the product');
          return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (!currentUser || !currentUser.username) {
          alert('User information not available. Please refresh the page.');
          return;
        }
        
        // ØªØ­Ø³ÙŠÙ† ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
        const dateStr = document.getElementById('ltDate').value;
        const timeStr = document.getElementById('ltTime').value;
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† DD/MM/YYYY Ø¥Ù„Ù‰ YYYY-MM-DD
        let finishDateTime;
        try {
          const dateParts = dateStr.split('/');
          if (dateParts.length !== 3) {
            throw new Error('Invalid date format');
          }
          
          const formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
          finishDateTime = new Date(`${formattedDate}T${timeStr}:00`);
          
          if (isNaN(finishDateTime.getTime())) {
            throw new Error('Invalid date');
          }
        } catch (error) {
          console.error('Date conversion error:', error);
          alert('Error: Invalid date or time format');
          return;
        }
        
        // Ø­Ø³Ø§Ø¨ Conversion Factor
        function calculateConversionFactor() {
          const levelDiff = (calcData.currentLevel - calcData.finalLevel) / 1000; // Convert to actual meters
          const timeHours = calcData.timeNeeded;
          const rateValue = calcData.withdrawalRate;
          
          const meterPerHour = levelDiff / timeHours;
          const conversionFactor = rateValue / meterPerHour;
          return conversionFactor;
        }
        
        const conversionFactor = calculateConversionFactor();
        console.log('Conversion Factor calculated:', conversionFactor);
        
        const tankData = {
          department: 'PLCR',
          tankNumber: calcData.tankNumber,
          product: finalProduct,
          targetValue: parseFloat((calcData.finalLevel / 1000).toFixed(3)), // Convert to actual meters and round to 3 decimals (6.318)
          targetType: 'Level', // Changed from 'Quantity MT' to 'Level'
          currentLevel: calcData.currentLevel / 1000, // Convert to actual meters (10.000)
          rate: calcData.withdrawalRate,
          rateUnit: 'MT/hr',
          conversionFactor: conversionFactor, // Add conversion factor
          addedBy: currentUser.username,
          userName: currentUser.fullName || currentUser.username,
          finishTime: timeStr,
          finishDate: dateStr,
          finishDateTime: finishDateTime,
          addedAt: window.serverTimestamp(),
          lastLevelUpdate: window.serverTimestamp(),
          status: 'active',
          notes: document.getElementById('ltNotes').value,
          source: 'PLCR_Calculator',
          calculationData: {
            requestQuantity: calcData.amountToWithdraw,
            timeNeeded: calcData.timeNeeded,
            finalLevel: calcData.finalLevel / 1000,
            currentLevel: calcData.currentLevel / 1000,
            currentWeight: calcData.currentWeight
          }
        };
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'â³ Adding...';
        submitBtn.disabled = true;
        
        console.log('Attempting to add to Firebase:', tankData);
        
        // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Firebase Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
        const docRef = await window.addDoc(window.collection(window.db, 'liveTanks'), tankData);
        console.log('Successfully added to Firebase with ID:', docRef.id);
        
        // Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        alert('âœ… Tank added to Live Tanks successfully!');
        closeLTModal();
        
        // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¨ØµØ±ÙŠØ©
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position:fixed;top:80px;right:20px;background:rgba(76,175,80,0.9);color:white;padding:15px 20px;border-radius:8px;font-size:14px;z-index:10000;animation:slideIn 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.3)';
        successMsg.innerHTML = 'âœ… Tank added to Live Tanks successfully!';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 4000);
        
        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Live Tanks
        setTimeout(() => {
          window.location.href = 'live-tanks.html';
        }, 1500);
        
      } catch (error) {
        console.error('Error adding to Live Tanks:', error);
        
        // Ø±Ø³Ø§Ø¦Ù„ Ø®Ø·Ø£ Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹
        let errorMessage = 'Error adding to Live Tanks: ';
        if (error.code === 'permission-denied') {
          errorMessage += 'Permission denied. Please check your access rights.';
        } else if (error.code === 'unavailable') {
          errorMessage += 'Service temporarily unavailable. Please try again later.';
        } else if (error.message) {
          errorMessage += error.message;
        } else {
          errorMessage += 'Unknown error occurred.';
        }
        
        alert('âŒ ' + errorMessage);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.textContent = 'ğŸ’¾ Add to Live Tanks';
          submitBtn.disabled = false;
        }
      }
    };

    console.log('%cğŸ”’ PLCR CALCULATOR - SMART SECURITY','color:red;font-size:16px;font-weight:bold');
    console.log('%cDeveloper: Fahad - 17877','color:green;font-size:14px');
  </script>
</body>
</html>