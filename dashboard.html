<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tank Tools - Master Admin Dashboard</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="icon.png" type="image/png">
  <meta name="theme-color" content="#003366">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('background.jpg'); background-size: cover; background-position: center; background-attachment: fixed; font-family: Arial, sans-serif; color: white; min-height: 100vh; }
    .navbar { background: rgba(0, 0, 0, 0.8); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(10px); box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    .navbar-brand { font-size: 1.5rem; font-weight: bold; background: linear-gradient(45deg, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(45deg, #FFD700, #FFA500); display: flex; align-items: center; justify-content: center; font-weight: bold; color: #003366; }
    .nav-btn, .logout-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; text-decoration: none; font-size: 14px; }
    .nav-btn:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
    .logout-btn { background: rgba(255, 0, 0, 0.2); border-color: rgba(255, 0, 0, 0.5); }
    .logout-btn:hover { background: rgba(255, 0, 0, 0.4); }
    .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
    .welcome-section { text-align: center; margin-bottom: 30px; background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px; backdrop-filter: blur(10px); }
    .admin-badge { display: inline-block; background: linear-gradient(45deg, #FFD700, #FFA500); color: #003366; padding: 8px 20px; border-radius: 25px; font-weight: bold; margin-bottom: 15px; font-size: 1.1rem; }
    .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .stat-card { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; text-align: center; backdrop-filter: blur(10px); transition: all 0.3s ease; }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-number { font-size: 2rem; font-weight: bold; background: linear-gradient(45deg, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stat-label { font-size: 0.9rem; opacity: 0.8; }
    .users-section { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px; backdrop-filter: blur(10px); margin-bottom: 30px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    .section-title { font-size: 1.3rem; color: #FFD700; }
    .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-size: 14px; font-weight: 500; }
    .btn-primary { background: linear-gradient(45deg, #4CAF50, #45a049); color: white; }
    .btn-secondary { background: linear-gradient(45deg, #2196F3, #1976D2); color: white; }
    .btn-danger { background: linear-gradient(45deg, #f44336, #d32f2f); color: white; }
    .btn-warning { background: linear-gradient(45deg, #ff9800, #f57c00); color: white; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .search-filter { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
    .search-box, .filter-select { padding: 10px 15px; border: none; border-radius: 8px; background: rgba(255, 255, 255, 0.9); color: #003366; font-size: 14px; }
    .search-box { flex: 1; min-width: 200px; }
    .users-table { width: 100%; background: rgba(255, 255, 255, 0.95); border-radius: 10px; overflow: hidden; color: #003366; }
    .users-table th, .users-table td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(0, 51, 102, 0.1); }
    .users-table th { background: #003366; color: white; font-weight: bold; }
    .users-table tr:hover { background: rgba(255, 215, 0, 0.1); }
    .user-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
    .badge-admin { background: #FFD700; color: #003366; }
    .badge-user { background: #4CAF50; color: white; }
    .badge-active { background: #4CAF50; color: white; }
    .badge-inactive { background: #ccc; color: #666; }
    .badge-verified { background: #2196F3; color: white; }
    .badge-pending { background: #ff9800; color: white; }
    .action-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
    .action-btn { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; }
    .action-btn:hover { transform: scale(1.05); }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; backdrop-filter: blur(5px); }
    .modal.show { display: flex; justify-content: center; align-items: center; }
    .modal-content { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; color: #003366; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
    .modal-title { font-size: 1.2rem; font-weight: bold; color: #003366; }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
    .close-btn:hover { color: #f44336; }
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; margin-bottom: 5px; font-weight: 500; color: #003366; }
    .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    .form-input:focus { outline: none; border-color: #4CAF50; }
    .message { padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; font-weight: 500; display: none; }
    .message.success { background: rgba(76, 175, 80, 0.2); border: 1px solid rgba(76, 175, 80, 0.5); color: #4CAF50; }
    .message.error { background: rgba(244, 67, 54, 0.2); border: 1px solid rgba(244, 67, 54, 0.5); color: #f44336; }
    .message.info { background: rgba(33, 150, 243, 0.2); border: 1px solid rgba(33, 150, 243, 0.5); color: #2196F3; }
    .message.warning { background: rgba(255, 193, 7, 0.2); border: 1px solid rgba(255, 193, 7, 0.5); color: #ffc107; }
    .message.show { display: block; animation: slideIn 0.5s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* Security Warning Modal */
    .security-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 9999; backdrop-filter: blur(5px); }
    .security-modal.show { display: flex; justify-content: center; align-items: center; }
    .security-modal-content { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; color: #003366; text-align: center; animation: modalSlideIn 0.5s ease; }
    @keyframes modalSlideIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    .security-icon { font-size: 3rem; margin-bottom: 15px; }
    .security-title { font-size: 1.5rem; margin-bottom: 15px; font-weight: bold; }
    .security-text { margin-bottom: 20px; line-height: 1.5; }
    .attempt-counter { background: rgba(255, 193, 7, 0.2); border: 1px solid rgba(255, 193, 7, 0.5); color: #f57c00; padding: 10px; border-radius: 8px; margin: 15px 0; font-weight: bold; }
    .security-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    .modal-btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
    .modal-btn-primary { background: #4CAF50; color: white; }
    .modal-btn-secondary { background: #2196F3; color: white; }
    .modal-btn-danger { background: #f44336; color: white; }
    .modal-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

    @media (max-width: 768px) { .navbar { flex-direction: column; gap: 10px; } .stats-section { grid-template-columns: repeat(2, 1fr); } .section-header { flex-direction: column; align-items: flex-start; } .search-filter { flex-direction: column; } .users-table { font-size: 12px; } .users-table th, .users-table td { padding: 8px 4px; } .action-buttons { flex-direction: column; } .security-buttons { flex-direction: column; } .modal-btn { width: 100%; } }
  </style>
</head>
<body>
  <!-- Security Warning Modal -->
  <div id="securityModal" class="security-modal">
    <div class="security-modal-content">
      <div class="security-icon" id="securityIcon">⚠️</div>
      <div class="security-title" id="securityTitle">Security Warning</div>
      <div class="security-text" id="securityText">
        We detected you trying to access developer tools. This action is monitored for security purposes.
      </div>
      <div class="attempt-counter" id="attemptCounter">
        Attempts: <span id="attemptCount">1</span>/3
      </div>
      <div class="security-buttons">
        <button class="modal-btn modal-btn-primary" onclick="acknowledgeWarning()">I Understand</button>
        <button class="modal-btn modal-btn-secondary" onclick="resetPage()">Reset Page</button>
        <button class="modal-btn modal-btn-danger" onclick="learnMore()">Learn More</button>
      </div>
    </div>
  </div>

  <nav class="navbar">
    <div class="navbar-brand">👑 Master Admin Control</div>
    <div class="user-info">
      <a href="index.html" class="nav-btn">📊 PBCR</a>
      <a href="plcr.html" class="nav-btn">⚗️ PLCR</a>
      <a href="NMOGASBL.html" class="nav-btn">🔧 NMOGAS</a>
      <div class="user-avatar" id="userAvatar">F</div>
      <div>
        <div id="userName">Fahad - fam030</div>
        <div style="font-size: 0.8rem; opacity: 0.7;" id="userEmail">fam030@knpc.com</div>
      </div>
      <button class="logout-btn" onclick="logout()">🚪 Logout</button>
    </div>
  </nav>

  <div class="container">
    <div class="welcome-section">
      <div class="admin-badge">👑 MASTER ADMIN CONTROL CENTER</div>
      <h2>🎉 Complete User Management System</h2>
      <p>Full control over all Tank Tools users - Advanced security and monitoring</p>
      <p id="currentTime"></p>
    </div>

    <div id="messageContainer"></div>

    <div class="stats-section">
      <div class="stat-card">
        <div class="stat-number" id="totalUsers">0</div>
        <div class="stat-label">Total Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="activeUsers">0</div>
        <div class="stat-label">Active Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pendingUsers">0</div>
        <div class="stat-label">Pending Approval</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="todayLogins">0</div>
        <div class="stat-label">Today's Logins</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="resetRequests">0</div>
        <div class="stat-label">Reset Requests</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pendingActivations">0</div>
        <div class="stat-label">Pending Activations</div>
      </div>
    </div>

    <div class="search-filter">
      <input type="text" class="search-box" id="userSearch" placeholder="🔍 Search users by name, username, or email...">
      <select class="filter-select" id="statusFilter">
        <option value="all">All Status</option>
        <option value="active">Active Only</option>
        <option value="inactive">Inactive Only</option>
        <option value="verified">Verified Email</option>
        <option value="pending">Pending Email</option>
      </select>
      <select class="filter-select" id="roleFilter">
        <option value="all">All Roles</option>
        <option value="admin">Admins</option>
        <option value="user">Users</option>
      </select>
    </div>

    <div class="users-section">
      <div class="section-header">
        <h3 class="section-title">👥 All Registered Users</h3>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="addNewUser()">➕ Add User</button>
          <button class="btn btn-secondary" onclick="exportUsers()">📊 Export</button>
          <button class="btn btn-warning" onclick="showPendingActivations()">🔍 Pending</button>
          <button class="btn btn-warning" onclick="showDebugInfo()">🔍 Debug</button>
          <button class="btn btn-danger" onclick="refreshUsers()">🔄 Refresh</button>
        </div>
      </div>
      
      <div style="overflow-x: auto;">
        <table class="users-table">
          <thead>
            <tr>
              <th>Avatar</th>
              <th>Full Name</th>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Email Verified</th>
              <th>Last Login</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <!-- Users will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Debug Modal -->
  <div id="debugModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">🔍 System Debug Information</h3>
        <button class="close-btn" onclick="closeDebugModal()">&times;</button>
      </div>
      <div id="debugContent" style="font-family: monospace; white-space: pre-wrap; background: #f5f5f5; padding: 20px; border-radius: 8px; color: #003366; font-size: 12px; max-height: 400px; overflow-y: auto;">
        Loading debug information...
      </div>
      <div style="margin-top: 20px; text-align: center;">
        <button class="btn btn-primary" onclick="fixUserData()">🔧 Fix User Data</button>
        <button class="btn btn-secondary" onclick="migrateData()">📦 Migrate Data</button>
        <button class="btn btn-danger" onclick="clearAllData()">🗑️ Clear All</button>
        <button class="btn btn-secondary" onclick="closeDebugModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Pending Activations Modal -->
  <div id="pendingActivationsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">🕐 Pending Account Activations</h3>
        <button class="close-btn" onclick="closePendingModal()">&times;</button>
      </div>
      <div id="pendingActivationsContent">
        Loading pending activations...
      </div>
      <div style="margin-top: 20px; text-align: center;">
        <button class="btn btn-primary" onclick="activateAllPending()">✅ Activate All</button>
        <button class="btn btn-danger" onclick="clearPendingList()">🗑️ Clear List</button>
        <button class="btn btn-secondary" onclick="closePendingModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- User Edit Modal -->
  <div id="userModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Edit User</h3>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <form id="userForm">
        <div class="form-group">
          <label class="form-label">Full Name:</label>
          <input type="text" class="form-input" id="editFullName" required>
        </div>
        <div class="form-group">
          <label class="form-label">Username:</label>
          <input type="text" class="form-input" id="editUsername" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Email:</label>
          <input type="email" class="form-input" id="editEmail" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Role:</label>
          <select class="form-input" id="editRole">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Status:</label>
          <select class="form-input" id="editStatus">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Email Verified:</label>
          <select class="form-input" id="editEmailVerified">
            <option value="true">Verified</option>
            <option value="false">Pending</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">New Password (Optional):</label>
          <input type="password" class="form-input" id="editPassword" placeholder="Leave empty to keep current">
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // 🔒 Smart Security Protection System - Dashboard Version
    (function() {
      'use strict';
      
      // Security state management
      let securityAttempts = 0;
      let isSecurityModalOpen = false;
      let securityViolationTypes = [];
      
      // Enhanced security with user-friendly approach
      function initSmartSecurity() {
        // Disable right-click context menu
        document.addEventListener('contextmenu', handleSecurityViolation.bind(null, 'context-menu'));
        
        // Disable text selection (but allow form inputs)
        document.addEventListener('selectstart', (e) => {
          if (!e.target.matches('input, textarea')) {
            handleSecurityViolation('text-selection')(e);
          }
        });
        
        // Monitor dangerous key combinations
        document.addEventListener('keydown', (e) => {
          const dangerousKeys = [
            (e.ctrlKey && e.key === 'u'), // View source
            (e.ctrlKey && e.key === 's'), // Save page
            (e.ctrlKey && e.shiftKey && e.key === 'I'), // DevTools
            (e.key === 'F12'), // DevTools
            (e.ctrlKey && e.shiftKey && e.key === 'C'), // Inspect element
            (e.ctrlKey && e.shiftKey && e.key === 'J'), // Console
            (e.ctrlKey && e.key === 'c' && !e.target.matches('input, textarea')), // Copy (outside inputs)
            (e.ctrlKey && e.key === 'a' && !e.target.matches('input, textarea')) // Select all (outside inputs)
          ];
          
          if (dangerousKeys.some(condition => condition)) {
            handleSecurityViolation('keyboard-shortcut')(e);
          }
        });
        
        // Monitor for developer tools (less aggressive)
        let devToolsOpen = false;
        setInterval(() => {
          const threshold = 160;
          const widthDiff = window.outerWidth - window.innerWidth;
          const heightDiff = window.outerHeight - window.innerHeight;
          
          if (widthDiff > threshold || heightDiff > threshold) {
            if (!devToolsOpen) {
              devToolsOpen = true;
              handleSecurityViolation('devtools-detected')();
            }
          } else {
            devToolsOpen = false;
          }
        }, 2000); // Check less frequently
      }
      
      // Smart security violation handler
      function handleSecurityViolation(type) {
        return function(e) {
          if (e && e.preventDefault) e.preventDefault();
          
          securityAttempts++;
          securityViolationTypes.push(type);
          
          // Different responses based on attempt count
          if (securityAttempts === 1) {
            showSecurityWarning('first');
          } else if (securityAttempts === 2) {
            showSecurityWarning('second');
          } else if (securityAttempts >= 3) {
            showSecurityWarning('final');
          }
          
          return false;
        };
      }
      
      // Show smart security warning
      function showSecurityWarning(level) {
        if (isSecurityModalOpen) return;
        
        const modal = document.getElementById('securityModal');
        const icon = document.getElementById('securityIcon');
        const title = document.getElementById('securityTitle');
        const text = document.getElementById('securityText');
        const counter = document.getElementById('attemptCounter');
        const countSpan = document.getElementById('attemptCount');
        
        isSecurityModalOpen = true;
        countSpan.textContent = securityAttempts;
        
        if (level === 'first') {
          icon.textContent = '👀';
          title.textContent = 'Admin Security Notice';
          text.innerHTML = `
            <p>We noticed you tried to access developer tools on the Admin Dashboard.</p>
            <p><strong>If this was accidental:</strong> No problem! Just click "I Understand" to continue.</p>
            <p><strong>Admin Note:</strong> As an administrator, you have access to debug tools through the interface. Use the Debug button for system diagnostics.</p>
          `;
          counter.style.background = 'rgba(33, 150, 243, 0.2)';
          counter.style.borderColor = 'rgba(33, 150, 243, 0.5)';
          counter.style.color = '#2196F3';
        } else if (level === 'second') {
          icon.textContent = '⚠️';
          title.textContent = 'Admin Security Warning';
          text.innerHTML = `
            <p><strong>Second attempt detected on Admin Dashboard.</strong></p>
            <p>As an admin, please note:</p>
            <ul style="text-align: left; margin: 10px 0;">
              <li>The dashboard provides safe debugging tools</li>
              <li>Direct browser tools may interfere with admin functions</li>
              <li>All admin activities are logged for security</li>
              <li>Use the built-in Debug feature for system analysis</li>
            </ul>
            <p>One more attempt will implement additional security measures.</p>
          `;
          counter.style.background = 'rgba(255, 193, 7, 0.2)';
          counter.style.borderColor = 'rgba(255, 193, 7, 0.5)';
          counter.style.color = '#ffc107';
        } else {
          icon.textContent = '🚫';
          title.textContent = 'Admin Security Lock';
          text.innerHTML = `
            <p><strong>Maximum attempts exceeded on Admin Dashboard.</strong></p>
            <p>For enhanced security of the admin panel:</p>
            <ul style="text-align: left; margin: 10px 0;">
              <li>Additional monitoring has been activated</li>
              <li>Use the "Reset Page" button to continue normally</li>
              <li>Utilize built-in admin tools for system management</li>
              <li>Contact system developer if browser tools are needed</li>
            </ul>
            <p><strong>Remember:</strong> You have full admin access through the interface.</p>
          `;
          counter.style.background = 'rgba(244, 67, 54, 0.2)';
          counter.style.borderColor = 'rgba(244, 67, 54, 0.5)';
          counter.style.color = '#f44336';
          
          // After final warning, implement restrictions
          setTimeout(() => {
            if (securityAttempts >= 3) {
              implementSecurityRestrictions();
            }
          }, 5000);
        }
        
        modal.classList.add('show');
      }
      
      // Implement security restrictions after 3 attempts
      function implementSecurityRestrictions() {
        document.body.style.filter = 'blur(3px)';
        
        const restrictionOverlay = document.createElement('div');
        restrictionOverlay.innerHTML = `
          <div style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            text-align: center;
            padding: 20px;
          ">
            <div style="font-size: 4rem; margin-bottom: 20px;">👑</div>
            <h2 style="color: #FFD700; margin-bottom: 15px;">Admin Security Mode</h2>
            <p style="margin-bottom: 20px; max-width: 500px; line-height: 1.5;">
              Enhanced security monitoring active. As an admin, please use the built-in dashboard tools for system management and debugging.
            </p>
            <p style="margin-bottom: 30px; font-size: 18px; color: #ffc107;">
              Master Admin Dashboard by <strong>Fahad - 17877</strong>
            </p>
            <button onclick="window.location.reload()" style="
              padding: 12px 24px;
              background: #FFD700;
              color: #003366;
              border: none;
              border-radius: 8px;
              cursor: pointer;
              font-size: 16px;
              font-weight: bold;
              transition: all 0.3s ease;
            " onmouseover="this.style.background='#FFA500'" onmouseout="this.style.background='#FFD700'">
              🔄 Reset Dashboard
            </button>
          </div>
        `;
        document.body.appendChild(restrictionOverlay);
      }
      
      // Modal action handlers
      window.acknowledgeWarning = function() {
        document.getElementById('securityModal').classList.remove('show');
        isSecurityModalOpen = false;
        
        if (securityAttempts >= 3) {
          showMessage('⚠️ Enhanced security monitoring active. Please use built-in admin tools.', 'warning');
        } else {
          showMessage('✅ Thank you. Continue using the admin dashboard normally.', 'success');
        }
      };
      
      window.resetPage = function() {
        window.location.reload();
      };
      
      window.learnMore = function() {
        showMessage(`
          🔒 <strong>Admin Dashboard Security:</strong><br>
          • This dashboard manages sensitive KNPC user data and system settings<br>
          • Built-in debug tools provide safe system diagnostics<br>
          • Browser developer tools may interfere with dashboard functions<br>
          • All admin activities are monitored and logged for compliance<br>
          • Use dashboard features: Debug, Export, User Management<br>
          • For advanced development needs, contact Fahad - 17877
        `, 'info');
        document.getElementById('securityModal').classList.remove('show');
        isSecurityModalOpen = false;
      };
      
      // Initialize security system
      initSmartSecurity();
      
      // Console messages for admins
      console.log('%c🔒 TANK TOOLS ADMIN DASHBOARD', 'color: gold; font-size: 20px; font-weight: bold;');
      console.log('%cSmart Security System Active', 'color: orange; font-size: 14px;');
      console.log('%cDeveloper: Fahad - 17877 | KNPC Admin Panel', 'color: green; font-size: 12px;');
      console.log('%cUse built-in Debug tools for system diagnostics.', 'color: blue; font-size: 12px;');
    })();

let currentUser = null;
let currentEditingUser = null;

window.addEventListener('load', () => {
  checkAdminAccess();
  loadUserData();
  updateCurrentTime();
  loadStatistics();
  loadUsers();
  setInterval(updateCurrentTime, 60000);
  setInterval(refreshData, 120000);
  document.getElementById('userSearch').addEventListener('input', filterUsers);
  document.getElementById('statusFilter').addEventListener('change', filterUsers);
  document.getElementById('roleFilter').addEventListener('change', filterUsers);
});

function checkAdminAccess() {
  const session = sessionStorage.getItem('tanktools_session');
  const userData = localStorage.getItem('tanktools_current_user');
  if (session !== 'active' || !userData) {
    window.location.href = 'login.html';
    return;
  }
  try {
    currentUser = JSON.parse(userData);
    if (currentUser.username !== 'fam030' && currentUser.role !== 'admin') {
      window.location.href = 'index.html';
      return;
    }
    logActivity('admin_dashboard_access', currentUser.username);
  } catch (error) {
    window.location.href = 'login.html';
  }
}

function loadUserData() {
  if (!currentUser) return;
  document.getElementById('userName').textContent = currentUser.fullName || currentUser.username;
  document.getElementById('userEmail').textContent = currentUser.email;
  const firstLetter = (currentUser.fullName || currentUser.username).charAt(0).toUpperCase();
  document.getElementById('userAvatar').textContent = firstLetter;
}

function updateCurrentTime() {
  const now = new Date();
  const timeString = now.toLocaleString('en-US', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
  });
  document.getElementById('currentTime').textContent = timeString;
}

function loadStatistics() {
  const users = JSON.parse(localStorage.getItem('tanktools_users') || '[]');
  const activities = JSON.parse(localStorage.getItem('tanktools_activities') || '[]');
  const resetRequests = JSON.parse(localStorage.getItem('tanktools_reset_requests') || '[]');
  const pendingActivations = JSON.parse(localStorage.getItem('tanktools_pending_activations') || '[]');
  
  const totalUsers = users.length;
  const activeUsers = users.filter(u => u.isActive).length;
  const pendingUsers = users.filter(u => !u.emailVerified || !u.isActive).length;
  const today = new Date().toDateString();
  const todayLogins = activities.filter(a => a.action === 'user_login' && new Date(a.timestamp).toDateString() === today).length;
  const pendingResets = resetRequests.filter(r => r.status === 'pending').length;
  const pendingActivationsCount = pendingActivations.length;
  
  document.getElementById('totalUsers').textContent = totalUsers;
  document.getElementById('activeUsers').textContent = activeUsers;
  document.getElementById('pendingUsers').textContent = pendingUsers;
  document.getElementById('todayLogins').textContent = todayLogins;
  document.getElementById('resetRequests').textContent = pendingResets;
  document.getElementById('pendingActivations').textContent = pendingActivationsCount;
}

function loadUsers() {
  const users = JSON.parse(localStorage.getItem('tanktools_users') || '[]');
  displayUsers(users);
}

function displayUsers(users) {
  const tbody = document.getElementById('usersTableBody');
  tbody.innerHTML = '';
  users.forEach(user => {
    const row = document.createElement('tr');
    const roleClass = user.username === 'fam030' || user.role === 'admin' ? 'badge-admin' : 'badge-user';
    const statusClass = user.isActive ? 'badge-active' : 'badge-inactive';
    const verifiedClass = user.emailVerified ? 'badge-verified' : 'badge-pending';
    const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Never';
    const avatarLetter = (user.fullName || user.username).charAt(0).toUpperCase();
    const avatarColor = user.username === 'fam030' ? '#FFD700' : '#4CAF50';
    row.innerHTML = `
      <td><div style="width:30px;height:30px;border-radius:50%;background:${avatarColor};display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:14px;">${avatarLetter}</div></td>
      <td>${user.fullName || user.username}</td>
      <td>${user.username}</td>
      <td>${user.email}</td>
      <td><span class="user-badge ${roleClass}">${user.username === 'fam030' || user.role === 'admin' ? 'Admin' : 'User'}</span></td>
      <td><span class="user-badge ${statusClass}">${user.isActive ? 'Active' : 'Inactive'}</span></td>
      <td><span class="user-badge ${verifiedClass}">${user.emailVerified ? 'Verified' : 'Pending'}</span></td>
      <td>${lastLogin}</td>
      <td>
        <div class="action-buttons">
          ${user.username !== 'fam030' ? `
            <button class="action-btn btn-primary" onclick="editUser('${user.username}')" title="Edit">✏️</button>
            <button class="action-btn ${user.isActive ? 'btn-warning' : 'btn-primary'}" onclick="toggleUserStatus('${user.username}')" title="${user.isActive ? 'Deactivate' : 'Activate'}">
              ${user.isActive ? '❌' : '✅'}
            </button>
            <button class="action-btn btn-secondary" onclick="resetUserPassword('${user.username}')" title="Reset Password">🔑</button>
            <button class="action-btn btn-danger" onclick="deleteUser('${user.username}')" title="Delete">🗑️</button>
          ` : '<span style="color: #FFD700; font-weight: bold;">MASTER</span>'}
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function filterUsers() {
  const searchTerm = document.getElementById('userSearch').value.toLowerCase();
  const statusFilter = document.getElementById('statusFilter').value;
  const roleFilter = document.getElementById('roleFilter').value;
  const users = JSON.parse(localStorage.getItem('tanktools_users') || '[]');
  const filteredUsers = users.filter(user => {
    const matchesSearch = (user.fullName || '').toLowerCase().includes(searchTerm) || user.username.toLowerCase().includes(searchTerm) || user.email.toLowerCase().includes(searchTerm);
    const matchesStatus = statusFilter === 'all' || (statusFilter === 'active' && user.isActive) || (statusFilter === 'inactive' && !user.isActive) || (statusFilter === 'verified' && user.emailVerified) || (statusFilter === 'pending' && !user.emailVerified);
    const matchesRole = roleFilter === 'all' || (roleFilter === 'admin' && (user.role === 'admin' || user.username === 'fam030')) || (roleFilter === 'user' && user.role !== 'admin' && user.username !== 'fam030');
    return matchesSearch && matchesStatus && matchesRole;
  });
  displayUsers(filteredUsers);
}

function editUser(username) {
  const users = JSON.parse(localStorage.getItem('tanktools_users') || '[]');
  const user = users.find(u => u.username === username);
  if (!user) return;
  currentEditingUser = user;
  document.getElementById('modalTitle').textContent = 'Edit User: ' + user.username;
  document.getElementById('editFullName').value = user.fullName || '';
  document.getElementById('editUsername').value = user.username;
  document.getElementById('editEmail').value = user.email;
  document.getElementById('editRole').value = user.role || 'user';
  document.getElementById('editStatus').value = user.isActive ? 'true' : 'false';
  document.getElementById('editEmailVerified').value = user.emailVerified ? 'true' : 'false';
  document.getElementById('editPassword').value = '';
  document.getElementById('userModal').classList.add('show');
}

function closeModal() {
  document.getElementById('userModal').classList.remove('show');
  currentEditingUser = null;
}

document.getElementById('userForm').addEventListener('submit', function(e) {
  e.preventDefault();
  if (!currentEditingUser) return;
  const users = JSON.parse(localStorage.getItem('tanktools_users') || '[]');
  const userIndex = users.findIndex(u => u.username === currentEditingUser.username);
  if (userIndex === -1) return;
  users[userIndex].fullName = document.getElementById('editFullName').value;
  users[userIndex].role = document.getElementById('editRole').value;
  users[userIndex].isActive = document.getElementById('editStatus').value === 'true';
  users[userIndex].emailVerified = document.getElementById('editEmailVerified').value === 'true';
  const newPassword = document.getElementById('editPassword').value;
  if (newPassword) {
    users[userIndex].password = btoa(newPassword);
  }
  localStorage.setItem('tanktools_users', JSON.stringify(users));
  logActivity('user_edited', currentUser.username);
  showMessage('User updated successfully!', 'success');
  closeModal();
  loadUsers();
  loadStatistics();
});

function toggleUserStatus(username) {
  const users = JSON.parse(localStorage.getItem('tanktools_users') || '[]');
  const user = users.find(u => u.username === username);
  if (user && user.username !== 'fam030') {
    user.isActive = !user.isActive;
    localStorage.setItem('tanktools_users', JSON.stringify(users));
    logActivity(user.isActive ? 'user_activated' : 'user_deactivated', currentUser.username);
    showMessage(`User ${user.isActive ? 'activated' : 'deactivated'} successfully!`, 'success');
    loadUsers();
    loadStatistics();
  }
}

function resetUserPassword(username) {
  if (confirm(`Reset password for user: ${username}?`)) {
    const users = JSON.parse(localStorage.getItem('tanktools_users') || '[]');
    const user = users.find(u => u.username === username);
    if (user) {
      const newPassword = generateRandomPassword();
      user.password = btoa(newPassword);
      localStorage.setItem('tanktools_users', JSON.stringify(users));
      logActivity('password_reset', currentUser.username);
      showMessage(`Password reset! New password: ${newPassword}`, 'success');
    }
  }
}

function deleteUser(username) {
  if (confirm(`Delete user: ${username}? This action cannot be undone!`)) {
    const users = JSON.parse(localStorage.getItem('tanktools_users') || '[]');
    const filteredUsers = users.filter(u => u.username !== username);
    localStorage.setItem('tanktools_users', JSON.stringify(filteredUsers));
    logActivity('user_deleted', currentUser.username);
    showMessage('User deleted successfully!', 'success');
    loadUsers();
    loadStatistics();
  }
}

function addNewUser() {
  const username = prompt('Enter new username (3 letters + 3 numbers):');
  if (!username || !/^[a-zA-Z]{3}[0-9]{3}$/.test(username)) {
    showMessage('Invalid username format!', 'error');
    return;
  }
  const users = JSON.parse(localStorage.getItem('tanktools_users') || '[]');
  if (users.find(u => u.username === username)) {
    showMessage('Username already exists!', 'error');
    return;
  }
  const fullName = prompt('Enter full name:');
  if (!fullName) {
    showMessage('Full name is required!', 'error');
    return;
  }
  const password = prompt('Enter password:');
  if (!password || password.length < 8) {
    showMessage('Password must be at least 8 characters!', 'error');
    return;
  }
  const newUser = {
    id: Date.now(),
    fullName,
    username,
    email: `${username}@knpc.com`,
    password: btoa(password),
    createdAt: new Date().toISOString(),
    isActive: true,
    emailVerified: true,
    lastLogin: null,
    role: 'user'
  };
  users.push(newUser);
  localStorage.setItem('tanktools_users', JSON.stringify(users));
  logActivity('user_created_by_admin', currentUser.username);
  showMessage(`User ${username} created successfully!`, 'success');
  loadUsers();
  loadStatistics();
}

function exportUsers() {
  const users = JSON.parse(localStorage.getItem('tanktools_users') || '[]');
  const exportData = users.map(user => ({
    fullName: user.fullName,
    username: user.username,
    email: user.email,
    role: user.role || 'user',
    isActive: user.isActive,
    emailVerified: user.emailVerified,
    createdAt: user.createdAt,
    lastLogin: user.lastLogin
  }));
  const dataStr = JSON.stringify(exportData, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(dataBlob);
  link.download = 'tanktools_users_' + new Date().toISOString().split('T')[0] + '.json';
  link.click();
  logActivity('users_exported', currentUser.username);
  showMessage('Users data exported successfully!', 'success');
}

function showPendingActivations() {
  const pendingActivations = JSON.parse(localStorage.getItem('tanktools_pending_activations') || '[]');
  const content = document.getElementById('pendingActivationsContent');
  
  if (pendingActivations.length === 0) {
    content.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No pending activations found.</p>';
  } else {
    let html = '<div style="max-height: 400px; overflow-y: auto;">';
    pendingActivations.forEach((pending, index) => {
      html += `
        <div style="background: #f5f5f5; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #ff9800;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <strong>${pending.fullName} (${pending.username})</strong>
            <button class="btn btn-primary" onclick="activatePendingUser('${pending.username}')" style="padding: 4px 8px; font-size: 12px;">✅ Activate</button>
          </div>
          <div style="font-size: 12px; color: #666;">
            <div>Email: ${pending.email}</div>
            <div>Request Time: ${new Date(pending.requestTime).toLocaleString()}</div>
            <div>Reason: ${pending.reason === 'email_service_failed' ? 'Email service failed' : pending.reason}</div>
          </div>
        </div>
      `;
    });
    html += '</div>';
    content.innerHTML = html;
  }
  
  document.getElementById('pendingActivationsModal').classList.add('show');
}

function closePendingModal() {
  document.getElementById('pendingActivationsModal').classList.remove('show');
}

function activatePendingUser(username) {
  const users = JSON.parse(localStorage.getItem('tanktools_users') || '[]');
  const user = users.find(u => u.username === username);
  
  if (user) {
    user.isActive = true;
    user.emailVerified = true;
    localStorage.setItem('tanktools_users', JSON.stringify(users));
    
    // Remove from pending list
    const pendingActivations = JSON.parse(localStorage.getItem('tanktools_pending_activations') || '[]');
    const filteredPending = pendingActivations.filter(p => p.username !== username);
    localStorage.setItem('tanktools_pending_activations', JSON.stringify(filteredPending));
    
    logActivity('user_activated_by_admin', currentUser.username);
    showMessage(`User ${username} activated successfully!`, 'success');
    
    // Refresh displays
    loadUsers();
    loadStatistics();
    showPendingActivations(); // Refresh modal content
  } else {
    showMessage('User not found!', 'error');
  }
}

function activateAllPending() {
  if (confirm('Activate all pending users?')) {
    const pendingActivations = JSON.parse(localStorage.getItem('tanktools_pending_activations') || '[]');
    const users = JSON.parse(localStorage.getItem('tanktools_users') || '[]');
    
    let activatedCount = 0;
    pendingActivations.forEach(pending => {
      const user = users.find(u => u.username === pending.username);
      if (user) {
        user.isActive = true;
        user.emailVerified = true;
        activatedCount++;
      }
    });
    
    if (activatedCount > 0) {
      localStorage.setItem('tanktools_users', JSON.stringify(users));
      localStorage.setItem('tanktools_pending_activations', '[]'); // Clear list
      
      logActivity('bulk_activation_by_admin', currentUser.username);
      showMessage(`${activatedCount} users activated successfully!`, 'success');
      
      // Refresh displays
      loadUsers();
      loadStatistics();
      closePendingModal();
    } else {
      showMessage('No users to activate!', 'warning');
    }
  }
}

function clearPendingList() {
  if (confirm('Clear the pending activations list? This will not affect user accounts.')) {
    localStorage.setItem('tanktools_pending_activations', '[]');
    showMessage('Pending activations list cleared!', 'success');
    loadStatistics();
    closePendingModal();
  }
}

function showDebugInfo() {
  const debugContent = document.getElementById('debugContent');
  let debugInfo = "TANK TOOLS SYSTEM DEBUG INFORMATION\n";
  debugInfo += "=====================================\n\n";
  debugInfo += "📊 CURRENT STATUS:\n";
  debugInfo += `Current User: ${currentUser ? currentUser.username : 'None'}\n`;
  debugInfo += `Session Active: ${sessionStorage.getItem('tanktools_session')}\n`;
  debugInfo += `Timestamp: ${new Date().toISOString()}\n\n`;
  debugInfo += "🗄️ LOCALSTORAGE KEYS:\n";
  const allKeys = Object.keys(localStorage);
  allKeys.forEach(key => { debugInfo += `- ${key}\n`; });
  debugInfo += `Total keys: ${allKeys.length}\n\n`;
  debugInfo += "👥 USER DATA ANALYSIS:\n";
  const usersData = localStorage.getItem('tanktools_users');
  if (usersData) {
    try {
      const users = JSON.parse(usersData);
      debugInfo += `Users found: ${users.length}\n`;
      users.forEach((user, index) => {
        debugInfo += `${index + 1}. ${user.fullName || 'No name'} (${user.username}) - ${user.email}\n`;
        debugInfo += `   Role: ${user.role || 'user'}, Active: ${user.isActive}, Verified: ${user.emailVerified}\n`;
        debugInfo += `   Created: ${user.createdAt}, Last Login: ${user.lastLogin || 'Never'}\n`;
      });
    } catch (error) {
      debugInfo += `ERROR parsing users data: ${error.message}\n`;
      debugInfo += `Raw data length: ${usersData.length} characters\n`;
      debugInfo += `First 100 chars: ${usersData.substring(0, 100)}\n`;
    }
  } else {
    debugInfo += "❌ No tanktools_users data found!\n";
  }
  
  debugInfo += "\n🕐 PENDING ACTIVATIONS:\n";
  const pendingActivations = JSON.parse(localStorage.getItem('tanktools_pending_activations') || '[]');
  if (pendingActivations.length > 0) {
    pendingActivations.forEach((pending, index) => {
      debugInfo += `${index + 1}. ${pending.fullName} (${pending.username})\n`;
      debugInfo += `   Email: ${pending.email}, Time: ${pending.requestTime}\n`;
      debugInfo += `   Reason: ${pending.reason}\n`;
    });
  } else {
    debugInfo += "No pending activations.\n";
  }
  
  debugInfo += "\n🔍 SEARCHING FOR ALTERNATIVE USER STORAGE:\n";
  const possibleKeys = allKeys.filter(key => key.toLowerCase().includes('user') || key.toLowerCase().includes('tank') || key.toLowerCase().includes('login'));
  possibleKeys.forEach(key => {
    const data = localStorage.getItem(key);
    debugInfo += `- ${key}: ${data ? data.length + ' chars' : 'empty'}\n`;
    if (data && data.length < 500) {
      debugInfo += `  Content: ${data.substring(0, 100)}...\n`;
    }
  });
  debugInfo += "\n🎯 RECOMMENDATIONS:\n";
  if (!usersData) {
    debugInfo += "❌ Main issue: No user data found in expected location\n";
    debugInfo += "✅ Try: Use 'Fix User Data' button to create default admin user\n";
    debugInfo += "✅ Try: Use 'Migrate Data' to search and migrate\n";
  } else {
    const users = JSON.parse(usersData);
    if (users.length === 0) {
      debugInfo += "❌ Users array is empty\n";
      debugInfo += "✅ Try: Use 'Fix User Data' to create default admin user\n";
    } else {
      debugInfo += "✅ User data looks good! Check filters and search.\n";
    }
  }
  debugContent.textContent = debugInfo;
  document.getElementById('debugModal').classList.add('show');
}

function closeDebugModal() {
  document.getElementById('debugModal').classList.remove('show');
}

function fixUserData() {
  if (confirm('This will create/fix the user data structure. Continue?')) {
    let users = [];
    try {
      const existingUsers = localStorage.getItem('tanktools_users');
      if (existingUsers) { users = JSON.parse(existingUsers); }
    } catch (error) { console.log('Error parsing existing users, starting fresh'); }
    let fam030User = users.find(u => u.username === 'fam030');
    if (!fam030User) {
      fam030User = {
        id: Date.now(),
        fullName: 'Fahad - Master Admin',
        username: 'fam030',
        email: 'fam030@knpc.com',
        password: btoa('admin123'),
        createdAt: new Date().toISOString(),
        isActive: true,
        emailVerified: true,
        lastLogin: new Date().toISOString(),
        role: 'admin'
      };
      users.push(fam030User);
    } else {
      fam030User.role = 'admin';
      fam030User.isActive = true;
      fam030User.emailVerified = true;
      if (!fam030User.fullName) fam030User.fullName = 'Fahad - Master Admin';
    }
    localStorage.setItem('tanktools_users', JSON.stringify(users));
    if (!localStorage.getItem('tanktools_activities')) {
      localStorage.setItem('tanktools_activities', JSON.stringify([{
        id: Date.now(),
        action: 'system_initialized',
        username: 'fam030',
        timestamp: new Date().toISOString(),
        ip: 'local',
        userAgent: navigator.userAgent.substring(0, 100)
      }]));
    }
    if (!localStorage.getItem('tanktools_reset_requests')) {
      localStorage.setItem('tanktools_reset_requests', '[]');
    }
    if (!localStorage.getItem('tanktools_pending_activations')) {
      localStorage.setItem('tanktools_pending_activations', '[]');
    }
    showMessage('User data fixed successfully! fam030 admin user created/updated.', 'success');
    closeDebugModal();
    refreshData();
  }
}

function migrateData() {
  if (confirm('This will search for user data in alternative storage locations and migrate it. Continue?')) {
    let migratedCount = 0;
    let users = [];
    try {
      const existingUsers = localStorage.getItem('tanktools_users');
      if (existingUsers) { users = JSON.parse(existingUsers); }
    } catch (error) { console.log('No existing users found'); }
    const allKeys = Object.keys(localStorage);
    allKeys.forEach(key => {
      if (key.includes('user') && key !== 'tanktools_users') {
        try {
          const data = localStorage.getItem(key);
          const parsedData = JSON.parse(data);
          if (Array.isArray(parsedData)) {
            parsedData.forEach(item => {
              if (item.username && item.email && !users.find(u => u.username === item.username)) {
                const migratedUser = {
                  id: item.id || Date.now() + migratedCount,
                  fullName: item.fullName || item.name || item.username,
                  username: item.username,
                  email: item.email,
                  password: item.password || btoa('password123'),
                  createdAt: item.createdAt || new Date().toISOString(),
                  isActive: item.isActive !== undefined ? item.isActive : true,
                  emailVerified: item.emailVerified !== undefined ? item.emailVerified : true,
                  lastLogin: item.lastLogin || null,
                  role: item.role || 'user'
                };
                users.push(migratedUser);
                migratedCount++;
              }
            });
          } else if (parsedData.username && parsedData.email) {
            if (!users.find(u => u.username === parsedData.username)) {
              const migratedUser = {
                id: parsedData.id || Date.now(),
                fullName: parsedData.fullName || parsedData.name || parsedData.username,
                username: parsedData.username,
                email: parsedData.email,
                password: parsedData.password || btoa('password123'),
                createdAt: parsedData.createdAt || new Date().toISOString(),
                isActive: parsedData.isActive !== undefined ? parsedData.isActive : true,
                emailVerified: parsedData.emailVerified !== undefined ? parsedData.emailVerified : true,
                lastLogin: parsedData.lastLogin || null,
                role: parsedData.role || 'user'
              };
              users.push(migratedUser);
              migratedCount++;
            }
          }
        } catch (error) { console.log(`Could not parse data from key: ${key}`); }
      }
    });
    if (migratedCount > 0) {
      localStorage.setItem('tanktools_users', JSON.stringify(users));
      showMessage(`Migration completed! ${migratedCount} users migrated successfully.`, 'success');
    } else {
      showMessage('No additional user data found to migrate.', 'info');
    }
    closeDebugModal();
    refreshData();
  }
}

function clearAllData() {
  if (confirm('⚠️ WARNING: This will delete ALL Tank Tools data. This cannot be undone! Are you sure?')) {
    if (prompt('Type "DELETE ALL" to confirm:') === 'DELETE ALL') {
      const allKeys = Object.keys(localStorage);
      allKeys.forEach(key => {
        if (key.startsWith('tanktools_') || key.includes('tanktools') || key === 'pbcrData' || key === 'plcrData' || key === 'nmogasData' || key === 'darkMode') {
          localStorage.removeItem(key);
        }
      });
      sessionStorage.clear();
      showMessage('All data cleared! Redirecting to login...', 'error');
      setTimeout(() => { window.location.href = 'login.html'; }, 2000);
    }
  }
}

function generateRandomPassword() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
  let result = '';
  for (let i = 0; i < 12; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

function showMessage(message, type) {
  const container = document.getElementById('messageContainer');
  container.innerHTML = `<div class="message ${type}">${message}</div>`;
  setTimeout(() => { container.querySelector('.message').classList.add('show'); }, 100);
  setTimeout(() => { container.innerHTML = ''; }, 5000);
}

function refreshUsers() {
  loadUsers();
  loadStatistics();
  showMessage('Data refreshed successfully!', 'success');
}

function refreshData() {
  loadStatistics();
  loadUsers();
  updateCurrentTime();
}

function logActivity(action, username) {
  const activities = JSON.parse(localStorage.getItem('tanktools_activities') || '[]');
  activities.unshift({
    id: Date.now(),
    action,
    username,
    timestamp: new Date().toISOString(),
    ip: 'local',
    userAgent: navigator.userAgent.substring(0, 100)
  });
  activities.splice(100);
  localStorage.setItem('tanktools_activities', JSON.stringify(activities));
}

function logout() {
  logActivity('user_logout', currentUser.username);
  sessionStorage.removeItem('tanktools_session');
  localStorage.removeItem('tanktools_current_user');
  window.location.href = 'login.html';
}

console.log('%c🔒 TANK TOOLS - SMART ADMIN DASHBOARD', 'color: red; font-size: 20px; font-weight: bold;');
console.log('%cDeveloper: Fahad - 17877', 'color: green; font-size: 16px;');
console.log('%cSmart Security System with Enhanced User Experience', 'color: blue; font-size: 14px;');

  </script>
</body>
</html>