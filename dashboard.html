<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tank Tools - Firebase Admin Dashboard</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="icon.png" type="image/png">
  <meta name="theme-color" content="#003366">
  <script src="permissions.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;font-family:Arial,sans-serif;min-height:100vh;color:white}
    .header{background:rgba(0,51,102,0.9);padding:15px 20px;display:flex;justify-content:space-between;align-items:center;backdrop-filter:blur(10px);box-shadow:0 2px 10px rgba(0,0,0,0.3)}
    .logo{font-size:1.8rem;font-weight:bold;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .user-info{display:flex;align-items:center;gap:15px}
    .user-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(45deg,#FFD700,#FFA500);display:flex;align-items:center;justify-content:center;font-weight:bold;color:#003366}
    .nav-links{display:flex;gap:10px}
    .nav-btn,.logout-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:white;padding:8px 15px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;text-decoration:none;font-size:14px}
    .nav-btn:hover{background:rgba(255,255,255,0.2);transform:translateY(-2px)}
    .logout-btn{background:rgba(255,0,0,0.2);border-color:rgba(255,0,0,0.5)}
    .logout-btn:hover{background:rgba(255,0,0,0.4)}
    .user-section{display:flex;flex-direction:column;gap:8px}
    .user-top{display:flex;align-items:center;gap:10px}
    .user-controls{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .font-controls{display:flex;gap:5px}
    .font-btn{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.3s ease;min-width:30px}
    .font-btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-1px)}
    .container{max-width:100%;margin:20px auto;padding:0 20px}
    .admin-banner{text-align:center;margin-bottom:30px;background:rgba(255,255,255,0.1);padding:20px;border-radius:15px;backdrop-filter:blur(10px)}
    .admin-badge{display:inline-block;background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366;padding:8px 20px;border-radius:25px;font-weight:bold;margin-bottom:15px;font-size:1.1rem}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:20px;text-align:center;border:1px solid rgba(255,255,255,0.2);transition:transform 0.3s ease}
    .stat-card:hover{transform:translateY(-5px)}
    .stat-number{font-size:2.2rem;font-weight:bold;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:5px}
    .stat-label{font-size:0.9rem;opacity:0.8}
    .section{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:25px;margin-bottom:25px;border:1px solid rgba(255,255,255,0.2)}
    .section-title{font-size:1.4rem;margin-bottom:20px;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:bold;border-bottom:2px solid rgba(255,215,0,0.3);padding-bottom:10px}
    .controls{display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
    .search-box{padding:12px 15px;border:none;border-radius:10px;background:rgba(255,255,255,0.9);color:#003366;font-size:14px;flex:1;min-width:250px}
    .filter-select{padding:12px 15px;border:none;border-radius:10px;background:rgba(255,255,255,0.9);color:#003366;font-size:14px}
    .btn{padding:12px 20px;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:all 0.3s ease;font-size:14px;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
    .btn-secondary{background:linear-gradient(45deg,#2196F3,#1976D2);color:white}
    .btn-warning{background:linear-gradient(45deg,#ff9800,#f57c00);color:white}
    .btn-danger{background:linear-gradient(45deg,#f44336,#d32f2f);color:white}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.3)}
    .users-table,.activities-table{width:100%;background:rgba(255,255,255,0.95);border-radius:15px;overflow:hidden;color:#003366;box-shadow:0 5px 15px rgba(0,0,0,0.2);border-collapse:collapse}
    .users-table th,.users-table td,.activities-table th,.activities-table td{padding:15px 12px;text-align:left;border-bottom:1px solid rgba(0,51,102,0.1)}
    .users-table th,.activities-table th{background:#003366;color:white;font-weight:bold;font-size:14px}
    .users-table tr:hover,.activities-table tr:hover{background:rgba(255,215,0,0.1)}
    .activities-table-container{width:100%;overflow-x:auto}
    .activities-table{min-width:620px}
    .status-badge{display:inline-block;padding:6px 12px;border-radius:20px;font-size:11px;font-weight:bold;text-transform:uppercase}
    .badge-active{background:#4CAF50;color:white}
    .badge-inactive{background:#f44336;color:white}
    .badge-pending{background:#ff9800;color:white}
    .badge-admin{background:#FFD700;color:#003366}
    .badge-user{background:#2196F3;color:white}
    .badge-panel-operator{background:#9C27B0;color:white}
    .badge-supervisor{background:#FF5722;color:white}
    .badge-section-head{background:#795548;color:white}
    .badge-operator{background:#607D8B;color:white}
    .badge-planning{background:#E91E63;color:white}
    .action-buttons{display:flex;gap:8px;flex-wrap:wrap}
    .action-btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:500;transition:all 0.3s ease}
    .action-btn:hover{transform:scale(1.05)}
    .loading{text-align:center;padding:40px;font-size:18px}
    .loading-spinner{display:inline-block;width:40px;height:40px;border:4px solid rgba(255,255,255,0.3);border-radius:50%;border-top:4px solid #FFD700;animation:spin 1s linear infinite;margin-bottom:10px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .message{padding:15px 20px;border-radius:10px;margin-bottom:20px;font-weight:500;border-left:5px solid}
    .message.success{background:rgba(76,175,80,0.2);border-color:#4CAF50;color:#4CAF50}
    .message.error{background:rgba(244,67,54,0.2);border-color:#f44336;color:#f44336}
    .message.info{background:rgba(33,150,243,0.2);border-color:#2196F3;color:#2196F3}
    .message.warning{background:rgba(255,193,7,0.2);border-color:#ffc107;color:#ffc107}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;backdrop-filter:blur(5px)}
    .modal.show{display:flex;justify-content:center;align-items:center}
    .modal-content{background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;max-width:600px;width:90%;color:#003366;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #ddd}
    .modal-title{font-size:1.3rem;font-weight:bold;color:#003366}
    .close-btn{background:none;border:none;font-size:28px;cursor:pointer;color:#666;font-weight:bold}
    .close-btn:hover{color:#f44336}
    .form-group{margin-bottom:20px}
    .form-label{display:block;margin-bottom:8px;font-weight:600;color:#003366}
    .form-input,.form-select{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px;transition:border-color 0.3s ease}
    .form-input:focus,.form-select:focus{outline:none;border-color:#4CAF50}
    .activities-container{max-height:400px;overflow-y:auto;background:rgba(255,255,255,0.95);border-radius:10px;padding:15px}
    .activity-item{padding:12px;border-bottom:1px solid rgba(0,51,102,0.1);display:flex;justify-content:space-between;align-items:center;color:#003366}
    .activity-item:last-child{border-bottom:none}
    .activity-info{flex:1}
    .activity-user{font-weight:bold;color:#003366}
    .activity-action{margin-top:4px;font-size:13px;color:#666}
    .activity-time{font-size:12px;color:#999;text-align:right}
    .pending-users-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:15px}
    .pending-card{background:rgba(255,193,7,0.1);border:2px solid rgba(255,193,7,0.3);border-radius:12px;padding:20px;transition:all 0.3s ease}
    .pending-card:hover{transform:translateY(-3px);box-shadow:0 5px 15px rgba(255,193,7,0.2)}
    .pending-header{display:flex;justify-content:between;align-items:center;margin-bottom:15px}
    .pending-name{font-size:1.1rem;font-weight:bold;color:#f57c00}
    .pending-details{margin-bottom:15px;line-height:1.6}
    .pending-actions{display:flex;gap:10px}
    .switch{position:relative;display:inline-block;width:60px;height:34px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px}
    .slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%}
    input:checked + .slider{background-color:#4CAF50}
    input:focus + .slider{box-shadow:0 0 1px #4CAF50}
    input:checked + .slider:before{transform:translateX(26px)}
    .role-settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
    .role-setting{background:rgba(255,255,255,0.1);padding:20px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.2)}
    .role-info{flex:1}
    .role-name{font-weight:bold;font-size:1.1rem;margin-bottom:5px}
    .role-desc{font-size:0.9rem;opacity:0.8}
    .role-control{margin-left:15px}
    @media(max-width:768px){.header{flex-direction:column;gap:15px}.controls{flex-direction:column}.stats-grid{grid-template-columns:repeat(2,1fr)}.users-table{font-size:12px}.users-table th,.users-table td{padding:8px 6px}.action-buttons{flex-direction:column}.nav-links{flex-direction:column;width:100%}.role-settings-grid{grid-template-columns:1fr}}
    /* Force activities table to stay full width on all screen sizes */
    .activities-table-container{overflow-x:auto !important;width:100% !important}
    .activities-table{min-width:800px !important;width:100% !important}
    .activities-table th,.activities-table td{padding:15px 20px !important;white-space:nowrap !important}
    .activities-table th{font-size:14px !important}
    .activities-table td{font-size:13px !important}
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">üî• Firebase Admin Dashboard</div>
    <div class="user-info">
      <div class="nav-links">
        <a href="index.html" class="nav-btn">üìä PBCR</a>
        <a href="plcr.html" class="nav-btn">‚öóÔ∏è PLCR</a>
        <a href="NMOGASBL.html" class="nav-btn">üîß NMOGAS</a>
        <a href="live-tanks.html" class="nav-btn">üî¥ Live Tanks</a>
        <a href="user-management.html" class="nav-btn" id="user-management-link" style="display:none">üë• User Management</a>
      </div>
      <div class="user-section">
        <div class="user-top">
          <div class="user-avatar" id="userAvatar">F</div>
          <div>
            <div id="userName" style="font-weight:bold">Loading...</div>
            <div id="userEmail" style="font-size:0.8rem;opacity:0.7">Loading...</div>
          </div>
        </div>
        <div class="user-controls">
          <div class="font-controls">
            <button class="font-btn" onclick="decreaseFontSize()" title="ÿ™ÿµÿ∫Ÿäÿ± ÿßŸÑÿÆÿ∑">-</button>
            <button class="font-btn" onclick="increaseFontSize()" title="ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑÿÆÿ∑">+</button>
          </div>
          <button class="logout-btn" onclick="logout()">üö™ Logout</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="admin-banner">
      <div class="admin-badge">üî• FIREBASE ADMIN CONTROL</div>
      <h2>üéõÔ∏è Master User Management System</h2>
      <p>Real-time Firebase database with advanced user controls</p>
      <p id="currentTime" style="margin-top:10px;opacity:0.8"></p>
    </div>

    <div id="messageContainer"></div>

    <!-- Statistics -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalUsers">-</div>
        <div class="stat-label">Total Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="activeUsers">-</div>
        <div class="stat-label">Active Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pendingUsers">-</div>
        <div class="stat-label">Pending Approval</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="usersWithLiveTanks">-</div>
        <div class="stat-label">Live Tanks Access</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalActivities">-</div>
        <div class="stat-label">Total Activities</div>
      </div>
    </div>

    <!-- Live Tanks Access Control -->
    <div class="section">
      <div class="section-title">üî¥ Live Tanks Access Control</div>
      
      <div class="role-settings-grid">
        <div class="role-setting">
          <div class="role-info">
            <div class="role-name">üëë Admin</div>
            <div class="role-desc">Full system access</div>
          </div>
          <div class="role-control">
            <span style="color: #4CAF50; font-weight: bold;">‚úÖ Always Active</span>
          </div>
        </div>
        
        <div class="role-setting">
          <div class="role-info">
            <div class="role-name">‚öôÔ∏è Panel Operator</div>
            <div class="role-desc">Can add/edit tanks</div>
          </div>
          <div class="role-control">
            <label class="switch">
              <input type="checkbox" checked id="role_panel_operator" onchange="updateRoleAccess()">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        
        <div class="role-setting">
          <div class="role-info">
            <div class="role-name">üë• Supervisor</div>
            <div class="role-desc">View only access</div>
          </div>
          <div class="role-control">
            <label class="switch">
              <input type="checkbox" checked id="role_supervisor" onchange="updateRoleAccess()">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        
        <div class="role-setting">
          <div class="role-info">
            <div class="role-name">üè¢ Section Head</div>
            <div class="role-desc">View only access</div>
          </div>
          <div class="role-control">
            <label class="switch">
              <input type="checkbox" id="role_section_head" onchange="updateRoleAccess()">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        
        <div class="role-setting">
          <div class="role-info">
            <div class="role-name">üîß Operator</div>
            <div class="role-desc">View only access</div>
          </div>
          <div class="role-control">
            <label class="switch">
              <input type="checkbox" checked id="role_operator" onchange="updateRoleAccess()">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        
        <div class="role-setting">
          <div class="role-info">
            <div class="role-name">üìã Planning</div>
            <div class="role-desc">View only access</div>
          </div>
          <div class="role-control">
            <label class="switch">
              <input type="checkbox" id="role_planning" onchange="updateRoleAccess()">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 20px; text-align: center;">
        <button class="btn btn-primary" onclick="saveGlobalSettings()">üíæ Save Global Settings</button>
        <button class="btn btn-secondary" onclick="resetToDefault()">üîÑ Reset to Default</button>
      </div>
    </div>

    <!-- User Management Section -->
    <div class="section">
      <div class="section-title">üë• Advanced User Management</div>
      
      <div class="controls">
        <input type="text" class="search-box" id="userSearch" placeholder="üîç Search users by name, username, or email...">
        <select class="filter-select" id="statusFilter">
          <option value="all">All Status</option>
          <option value="active">Active Only</option>
          <option value="inactive">Inactive Only</option>
          <option value="pending">Pending Approval</option>
        </select>
        <select class="filter-select" id="roleFilter">
          <option value="all">All Roles</option>
          <option value="admin">Admin</option>
          <option value="panel_operator">Panel Operator</option>
          <option value="supervisor">Supervisor</option>
          <option value="section_head">Section Head</option>
          <option value="operator">Operator</option>
          <option value="planning">Planning</option>
        </select>
        <button class="btn btn-primary" onclick="loadDashboardData()">üîÑ Refresh</button>
        <button class="btn btn-warning" onclick="showPendingUsers()">‚è≥ Pending</button>
      </div>

      <div id="usersContainer">
        <div class="loading">
          <div class="loading-spinner"></div>
          <div>Loading users from Firebase...</div>
        </div>
      </div>
    </div>

    <!-- Recent Activities -->
    <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 25px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.2); width: 100%; max-width: none;">
      <div class="section-title">üìã Recent Activities</div>
      <div class="activities-controls" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <input type="text" id="activitySearch" placeholder="üîç Search activities..." style="padding: 10px 15px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #003366; flex: 1; min-width: 250px;">
        <select id="activityFilter" style="padding: 10px 15px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); color: #003366;">
          <option value="">All Activities</option>
          <option value="login">Login</option>
          <option value="pbcr_calculation">PBCR Calculations</option>
          <option value="live_tanks">Live Tanks</option>
          <option value="admin">Admin Actions</option>
        </select>
        <button class="btn btn-secondary" onclick="refreshActivities()">üîÑ Refresh</button>
      </div>
      
      <div class="activities-table-container" style="width: 100%; background: rgba(255,255,255,0.95); border-radius: 15px; overflow-x: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
        <table class="activities-table" style="width: 100%; min-width: 800px; color: #003366; border-collapse: collapse;">
          <thead style="background: #003366; color: white;">
            <tr>
              <th style="padding: 15px 20px; text-align: left; font-weight: bold; width: 15%;">üë§ User</th>
              <th style="padding: 15px 20px; text-align: left; font-weight: bold; width: 35%;">üìù Activity</th>
              <th style="padding: 15px 20px; text-align: center; font-weight: bold; width: 15%;">üìÖ Date</th>
              <th style="padding: 15px 20px; text-align: center; font-weight: bold; width: 15%;">‚è∞ Time</th>
              <th style="padding: 15px 20px; text-align: center; font-weight: bold; width: 20%;">üåê Source</th>
            </tr>
          </thead>
          <tbody id="activitiesTableBody">
            <tr>
              <td colspan="5" style="padding: 30px; text-align: center; color: #666;">
                <div class="loading">
                  <div class="loading-spinner"></div>
                  <div>Loading activities...</div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="pagination-container" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
        <div class="pagination-info" style="color: rgba(255,255,255,0.8); font-size: 14px;">
          Showing <span id="activitiesStart">0</span> - <span id="activitiesEnd">0</span> of <span id="activitiesTotal">0</span> activities
        </div>
        <div class="pagination-controls" style="display: flex; gap: 10px; align-items: center;">
          <span style="color: rgba(255,255,255,0.8); font-size: 14px;">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
        </div>
      </div>
    </div>
  </div>

  <!-- User Edit Modal -->
  <div id="userModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Edit User</h3>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <form id="userForm">
        <div class="form-group">
          <label class="form-label">Full Name:</label>
          <input type="text" class="form-input" id="editFullName" required>
        </div>
        <div class="form-group">
          <label class="form-label">Username:</label>
          <input type="text" class="form-input" id="editUsername" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Email:</label>
          <input type="email" class="form-input" id="editEmail" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Role:</label>
          <select class="form-select" id="editRole">
            <option value="operator">Operator</option>
            <option value="panel_operator">Panel Operator</option>
            <option value="supervisor">Supervisor</option>
            <option value="section_head">Section Head</option>
            <option value="planning">Planning</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Status:</label>
          <select class="form-select" id="editStatus">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Live Tanks Access:</label>
          <label class="switch">
            <input type="checkbox" id="editLiveTanksAccess">
            <span class="slider"></span>
          </label>
        </div>
        <div class="form-group">
          <label class="form-label">New Password (Optional):</label>
          <input type="password" class="form-input" id="editPassword" placeholder="Leave empty to keep current">
        </div>
        <div style="display:flex;gap:15px;justify-content:flex-end;margin-top:25px">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Pending Users Modal -->
  <div id="pendingModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">‚è≥ Pending User Approvals</h3>
        <button class="close-btn" onclick="closePendingModal()">&times;</button>
      </div>
      <div id="pendingUsersContainer">
        <div class="loading">
          <div class="loading-spinner"></div>
          <div>Loading pending users...</div>
        </div>
      </div>
      <div style="margin-top:20px;text-align:center">
        <button class="btn btn-primary" onclick="approveAllPending()">‚úÖ Approve All</button>
        <button class="btn btn-secondary" onclick="closePendingModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs, addDoc, serverTimestamp, query, orderBy, limit, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Make Firebase functions globally available
    window.db = db;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.collection = collection;
    window.getDocs = getDocs;
    window.addDoc = addDoc;
    window.serverTimestamp = serverTimestamp;
    window.query = query;
    window.orderBy = orderBy;
    window.limit = limit;
    window.where = where;

    console.log('üî• Firebase Dashboard initialized successfully!');
  </script>

  <script>
    let currentUser = null;
    let currentEditingUser = null;
    let allUsers = [];
    let allActivities = [];
    let globalLiveTanksSettings = null;

    // Check admin access
    function checkAdminAccess() {
      console.log('Checking admin access...');
      
      const session = sessionStorage.getItem('tanktools_session');
      const userData = localStorage.getItem('tanktools_current_user');
      
      console.log('Session:', session);
      console.log('User data exists:', !!userData);
      
      if (session !== 'active' || !userData) {
        console.log('No active session or user data');
        showMessage('‚ùå No active session. Redirecting to login...', 'error');
        setTimeout(() => window.location.href = 'login.html', 3000);
        return false;
      }
      
      try {
        currentUser = JSON.parse(userData);
        console.log('Current user:', currentUser);
        
        // More flexible admin check - allow fam030 or admin role
        if (currentUser.username === 'fam030' || currentUser.role === 'admin') {
          console.log('Admin access granted');
          
          // Update UI with admin info
          document.getElementById('userName').textContent = currentUser.fullName || currentUser.username;
          document.getElementById('userEmail').textContent = currentUser.email || `${currentUser.username}@knpc.com`;
          const firstLetter = (currentUser.fullName || currentUser.username).charAt(0).toUpperCase();
          document.getElementById('userAvatar').textContent = firstLetter;
          
          return true;
        } else {
          console.log('Access denied - not admin');
          showMessage('‚ùå Access Denied! Admin privileges required.', 'error');
          setTimeout(() => window.location.href = 'index.html', 3000);
          return false;
        }
        
      } catch (error) {
        console.error('Error parsing user data:', error);
        showMessage('‚ùå Session error. Redirecting to login...', 'error');
        setTimeout(() => window.location.href = 'login.html', 3000);
        return false;
      }
    }

    // Load dashboard data
    async function loadDashboardData() {
      console.log('Starting loadDashboardData...');
      
      if (!checkAdminAccess()) {
        console.log('Admin access check failed');
        return;
      }
      
      console.log('Admin access check passed');
      showMessage('üîÑ Loading dashboard data from Firebase...', 'info');
      
      try {
        console.log('Loading users from Firebase...');
        // Load users
        const usersSnapshot = await getDocs(collection(db, 'users'));
        allUsers = [];
        
        usersSnapshot.forEach((doc) => {
          const userData = { id: doc.id, ...doc.data() };
          allUsers.push(userData);
        });
        
        console.log(`Loaded ${allUsers.length} users`);

        console.log('Loading activities from Firebase...');
        // Load activities
        const activitiesSnapshot = await getDocs(
          query(collection(db, 'activities'), orderBy('timestamp', 'desc'), limit(50))
        );
        allActivities = [];
        
        activitiesSnapshot.forEach((doc) => {
          const activityData = { id: doc.id, ...doc.data() };
          allActivities.push(activityData);
        });
        
        console.log(`Loaded ${allActivities.length} activities`);

        // Load Live Tanks settings
        console.log('Loading Live Tanks settings...');
        await loadLiveTanksSettings();

        // Update statistics
        console.log('Updating statistics...');
        updateStatistics();
        
        // Display users
        console.log('Displaying users...');
        displayUsers(allUsers);
        
        // Display activities
        console.log('Displaying activities...');
        displayActivities(allActivities);
        
        showMessage('‚úÖ Dashboard data loaded successfully!', 'success');
        
        // Add activity log
        await addActivity('admin_dashboard_loaded', currentUser.username);
        
      } catch (error) {
        console.error('Error loading dashboard:', error);
        showMessage('‚ùå Error loading data: ' + error.message, 'error');
        
        // Show fallback data
        const container = document.getElementById('usersContainer');
        if (container) {
          container.innerHTML = '<div class="loading">‚ùå Failed to load users. Please check your connection and try again.</div>';
        }
        
        const tbody = document.getElementById('activitiesTableBody');
        if (tbody) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" style="padding: 30px; text-align: center; color: #f44336;">
                ‚ùå Failed to load activities: ${error.message}
              </td>
            </tr>
          `;
        }
      }
    }

    // Load Live Tanks settings
    async function loadLiveTanksSettings() {
      try {
        const settingsDoc = await getDoc(doc(db, 'systemSettings', 'liveTanksAccess'));
        if (settingsDoc.exists()) {
          globalLiveTanksSettings = settingsDoc.data();
          updateSettingsUI();
        } else {
          // Create default settings
          globalLiveTanksSettings = {
            roleAccess: {
              "admin": true,
              "panel_operator": true,
              "supervisor": true,
              "section_head": false,
              "operator": true,
              "planning": false
            },
            lastModified: new Date(),
            modifiedBy: currentUser.username
          };
          await setDoc(doc(db, 'systemSettings', 'liveTanksAccess'), globalLiveTanksSettings);
          updateSettingsUI();
        }
      } catch (error) {
        console.error('Error loading Live Tanks settings:', error);
      }
    }

    // Update settings UI
    function updateSettingsUI() {
      if (!globalLiveTanksSettings) return;
      
      const roleAccess = globalLiveTanksSettings.roleAccess || {};
      
      document.getElementById('role_panel_operator').checked = roleAccess.panel_operator || false;
      document.getElementById('role_supervisor').checked = roleAccess.supervisor || false;
      document.getElementById('role_section_head').checked = roleAccess.section_head || false;
      document.getElementById('role_operator').checked = roleAccess.operator || false;
      document.getElementById('role_planning').checked = roleAccess.planning || false;
    }

    // Update role access
    async function updateRoleAccess() {
      // Auto-save when toggles change
      await saveGlobalSettings();
    }

    // Save global settings
    async function saveGlobalSettings() {
      try {
        const settings = {
          roleAccess: {
            "admin": true, // always true
            "panel_operator": document.getElementById('role_panel_operator').checked,
            "supervisor": document.getElementById('role_supervisor').checked,
            "section_head": document.getElementById('role_section_head').checked,
            "operator": document.getElementById('role_operator').checked,
            "planning": document.getElementById('role_planning').checked
          },
          lastModified: serverTimestamp(),
          modifiedBy: currentUser.username
        };

        await setDoc(doc(db, 'systemSettings', 'liveTanksAccess'), settings);
        globalLiveTanksSettings = settings;
        
        showMessage('‚úÖ Live Tanks access settings saved successfully!', 'success');
        
        await addActivity('live_tanks_settings_updated', currentUser.username);
        
        // Update statistics
        updateStatistics();
        
      } catch (error) {
        console.error('Error saving settings:', error);
        showMessage('‚ùå Error saving settings: ' + error.message, 'error');
      }
    }

    // Reset to default
    async function resetToDefault() {
      if (!confirm('Reset Live Tanks access to default settings?\n\nDefault: Panel Operator, Supervisor, and Operator will have access.')) {
        return;
      }
      
      document.getElementById('role_panel_operator').checked = true;
      document.getElementById('role_supervisor').checked = true;
      document.getElementById('role_section_head').checked = false;
      document.getElementById('role_operator').checked = true;
      document.getElementById('role_planning').checked = false;
      
      await saveGlobalSettings();
    }

    // Update statistics
    function updateStatistics() {
      // Check if elements exist before updating
      const totalUsersEl = document.getElementById('totalUsers');
      const activeUsersEl = document.getElementById('activeUsers');
      const pendingUsersEl = document.getElementById('pendingUsers');
      const usersWithLiveTanksEl = document.getElementById('usersWithLiveTanks');
      const totalActivitiesEl = document.getElementById('totalActivities');
      
      if (!totalUsersEl || !activeUsersEl || !pendingUsersEl || !usersWithLiveTanksEl || !totalActivitiesEl) {
        console.error('Statistics elements not found');
        return;
      }
      
      // Ensure allUsers is defined
      if (!allUsers || !Array.isArray(allUsers)) {
        allUsers = [];
      }
      
      // Ensure allActivities is defined
      if (!allActivities || !Array.isArray(allActivities)) {
        allActivities = [];
      }
      
      const totalUsers = allUsers.length;
      const activeUsers = allUsers.filter(u => u.isActive).length;
      const pendingUsers = allUsers.filter(u => !u.isActive).length;
      
      // Calculate users with Live Tanks access
      let usersWithAccess = 0;
      if (globalLiveTanksSettings && globalLiveTanksSettings.roleAccess) {
        const roleAccess = globalLiveTanksSettings.roleAccess;
        allUsers.forEach(user => {
          const userRole = user.role || 'operator';
          if (roleAccess[userRole] || user.accessOverride?.liveTanksAccess) {
            usersWithAccess++;
          }
        });
      }
      
      // Calculate today's logins
      const today = new Date().toDateString();
      const todayLogins = allActivities.filter(activity => {
        const activityDate = activity.timestamp?.toDate?.()?.toDateString() || 
                             new Date(activity.timestamp?.seconds * 1000).toDateString();
        return activityDate === today && activity.action === 'user_login';
      }).length;

      totalUsersEl.textContent = totalUsers;
      activeUsersEl.textContent = activeUsers;
      pendingUsersEl.textContent = pendingUsers;
      usersWithLiveTanksEl.textContent = usersWithAccess;
      totalActivitiesEl.textContent = allActivities.length;
    }

    // Display users in table
    function displayUsers(users) {
      const container = document.getElementById('usersContainer');
      
      if (!container) {
        console.error('usersContainer element not found');
        return;
      }
      
      if (!users || !Array.isArray(users) || users.length === 0) {
        container.innerHTML = '<div class="loading">No users found in Firebase database.</div>';
        return;
      }
      
      // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖŸÉÿ±ÿ±ŸäŸÜ ŸÇÿ®ŸÑ ÿßŸÑÿπÿ±ÿ∂
      const uniqueUsers = [];
      const userMap = new Map();
      
      // ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿ≠ÿ≥ÿ® ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (ÿ®ÿ∫ÿ∂ ÿßŸÑŸÜÿ∏ÿ± ÿπŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ£ÿ≠ÿ±ŸÅ)
      users.forEach(user => {
        const normalizedUsername = user.username.toLowerCase();
        if (!userMap.has(normalizedUsername)) {
          userMap.set(normalizedUsername, user);
          uniqueUsers.push(user);
        }
      });
      
      let html = `
        <table class="users-table">
          <thead>
            <tr>
              <th>Avatar</th>
              <th>Full Name</th>
              <th>Username</th>
              <th>Email</th>
              <th>Specialization</th>
              <th>Pages Access</th>
              <th>Live Tanks</th>
              <th>Status</th>
              <th>Last Login</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      uniqueUsers.forEach(user => {
        const avatar = (user.fullName || user.username).charAt(0).toUpperCase();
        const specialization = user.specialization || user.role || 'planning';
        const specializationClass = getSpecializationBadgeClass(specialization);
        const statusClass = user.isActive ? 'badge-active' : 'badge-inactive';
        const statusText = user.isActive ? 'Active' : 'Pending';
        
        // Check Live Tanks access
        const liveTanksAccess = getUserLiveTanksAccess(user);
        
        // Get pages access
        const pagesAccess = getUserPagesAccess(user);
        
        const lastLoginDate = user.lastLogin?.toDate?.() || (user.lastLogin ? new Date(user.lastLogin?.seconds * 1000) : null);
        
        html += `
          <tr>
            <td>
              <div style="width:35px;height:35px;border-radius:50%;background:${specialization === 'admin' ? '#FFD700' : '#4CAF50'};display:flex;align-items:center;justify-content:center;color:${specialization === 'admin' ? '#003366' : 'white'};font-weight:bold;">
                ${avatar}
              </div>
            </td>
            <td><strong>${user.fullName || user.username}</strong></td>
            <td>${user.username}</td>
            <td>${user.email || `${user.username}@example.com`}</td>
            <td><span class="status-badge ${specializationClass}">${formatSpecializationName(specialization)}</span></td>
            <td><small>${pagesAccess}</small></td>
            <td><span class="status-badge ${liveTanksAccess.class}">${liveTanksAccess.text}</span></td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${lastLoginDate ? lastLoginDate.toLocaleString() : 'Never'}</td>
            <td>
              <div class="action-buttons">
                ${user.username !== 'fam030' ? `
                  <button class="action-btn btn-primary" onclick="editUserPermissions('${user.username}')" title="Edit Permissions">üîß Permissions</button>
                  <button class="action-btn ${user.isActive ? 'btn-warning' : 'btn-primary'}" onclick="toggleUserStatus('${user.username}')" title="${user.isActive ? 'Deactivate' : 'Activate'} User">
                    ${user.isActive ? '‚ùå' : '‚úÖ'}
                  </button>
                  <button class="action-btn btn-danger" onclick="deleteUser('${user.username}')" title="Delete User">üóëÔ∏è</button>
                ` : '<span class="status-badge badge-admin">üîí MASTER</span>'}
              </div>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Check if user has Live Tanks access
    function checkUserLiveTanksAccess(user) {
      if (!globalLiveTanksSettings) return false;
      
      // Check individual override first
      if (user.accessOverride && user.accessOverride.liveTanksAccess !== undefined) {
        return user.accessOverride.liveTanksAccess;
      }
      
      // Check global role settings
      const roleAccess = globalLiveTanksSettings.roleAccess || {};
      const userRole = user.role || 'operator';
      return roleAccess[userRole] || false;
    }

    // Get role badge class
    function getRoleBadgeClass(role) {
      const classMap = {
        'admin': 'badge-admin',
        'panel_operator': 'badge-panel-operator',
        'supervisor': 'badge-supervisor',
        'section_head': 'badge-section-head',
        'operator': 'badge-operator',
        'planning': 'badge-planning'
      };
      return classMap[role] || 'badge-user';
    }

    // Format role name
    function formatRoleName(role) {
      const nameMap = {
        'admin': 'Admin',
        'panel_operator': 'Panel Operator',
        'supervisor': 'Supervisor',
        'section_head': 'Section Head',
        'operator': 'Operator',
        'planning': 'Planning'
      };
      return nameMap[role] || 'User';
    }

    // Get specialization badge class
    function getSpecializationBadgeClass(specialization) {
      const classMap = {
        'admin': 'badge-admin',
        'supervisor': 'badge-supervisor',
        'planning': 'badge-planning',
        'control_panel': 'badge-panel-operator',
        'field_operator': 'badge-operator'
      };
      return classMap[specialization] || 'badge-user';
    }

    // Format specialization name
    function formatSpecializationName(specialization) {
      const nameMap = {
        'admin': 'Administrator',
        'supervisor': 'Supervisor',
        'planning': 'Planning',
        'control_panel': 'Control Panel',
        'field_operator': 'Field Operator'
      };
      return nameMap[specialization] || 'User';
    }

    // Get user Live Tanks access
    function getUserLiveTanksAccess(user) {
      // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ Ÿäÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÇÿØŸäŸÖ
      if (user.role && !user.specialization) {
        const canView = ['admin', 'panel_operator', 'supervisor'].includes(user.role);
        const canEdit = ['admin', 'panel_operator'].includes(user.role);
        
        if (!canView) return { class: 'badge-inactive', text: 'No Access' };
        if (canEdit) return { class: 'badge-active', text: 'Full Access' };
        return { class: 'badge-warning', text: 'View Only' };
      }

      // ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑÿ¨ÿØÿØ
      let permissions = {};
      if (user.customPermissions) {
        permissions = user.customPermissions;
      } else if (window.TankToolsPermissions && window.TankToolsPermissions.SPECIALIZATIONS && window.TankToolsPermissions.SPECIALIZATIONS[user.specialization]) {
        permissions = window.TankToolsPermissions.SPECIALIZATIONS[user.specialization].defaultPermissions;
      }

      if (!permissions.canViewLiveTanks) return { class: 'badge-inactive', text: 'No Access' };
      if (permissions.canEditLiveTanks) return { class: 'badge-active', text: 'Full Access' };
      return { class: 'badge-warning', text: 'View Only' };
    }

    // Get user pages access
    function getUserPagesAccess(user) {
      // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ Ÿäÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÇÿØŸäŸÖ
      if (user.role && !user.specialization) {
        if (user.role === 'admin') return 'All Pages';
        return 'Basic Pages';
      }

      // ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑÿ¨ÿØÿØ
      if (user.customPages && Array.isArray(user.customPages)) {
        if (user.customPages.includes('all')) return 'All Pages';
        return user.customPages.map(page => {
          const pageNames = {
            'index.html': 'PBCR',
            'plcr.html': 'PLCR',
            'NMOGASBL.html': 'NMOGAS',
            'live-tanks.html': 'Live Tanks',
            'dashboard.html': 'Dashboard',
            'verify.html': 'Verify'
          };
          return pageNames[page] || page;
        }).join(', ');
      }

      // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿµŸÅÿ≠ÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÑŸÑÿ™ÿÆÿµÿµ
      if (window.TankToolsPermissions && window.TankToolsPermissions.SPECIALIZATIONS[user.specialization]) {
        const defaultPages = window.TankToolsPermissions.SPECIALIZATIONS[user.specialization].defaultPages;
        if (defaultPages.includes('all')) return 'All Pages';
        return defaultPages.map(page => {
          const pageNames = {
            'index.html': 'PBCR',
            'plcr.html': 'PLCR',
            'NMOGASBL.html': 'NMOGAS',
            'live-tanks.html': 'Live Tanks',
            'dashboard.html': 'Dashboard',
            'verify.html': 'Verify'
          };
          return pageNames[page] || page;
        }).join(', ');
      }

      return 'Dashboard';
    }

    // Display activities in table format
    function displayActivities(activities) {
      const tbody = document.getElementById('activitiesTableBody');
      
      if (activities.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="padding: 30px; text-align: center; color: #666;">
              üì≠ No activities found
            </td>
          </tr>
        `;
        return;
      }
      
      // Sort by timestamp (newest first)
      activities.sort((a, b) => {
        const timeA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
        const timeB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
        return timeB - timeA;
      });
      
      // Take first 50 activities
      const displayActivities = activities.slice(0, 50);
      
      tbody.innerHTML = displayActivities.map((activity, index) => {
        const timestamp = activity.timestamp?.toDate ? activity.timestamp.toDate() : new Date(activity.timestamp);
        const date = timestamp.toLocaleDateString('en-GB');
        const time = timestamp.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        
        let activityText = activity.action || 'Unknown activity';
        let activityIcon = 'üìù';
        let sourceIcon = 'üåê';
        let hasDetails = false;
        let detailsButton = '';
        
        // Check if activity has detailed information
        if (activity.details && activity.details.changes) {
          hasDetails = true;
          detailsButton = ` <span class="details-btn" onclick="showActivityDetails(${index})" style="cursor: pointer; color: #ff6b35; font-weight: bold; font-size: 16px;" title="Click to view details">‚ùó</span>`;
        }
        
        // Clean up activity text - make it shorter and clearer
        if (activityText.includes('ÿ™ŸÖ ÿ≠ÿ≥ÿßÿ® Tank') && activityText.includes('PBCR Calculator')) {
          const tankMatch = activityText.match(/Tank (\d+)/);
          const tankNumber = tankMatch ? tankMatch[1] : 'Unknown';
          activityText = `PBCR Calculation - Tank ${tankNumber}`;
          activityIcon = 'üßÆ';
        } else if (activityText.includes('ÿØÿÆŸàŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ') || activityText.includes('login')) {
          activityText = 'User Login';
          activityIcon = 'üîê';
        } else if (activityText.includes('admin_dashboard_loaded')) {
          activityText = 'Dashboard Access';
          activityIcon = 'üë®‚Äçüíº';
        } else if (activityText.includes('Tank') && activityText.includes('Updated')) {
          activityIcon = 'üõ¢Ô∏è';
        } else if (activityText.includes('Tank') && activityText.includes('Added')) {
          activityIcon = '‚ûï';
        } else if (activityText.includes('Tank') && activityText.includes('Deleted')) {
          activityIcon = 'üóëÔ∏è';
        } else if (activityText.includes('Live Tanks')) {
          activityText = 'Live Tanks Activity';
          activityIcon = 'üõ¢Ô∏è';
        }
        
        // Determine source
        let source = 'Unknown';
        if (activity.page === 'pbcr-calculator' || activityText.includes('PBCR')) {
          source = 'PBCR Calculator';
          sourceIcon = 'üßÆ';
        } else if (activity.page === 'live-tanks' || activityText.includes('Live Tanks') || activityText.includes('Tank')) {
          source = 'Live Tanks';
          sourceIcon = 'üõ¢Ô∏è';
        } else if (activity.page === 'login' || activityText.includes('Login')) {
          source = 'Login Page';
          sourceIcon = 'üîê';
        } else if (activity.ip === 'admin-dashboard' || activityText.includes('Dashboard')) {
          source = 'Admin Dashboard';
          sourceIcon = 'üë®‚Äçüíº';
        }
        
        return `
          <tr style="border-bottom: 1px solid rgba(0,51,102,0.1);" onmouseover="this.style.background='rgba(255,215,0,0.1)'" onmouseout="this.style.background=''">
            <td style="padding: 15px 20px; font-weight: bold; color: #003366; white-space: nowrap;">
              üë§ ${activity.username || 'Unknown'}
            </td>
            <td style="padding: 15px 20px; color: #003366;">
              ${activityIcon} ${activityText}${detailsButton}
            </td>
            <td style="padding: 15px 20px; color: #666; white-space: nowrap; text-align: center; font-size: 13px;">
              üìÖ ${date}
            </td>
            <td style="padding: 15px 20px; color: #666; white-space: nowrap; text-align: center; font-size: 13px;">
              ‚è∞ ${time}
            </td>
            <td style="padding: 15px 20px; color: #666; text-align: center; font-size: 13px;">
              ${sourceIcon} ${source}
            </td>
          </tr>
        `;
      }).join('');
      
      // Store activities globally for details popup
      window.currentActivities = displayActivities;
      
      // Update pagination info
      document.getElementById('activitiesStart').textContent = '1';
      document.getElementById('activitiesEnd').textContent = displayActivities.length;
      document.getElementById('activitiesTotal').textContent = activities.length;
      document.getElementById('currentPage').textContent = '1';
      document.getElementById('totalPages').textContent = '1';
    }

    // Show activity details popup
    function showActivityDetails(index) {
      const activity = window.currentActivities[index];
      if (!activity || !activity.details) return;
      
      const details = activity.details;
      const timestamp = activity.timestamp?.toDate ? activity.timestamp.toDate() : new Date(activity.timestamp);
      const dateTime = timestamp.toLocaleString('en-GB');
      
      let detailsHTML = `
        <div style="background: rgba(255,255,255,0.95); border-radius: 15px; padding: 25px; max-width: 600px; margin: 20px auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); color: #003366;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #003366; padding-bottom: 15px;">
            <h3 style="margin: 0; color: #003366;">üìä Tank ${details.tankNumber} Changes</h3>
            <button onclick="closeActivityDetails()" style="background: #ff4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px;">√ó</button>
          </div>
          
          <div style="margin-bottom: 15px;">
            <strong>üè≠ Department:</strong> ${details.department}<br>
            <strong>üë§ Modified by:</strong> ${activity.username}<br>
            <strong>üìÖ Date & Time:</strong> ${dateTime}
          </div>
      `;
      
      if (details.action === 'updated' && details.changes) {
        detailsHTML += `<div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 15px 0;">
          <h4 style="margin: 0 0 15px 0; color: #003366;">üîÑ Changes Made:</h4>`;
        
        Object.keys(details.changes).forEach(key => {
          const change = details.changes[key];
          const fieldName = key.charAt(0).toUpperCase() + key.slice(1);
          detailsHTML += `
            <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #4CAF50;">
              <strong>${fieldName}:</strong><br>
              <span style="color: #ff4444;">‚ùå Before: ${change.from || 'Not set'}</span><br>
              <span style="color: #4CAF50;">‚úÖ After: ${change.to}</span>
            </div>
          `;
        });
        
        detailsHTML += `</div>`;
      } else if (details.action === 'added') {
        detailsHTML += `
          <div style="background: #e8f5e8; border-radius: 10px; padding: 15px; margin: 15px 0; border-left: 4px solid #4CAF50;">
            <h4 style="margin: 0 0 10px 0; color: #4CAF50;">‚ûï Tank Added</h4>
            <p style="margin: 0;">${details.details}</p>
          </div>
        `;
      } else if (details.action === 'deleted') {
        detailsHTML += `
          <div style="background: #ffe8e8; border-radius: 10px; padding: 15px; margin: 15px 0; border-left: 4px solid #ff4444;">
            <h4 style="margin: 0 0 10px 0; color: #ff4444;">üóëÔ∏è Tank Deleted</h4>
            <p style="margin: 0;">${details.details}</p>
          </div>
        `;
      }
      
      detailsHTML += `</div>`;
      
      // Create overlay
      const overlay = document.createElement('div');
      overlay.id = 'activityDetailsOverlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
      `;
      overlay.innerHTML = detailsHTML;
      
      // Close on overlay click
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          closeActivityDetails();
        }
      });
      
      document.body.appendChild(overlay);
    }
    
    // Close activity details popup
    function closeActivityDetails() {
      const overlay = document.getElementById('activityDetailsOverlay');
      if (overlay) {
        overlay.remove();
      }
    }

    // Edit user
    function editUser(username) {
      const user = allUsers.find(u => u.username === username);
      if (!user) {
        showMessage('‚ùå User not found!', 'error');
        return;
      }
      
      currentEditingUser = user;
      
      document.getElementById('modalTitle').textContent = `Edit User: ${user.username}`;
      document.getElementById('editFullName').value = user.fullName || '';
      document.getElementById('editUsername').value = user.username;
      document.getElementById('editEmail').value = user.email;
      document.getElementById('editRole').value = user.role || 'operator';
      document.getElementById('editStatus').value = user.isActive ? 'true' : 'false';
      document.getElementById('editLiveTanksAccess').checked = checkUserLiveTanksAccess(user);
      document.getElementById('editPassword').value = '';
      
      document.getElementById('userModal').classList.add('show');
    }

    // Edit user permissions (new function)
    function editUserPermissions(username) {
      // ÿ™Ÿàÿ≠ŸäÿØ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ£ÿ≠ÿ±ŸÅ ŸÅŸä ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑŸÑÿ®ÿ≠ÿ´
      const normalizedUsername = username.toLowerCase();
      
      // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿ∫ÿ∂ ÿßŸÑŸÜÿ∏ÿ± ÿπŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ£ÿ≠ÿ±ŸÅ
      const user = allUsers.find(u => u.username.toLowerCase() === normalizedUsername);
      if (!user) {
        showMessage('‚ùå User not found!', 'error');
        return;
      }
      
      // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ŸÖŸÜÿ®ÿ´ŸÇÿ© ŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
      const permissionsModal = document.createElement('div');
      permissionsModal.className = 'modal show';
      permissionsModal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h2 class="modal-title">üîß Edit Permissions: ${user.username}</h2>
            <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
          </div>
          <div style="padding: 20px;">
            <div class="form-group">
              <label class="form-label">Specialization:</label>
              <select id="userSpecialization" class="form-select">
                <option value="admin">Administrator</option>
                <option value="supervisor">Supervisor</option>
                <option value="planning">Planning</option>
                <option value="control_panel">Control Panel</option>
                <option value="field_operator">Field Operator</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Pages Access:</label>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                <label><input type="checkbox" value="index.html"> PBCR</label>
                <label><input type="checkbox" value="plcr.html"> PLCR</label>
                <label><input type="checkbox" value="NMOGASBL.html"> NMOGAS</label>
                <label><input type="checkbox" value="live-tanks.html"> Live Tanks</label>
                <label><input type="checkbox" value="dashboard.html"> Dashboard</label>
                <label><input type="checkbox" value="verify.html"> Verification</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Live Tanks Permissions:</label>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                <label><input type="checkbox" id="canViewLiveTanks"> View Live Tanks</label>
                <label><input type="checkbox" id="canEditLiveTanks"> Edit Live Tanks</label>
                <label><input type="checkbox" id="canAddToLiveTanks"> Add to Live Tanks</label>
                <label><input type="checkbox" id="canDeleteFromLiveTanks"> Delete from Live Tanks</label>
              </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
              <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
              <button class="btn btn-primary" onclick="saveUserPermissions('${user.username}', this.closest('.modal'))">Save Permissions</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(permissionsModal);
      
      // ÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿ≠ÿßŸÑŸäÿ©
      const specialization = user.specialization || user.role || 'planning';
      permissionsModal.querySelector('#userSpecialization').value = specialization;
      
      // ÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑÿµŸÅÿ≠ÿßÿ™ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ÿ©
      const currentPages = user.customPages || (window.TankToolsPermissions?.SPECIALIZATIONS[specialization]?.defaultPages) || [];
      const pageCheckboxes = permissionsModal.querySelectorAll('input[type="checkbox"][value]');
      pageCheckboxes.forEach(checkbox => {
        checkbox.checked = currentPages.includes(checkbox.value) || currentPages.includes('all');
      });
      
      // ÿ™ÿπÿ®ÿ¶ÿ© ÿµŸÑÿßÿ≠Ÿäÿßÿ™ Live Tanks
      const permissions = user.customPermissions || (window.TankToolsPermissions?.SPECIALIZATIONS[specialization]?.defaultPermissions) || {};
      permissionsModal.querySelector('#canViewLiveTanks').checked = permissions.canViewLiveTanks || false;
      permissionsModal.querySelector('#canEditLiveTanks').checked = permissions.canEditLiveTanks || false;
      permissionsModal.querySelector('#canAddToLiveTanks').checked = permissions.canAddToLiveTanks || false;
      permissionsModal.querySelector('#canDeleteFromLiveTanks').checked = permissions.canDeleteFromLiveTanks || false;
    }

    // Save user permissions
    async function saveUserPermissions(username, modal) {
      try {
        // ÿ•ÿ∂ÿßŸÅÿ© console.log ŸÑŸÑÿ™ÿ¥ÿÆŸäÿµ
        console.log('Saving permissions for:', username);
        
        // ÿ™Ÿàÿ≠ŸäÿØ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ£ÿ≠ÿ±ŸÅ ŸÅŸä ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (ÿ™ÿ≠ŸàŸäŸÑŸá ÿ•ŸÑŸâ lowercase)
        const normalizedUsername = username.toLowerCase();
        console.log('Normalized username:', normalizedUsername);
        
        const specialization = modal.querySelector('#userSpecialization').value;
        console.log('Specialization:', specialization);
        
        // ÿ¨ŸÖÿπ ÿßŸÑÿµŸÅÿ≠ÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©
        const selectedPages = [];
        const pageCheckboxes = modal.querySelectorAll('input[type="checkbox"][value]:checked');
        pageCheckboxes.forEach(checkbox => selectedPages.push(checkbox.value));
        console.log('Selected pages:', selectedPages);
        
        // ÿ¨ŸÖÿπ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ Live Tanks
        const customPermissions = {
          canViewLiveTanks: modal.querySelector('#canViewLiveTanks').checked,
          canEditLiveTanks: modal.querySelector('#canEditLiveTanks').checked,
          canAddToLiveTanks: modal.querySelector('#canAddToLiveTanks').checked,
          canDeleteFromLiveTanks: modal.querySelector('#canDeleteFromLiveTanks').checked,
          canManageUsers: specialization === 'admin'
        };
        console.log('Custom permissions:', customPermissions);
        
        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿ∫ÿ∂ ÿßŸÑŸÜÿ∏ÿ± ÿπŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ£ÿ≠ÿ±ŸÅ
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('username', '==', username));
        const querySnapshot = await getDocs(q);
        
        let existingUser = null;
        let existingDocId = null;
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿ£Ÿä ÿ≠ÿßŸÑÿ© ÿ£ÿ≠ÿ±ŸÅ
        if (!querySnapshot.empty) {
          querySnapshot.forEach((doc) => {
            existingUser = doc.data();
            existingDocId = doc.id;
          });
          console.log('Found existing user with ID:', existingDocId);
        }
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿßŸÑŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≠ÿØÿØ
        const userRef = doc(db, 'users', normalizedUsername);
        const userDoc = await getDoc(userRef);
        
        if (userDoc.exists() || existingUser) {
          // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØ - ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ŸÖÿπ ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿµŸÑŸäÿ©
          const userData = userDoc.exists() ? userDoc.data() : existingUser;
          const updateData = {
            username: normalizedUsername, // ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖÿπÿ±ŸÅ ÿ®ÿ≠ÿßŸÑÿ© ŸÖŸàÿ≠ÿØÿ©
            specialization: specialization,
            customPages: selectedPages,
            customPermissions: customPermissions,
            updatedAt: serverTimestamp()
          };
          
          // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿπÿ±ŸÅ ÿßŸÑŸÖŸàÿ¨ŸàÿØ ÿ£Ÿà ÿßŸÑŸÖÿπÿ±ŸÅ ÿßŸÑŸÖŸàÿ≠ÿØ
          const targetRef = existingDocId ? doc(db, 'users', existingDocId) : userRef;
          await updateDoc(targetRef, updateData);
          console.log('User permissions updated successfully');
          
          // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØ ÿ®ŸÖÿπÿ±ŸÅ ŸÖÿÆÿ™ŸÑŸÅÿå ŸÜÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ ÿßŸÑŸÖŸÉÿ±ÿ±
          if (existingDocId && existingDocId !== normalizedUsername) {
            console.log('Cleaning up duplicate user document');
            // ŸÜŸÇŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ ÿßŸÑŸÖŸàÿ≠ÿØ
            await setDoc(userRef, {
              ...userData,
              ...updateData
            });
            // ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ ÿßŸÑŸÇÿØŸäŸÖ
            await deleteDoc(doc(db, 'users', existingDocId));
          }
        } else {
          // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ - ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿ≥ÿ™ŸÜÿØ ÿ¨ÿØŸäÿØ ŸÖÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
          const updateData = {
            username: normalizedUsername, // ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖÿπÿ±ŸÅ ÿ®ÿ≠ÿßŸÑÿ© ŸÖŸàÿ≠ÿØÿ©
            fullName: username, // ŸÇŸäŸÖÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
            email: `${normalizedUsername}@example.com`, // ŸÇŸäŸÖÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
            specialization: specialization,
            customPages: selectedPages,
            customPermissions: customPermissions,
            isActive: true,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          };
          
          await setDoc(userRef, updateData);
          console.log('New user created with permissions');
        }
        
        console.log('Permissions updated successfully in Firebase');
        showMessage('‚úÖ Permissions updated successfully!', 'success');
        modal.remove();
        
        // ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ¨ÿØŸàŸÑ
        loadDashboardData();
        
      } catch (error) {
        console.error('Error updating permissions:', error);
        showMessage('‚ùå Error updating permissions: ' + error.message, 'error');
      }
    }

    // Close modal
    function closeModal() {
      document.getElementById('userModal').classList.remove('show');
      currentEditingUser = null;
    }

    // Handle form submission
    document.getElementById('userForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!currentEditingUser) return;
      
      const fullName = document.getElementById('editFullName').value;
      const role = document.getElementById('editRole').value;
      const isActive = document.getElementById('editStatus').value === 'true';
      const liveTanksAccess = document.getElementById('editLiveTanksAccess').checked;
      const newPassword = document.getElementById('editPassword').value;
      
      try {
        const updateData = {
          fullName: fullName,
          role: role,
          isActive: isActive,
          'accessOverride.liveTanksAccess': liveTanksAccess,
          lastModified: serverTimestamp(),
          modifiedBy: currentUser.username
        };
        
        if (newPassword) {
          updateData.password = newPassword;
        }
        
        await updateDoc(doc(db, 'users', currentEditingUser.username), updateData);
        
        await addActivity('user_updated_by_admin', currentUser.username);
        
        showMessage('‚úÖ User updated successfully!', 'success');
        closeModal();
        loadDashboardData(); // Refresh data
        
      } catch (error) {
        console.error('Error updating user:', error);
        showMessage('‚ùå Error updating user: ' + error.message, 'error');
      }
    });

    // Toggle user status
    async function toggleUserStatus(username) {
      const user = allUsers.find(u => u.username === username);
      if (!user || user.username === 'fam030') return;
      
      const newStatus = !user.isActive;
      
      try {
        await updateDoc(doc(db, 'users', username), {
          isActive: newStatus,
          lastModified: serverTimestamp(),
          modifiedBy: currentUser.username
        });
        
        await addActivity(newStatus ? 'user_activated_by_admin' : 'user_deactivated_by_admin', currentUser.username);
        
        showMessage(`‚úÖ User ${username} ${newStatus ? 'activated' : 'deactivated'} successfully!`, 'success');
        loadDashboardData(); // Refresh data
        
      } catch (error) {
        console.error('Error toggling user status:', error);
        showMessage('‚ùå Error updating user status: ' + error.message, 'error');
      }
    }

    // Delete user
    async function deleteUser(username) {
      if (username === 'fam030') {
        showMessage('‚ùå Cannot delete master admin account!', 'error');
        return;
      }
      
      if (!confirm(`Are you sure you want to delete user "${username}"?\n\nThis action cannot be undone!`)) {
        return;
      }
      
      try {
        await deleteDoc(doc(db, 'users', username));
        
        await addActivity('user_deleted_by_admin', currentUser.username);
        
        showMessage(`‚úÖ User ${username} deleted successfully!`, 'success');
        loadDashboardData(); // Refresh data
        
      } catch (error) {
        console.error('Error deleting user:', error);
        showMessage('‚ùå Error deleting user: ' + error.message, 'error');
      }
    }

    // Show pending users
    function showPendingUsers() {
      const pendingUsers = allUsers.filter(u => !u.isActive);
      const container = document.getElementById('pendingUsersContainer');
      
      if (pendingUsers.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">No pending users found.</p>';
      } else {
        let html = '<div class="pending-users-grid">';
        
        pendingUsers.forEach(user => {
          const createdDate = user.createdAt?.toDate?.() || new Date(user.createdAt?.seconds * 1000) || new Date();
          
          html += `
            <div class="pending-card">
              <div class="pending-header">
                <div class="pending-name">${user.fullName || user.username}</div>
              </div>
              <div class="pending-details">
                <div><strong>Username:</strong> ${user.username}</div>
                <div><strong>Email:</strong> ${user.email}</div>
                <div><strong>Role:</strong> ${formatRoleName(user.role || 'operator')}</div>
                <div><strong>Registered:</strong> ${createdDate.toLocaleString()}</div>
              </div>
              <div class="pending-actions">
                <button class="btn btn-primary" onclick="approveUser('${user.username}')">‚úÖ Approve</button>
                <button class="btn btn-danger" onclick="deleteUser('${user.username}')">‚ùå Reject</button>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        container.innerHTML = html;
      }
      
      document.getElementById('pendingModal').classList.add('show');
    }

    // Close pending modal
    function closePendingModal() {
      document.getElementById('pendingModal').classList.remove('show');
    }

    // Approve user
    async function approveUser(username) {
      try {
        await updateDoc(doc(db, 'users', username), {
          isActive: true,
          lastModified: serverTimestamp(),
          modifiedBy: currentUser.username
        });
        
        await addActivity('user_approved_by_admin', currentUser.username);
        
        showMessage(`‚úÖ User ${username} approved successfully!`, 'success');
        loadDashboardData(); // Refresh data
        showPendingUsers(); // Refresh modal
        
      } catch (error) {
        console.error('Error approving user:', error);
        showMessage('‚ùå Error approving user: ' + error.message, 'error');
      }
    }

    // Approve all pending users
    async function approveAllPending() {
      const pendingUsers = allUsers.filter(u => !u.isActive);
      
      if (pendingUsers.length === 0) {
        showMessage('‚ÑπÔ∏è No pending users to approve.', 'info');
        return;
      }
      
      if (!confirm(`Approve all ${pendingUsers.length} pending users?`)) {
        return;
      }
      
      try {
        const promises = pendingUsers.map(user => 
          updateDoc(doc(db, 'users', user.username), { 
            isActive: true,
            lastModified: serverTimestamp(),
            modifiedBy: currentUser.username
          })
        );
        
        await Promise.all(promises);
        
        await addActivity('bulk_approval_by_admin', currentUser.username);
        
        showMessage(`‚úÖ ${pendingUsers.length} users approved successfully!`, 'success');
        loadDashboardData(); // Refresh data
        closePendingModal();
        
      } catch (error) {
        console.error('Error approving all users:', error);
        showMessage('‚ùå Error approving users: ' + error.message, 'error');
      }
    }

    // Filter users
    function filterUsers() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const roleFilter = document.getElementById('roleFilter').value;
      
      let filteredUsers = allUsers.filter(user => {
        const matchesSearch = (user.fullName || '').toLowerCase().includes(searchTerm) ||
                             user.username.toLowerCase().includes(searchTerm) ||
                             user.email.toLowerCase().includes(searchTerm);
        
        const matchesStatus = statusFilter === 'all' ||
                             (statusFilter === 'active' && user.isActive) ||
                             (statusFilter === 'inactive' && !user.isActive) ||
                             (statusFilter === 'pending' && !user.isActive);
        
        const userRole = user.role || 'operator';
        const matchesRole = roleFilter === 'all' || userRole === roleFilter;
        
        return matchesSearch && matchesStatus && matchesRole;
      });
      
      displayUsers(filteredUsers);
    }

    // Load activities with simple approach
    async function loadActivities() {
      try {
        console.log('Loading activities...');
        
        const tbody = document.getElementById('activitiesTableBody');
        if (!tbody) {
          console.error('activitiesTableBody element not found');
          return;
        }
        
        const activitiesSnapshot = await getDocs(collection(db, 'activities'));
        
        if (activitiesSnapshot.empty) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" style="padding: 30px; text-align: center; color: #666;">
                üì≠ No activities found
              </td>
            </tr>
          `;
          return;
        }
        
        const activities = [];
        activitiesSnapshot.forEach((doc) => {
          activities.push({ id: doc.id, ...doc.data() });
        });
        
        // Use displayActivities function
        displayActivities(activities);
        
        console.log('Activities loaded successfully');
        
      } catch (error) {
        console.error('Error loading activities:', error);
        const tbody = document.getElementById('activitiesTableBody');
        if (tbody) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" style="padding: 30px; text-align: center; color: #f44336;">
                ‚ùå Error loading activities: ${error.message}
              </td>
            </tr>
          `;
        }
      }
    }

    // Add activity to Firebase
    async function addActivity(action, username) {
      try {
        await addDoc(collection(db, 'activities'), {
          action: action,
          username: username,
          timestamp: serverTimestamp(),
          ip: 'admin-dashboard',
          userAgent: navigator.userAgent.substring(0, 100)
        });
      } catch (error) {
        console.error('Error adding activity:', error);
      }
    }

    // Update current time
    function updateCurrentTime() {
      const now = new Date();
      const timeString = now.toLocaleString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      document.getElementById('currentTime').textContent = timeString;
    }

    // Show message
    function showMessage(message, type) {
      const container = document.getElementById('messageContainer');
      container.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => container.innerHTML = '', 7000);
    }

    // Logout
    function logout() {
      localStorage.removeItem('tanktools_current_user');
      sessionStorage.removeItem('tanktools_session');
      window.location.href = 'login.html';
    }

    // Initialize dashboard
    window.addEventListener('load', () => {
      updateCurrentTime();
      setInterval(updateCurrentTime, 60000);
      
      // Add event listeners
      document.getElementById('userSearch').addEventListener('input', filterUsers);
      document.getElementById('statusFilter').addEventListener('change', filterUsers);
      document.getElementById('roleFilter').addEventListener('change', filterUsers);
      
      // Load data after Firebase initialization
      setTimeout(() => {
        console.log('üöÄ Starting dashboard initialization...');
        loadDashboardData();
      }, 1000);
    });

    // Make functions globally available
    window.loadDashboardData = loadDashboardData;
    window.editUser = editUser;
    window.editUserPermissions = editUserPermissions;
    window.saveUserPermissions = saveUserPermissions;
    window.closeModal = closeModal;
    window.toggleUserStatus = toggleUserStatus;
    window.deleteUser = deleteUser;
    window.showPendingUsers = showPendingUsers;
    window.closePendingModal = closePendingModal;
    window.approveUser = approveUser;
    window.approveAllPending = approveAllPending;
    window.updateRoleAccess = updateRoleAccess;
    window.saveGlobalSettings = saveGlobalSettings;
    window.resetToDefault = resetToDefault;
    window.logout = logout;
    window.loadActivities = loadActivities;
    window.refreshActivities = () => loadActivities();

    // Font size control functions
    let currentFontSize = parseInt(localStorage.getItem('tanktools_font_size_dashboard') || '14');
    
    function increaseFontSize() {
      if (currentFontSize < 22) {
        currentFontSize += 2;
        applyFontSize();
        localStorage.setItem('tanktools_font_size_dashboard', currentFontSize);
        showFontMessage(`üìà Font size increased to ${currentFontSize}px`);
      }
    }
    
    function decreaseFontSize() {
      if (currentFontSize > 10) {
        currentFontSize -= 2;
        applyFontSize();
        localStorage.setItem('tanktools_font_size_dashboard', currentFontSize);
        showFontMessage(`üìâ Font size decreased to ${currentFontSize}px`);
      }
    }
    
    function applyFontSize() {
      const style = document.createElement('style');
      style.id = 'dynamic-font-style';
      
      const existingStyle = document.getElementById('dynamic-font-style');
      if (existingStyle) {
        existingStyle.remove();
      }
      
      style.textContent = `
        .users-table { font-size: ${currentFontSize}px !important; }
        .users-table th, .users-table td { font-size: ${currentFontSize}px !important; padding: ${Math.max(8, currentFontSize/2)}px ${Math.max(6, currentFontSize/3)}px !important; }
        .form-input, .form-select, .search-box, .filter-select { font-size: ${currentFontSize}px !important; }
        .btn { font-size: ${currentFontSize}px !important; }
        .stat-number { font-size: ${currentFontSize + 8}px !important; }
        .stat-label { font-size: ${currentFontSize - 2}px !important; }
        .section-title { font-size: ${currentFontSize + 6}px !important; }
        .activity-item { font-size: ${currentFontSize}px !important; }
        .pending-card { font-size: ${currentFontSize}px !important; }
      `;
      
      document.head.appendChild(style);
    }
    
    function showFontMessage(message) {
      const msgDiv = document.createElement('div');
      msgDiv.style.cssText = 'position:fixed;top:80px;right:20px;background:rgba(76,175,80,0.9);color:white;padding:10px 15px;border-radius:8px;font-size:12px;z-index:1000;animation:slideIn 0.3s ease';
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);
      setTimeout(() => msgDiv.remove(), 3000);
    }
    
    // Apply saved font size on page load
    applyFontSize();
    
    window.increaseFontSize = increaseFontSize;
    window.decreaseFontSize = decreaseFontSize;

    console.log('%cüî• FIREBASE ADMIN DASHBOARD v4.2', 'color:orange;font-size:20px;font-weight:bold');
    console.log('%cDeveloper: Fahad - 17877', 'color:green;font-size:16px');
    console.log('%cLive Tanks Access Control System', 'color:blue;font-size:14px');
  </script>
</body>
</html>