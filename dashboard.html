<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tank Tools - Firebase Admin Dashboard</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="icon.png" type="image/png">
  <meta name="theme-color" content="#003366">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;font-family:Arial,sans-serif;min-height:100vh;color:white}
    .header{background:rgba(0,51,102,0.9);padding:15px 20px;display:flex;justify-content:space-between;align-items:center;backdrop-filter:blur(10px);box-shadow:0 2px 10px rgba(0,0,0,0.3)}
    .logo{font-size:1.8rem;font-weight:bold;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .user-info{display:flex;align-items:center;gap:15px}
    .user-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(45deg,#FFD700,#FFA500);display:flex;align-items:center;justify-content:center;font-weight:bold;color:#003366}
    .nav-links{display:flex;gap:10px}
    .nav-btn,.logout-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:white;padding:8px 15px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;text-decoration:none;font-size:14px}
    .nav-btn:hover{background:rgba(255,255,255,0.2);transform:translateY(-2px)}
    .logout-btn{background:rgba(255,0,0,0.2);border-color:rgba(255,0,0,0.5)}
    .logout-btn:hover{background:rgba(255,0,0,0.4)}
    .container{max-width:1400px;margin:20px auto;padding:0 20px}
    .admin-banner{text-align:center;margin-bottom:30px;background:rgba(255,255,255,0.1);padding:20px;border-radius:15px;backdrop-filter:blur(10px)}
    .admin-badge{display:inline-block;background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366;padding:8px 20px;border-radius:25px;font-weight:bold;margin-bottom:15px;font-size:1.1rem}
    .notification-banner{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#ffc107;padding:15px;border-radius:10px;margin-bottom:20px;display:none;text-align:center}
    .notification-banner.show{display:block}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:20px;text-align:center;border:1px solid rgba(255,255,255,0.2);transition:transform 0.3s ease}
    .stat-card:hover{transform:translateY(-5px)}
    .stat-number{font-size:2.2rem;font-weight:bold;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:5px}
    .stat-label{font-size:0.9rem;opacity:0.8}
    .section{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:25px;margin-bottom:25px;border:1px solid rgba(255,255,255,0.2)}
    .section-title{font-size:1.4rem;margin-bottom:20px;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:bold;border-bottom:2px solid rgba(255,215,0,0.3);padding-bottom:10px}
    .controls{display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
    .search-box{padding:12px 15px;border:none;border-radius:10px;background:rgba(255,255,255,0.9);color:#003366;font-size:14px;flex:1;min-width:250px}
    .filter-select{padding:12px 15px;border:none;border-radius:10px;background:rgba(255,255,255,0.9);color:#003366;font-size:14px}
    .btn{padding:12px 20px;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:all 0.3s ease;font-size:14px;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
    .btn-secondary{background:linear-gradient(45deg,#2196F3,#1976D2);color:white}
    .btn-warning{background:linear-gradient(45deg,#ff9800,#f57c00);color:white}
    .btn-danger{background:linear-gradient(45deg,#f44336,#d32f2f);color:white}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.3)}
    .users-table{width:100%;background:rgba(255,255,255,0.95);border-radius:15px;overflow:hidden;color:#003366;box-shadow:0 5px 15px rgba(0,0,0,0.2)}
    .users-table th,.users-table td{padding:15px 12px;text-align:left;border-bottom:1px solid rgba(0,51,102,0.1)}
    .users-table th{background:#003366;color:white;font-weight:bold;font-size:14px}
    .users-table tr:hover{background:rgba(255,215,0,0.1)}
    .status-badge{display:inline-block;padding:6px 12px;border-radius:20px;font-size:11px;font-weight:bold;text-transform:uppercase}
    .badge-active{background:#4CAF50;color:white}
    .badge-inactive{background:#f44336;color:white}
    .badge-pending{background:#ff9800;color:white}
    .badge-admin{background:#FFD700;color:#003366}
    .badge-user{background:#2196F3;color:white}
    .action-buttons{display:flex;gap:8px;flex-wrap:wrap}
    .action-btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:500;transition:all 0.3s ease}
    .action-btn:hover{transform:scale(1.05)}
    .loading{text-align:center;padding:40px;font-size:18px}
    .loading-spinner{display:inline-block;width:40px;height:40px;border:4px solid rgba(255,255,255,0.3);border-radius:50%;border-top:4px solid #FFD700;animation:spin 1s linear infinite;margin-bottom:10px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .message{padding:15px 20px;border-radius:10px;margin-bottom:20px;font-weight:500;border-left:5px solid}
    .message.success{background:rgba(76,175,80,0.2);border-color:#4CAF50;color:#4CAF50}
    .message.error{background:rgba(244,67,54,0.2);border-color:#f44336;color:#f44336}
    .message.info{background:rgba(33,150,243,0.2);border-color:#2196F3;color:#2196F3}
    .message.warning{background:rgba(255,193,7,0.2);border-color:#ffc107;color:#ffc107}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;backdrop-filter:blur(5px)}
    .modal.show{display:flex;justify-content:center;align-items:center}
    .modal-content{background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;max-width:600px;width:90%;color:#003366;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #ddd}
    .modal-title{font-size:1.3rem;font-weight:bold;color:#003366}
    .close-btn{background:none;border:none;font-size:28px;cursor:pointer;color:#666;font-weight:bold}
    .close-btn:hover{color:#f44336}
    .form-group{margin-bottom:20px}
    .form-label{display:block;margin-bottom:8px;font-weight:600;color:#003366}
    .form-input{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px;transition:border-color 0.3s ease}
    .form-input:focus{outline:none;border-color:#4CAF50}
    .activities-container{max-height:400px;overflow-y:auto;background:rgba(255,255,255,0.95);border-radius:10px;padding:15px}
    .activity-item{padding:12px;border-bottom:1px solid rgba(0,51,102,0.1);display:flex;justify-content:space-between;align-items:center;color:#003366}
    .activity-item:last-child{border-bottom:none}
    .activity-info{flex:1}
    .activity-user{font-weight:bold;color:#003366}
    .activity-action{margin-top:4px;font-size:13px;color:#666}
    .activity-time{font-size:12px;color:#999;text-align:right}
    .pending-users-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:15px}
    .pending-card{background:rgba(255,193,7,0.1);border:2px solid rgba(255,193,7,0.3);border-radius:12px;padding:20px;transition:all 0.3s ease}
    .pending-card:hover{transform:translateY(-3px);box-shadow:0 5px 15px rgba(255,193,7,0.2)}
    .pending-header{display:flex;justify-content:between;align-items:center;margin-bottom:15px}
    .pending-name{font-size:1.1rem;font-weight:bold;color:#f57c00}
    .pending-details{margin-bottom:15px;line-height:1.6}
    .pending-actions{display:flex;gap:10px}
    .toggle-switch{position:relative;display:inline-block;width:50px;height:25px}
    .toggle-switch input{opacity:0;width:0;height:0}
    .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.4s;border-radius:25px}
    .toggle-slider:before{position:absolute;content:"";height:19px;width:19px;left:3px;bottom:3px;background:white;transition:.4s;border-radius:50%}
    input:checked+.toggle-slider{background:#4CAF50}
    input:checked+.toggle-slider:before{transform:translateX(25px)}
    .volume-slider{-webkit-appearance:none;appearance:none;height:6px;border-radius:5px;background:#ddd;outline:none;opacity:0.7;transition:opacity .2s}
    .volume-slider:hover{opacity:1}
    .volume-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:#4CAF50;cursor:pointer}
    .volume-slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:#4CAF50;cursor:pointer}
    @media(max-width:768px){.header{flex-direction:column;gap:15px}.controls{flex-direction:column}.stats-grid{grid-template-columns:repeat(2,1fr)}.users-table{font-size:12px}.users-table th,.users-table td{padding:8px 6px}.action-buttons{flex-direction:column}.nav-links{flex-direction:column;width:100%}}
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">üî• Firebase Admin Dashboard</div>
    <div class="user-info">
      <div class="nav-links">
        <a href="index.html" class="nav-btn">üìä PBCR</a>
        <a href="plcr.html" class="nav-btn">‚öóÔ∏è PLCR</a>
        <a href="NMOGASBL.html" class="nav-btn">üîß NMOGAS</a>
      </div>
      <div class="user-avatar" id="userAvatar">F</div>
      <div>
        <div id="userName" style="font-weight:bold">Loading...</div>
        <div id="userEmail" style="font-size:0.8rem;opacity:0.7">Loading...</div>
      </div>
      <button class="logout-btn" onclick="logout()">üö™ Logout</button>
    </div>
  </div>

  <div class="container">
    <div class="admin-banner">
      <div class="admin-badge">üî• FIREBASE ADMIN CONTROL</div>
      <h2>üéõÔ∏è Master User Management System</h2>
      <p>Real-time Firebase database with advanced user controls</p>
      <p id="currentTime" style="margin-top:10px;opacity:0.8"></p>
    </div>

    <!-- Notification Settings Panel -->
    <div class="section">
      <div class="section-title">üîä Notification Settings</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;align-items:end;">
        
        <div class="form-group">
          <label class="form-label">üéµ Alert Sound:</label>
          <select class="form-input" id="notificationSound">
            <option value="alarm1">üö® Alarm 1 (Emergency)</option>
            <option value="alarm2">‚è∞ Alarm 2 (Classic)</option>
            <option value="beep">üì¢ Beep (Continuous)</option>
            <option value="bell">üîî Bell (Ring)</option>
            <option value="siren">üöì Siren (Police)</option>
            <option value="phone">üì± Phone Ring</option>
            <option value="custom">üéº Custom Sound</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">üîä Volume: <span id="volumeDisplay">70%</span></label>
          <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70" 
                 style="width:100%;height:6px;border-radius:5px;background:#ddd;outline:none;">
        </div>

        <div class="form-group">
          <label class="form-label">üì≥ Vibration:</label>
          <div style="display:flex;align-items:center;gap:10px;">
            <label class="toggle-switch">
              <input type="checkbox" id="vibrationToggle" checked>
              <span class="toggle-slider"></span>
            </label>
            <span id="vibrationStatus">ON</span>
          </div>
        </div>

        <div class="form-group">
          <button class="btn btn-secondary" onclick="testSound()" style="margin-top:0;">
            üéµ Test Sound
          </button>
        </div>

        <div class="form-group">
          <button class="btn btn-primary" onclick="saveNotificationSettings()" style="margin-top:0;">
            üíæ Save Settings
          </button>
        </div>

      </div>

      <!-- Custom Sound Upload -->
      <div id="customSoundSection" style="display:none;margin-top:20px;padding:15px;background:rgba(255,255,255,0.05);border-radius:10px;">
        <label class="form-label">üìÅ Upload Custom Sound (MP3, WAV):</label>
        <input type="file" id="customSoundFile" accept="audio/*" class="form-input" style="padding:8px;">
        <small style="color:#ccc;font-size:12px;display:block;margin-top:5px;">
          ‚ö†Ô∏è Keep file size under 2MB for best performance
        </small>
      </div>

    </div>

    <div class="notification-banner" id="notificationBanner">
      <span id="notificationText">üîî Notifications enabled for new user registrations</span>
      <button onclick="showPendingUsers()" style="background:rgba(255,193,7,0.3);border:1px solid rgba(255,193,7,0.8);color:#ffc107;padding:8px 15px;border-radius:5px;margin-left:15px;cursor:pointer;font-weight:bold;">
        Review Now
      </button>
    </div>

    <div id="messageContainer"></div>

    <!-- Statistics -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalUsers">-</div>
        <div class="stat-label">Total Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="activeUsers">-</div>
        <div class="stat-label">Active Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pendingUsers">-</div>
        <div class="stat-label">Pending Approval</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="todayLogins">-</div>
        <div class="stat-label">Today's Logins</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalActivities">-</div>
        <div class="stat-label">Total Activities</div>
      </div>
    </div>

    <!-- User Management Section -->
    <div class="section">
      <div class="section-title">üë• User Management</div>
      
      <div class="controls">
        <input type="text" class="search-box" id="userSearch" placeholder="üîç Search users by name, username, or email...">
        <select class="filter-select" id="statusFilter">
          <option value="all">All Status</option>
          <option value="active">Active Only</option>
          <option value="inactive">Inactive Only</option>
          <option value="pending">Pending Approval</option>
        </select>
        <select class="filter-select" id="roleFilter">
          <option value="all">All Roles</option>
          <option value="admin">Admins</option>
          <option value="user">Users</option>
        </select>
        <button class="btn btn-primary" onclick="loadDashboardData()">üîÑ Refresh</button>
        <button class="btn btn-warning" onclick="showPendingUsers()">‚è≥ Pending</button>
      </div>

      <div id="usersContainer">
        <div class="loading">
          <div class="loading-spinner"></div>
          <div>Loading users from Firebase...</div>
        </div>
      </div>
    </div>

    <!-- Recent Activities -->
    <div class="section">
      <div class="section-title">üìã Recent Activities</div>
      <div id="activitiesContainer">
        <div class="loading">
          <div class="loading-spinner"></div>
          <div>Loading activities...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Edit Modal -->
  <div id="userModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Edit User</h3>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <form id="userForm">
        <div class="form-group">
          <label class="form-label">Full Name:</label>
          <input type="text" class="form-input" id="editFullName" required>
        </div>
        <div class="form-group">
          <label class="form-label">Username:</label>
          <input type="text" class="form-input" id="editUsername" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Email:</label>
          <input type="email" class="form-input" id="editEmail" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Role:</label>
          <select class="form-input" id="editRole">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Status:</label>
          <select class="form-input" id="editStatus">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">New Password (Optional):</label>
          <input type="password" class="form-input" id="editPassword" placeholder="Leave empty to keep current">
        </div>
        <div style="display:flex;gap:15px;justify-content:flex-end;margin-top:25px">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Pending Users Modal -->
  <div id="pendingModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">‚è≥ Pending User Approvals</h3>
        <button class="close-btn" onclick="closePendingModal()">&times;</button>
      </div>
      <div id="pendingUsersContainer">
        <div class="loading">
          <div class="loading-spinner"></div>
          <div>Loading pending users...</div>
        </div>
      </div>
      <div style="margin-top:20px;text-align:center">
        <button class="btn btn-primary" onclick="approveAllPending()">‚úÖ Approve All</button>
        <button class="btn btn-secondary" onclick="closePendingModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs, addDoc, serverTimestamp, query, orderBy, limit, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Make Firebase functions globally available
    window.db = db;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.collection = collection;
    window.getDocs = getDocs;
    window.addDoc = addDoc;
    window.serverTimestamp = serverTimestamp;
    window.query = query;
    window.orderBy = orderBy;
    window.limit = limit;
    window.where = where;

    console.log('üî• Firebase Dashboard initialized successfully!');
  </script>

  <script>
    let currentUser = null;
    let currentEditingUser = null;
    let allUsers = [];
    let allActivities = [];

    // Push Notifications Setup - Enhanced with Custom Settings
    async function setupNotifications(){
      if(!('Notification'in window)||!('serviceWorker'in navigator))return;
      
      try {
        // Load saved notification settings
        loadNotificationSettings();
        
        // Register service worker first
        const registration = await navigator.serviceWorker.register('/sw.js');
        console.log('‚úÖ Service Worker registered for push notifications');
        
        // Request notification permission
        const permission = await Notification.requestPermission();
        
        if(permission==='granted'){
          document.getElementById('notificationBanner').classList.add('show');
          localStorage.setItem('admin_notifications','enabled');
          
          // Test notification with saved settings
          showAlarmNotification('üîî Tank Tools Admin Alerts', 'Custom notification system enabled with your settings');
          
          console.log('‚úÖ Custom notifications enabled');
        } else {
          console.log('‚ùå Notification permission denied');
        }
      } catch(error) {
        console.error('‚ùå Error setting up notifications:', error);
      }
    }

    // Enhanced Alarm-Style Notification
    function showAlarmNotification(title, body, data = {}) {
      if(Notification.permission !== 'granted') return;
      
      // Close any existing notifications first
      navigator.serviceWorker.ready.then(registration => {
        registration.getNotifications().then(notifications => {
          notifications.forEach(notification => notification.close());
        });
      });
      
      const notification = new Notification(title, {
        body,
        icon: '/icon.png',
        badge: '/icon.png',
        tag: 'admin-alarm-notification',
        requireInteraction: true,  // Must interact to dismiss
        persistent: true,          // Stays until dismissed
        renotify: true,           // Can renotify with same tag
        silent: false,            // Play sound
        timestamp: Date.now(),
        vibrate: [500, 200, 500, 200, 500, 200, 500], // Long vibration pattern
        actions: [
          {
            action: 'review_now',
            title: 'üîç Review Now',
            icon: '/icon.png'
          },
          {
            action: 'snooze',
            title: '‚è∞ Remind Later',
            icon: '/icon.png'
          },
          {
            action: 'dismiss',
            title: '‚ùå Dismiss',
            icon: '/icon.png'
          }
        ],
        data: {
          ...data,
          timestamp: Date.now(),
          alarmStyle: true,
          priority: 'high'
        }
      });
      
      // Handle notification click
      notification.onclick = () => {
        window.focus();
        if(data.action === 'pending') showPendingUsers();
        notification.close();
        stopAlarmSound(); // Stop any alarm sounds
      };
      
      // Start alarm sound loop
      startAlarmSound();
      
      // Auto-renotify every 10 seconds if not dismissed (alarm style)
      const renotifyInterval = setInterval(() => {
        if(document.hidden && Notification.permission === 'granted') {
          // Create new notification if page is hidden
          const alarmNotification = new Notification(title + ' (Reminder)', {
            body: body + ' - Please check immediately!',
            icon: '/icon.png',
            tag: 'admin-alarm-repeat',
            requireInteraction: true,
            renotify: true,
            vibrate: [1000, 300, 1000, 300, 1000],
            data: data
          });
          
          alarmNotification.onclick = () => {
            window.focus();
            if(data.action === 'pending') showPendingUsers();
            alarmNotification.close();
            clearInterval(renotifyInterval);
            stopAlarmSound();
          };
        } else {
          // Stop renotifying if page is visible
          clearInterval(renotifyInterval);
          stopAlarmSound();
        }
      }, 10000); // Repeat every 10 seconds
      
      // Clear interval when notification is closed
      notification.onclose = () => {
        clearInterval(renotifyInterval);
        stopAlarmSound();
      };
      
      // Store interval reference to clear later
      window.currentAlarmInterval = renotifyInterval;
    }

    // Alarm Sound System
    let alarmAudio = null;
    let alarmInterval = null;

    function startAlarmSound() {
      stopAlarmSound(); // Stop any existing alarm
      
      try {
        // Create audio element for alarm sound
        alarmAudio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEeCarS6+iZRQoMVa3s6aJPFAxPo+OhpmIgGGw');
        alarmAudio.loop = true;
        alarmAudio.volume = 0.7;
        
        // Try to play (might be blocked by browser policy)
        const playPromise = alarmAudio.play();
        if (playPromise !== undefined) {
          playPromise.catch(() => {
            console.log('Audio autoplay blocked - user interaction required');
          });
        }
        
        // Backup: Use Web Audio API for more persistent sound
        createWebAudioAlarm();
        
      } catch(error) {
        console.log('Audio creation failed, using backup method');
        createWebAudioAlarm();
      }
    }

    function stopAlarmSound() {
      if(alarmAudio) {
        alarmAudio.pause();
        alarmAudio = null;
      }
      if(alarmInterval) {
        clearInterval(alarmInterval);
        alarmInterval = null;
      }
      if(window.currentAlarmInterval) {
        clearInterval(window.currentAlarmInterval);
        window.currentAlarmInterval = null;
      }
    }

    function createWebAudioAlarm() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playBeep() {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = 800; // High pitch like alarm
          oscillator.type = 'square';
          
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
          
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.5);
        }
        
        // Play beep every 1 second
        alarmInterval = setInterval(playBeep, 1000);
        playBeep(); // Play immediately
        
      } catch(error) {
        console.log('Web Audio API not supported');
      }
    }

    function showAdminNotification(title,body,data={}){
      if(Notification.permission!=='granted')return;
      
      // Use alarm-style notification for admin alerts
      showAlarmNotification(title, body, data);
    }

    window.addEventListener('message',event=>{
      if(event.data&&event.data.type==='NEW_USER_REGISTERED'){
        const{username,fullName}=event.data;
        
        // Show persistent alarm-style notification
        showAlarmNotification(
          'üö® URGENT: New User Registration', 
          `${fullName||username} is waiting for approval - Action Required!`,
          {action:'pending', username, fullName, urgent: true}
        );
        
        // Reload dashboard data to show new user immediately
        setTimeout(() => {
          loadDashboardData();
        }, 1000);
      }
    });

    // Check admin access
    function checkAdminAccess() {
      const session = sessionStorage.getItem('tanktools_session');
      const userData = localStorage.getItem('tanktools_current_user');
      
      if (session !== 'active' || !userData) {
        showMessage('‚ùå No active session. Redirecting to login...', 'error');
        setTimeout(() => window.location.href = 'login.html', 2000);
        return false;
      }
      
      try {
        currentUser = JSON.parse(userData);
        if (currentUser.username !== 'fam030' && currentUser.role !== 'admin') {
          showMessage('‚ùå Access Denied! Admin privileges required.', 'error');
          setTimeout(() => window.location.href = 'index.html', 2000);
          return false;
        }
        
        // Update UI with admin info
        document.getElementById('userName').textContent = currentUser.fullName || currentUser.username;
        document.getElementById('userEmail').textContent = currentUser.email || `${currentUser.username}@knpc.com`;
        const firstLetter = (currentUser.fullName || currentUser.username).charAt(0).toUpperCase();
        document.getElementById('userAvatar').textContent = firstLetter;
        
        return true;
      } catch (error) {
        console.error('Error checking admin access:', error);
        showMessage('‚ùå Session error. Redirecting to login...', 'error');
        setTimeout(() => window.location.href = 'login.html', 2000);
        return false;
      }
    }

    // Load dashboard data
    async function loadDashboardData() {
      if (!checkAdminAccess()) return;
      
      showMessage('üîÑ Loading dashboard data from Firebase...', 'info');
      
      try {
        // Load users with real-time listener
        const usersSnapshot = await getDocs(collection(db, 'users'));
        allUsers = [];
        
        usersSnapshot.forEach((doc) => {
          const userData = { id: doc.id, ...doc.data() };
          allUsers.push(userData);
        });

        console.log('üìä Loaded users from Firebase:', allUsers.length);
        console.log('üìä User details:', allUsers);

        // Load activities with real-time listener  
        const activitiesSnapshot = await getDocs(
          query(collection(db, 'activities'), orderBy('timestamp', 'desc'), limit(50))
        );
        allActivities = [];
        
        activitiesSnapshot.forEach((doc) => {
          const activityData = { id: doc.id, ...doc.data() };
          allActivities.push(activityData);
        });

        console.log('üìä Loaded activities from Firebase:', allActivities.length);

        // Update statistics
        updateStatistics();
        
        // Display users
        displayUsers(allUsers);
        
        // Display activities
        displayActivities(allActivities);
        
        // Check for pending users and show notification banner
        const pendingCount = allUsers.filter(u => !u.isActive).length;
        if (pendingCount > 0) {
          document.getElementById('notificationText').textContent = `üîî ${pendingCount} users waiting for approval - Click "Pending" to review`;
          document.getElementById('notificationBanner').classList.add('show');
        }
        
        showMessage('‚úÖ Dashboard data loaded successfully!', 'success');
        
        // Add activity log
        await addActivity('admin_dashboard_loaded', currentUser.username);
        
      } catch (error) {
        console.error('‚ùå Error loading dashboard:', error);
        showMessage('‚ùå Error loading data: ' + error.message, 'error');
      }
    }

    // Update statistics
    function updateStatistics() {
      const totalUsers = allUsers.length;
      const activeUsers = allUsers.filter(u => u.isActive).length;
      const pendingUsers = allUsers.filter(u => !u.isActive).length;
      
      // Calculate today's logins
      const today = new Date().toDateString();
      const todayLogins = allActivities.filter(activity => {
        const activityDate = activity.timestamp?.toDate?.()?.toDateString() || 
                             new Date(activity.timestamp?.seconds * 1000).toDateString();
        return activityDate === today && activity.action === 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ';
      }).length;

      document.getElementById('totalUsers').textContent = totalUsers;
      document.getElementById('activeUsers').textContent = activeUsers;
      document.getElementById('pendingUsers').textContent = pendingUsers;
      document.getElementById('todayLogins').textContent = todayLogins;
      document.getElementById('totalActivities').textContent = allActivities.length;
    }

    // Display users in table
    function displayUsers(users) {
      const container = document.getElementById('usersContainer');
      
      if (users.length === 0) {
        container.innerHTML = '<div class="loading">No users found in Firebase database.</div>';
        return;
      }
      
      let html = `
        <table class="users-table">
          <thead>
            <tr>
              <th>Avatar</th>
              <th>Full Name</th>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Created</th>
              <th>Last Login</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      users.forEach(user => {
        const avatar = (user.fullName || user.username).charAt(0).toUpperCase();
        const role = user.role === 'admin' || user.username === 'fam030' ? 'admin' : 'user';
        const roleClass = role === 'admin' ? 'badge-admin' : 'badge-user';
        const statusClass = user.isActive ? 'badge-active' : 'badge-inactive';
        const statusText = user.isActive ? 'Active' : 'Pending';
        
        const createdDate = user.createdAt?.toDate?.() || new Date(user.createdAt?.seconds * 1000) || new Date();
        const lastLoginDate = user.lastLogin?.toDate?.() || (user.lastLogin ? new Date(user.lastLogin?.seconds * 1000) : null);
        
        html += `
          <tr>
            <td>
              <div style="width:35px;height:35px;border-radius:50%;background:${role === 'admin' ? '#FFD700' : '#4CAF50'};display:flex;align-items:center;justify-content:center;color:${role === 'admin' ? '#003366' : 'white'};font-weight:bold;">
                ${avatar}
              </div>
            </td>
            <td><strong>${user.fullName || user.username}</strong></td>
            <td>${user.username}</td>
            <td>${user.email}</td>
            <td><span class="status-badge ${roleClass}">${role}</span></td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${createdDate.toLocaleDateString()}</td>
            <td>${lastLoginDate ? lastLoginDate.toLocaleString() : 'Never'}</td>
            <td>
              <div class="action-buttons">
                ${user.username !== 'fam030' ? `
                  <button class="action-btn btn-primary" onclick="editUser('${user.username}')" title="Edit User">‚úèÔ∏è Edit</button>
                  <button class="action-btn ${user.isActive ? 'btn-warning' : 'btn-primary'}" onclick="toggleUserStatus('${user.username}')" title="${user.isActive ? 'Deactivate' : 'Activate'} User">
                    ${user.isActive ? '‚ùå Deactivate' : '‚úÖ Activate'}
                  </button>
                  <button class="action-btn btn-danger" onclick="deleteUser('${user.username}')" title="Delete User">üóëÔ∏è Delete</button>
                ` : '<span class="status-badge badge-admin">üîí MASTER</span>'}
              </div>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Display activities
    function displayActivities(activities) {
      const container = document.getElementById('activitiesContainer');
      
      if (activities.length === 0) {
        container.innerHTML = '<div class="activities-container"><p style="text-align:center;color:#666;padding:20px;">No activities found.</p></div>';
        return;
      }
      
      let html = '<div class="activities-container">';
      
      activities.forEach(activity => {
        const timestamp = activity.timestamp?.toDate?.() || new Date(activity.timestamp?.seconds * 1000) || new Date();
        const timeStr = timestamp.toLocaleString();
        
        html += `
          <div class="activity-item">
            <div class="activity-info">
              <div class="activity-user">üë§ ${activity.username || 'System'}</div>
              <div class="activity-action">üìù ${activity.action}</div>
            </div>
            <div class="activity-time">‚è∞ ${timeStr}</div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    // Edit user
    function editUser(username) {
      const user = allUsers.find(u => u.username === username);
      if (!user) {
        showMessage('‚ùå User not found!', 'error');
        return;
      }
      
      currentEditingUser = user;
      
      document.getElementById('modalTitle').textContent = `Edit User: ${user.username}`;
      document.getElementById('editFullName').value = user.fullName || '';
      document.getElementById('editUsername').value = user.username;
      document.getElementById('editEmail').value = user.email;
      document.getElementById('editRole').value = user.role || 'user';
      document.getElementById('editStatus').value = user.isActive ? 'true' : 'false';
      document.getElementById('editPassword').value = '';
      
      document.getElementById('userModal').classList.add('show');
    }

    // Close modal
    function closeModal() {
      document.getElementById('userModal').classList.remove('show');
      currentEditingUser = null;
    }

    // Handle form submission
    document.getElementById('userForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!currentEditingUser) return;
      
      const fullName = document.getElementById('editFullName').value;
      const role = document.getElementById('editRole').value;
      const isActive = document.getElementById('editStatus').value === 'true';
      const newPassword = document.getElementById('editPassword').value;
      
      try {
        const updateData = {
          fullName: fullName,
          role: role,
          isActive: isActive
        };
        
        if (newPassword) {
          updateData.password = newPassword; // Store plain text for now
        }
        
        await updateDoc(doc(db, 'users', currentEditingUser.username), updateData);
        
        await addActivity('user_updated_by_admin', currentUser.username);
        
        showMessage('‚úÖ User updated successfully!', 'success');
        closeModal();
        loadDashboardData(); // Refresh data
        
      } catch (error) {
        console.error('Error updating user:', error);
        showMessage('‚ùå Error updating user: ' + error.message, 'error');
      }
    });

    // Toggle user status
    async function toggleUserStatus(username) {
      const user = allUsers.find(u => u.username === username);
      if (!user || user.username === 'fam030') return;
      
      const newStatus = !user.isActive;
      
      try {
        await updateDoc(doc(db, 'users', username), {
          isActive: newStatus
        });
        
        await addActivity(newStatus ? 'user_activated_by_admin' : 'user_deactivated_by_admin', currentUser.username);
        
        showMessage(`‚úÖ User ${username} ${newStatus ? 'activated' : 'deactivated'} successfully!`, 'success');
        loadDashboardData(); // Refresh data
        
      } catch (error) {
        console.error('Error toggling user status:', error);
        showMessage('‚ùå Error updating user status: ' + error.message, 'error');
      }
    }

    // Delete user
    async function deleteUser(username) {
      if (username === 'fam030') {
        showMessage('‚ùå Cannot delete master admin account!', 'error');
        return;
      }
      
      if (!confirm(`Are you sure you want to delete user "${username}"?\n\nThis action cannot be undone!`)) {
        return;
      }
      
      try {
        await deleteDoc(doc(db, 'users', username));
        
        await addActivity('user_deleted_by_admin', currentUser.username);
        
        showMessage(`‚úÖ User ${username} deleted successfully!`, 'success');
        loadDashboardData(); // Refresh data
        
      } catch (error) {
        console.error('Error deleting user:', error);
        showMessage('‚ùå Error deleting user: ' + error.message, 'error');
      }
    }

    // Show pending users
    function showPendingUsers() {
      const pendingUsers = allUsers.filter(u => !u.isActive);
      const container = document.getElementById('pendingUsersContainer');
      
      if (pendingUsers.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">No pending users found.</p>';
      } else {
        let html = '<div class="pending-users-grid">';
        
        pendingUsers.forEach(user => {
          const createdDate = user.createdAt?.toDate?.() || new Date(user.createdAt?.seconds * 1000) || new Date();
          
          html += `
            <div class="pending-card">
              <div class="pending-header">
                <div class="pending-name">${user.fullName || user.username}</div>
              </div>
              <div class="pending-details">
                <div><strong>Username:</strong> ${user.username}</div>
                <div><strong>Email:</strong> ${user.email}</div>
                <div><strong>Registered:</strong> ${createdDate.toLocaleString()}</div>
              </div>
              <div class="pending-actions">
                <button class="btn btn-primary" onclick="approveUser('${user.username}')">‚úÖ Approve</button>
                <button class="btn btn-secondary" onclick="sendActivationEmail('${user.username}')">üìß Send Email</button>
                <button class="btn btn-danger" onclick="deleteUser('${user.username}')">‚ùå Reject</button>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        container.innerHTML = html;
      }
      
      document.getElementById('pendingModal').classList.add('show');
    }

    // Close pending modal
    function closePendingModal() {
      document.getElementById('pendingModal').classList.remove('show');
    }

    // Send activation email
    async function sendActivationEmail(username) {
      const user = allUsers.find(u => u.username === username);
      if (!user) return;
      
      try {
        // Generate new token if doesn't exist
        const verificationToken = user.emailVerificationToken || generateToken();
        
        if (!user.emailVerificationToken) {
          await updateDoc(doc(db, 'users', username), {
            emailVerificationToken: verificationToken
          });
        }
        
        // Add to email queue
        await addDoc(collection(db, 'emailQueue'), {
          type: 'activation',
          to: user.email,
          username: username,
          fullName: user.fullName,
          token: verificationToken,
          timestamp: serverTimestamp(),
          status: 'pending'
        });
        
        showMessage(`üìß Activation email queued for ${username}!`, 'success');
        
        await addActivity('activation_email_sent_by_admin', currentUser.username);
        
      } catch (error) {
        console.error('Error sending activation email:', error);
        showMessage('‚ùå Error sending email: ' + error.message, 'error');
      }
    }

    // Generate token
    function generateToken() {
      return Math.random().toString(36).substring(2) + Date.now().toString(36);
    }

    // Approve user
    async function approveUser(username) {
      try {
        await updateDoc(doc(db, 'users', username), {
          isActive: true
        });
        
        await addActivity('user_approved_by_admin', currentUser.username);
        
        showMessage(`‚úÖ User ${username} approved successfully!`, 'success');
        loadDashboardData(); // Refresh data
        showPendingUsers(); // Refresh modal
        
      } catch (error) {
        console.error('Error approving user:', error);
        showMessage('‚ùå Error approving user: ' + error.message, 'error');
      }
    }

    // Approve all pending users
    async function approveAllPending() {
      const pendingUsers = allUsers.filter(u => !u.isActive);
      
      if (pendingUsers.length === 0) {
        showMessage('‚ÑπÔ∏è No pending users to approve.', 'info');
        return;
      }
      
      if (!confirm(`Approve all ${pendingUsers.length} pending users?`)) {
        return;
      }
      
      try {
        const promises = pendingUsers.map(user => 
          updateDoc(doc(db, 'users', user.username), { isActive: true })
        );
        
        await Promise.all(promises);
        
        await addActivity('bulk_approval_by_admin', currentUser.username);
        
        showMessage(`‚úÖ ${pendingUsers.length} users approved successfully!`, 'success');
        loadDashboardData(); // Refresh data
        closePendingModal();
        
      } catch (error) {
        console.error('Error approving all users:', error);
        showMessage('‚ùå Error approving users: ' + error.message, 'error');
      }
    }

    // Filter users
    function filterUsers() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const roleFilter = document.getElementById('roleFilter').value;
      
      let filteredUsers = allUsers.filter(user => {
        const matchesSearch = (user.fullName || '').toLowerCase().includes(searchTerm) ||
                             user.username.toLowerCase().includes(searchTerm) ||
                             user.email.toLowerCase().includes(searchTerm);
        
        const matchesStatus = statusFilter === 'all' ||
                             (statusFilter === 'active' && user.isActive) ||
                             (statusFilter === 'inactive' && !user.isActive) ||
                             (statusFilter === 'pending' && !user.isActive);
        
        const userRole = user.role === 'admin' || user.username === 'fam030' ? 'admin' : 'user';
        const matchesRole = roleFilter === 'all' ||
                           (roleFilter === 'admin' && userRole === 'admin') ||
                           (roleFilter === 'user' && userRole === 'user');
        
        return matchesSearch && matchesStatus && matchesRole;
      });
      
      displayUsers(filteredUsers);
    }

    // Add activity to Firebase
    async function addActivity(action, username) {
      try {
        await addDoc(collection(db, 'activities'), {
          action: action,
          username: username,
          timestamp: serverTimestamp(),
          ip: 'admin-dashboard',
          userAgent: navigator.userAgent.substring(0, 100)
        });
      } catch (error) {
        console.error('Error adding activity:', error);
      }
    }

    // Update current time
    function updateCurrentTime() {
      const now = new Date();
      const timeString = now.toLocaleString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      document.getElementById('currentTime').textContent = timeString;
    }

    // Show message
    function showMessage(message, type) {
      const container = document.getElementById('messageContainer');
      container.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => container.innerHTML = '', 7000);
    }

    // Logout
    function logout() {
      localStorage.removeItem('tanktools_current_user');
      sessionStorage.removeItem('tanktools_session');
      window.location.href = 'login.html';
    }

    // Initialize dashboard
    window.addEventListener('load', () => {
      updateCurrentTime();
      setInterval(updateCurrentTime, 60000);
      
      // Add event listeners
      document.getElementById('userSearch').addEventListener('input', filterUsers);
      document.getElementById('statusFilter').addEventListener('change', filterUsers);
      document.getElementById('roleFilter').addEventListener('change', filterUsers);
      
      // Setup notifications first (with service worker)
      setupNotifications();
      
      // Auto-refresh every 30 seconds to catch new users
      setInterval(loadDashboardData, 30000);
      
      // Load data after Firebase initialization
      setTimeout(loadDashboardData, 1000);
      
      // Handle page visibility changes for alarm notifications
      document.addEventListener('visibilitychange', () => {
        if(!document.hidden) {
          // Stop alarm sounds when page becomes visible
          stopAllSounds();
        }
      });
      
      // Handle window focus for alarm notifications
      window.addEventListener('focus', () => {
        stopAllSounds();
      });
      
      // Load notification settings on page load
      setTimeout(loadNotificationSettings, 500);
    });

    // Make functions globally available
    window.loadDashboardData = loadDashboardData;
    window.editUser = editUser;
    window.closeModal = closeModal;
    window.toggleUserStatus = toggleUserStatus;
    window.deleteUser = deleteUser;
    window.showPendingUsers = showPendingUsers;
    window.closePendingModal = closePendingModal;
    window.approveUser = approveUser;
    window.approveAllPending = approveAllPending;
    window.sendActivationEmail = sendActivationEmail;
    window.logout = logout;

    console.log('%cüî• FIREBASE ADMIN DASHBOARD v4.0 - WITH NOTIFICATIONS', 'color:orange;font-size:20px;font-weight:bold');
    console.log('%cDeveloper: Fahad - 17877', 'color:green;font-size:16px');
    console.log('%cReal-time Firebase Integration + Push Notifications', 'color:blue;font-size:14px');
  </script>
</body>
</html>