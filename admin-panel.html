<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <script type="module">
        import{initializeApp}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import{getFirestore,doc,getDoc,setDoc,updateDoc,deleteDoc,collection,getDocs,addDoc,query,orderBy,where}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        const app=initializeApp({apiKey:"AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",authDomain:"tank-tools-knpc-c2d95.firebaseapp.com",projectId:"tank-tools-knpc-c2d95",storageBucket:"tank-tools-knpc-c2d95.firebasestorage.app",messagingSenderId:"510062594324",appId:"1:510062594324:web:b892fd02007a5ca2f0da01"});
        window.db=getFirestore(app);window.doc=doc;window.getDoc=getDoc;window.setDoc=setDoc;window.updateDoc=updateDoc;window.deleteDoc=deleteDoc;window.collection=collection;window.getDocs=getDocs;window.addDoc=addDoc;window.query=query;window.orderBy=orderBy;window.where=where;
    </script>
    <script src="permissions.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tab.active {
            background: white;
            border-bottom-color: #007bff;
            color: #007bff;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            background: #007bff;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .user-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .user-card:hover {
            border-color: #007bff;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .user-card.admin {
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }
        
        .user-card.operator {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fffbf0 0%, #fef5e7 100%);
        }
        
        .user-card.viewer {
            border-color: #28a745;
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
        }
        
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .user-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .user-role {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            color: white;
        }
        
        .role-admin {
            background: #dc3545;
        }
        
        .role-operator {
            background: #ffc107;
            color: #212529;
        }
        
        .role-viewer {
            background: #28a745;
        }
        
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .permission-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #dee2e6;
        }
        
        .permission-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-item label {
            cursor: pointer;
            margin: 0;
            font-weight: normal;
        }
        
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            background: #007bff;
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        .close:hover {
            opacity: 0.7;
        }
        
        .template-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .template-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .template-card:hover {
            border-color: #007bff;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .template-card.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        .template-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .template-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .template-desc {
            color: #666;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .users-grid {
                grid-template-columns: 1fr;
            }
            
            .permissions-grid {
                grid-template-columns: 1fr;
            }
            
            .template-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🛡️ Admin Panel</h1>
            <p>إدارة المستخدمين والصلاحيات - Tank Tools System</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('users')">👥 إدارة المستخدمين</button>
            <button class="nav-tab" onclick="showTab('permissions')">🔐 قوالب الصلاحيات</button>
            <button class="nav-tab" onclick="showTab('settings')">⚙️ الإعدادات</button>
        </div>
        
        <!-- Users Tab -->
        <div id="users" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    👥 المستخدمين الحاليين
                    <button class="btn btn-success" style="float: left;" onclick="showAddUserModal()">➕ إضافة مستخدم</button>
                </div>
                <div class="card-body">
                    <div id="usersGrid" class="users-grid">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Permissions Tab -->
        <div id="permissions" class="tab-content">
            <div class="card">
                <div class="card-header">🔐 قوالب الصلاحيات</div>
                <div class="card-body">
                    <div class="template-cards">
                        <div class="template-card" onclick="showTemplateDetails('admin')">
                            <div class="template-icon">👑</div>
                            <div class="template-name">Admin</div>
                            <div class="template-desc">وصول كامل لجميع الميزات والبيانات</div>
                        </div>
                        <div class="template-card" onclick="showTemplateDetails('operator')">
                            <div class="template-icon">⚙️</div>
                            <div class="template-name">Operator</div>
                            <div class="template-desc">تشغيل محدود مع إمكانية التعديل</div>
                        </div>
                        <div class="template-card" onclick="showTemplateDetails('viewer')">
                            <div class="template-icon">👁️</div>
                            <div class="template-name">Viewer</div>
                            <div class="template-desc">مشاهدة فقط بدون تعديل</div>
                        </div>
                    </div>
                    <div id="templateDetails"></div>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="card">
                <div class="card-header">⚙️ إعدادات النظام</div>
                <div class="card-body">
                    <div class="form-group">
                        <label>🔄 تحديث البيانات من Firebase</label>
                        <button class="btn btn-primary" onclick="refreshData()">تحديث البيانات</button>
                    </div>
                    <div class="form-group">
                        <label>📊 إحصائيات النظام</label>
                        <div id="systemStats"></div>
                    </div>
                    <div class="form-group">
                        <label>🗑️ إدارة البيانات</label>
                        <button class="btn btn-warning" onclick="exportData()">تصدير البيانات</button>
                        <button class="btn btn-danger" onclick="resetPermissions()">إعادة تعيين الصلاحيات</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>➕ إضافة مستخدم جديد</h2>
                <button class="close" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-group">
                        <label>اسم المستخدم (User ID)</label>
                        <input type="text" id="newUserId" class="form-control" placeholder="مثال: fam030" required>
                    </div>
                    <div class="form-group">
                        <label>الاسم الكامل</label>
                        <input type="text" id="newUserName" class="form-control" placeholder="مثال: فهد الماري" required>
                    </div>
                    <div class="form-group">
                        <label>البريد الإلكتروني</label>
                        <input type="email" id="newUserEmail" class="form-control" placeholder="مثال: fahad@knpc.com">
                    </div>
                    <div class="form-group">
                        <label>نوع الصلاحية</label>
                        <select id="newUserRole" class="form-control" required>
                            <option value="">اختر نوع الصلاحية</option>
                            <option value="admin">Admin - وصول كامل</option>
                            <option value="operator">Operator - تشغيل محدود</option>
                            <option value="viewer">Viewer - مشاهدة فقط</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>القسم</label>
                        <select id="newUserDepartment" class="form-control">
                            <option value="">اختر القسم</option>
                            <option value="PBCR">PBCR</option>
                            <option value="PLCR">PLCR</option>
                            <option value="NMOGAS">NMOGAS</option>
                            <option value="ALL">جميع الأقسام</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-success">✅ إضافة المستخدم</button>
                        <button type="button" class="btn btn-danger" onclick="closeModal('addUserModal')">❌ إلغاء</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✏️ تعديل صلاحيات المستخدم</h2>
                <button class="close" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="editUserContent">
                    <!-- User edit form will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <div id="status"></div>

    <script>
        let currentUser = null;
        let currentUsers = {};
        
        // Check admin access
        async function checkAdminAccess() {
            const session = sessionStorage.getItem('tanktools_session');
            const userData = localStorage.getItem('tanktools_current_user');
            
            if (session !== 'active' || !userData) {
                showStatus('❌ غير مصرح بالدخول. يتم التوجيه لصفحة تسجيل الدخول...', 'error');
                setTimeout(() => window.location.href = 'login.html', 3000);
                return false;
            }
            
            try {
                currentUser = JSON.parse(userData);
                
                // Initialize permissions manager
                if (!window.permissionsManager) {
                    window.permissionsManager = new PermissionsManager();
                }
                
                // Load user permissions
                await window.permissionsManager.loadUserPermissions(currentUser.username);
                
                // Check permissions before initializing
                const hasPermissions = await checkUserPermissions();
                if (!hasPermissions) {
                    showStatus('❌ غير مصرح بالدخول. صلاحيات غير كافية.', 'error');
                    setTimeout(() => window.location.href = 'index.html', 3000);
                    return false;
                }
                
                // Check admin panel access
                if (!checkPageAccess('admin')) {
                    return false;
                }
                
                // Check admin permissions using permissions manager
                if (!window.permissionsManager.hasPageAccess('admin') && 
                    !window.permissionsManager.hasPageAccess('dashboard')) {
                    showStatus('❌ غير مصرح بالدخول. صلاحيات إدارية مطلوبة.', 'error');
                    setTimeout(() => window.location.href = 'index.html', 3000);
                    return false;
                }
                
                return true;
            } catch (error) {
                showStatus('❌ خطأ في التحقق من الصلاحيات: ' + error.message, 'error');
                setTimeout(() => window.location.href = 'login.html', 3000);
                return false;
            }
        }
        
        // Initialize admin panel
        async function initializeAdminPanel() {
            const hasAccess = await checkAdminAccess();
            if (!hasAccess) return;
            
            await loadData();
            displayUsers();
            updateSystemStats();
            
            // Apply UI restrictions based on permissions
            window.permissionsManager.applyUIRestrictions();
            
            showStatus('✅ تم تحميل لوحة الإدارة بنجاح', 'success');
        }
        
        // Initialize on page load
        window.addEventListener('load', initializeAdminPanel);

        // Permission templates
        let permissionTemplates = {};

        async function loadData() {
            try {
                // Load users
                const usersDoc = await getDoc(doc(db, 'userPermissions', 'users'));
                if (usersDoc.exists()) {
                    currentUsers = usersDoc.data();
                }

                // Load permission templates
                const templatesDoc = await getDoc(doc(db, 'userPermissions', 'templates'));
                if (templatesDoc.exists()) {
                    permissionTemplates = templatesDoc.data();
                }

                showStatus('✅ تم تحميل البيانات بنجاح', 'success');
            } catch (error) {
                showStatus('❌ خطأ في تحميل البيانات: ' + error.message, 'error');
                console.error('Error loading data:', error);
            }
        }

        function displayUsers() {
            const usersGrid = document.getElementById('usersGrid');
            usersGrid.innerHTML = '';

            for (const [userId, userData] of Object.entries(currentUsers)) {
                const userCard = document.createElement('div');
                userCard.className = `user-card ${userData.role}`;
                userCard.innerHTML = `
                    <div class="user-header">
                        <div class="user-name">${userData.fullName || userId}</div>
                        <div class="user-role role-${userData.role}">${getRoleDisplayName(userData.role)}</div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>User ID:</strong> ${userId}<br>
                        <strong>البريد:</strong> ${userData.email || 'غير محدد'}<br>
                        <strong>القسم:</strong> ${userData.department || 'غير محدد'}<br>
                        <strong>الحالة:</strong> <span style="color: ${userData.status === 'active' ? 'green' : 'red'}">${userData.status === 'active' ? 'نشط' : 'معطل'}</span><br>
                        <strong>آخر دخول:</strong> ${userData.lastLogin ? new Date(userData.lastLogin).toLocaleDateString('ar') : 'لم يدخل بعد'}
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="editUser('${userId}')">✏️ تعديل</button>
                        <button class="btn btn-warning" onclick="toggleUserStatus('${userId}')">${userData.status === 'active' ? '🔒 تعطيل' : '🔓 تفعيل'}</button>
                        <button class="btn btn-danger" onclick="deleteUser('${userId}')">🗑️ حذف</button>
                    </div>
                `;
                usersGrid.appendChild(userCard);
            }
        }

        function getRoleDisplayName(role) {
            const roleNames = {
                'admin': 'مدير',
                'operator': 'مشغل',
                'viewer': 'مشاهد'
            };
            return roleNames[role] || role;
        }

        window.showTab = function(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        };

        window.showAddUserModal = function() {
            document.getElementById('addUserModal').style.display = 'block';
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        };

        window.editUser = function(userId) {
            const userData = currentUsers[userId];
            const template = permissionTemplates[userData.role] || {};
            
            const editContent = document.getElementById('editUserContent');
            editContent.innerHTML = `
                <form id="editUserForm">
                    <input type="hidden" id="editUserId" value="${userId}">
                    <div class="form-group">
                        <label>اسم المستخدم</label>
                        <input type="text" id="editUserName" class="form-control" value="${userData.fullName || ''}" placeholder="الاسم الكامل">
                    </div>
                    <div class="form-group">
                        <label>البريد الإلكتروني</label>
                        <input type="email" id="editUserEmail" class="form-control" value="${userData.email || ''}" placeholder="البريد الإلكتروني">
                    </div>
                    <div class="form-group">
                        <label>نوع الصلاحية</label>
                        <select id="editUserRole" class="form-control" onchange="updatePermissionPreview()">
                            <option value="admin" ${userData.role === 'admin' ? 'selected' : ''}>Admin - وصول كامل</option>
                            <option value="operator" ${userData.role === 'operator' ? 'selected' : ''}>Operator - تشغيل محدود</option>
                            <option value="viewer" ${userData.role === 'viewer' ? 'selected' : ''}>Viewer - مشاهدة فقط</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>القسم</label>
                        <select id="editUserDepartment" class="form-control">
                            <option value="">اختر القسم</option>
                            <option value="PBCR" ${userData.department === 'PBCR' ? 'selected' : ''}>PBCR</option>
                            <option value="PLCR" ${userData.department === 'PLCR' ? 'selected' : ''}>PLCR</option>
                            <option value="NMOGAS" ${userData.department === 'NMOGAS' ? 'selected' : ''}>NMOGAS</option>
                            <option value="ALL" ${userData.department === 'ALL' ? 'selected' : ''}>جميع الأقسام</option>
                        </select>
                    </div>
                    
                    <div class="permissions-grid">
                        <div class="permission-section">
                            <div class="permission-title">📄 الصفحات المسموحة</div>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="page_pbcr" ${template.pages?.pbcr ? 'checked' : ''}>
                                    <label for="page_pbcr">PBCR</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="page_plcr" ${template.pages?.plcr ? 'checked' : ''}>
                                    <label for="page_plcr">PLCR</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="page_liveTanks" ${template.pages?.liveTanks ? 'checked' : ''}>
                                    <label for="page_liveTanks">Live Tanks</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="page_dashboard" ${template.pages?.dashboard ? 'checked' : ''}>
                                    <label for="page_dashboard">Dashboard</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="page_nmogas" ${template.pages?.nmogas ? 'checked' : ''}>
                                    <label for="page_nmogas">NMOGAS</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="permission-section">
                            <div class="permission-title">📊 البيانات المسموحة</div>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="data_tankNumbers" ${template.data?.tankNumbers ? 'checked' : ''}>
                                    <label for="data_tankNumbers">أرقام التانكات</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="data_currentLevels" ${template.data?.currentLevels ? 'checked' : ''}>
                                    <label for="data_currentLevels">المستويات الحالية</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="data_capacityFactors" ${template.data?.capacityFactors ? 'checked' : ''}>
                                    <label for="data_capacityFactors">معاملات السعة</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="data_minMaxLevels" ${template.data?.minMaxLevels ? 'checked' : ''}>
                                    <label for="data_minMaxLevels">الحد الأدنى والأقصى</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="data_calculations" ${template.data?.calculations ? 'checked' : ''}>
                                    <label for="data_calculations">الحسابات</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="permission-section">
                            <div class="permission-title">⚡ الإجراءات المسموحة</div>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="action_addTanks" ${template.actions?.addTanks ? 'checked' : ''}>
                                    <label for="action_addTanks">إضافة تانكات</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="action_editTanks" ${template.actions?.editTanks ? 'checked' : ''}>
                                    <label for="action_editTanks">تعديل تانكات</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="action_deleteTanks" ${template.actions?.deleteTanks ? 'checked' : ''}>
                                    <label for="action_deleteTanks">حذف تانكات</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="action_exportData" ${template.actions?.exportData ? 'checked' : ''}>
                                    <label for="action_exportData">تصدير البيانات</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 30px;">
                        <button type="submit" class="btn btn-success">✅ حفظ التغييرات</button>
                        <button type="button" class="btn btn-danger" onclick="closeModal('editUserModal')">❌ إلغاء</button>
                    </div>
                </form>
            `;
            
            document.getElementById('editUserModal').style.display = 'block';
            
            // Add form submit handler
            document.getElementById('editUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveUserChanges();
            });
        };

        window.toggleUserStatus = async function(userId) {
            try {
                const currentStatus = currentUsers[userId].status;
                const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                
                currentUsers[userId].status = newStatus;
                
                await setDoc(doc(db, 'userPermissions', 'users'), currentUsers);
                
                displayUsers();
                showStatus(`✅ تم ${newStatus === 'active' ? 'تفعيل' : 'تعطيل'} المستخدم بنجاح`, 'success');
            } catch (error) {
                showStatus('❌ خطأ في تغيير حالة المستخدم: ' + error.message, 'error');
            }
        };

        window.deleteUser = async function(userId) {
            if (!confirm(`هل أنت متأكد من حذف المستخدم ${userId}؟`)) return;
            
            try {
                delete currentUsers[userId];
                await setDoc(doc(db, 'userPermissions', 'users'), currentUsers);
                
                displayUsers();
                showStatus('✅ تم حذف المستخدم بنجاح', 'success');
            } catch (error) {
                showStatus('❌ خطأ في حذف المستخدم: ' + error.message, 'error');
            }
        };

        async function saveUserChanges() {
            try {
                const userId = document.getElementById('editUserId').value;
                const fullName = document.getElementById('editUserName').value;
                const email = document.getElementById('editUserEmail').value;
                const role = document.getElementById('editUserRole').value;
                const department = document.getElementById('editUserDepartment').value;
                
                // Collect permissions
                const customPermissions = {
                    pages: {
                        pbcr: document.getElementById('page_pbcr').checked,
                        plcr: document.getElementById('page_plcr').checked,
                        liveTanks: document.getElementById('page_liveTanks').checked,
                        dashboard: document.getElementById('page_dashboard').checked,
                        nmogas: document.getElementById('page_nmogas').checked
                    },
                    data: {
                        tankNumbers: document.getElementById('data_tankNumbers').checked,
                        currentLevels: document.getElementById('data_currentLevels').checked,
                        capacityFactors: document.getElementById('data_capacityFactors').checked,
                        minMaxLevels: document.getElementById('data_minMaxLevels').checked,
                        calculations: document.getElementById('data_calculations').checked
                    },
                    actions: {
                        addTanks: document.getElementById('action_addTanks').checked,
                        editTanks: document.getElementById('action_editTanks').checked,
                        deleteTanks: document.getElementById('action_deleteTanks').checked,
                        exportData: document.getElementById('action_exportData').checked
                    }
                };
                
                currentUsers[userId] = {
                    ...currentUsers[userId],
                    fullName,
                    email,
                    role,
                    department,
                    customPermissions,
                    lastModified: new Date().toISOString()
                };
                
                await setDoc(doc(db, 'userPermissions', 'users'), currentUsers);
                
                closeModal('editUserModal');
                displayUsers();
                showStatus('✅ تم حفظ التغييرات بنجاح', 'success');
            } catch (error) {
                showStatus('❌ خطأ في حفظ التغييرات: ' + error.message, 'error');
            }
        }

        // Add user form handler
        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const userId = document.getElementById('newUserId').value;
                const fullName = document.getElementById('newUserName').value;
                const email = document.getElementById('newUserEmail').value;
                const role = document.getElementById('newUserRole').value;
                const department = document.getElementById('newUserDepartment').value;
                
                if (currentUsers[userId]) {
                    showStatus('❌ المستخدم موجود بالفعل', 'error');
                    return;
                }
                
                currentUsers[userId] = {
                    fullName,
                    email,
                    role,
                    department,
                    status: 'active',
                    customPermissions: null,
                    lastLogin: null,
                    createdAt: new Date().toISOString()
                };
                
                await setDoc(doc(db, 'userPermissions', 'users'), currentUsers);
                
                closeModal('addUserModal');
                document.getElementById('addUserForm').reset();
                displayUsers();
                showStatus('✅ تم إضافة المستخدم بنجاح', 'success');
            } catch (error) {
                showStatus('❌ خطأ في إضافة المستخدم: ' + error.message, 'error');
            }
        });

        window.showTemplateDetails = function(templateName) {
            const template = permissionTemplates[templateName];
            if (!template) return;
            
            const detailsDiv = document.getElementById('templateDetails');
            detailsDiv.innerHTML = `
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">تفاصيل قالب ${getRoleDisplayName(templateName)}</div>
                    <div class="card-body">
                        <div class="permissions-grid">
                            <div class="permission-section">
                                <div class="permission-title">📄 الصفحات المسموحة</div>
                                <ul>
                                    ${Object.entries(template.pages || {}).map(([page, allowed]) => 
                                        `<li style="color: ${allowed ? 'green' : 'red'}">${allowed ? '✅' : '❌'} ${page}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                            <div class="permission-section">
                                <div class="permission-title">📊 البيانات المسموحة</div>
                                <ul>
                                    ${Object.entries(template.data || {}).map(([data, allowed]) => 
                                        `<li style="color: ${allowed ? 'green' : 'red'}">${allowed ? '✅' : '❌'} ${data}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                            <div class="permission-section">
                                <div class="permission-title">⚡ الإجراءات المسموحة</div>
                                <ul>
                                    ${Object.entries(template.actions || {}).map(([action, allowed]) => 
                                        `<li style="color: ${allowed ? 'green' : 'red'}">${allowed ? '✅' : '❌'} ${action}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        window.refreshData = async function() {
            showStatus('🔄 جاري تحديث البيانات...', 'info');
            await loadData();
            displayUsers();
            updateSystemStats();
        };

        window.exportData = function() {
            const dataToExport = {
                users: currentUsers,
                templates: permissionTemplates,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tank-tools-permissions-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('✅ تم تصدير البيانات بنجاح', 'success');
        };

        window.resetPermissions = async function() {
            if (!confirm('هل أنت متأكد من إعادة تعيين جميع الصلاحيات؟ هذا سيحذف جميع المستخدمين!')) return;
            
            try {
                currentUsers = {
                    'fam030': { 
                        fullName: 'فهد الماري',
                        email: 'fam030@knpc.com',
                        role: 'admin', 
                        department: 'ALL',
                        customPermissions: null, 
                        lastLogin: null, 
                        status: 'active',
                        createdAt: new Date().toISOString()
                    }
                };
                
                await setDoc(doc(db, 'userPermissions', 'users'), currentUsers);
                
                displayUsers();
                showStatus('✅ تم إعادة تعيين الصلاحيات بنجاح', 'success');
            } catch (error) {
                showStatus('❌ خطأ في إعادة تعيين الصلاحيات: ' + error.message, 'error');
            }
        };

        function updateSystemStats() {
            const statsDiv = document.getElementById('systemStats');
            const userCount = Object.keys(currentUsers).length;
            const activeUsers = Object.values(currentUsers).filter(u => u.status === 'active').length;
            const adminCount = Object.values(currentUsers).filter(u => u.role === 'admin').length;
            
            statsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #1976d2;">${userCount}</div>
                        <div>إجمالي المستخدمين</div>
                    </div>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #388e3c;">${activeUsers}</div>
                        <div>المستخدمين النشطين</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #f57c00;">${adminCount}</div>
                        <div>المديرين</div>
                    </div>
                </div>
            `;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Add missing permission functions
        async function checkUserPermissions() {
            try {
                if (!window.permissionsManager) {
                    window.permissionsManager = new PermissionsManager();
                    await window.permissionsManager.loadUserPermissions(currentUser.username);
                }
                return true;
            } catch (error) {
                console.error('Error checking user permissions:', error);
                return false;
            }
        }

        function checkPageAccess(page) {
            try {
                if (!window.permissionsManager) {
                    return false;
                }
                return window.permissionsManager.hasPageAccess(page);
            } catch (error) {
                console.error('Error checking page access:', error);
                return false;
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
    </script>
</body>
</html>

