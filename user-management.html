<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management - Tank Tools</title>
  <link href="icon.png" rel="icon" type="image/png"/>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#003366">
  <script src="permissions.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;color:white;font-family:Arial,sans-serif;padding:20px;min-height:100vh}
    
    .nav-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(0,0,0,0.5);border-radius:10px;margin-bottom:20px;flex-wrap:wrap}
    .nav-logo{font-size:24px;font-weight:bold;color:white}
    .nav-links{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .nav-link{color:white;text-decoration:none;padding:8px 16px;border-radius:8px;transition:all 0.3s ease;background:rgba(255,255,255,0.1);font-weight:500;border:1px solid rgba(255,255,255,0.2)}
    .nav-link:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px)}
    .nav-link.active{background:rgba(255,255,255,0.3);font-weight:bold;border:1px solid rgba(255,255,255,0.4)}
    .nav-admin{background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366;font-weight:bold;border-radius:8px;padding:8px 16px;text-decoration:none;transition:all 0.3s ease;border:1px solid #FFA500}
    .nav-user{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.1);padding:5px 15px;border-radius:20px}
    .user-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(45deg,#4CAF50,#45a049);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px}
    .logout-btn{background:rgba(255,0,0,0.2);border:1px solid rgba(255,0,0,0.5);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:12px}
    
    .container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:30px;border:1px solid rgba(255,255,255,0.2)}
    .page-title{text-align:center;font-size:2.5rem;margin-bottom:30px;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    
    .section{background:rgba(255,255,255,0.1);border-radius:12px;padding:25px;margin-bottom:25px;border:1px solid rgba(255,255,255,0.2)}
    .section-title{font-size:1.5rem;margin-bottom:20px;color:#FFD700;display:flex;align-items:center;gap:10px}
    
    .users-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:20px;margin-bottom:30px}
    .user-card{background:rgba(255,255,255,0.1);border-radius:12px;padding:20px;border:1px solid rgba(255,255,255,0.2);transition:all 0.3s ease}
    .user-card:hover{background:rgba(255,255,255,0.15);transform:translateY(-2px)}
    .user-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
    .user-name{font-size:1.2rem;font-weight:bold;color:#4CAF50}
    .user-type{background:rgba(76,175,80,0.2);color:#4CAF50;padding:4px 8px;border-radius:6px;font-size:12px;border:1px solid rgba(76,175,80,0.5)}
    .user-info{margin-bottom:15px}
    .user-info div{margin-bottom:5px;font-size:14px}
    .user-permissions{margin-bottom:15px}
    .permission-tag{display:inline-block;background:rgba(33,150,243,0.2);color:#2196F3;padding:2px 6px;border-radius:4px;font-size:11px;margin:2px;border:1px solid rgba(33,150,243,0.5)}
    .user-actions{display:flex;gap:8px;flex-wrap:wrap}
    
    .btn{padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s ease;font-size:14px;text-decoration:none;display:inline-flex;align-items:center;gap:5px}
    .btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
    .btn-secondary{background:linear-gradient(45deg,#2196F3,#1976D2);color:white}
    .btn-warning{background:linear-gradient(45deg,#FF9800,#F57C00);color:white}
    .btn-danger{background:linear-gradient(45deg,#f44336,#d32f2f);color:white}
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
    
    .add-user-form{background:rgba(255,255,255,0.1);border-radius:12px;padding:25px;border:1px solid rgba(255,255,255,0.2)}
    .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:20px}
    .form-group{display:flex;flex-direction:column}
    .form-label{margin-bottom:8px;font-weight:500;color:rgba(255,255,255,0.9)}
    .form-input,.form-select{background:rgba(255,255,255,0.9);border:none;border-radius:8px;padding:12px;color:#003366;font-size:14px;border:2px solid transparent;transition:all 0.3s ease}
    .form-input:focus,.form-select:focus{outline:none;background:rgba(255,255,255,1);border-color:#4CAF50;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
    
    .permissions-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
    .permission-item{background:rgba(255,255,255,0.1);border-radius:8px;padding:15px;border:1px solid rgba(255,255,255,0.2)}
    .permission-checkbox{margin-right:8px}
    .permission-label{font-size:14px;cursor:pointer}
    
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:rgba(255,255,255,0.1);border-radius:12px;padding:20px;text-align:center;border:1px solid rgba(255,255,255,0.2)}
    .stat-number{font-size:2rem;font-weight:bold;color:#4CAF50;margin-bottom:5px}
    .stat-label{font-size:14px;opacity:0.8}
    
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;backdrop-filter:blur(5px)}
    .modal.show{display:flex;justify-content:center;align-items:center}
    .modal-content{background:rgba(255,255,255,0.95);color:#003366;border-radius:15px;padding:30px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid rgba(0,51,102,0.2)}
    .modal-title{font-size:1.5rem;font-weight:bold}
    .close-btn{background:none;border:none;font-size:24px;cursor:pointer;color:#666}
    
    .access-denied{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url('background.jpg');background-size:cover;background-position:center;display:flex;justify-content:center;align-items:center;z-index:9999}
    .access-denied-content{text-align:center;background:rgba(255,255,255,0.1);padding:40px;border-radius:20px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2)}
    .access-denied-icon{font-size:5rem;color:#f44336;margin-bottom:20px}
    .access-denied-title{font-size:2rem;color:#f44336;margin-bottom:15px}
    .access-denied-text{font-size:1.2rem;margin-bottom:20px;opacity:0.8}
    
    @media (max-width:768px){
      .users-grid{grid-template-columns:1fr}
      .form-row{grid-template-columns:1fr}
      .permissions-grid{grid-template-columns:1fr}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
      .nav-bar{flex-direction:column;gap:15px;padding:15px}
      .container{padding:20px}
    }
  </style>
</head>
<body>
  <div id="accessDenied" class="access-denied" style="display:none">
    <div class="access-denied-content">
      <div class="access-denied-icon">ğŸš«</div>
      <div class="access-denied-title">Access Denied</div>
      <div class="access-denied-text">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©</div>
      <div class="access-denied-text">You don't have permission to access this page</div>
      <button class="btn btn-primary" onclick="redirectToLogin()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <div id="mainContent" style="display:none">
    <div class="nav-bar">
      <div class="nav-logo">ğŸ› ï¸ Tank Tools</div>
      <div class="nav-links">
        <a class="nav-link" href="index.html">PBCR</a>
        <a class="nav-link" href="plcr.html">PLCR</a>
        <a class="nav-link" href="NMOGASBL.html">NMOGAS</a>
        <a class="nav-link" href="live-tanks.html" id="live-tanks-btn" style="display:none">ğŸ”´ Live Tanks</a>
        <a class="nav-link" href="dashboard.html">ğŸ“Š Dashboard</a>
        <a class="nav-admin active" href="user-management.html">ğŸ‘¥ User Management</a>
      </div>
      <div class="nav-user">
        <div class="user-avatar" id="userAvatar">A</div>
        <span id="userName">Admin</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="container">
      <h1 class="page-title">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h1>
      
      <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
      <div class="section">
        <h2 class="section-title">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalUsers">0</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="activeUsers">0</div>
            <div class="stat-label">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="adminUsers">0</div>
            <div class="stat-label">Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="todayLogins">0</div>
            <div class="stat-label">ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…</div>
          </div>
        </div>
      </div>

      <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
      <div class="section">
        <h2 class="section-title">
          ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†
          <button class="btn btn-primary" onclick="showAddUserModal()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</button>
        </h2>
        <div class="users-grid" id="usersGrid">
          <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… -->
  <div id="userModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
        <button class="close-btn" onclick="closeUserModal()">&times;</button>
      </div>
      
      <form id="userForm" onsubmit="saveUser(event)">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Username)</label>
            <input type="text" id="username" class="form-input" placeholder="abc123" pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6" required>
          </div>
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input type="text" id="fullName" class="form-input" placeholder="Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ - 12345" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <select id="userType" class="form-select" onchange="updatePermissions()" required>
              <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</option>
              <option value="admin">Admin - Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</option>
              <option value="control_panel">Control Panel - Ù…Ø´ØºÙ„ ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ…</option>
              <option value="pbcr_supervisor">PBCR Supervisor - Ù…Ø´Ø±Ù PBCR</option>
              <option value="pbcr_planning">PBCR Planning - ØªØ®Ø·ÙŠØ· PBCR</option>
              <option value="plcr_supervisor">PLCR Supervisor - Ù…Ø´Ø±Ù PLCR</option>
              <option value="plcr_planning">PLCR Planning - ØªØ®Ø·ÙŠØ· PLCR</option>
              <option value="nmogas_supervisor">NMOGAS Supervisor - Ù…Ø´Ø±Ù NMOGAS</option>
              <option value="nmogas_planning">NMOGAS Planning - ØªØ®Ø·ÙŠØ· NMOGAS</option>
              <option value="viewer">Viewer - Ù…Ø´Ø§Ù‡Ø¯ ÙÙ‚Ø·</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <select id="isActive" class="form-select" required>
              <option value="true">Ù†Ø´Ø·</option>
              <option value="false">ØºÙŠØ± Ù†Ø´Ø·</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©</label>
          <div class="permissions-grid">
            <div class="permission-item">
              <input type="checkbox" id="page_index" class="permission-checkbox" value="index.html">
              <label for="page_index" class="permission-label">PBCR & WASHERY</label>
            </div>
            <div class="permission-item">
              <input type="checkbox" id="page_plcr" class="permission-checkbox" value="plcr.html">
              <label for="page_plcr" class="permission-label">PLCR Calculator</label>
            </div>
            <div class="permission-item">
              <input type="checkbox" id="page_nmogas" class="permission-checkbox" value="NMOGASBL.html">
              <label for="page_nmogas" class="permission-label">NMOGAS Blender</label>
            </div>
            <div class="permission-item">
              <input type="checkbox" id="page_livetanks" class="permission-checkbox" value="live-tanks.html">
              <label for="page_livetanks" class="permission-label">Live Tanks</label>
            </div>
            <div class="permission-item">
              <input type="checkbox" id="page_dashboard" class="permission-checkbox" value="dashboard.html">
              <label for="page_dashboard" class="permission-label">Dashboard</label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù</label>
          <div class="permissions-grid">
            <div class="permission-item">
              <input type="checkbox" id="perm_viewLiveTanks" class="permission-checkbox">
              <label for="perm_viewLiveTanks" class="permission-label">Ø¹Ø±Ø¶ Live Tanks</label>
            </div>
            <div class="permission-item">
              <input type="checkbox" id="perm_editLiveTanks" class="permission-checkbox">
              <label for="perm_editLiveTanks" class="permission-label">ØªØ¹Ø¯ÙŠÙ„ Live Tanks</label>
            </div>
            <div class="permission-item">
              <input type="checkbox" id="perm_addToLiveTanks" class="permission-checkbox">
              <label for="perm_addToLiveTanks" class="permission-label">Ø¥Ø¶Ø§ÙØ© Ù„Ù€ Live Tanks</label>
            </div>
            <div class="permission-item">
              <input type="checkbox" id="perm_deleteFromLiveTanks" class="permission-checkbox">
              <label for="perm_deleteFromLiveTanks" class="permission-label">Ø­Ø°Ù Ù…Ù† Live Tanks</label>
            </div>
            <div class="permission-item">
              <input type="checkbox" id="perm_manageUsers" class="permission-checkbox">
              <label for="perm_manageUsers" class="permission-label">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</label>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:25px">
          <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Make Firebase functions globally available
    window.db = db;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.collection = collection;
    window.getDocs = getDocs;
    window.query = query;
    window.where = where;

    console.log('ğŸ”¥ Firebase initialized for User Management!');
  </script>

  <script>
    let currentUser = null;
    let editingUserId = null;

    // ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', function() {
      checkAdminAccess();
    });

    function checkAdminAccess() {
      currentUser = getCurrentUser();
      if (!currentUser) {
        showAccessDenied();
        return;
      }

      // ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†
      if (!hasPermission('canManageUsers')) {
        showAccessDenied();
        return;
      }

      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('accessDenied').style.display = 'none';
      
      loadUserInfo();
      loadUsers();
      loadStats();
    }

    function showAccessDenied() {
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('accessDenied').style.display = 'flex';
    }

    function loadUserInfo() {
      if (currentUser) {
        document.getElementById('userName').textContent = currentUser.username;
        document.getElementById('userAvatar').textContent = (currentUser.fullName || currentUser.username).charAt(0).toUpperCase();
      }
    }

    async function loadUsers() {
      try {
        const usersRef = collection(db, 'users');
        const snapshot = await getDocs(usersRef);
        const usersGrid = document.getElementById('usersGrid');
        usersGrid.innerHTML = '';

        snapshot.forEach((doc) => {
          const userData = doc.data();
          const userCard = createUserCard(doc.id, userData);
          usersGrid.appendChild(userCard);
        });
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', error);
        alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ' + error.message);
      }
    }

    function createUserCard(userId, userData) {
      const card = document.createElement('div');
      card.className = 'user-card';
      
      const userTypeLabels = {
        admin: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…',
        control_panel: 'Ù…Ø´ØºÙ„ ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ…',
        pbcr_supervisor: 'Ù…Ø´Ø±Ù PBCR',
        pbcr_planning: 'ØªØ®Ø·ÙŠØ· PBCR',
        plcr_supervisor: 'Ù…Ø´Ø±Ù PLCR',
        plcr_planning: 'ØªØ®Ø·ÙŠØ· PLCR',
        nmogas_supervisor: 'Ù…Ø´Ø±Ù NMOGAS',
        nmogas_planning: 'ØªØ®Ø·ÙŠØ· NMOGAS',
        viewer: 'Ù…Ø´Ø§Ù‡Ø¯'
      };

      const allowedPages = userData.allowedPages || [];
      const permissions = userData.permissions || {};
      
      card.innerHTML = `
        <div class="user-header">
          <div class="user-name">${userData.fullName || userData.username}</div>
          <div class="user-type">${userTypeLabels[userData.userType] || userData.userType}</div>
        </div>
        <div class="user-info">
          <div><strong>Username:</strong> ${userData.username}</div>
          <div><strong>Email:</strong> ${userData.email || userData.username + '@knpc.com'}</div>
          <div><strong>Status:</strong> ${userData.isActive ? 'ğŸŸ¢ Ù†Ø´Ø·' : 'ğŸ”´ ØºÙŠØ± Ù†Ø´Ø·'}</div>
          <div><strong>Created:</strong> ${userData.createdAt ? new Date(userData.createdAt).toLocaleDateString('ar-SA') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
        </div>
        <div class="user-permissions">
          <strong>Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©:</strong><br>
          ${allowedPages.includes('all') ? '<span class="permission-tag">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª</span>' : 
            allowedPages.map(page => `<span class="permission-tag">${getPageLabel(page)}</span>`).join('')}
        </div>
        <div class="user-actions">
          <button class="btn btn-secondary" onclick="editUser('${userId}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn btn-warning" onclick="toggleUserStatus('${userId}', ${!userData.isActive})">${userData.isActive ? 'â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù' : 'â–¶ï¸ ØªÙØ¹ÙŠÙ„'}</button>
          ${userData.username !== 'fam030' ? `<button class="btn btn-danger" onclick="deleteUser('${userId}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>` : ''}
        </div>
      `;
      
      return card;
    }

    function getPageLabel(page) {
      const labels = {
        'index.html': 'PBCR',
        'plcr.html': 'PLCR',
        'NMOGASBL.html': 'NMOGAS',
        'live-tanks.html': 'Live Tanks',
        'dashboard.html': 'Dashboard',
        'verify.html': 'Verification'
      };
      return labels[page] || page;
    }

    async function loadStats() {
      try {
        const usersRef = collection(db, 'users');
        const snapshot = await getDocs(usersRef);
        
        let totalUsers = 0;
        let activeUsers = 0;
        let adminUsers = 0;
        
        snapshot.forEach((doc) => {
          const userData = doc.data();
          totalUsers++;
          if (userData.isActive) activeUsers++;
          if (userData.userType === 'admin' || userData.isAdmin) adminUsers++;
        });

        document.getElementById('totalUsers').textContent = totalUsers;
        document.getElementById('activeUsers').textContent = activeUsers;
        document.getElementById('adminUsers').textContent = adminUsers;
        document.getElementById('todayLogins').textContent = '0'; // ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
      }
    }

    function showAddUserModal() {
      editingUserId = null;
      document.getElementById('modalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯';
      document.getElementById('userForm').reset();
      document.getElementById('userModal').classList.add('show');
    }

    function closeUserModal() {
      document.getElementById('userModal').classList.remove('show');
      editingUserId = null;
    }

    async function editUser(userId) {
      try {
        const userDoc = await getDoc(doc(db, 'users', userId));
        if (!userDoc.exists()) {
          alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
          return;
        }

        const userData = userDoc.data();
        editingUserId = userId;
        
        document.getElementById('modalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
        document.getElementById('username').value = userData.username;
        document.getElementById('fullName').value = userData.fullName || '';
        document.getElementById('userType').value = userData.userType || '';
        document.getElementById('isActive').value = userData.isActive ? 'true' : 'false';

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
        const allowedPages = userData.allowedPages || [];
        document.querySelectorAll('.permission-checkbox[value]').forEach(checkbox => {
          checkbox.checked = allowedPages.includes(checkbox.value) || allowedPages.includes('all');
        });

        // ØªØ­Ø¯ÙŠØ¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù
        const permissions = userData.permissions || {};
        document.getElementById('perm_viewLiveTanks').checked = permissions.canViewLiveTanks || false;
        document.getElementById('perm_editLiveTanks').checked = permissions.canEditLiveTanks || false;
        document.getElementById('perm_addToLiveTanks').checked = permissions.canAddToLiveTanks || false;
        document.getElementById('perm_deleteFromLiveTanks').checked = permissions.canDeleteFromLiveTanks || false;
        document.getElementById('perm_manageUsers').checked = permissions.canManageUsers || false;

        document.getElementById('userModal').classList.add('show');
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message);
      }
    }

    function updatePermissions() {
      const userType = document.getElementById('userType').value;
      if (!userType) return;

      const userConfig = window.TankToolsPermissions.USER_TYPES[userType];
      if (!userConfig) return;

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
      document.querySelectorAll('.permission-checkbox[value]').forEach(checkbox => {
        checkbox.checked = userConfig.allowedPages.includes(checkbox.value) || userConfig.allowedPages.includes('all');
      });

      // ØªØ­Ø¯ÙŠØ« ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù
      const permissions = userConfig.permissions;
      document.getElementById('perm_viewLiveTanks').checked = permissions.canViewLiveTanks || false;
      document.getElementById('perm_editLiveTanks').checked = permissions.canEditLiveTanks || false;
      document.getElementById('perm_addToLiveTanks').checked = permissions.canAddToLiveTanks || false;
      document.getElementById('perm_deleteFromLiveTanks').checked = permissions.canDeleteFromLiveTanks || false;
      document.getElementById('perm_manageUsers').checked = permissions.canManageUsers || false;
    }

    async function saveUser(event) {
      event.preventDefault();
      
      const username = document.getElementById('username').value.trim();
      const fullName = document.getElementById('fullName').value.trim();
      const userType = document.getElementById('userType').value;
      const isActive = document.getElementById('isActive').value === 'true';

      // Ø¬Ù…Ø¹ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
      const allowedPages = [];
      document.querySelectorAll('.permission-checkbox[value]:checked').forEach(checkbox => {
        allowedPages.push(checkbox.value);
      });

      // Ø¬Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù
      const permissions = {
        canViewLiveTanks: document.getElementById('perm_viewLiveTanks').checked,
        canEditLiveTanks: document.getElementById('perm_editLiveTanks').checked,
        canAddToLiveTanks: document.getElementById('perm_addToLiveTanks').checked,
        canDeleteFromLiveTanks: document.getElementById('perm_deleteFromLiveTanks').checked,
        canManageUsers: document.getElementById('perm_manageUsers').checked
      };

      const userData = {
        username: username,
        email: username + '@knpc.com',
        fullName: fullName,
        userType: userType,
        allowedPages: allowedPages,
        permissions: permissions,
        isActive: isActive,
        isAdmin: userType === 'admin'
      };

      if (!editingUserId) {
        userData.createdAt = new Date().toISOString();
      }

      try {
        const userId = editingUserId || username;
        await setDoc(doc(db, 'users', userId), userData, { merge: true });
        
        alert(editingUserId ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!');
        closeUserModal();
        loadUsers();
        loadStats();
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
        logUserActivity(editingUserId ? 'user_updated' : 'user_created', `User: ${username}`);
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message);
      }
    }

    async function toggleUserStatus(userId, newStatus) {
      try {
        await updateDoc(doc(db, 'users', userId), {
          isActive: newStatus
        });
        
        alert(`ØªÙ… ${newStatus ? 'ØªÙØ¹ÙŠÙ„' : 'Ø¥ÙŠÙ‚Ø§Ù'} Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!`);
        loadUsers();
        loadStats();
        
        logUserActivity('user_status_changed', `User: ${userId}, Status: ${newStatus ? 'active' : 'inactive'}`);
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        alert('Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message);
      }
    }

    async function deleteUser(userId) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) {
        return;
      }

      try {
        await deleteDoc(doc(db, 'users', userId));
        alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!');
        loadUsers();
        loadStats();
        
        logUserActivity('user_deleted', `User: ${userId}`);
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        alert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message);
      }
    }

    function logout() {
      localStorage.removeItem('tanktools_user');
      window.location.href = 'login.html';
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.getElementById('userModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeUserModal();
      }
    });

    console.log('ğŸ‘¥ User Management System loaded successfully!');
  </script>
</body>
</html>

