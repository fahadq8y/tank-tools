<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Tanks Management</title>
  <link href="icon.png" rel="icon" type="image/png"/>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#003366">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;font-family:Arial,sans-serif;min-height:100vh;color:white}
    .nav-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(0,0,0,0.5);border-radius:10px;margin-bottom:20px;flex-wrap:wrap}
    .nav-logo{font-size:24px;font-weight:bold;color:white}
    .nav-links{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .nav-link{color:white;text-decoration:none;padding:8px 16px;border-radius:8px;transition:all 0.3s ease;background:rgba(255,255,255,0.1);font-weight:500;border:1px solid rgba(255,255,255,0.2)}
    .nav-link:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px)}
    .nav-link.active{background:rgba(255,68,68,0.3);font-weight:bold;border:1px solid rgba(255,68,68,0.4);color:#ff6666}
    .nav-admin{background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366;font-weight:bold;border-radius:8px;padding:8px 16px;text-decoration:none;transition:all 0.3s ease;border:1px solid #FFA500;font-size:inherit}
    .nav-admin:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,215,0,0.3)}
    .nav-user{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.1);padding:5px 15px;border-radius:20px;backdrop-filter:blur(10px)}
    .user-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(45deg,#4CAF50,#45a049);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px}
    .logout-btn{background:rgba(255,0,0,0.2);border:1px solid rgba(255,0,0,0.5);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:12px;transition:all 0.3s ease}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .header{text-align:center;margin-bottom:30px}
    .header h1{font-size:2.5rem;margin-bottom:10px;background:linear-gradient(45deg,#ff4444,#ff6666);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .header p{font-size:1.1rem;opacity:0.8}
    .section{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:25px;margin-bottom:25px;border:1px solid rgba(255,255,255,0.2)}
    .section-title{font-size:1.4rem;margin-bottom:20px;background:linear-gradient(45deg,#ff4444,#ff6666);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:bold;border-bottom:2px solid rgba(255,68,68,0.3);padding-bottom:10px}
    .form-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:20px}
    .form-group{display:flex;flex-direction:column}
    .form-label{font-weight:bold;margin-bottom:5px;color:rgba(255,255,255,0.9)}
    .form-input,.form-select{padding:12px;border:none;border-radius:8px;background:rgba(255,255,255,0.9);color:#003366;font-size:14px;transition:all 0.3s ease;border:2px solid transparent}
    .form-input:focus,.form-select:focus{outline:none;background:rgba(255,255,255,1);border-color:#ff4444;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
    .btn{padding:12px 20px;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:all 0.3s ease;font-size:14px;display:inline-flex;align-items:center;gap:8px;margin:5px}
    .btn-primary{background:linear-gradient(45deg,#ff4444,#ff6666);color:white}
    .btn-secondary{background:linear-gradient(45deg,#2196F3,#1976D2);color:white}
    .btn-success{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
    .btn-warning{background:linear-gradient(45deg,#ff9800,#f57c00);color:white}
    .btn-danger{background:linear-gradient(45deg,#f44336,#d32f2f);color:white}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.3)}
    .live-tanks-table{width:100%;background:rgba(255,255,255,0.95);border-radius:15px;overflow:hidden;color:#003366;box-shadow:0 5px 15px rgba(0,0,0,0.2)}
    .live-tanks-table th,.live-tanks-table td{padding:15px 12px;text-align:left;border-bottom:1px solid rgba(0,51,102,0.1)}
    .live-tanks-table th{background:#003366;color:white;font-weight:bold;font-size:14px}
    .live-tanks-table tr:hover{background:rgba(255,68,68,0.1)}
    .status-badge{display:inline-block;padding:6px 12px;border-radius:20px;font-size:11px;font-weight:bold;text-transform:uppercase}
    .badge-pbcr{background:#4CAF50;color:white}
    .badge-washery{background:#2196F3;color:white}
    .badge-plcr{background:#9C27B0;color:white}
    .badge-live{background:#ff4444;color:white}
    .badge-finished{background:#666;color:white}
    .action-buttons{display:flex;gap:8px;flex-wrap:wrap}
    .action-btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:500;transition:all 0.3s ease}
    .action-btn:hover{transform:scale(1.05)}
    .loading{text-align:center;padding:40px;font-size:18px}
    .loading-spinner{display:inline-block;width:40px;height:40px;border:4px solid rgba(255,255,255,0.3);border-radius:50%;border-top:4px solid #ff4444;animation:spin 1s linear infinite;margin-bottom:10px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .message{padding:15px 20px;border-radius:10px;margin-bottom:20px;font-weight:500;border-left:5px solid}
    .message.success{background:rgba(76,175,80,0.2);border-color:#4CAF50;color:#4CAF50}
    .message.error{background:rgba(244,67,54,0.2);border-color:#f44336;color:#f44336}
    .message.info{background:rgba(33,150,243,0.2);border-color:#2196F3;color:#2196F3}
    .message.warning{background:rgba(255,193,7,0.2);border-color:#ffc107;color:#ffc107}
    .access-denied{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url('background.jpg');background-size:cover;background-position:center;display:flex;justify-content:center;align-items:center;z-index:9999}
    .access-denied-content{text-align:center;background:rgba(255,255,255,0.1);padding:40px;border-radius:20px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2)}
    .access-denied-icon{font-size:5rem;color:#f44336;margin-bottom:20px}
    .access-denied-title{font-size:2rem;color:#f44336;margin-bottom:15px}
    .access-denied-text{font-size:1.2rem;margin-bottom:20px;opacity:0.8}
    .login-btn{padding:12px 25px;background:linear-gradient(45deg,#4CAF50,#45a049);color:white;border:none;border-radius:10px;cursor:pointer;font-size:16px;transition:all 0.3s ease;margin:5px}
    .security-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;backdrop-filter:blur(5px)}
    .security-modal.show{display:flex;justify-content:center;align-items:center}
    .security-modal-content{background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;max-width:500px;width:90%;color:#003366;text-align:center;animation:modalSlideIn 0.5s ease}
    @keyframes modalSlideIn{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}
    .security-icon{font-size:3rem;margin-bottom:15px}
    .security-title{font-size:1.5rem;margin-bottom:15px;font-weight:bold}
    .security-text{margin-bottom:20px;line-height:1.5}
    .attempt-counter{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#f57c00;padding:10px;border-radius:8px;margin:15px 0;font-weight:bold}
    .security-buttons{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .modal-btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s ease}
    .modal-btn-primary{background:#4CAF50;color:white}
    .modal-btn-secondary{background:#2196F3;color:white}
    .modal-btn-danger{background:#f44336;color:white}
    .modal-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.3)}
    .firebase-status{position:fixed;top:70px;right:20px;background:rgba(76,175,80,0.2);border:1px solid rgba(76,175,80,0.5);color:#4CAF50;padding:8px 12px;border-radius:8px;font-size:12px;backdrop-filter:blur(10px);z-index:1000}
    .firebase-status.saving{background:rgba(255,193,7,0.2);border-color:rgba(255,193,7,0.5);color:#ffc107}
    .firebase-status.error{background:rgba(244,67,54,0.2);border-color:rgba(244,67,54,0.5);color:#f44336}
    .dark-mode{background:linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url('background.jpg')!important}
    .dark-mode .live-tanks-table{background:rgba(40,40,60,0.85)!important;color:#eee!important}
    .dark-mode .live-tanks-table th{border-bottom:1px solid #555!important}
    .dark-mode .form-input,.dark-mode .form-select{background:rgba(50,50,70,0.9)!important;color:#eee!important}
    .action-button{position:fixed;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.3);border:none;font-size:20px;color:white;box-shadow:0 2px 5px rgba(0,0,0,0.3);cursor:pointer;display:flex;align-items:center;justify-content:center;top:10px;right:10px}
    footer{margin-top:40px;color:#ccc;text-align:center}
    .whatsapp-link{color:#25D366;text-decoration:none;font-weight:bold;transition:all 0.3s ease;cursor:pointer}
    .whatsapp-link:hover{color:#128C7E;text-shadow:0 0 5px rgba(37,211,102,0.5);transform:scale(1.05)}
    @media (max-width:768px){
      .form-container{grid-template-columns:1fr}
      .nav-bar{flex-direction:column;gap:15px;padding:15px}
      .nav-links{order:1;justify-content:center;width:100%}
      .nav-user{order:2;width:100%;justify-content:space-between}
      .nav-link{padding:10px 15px;font-size:14px}
      .nav-admin{padding:10px 15px;font-size:14px;display:inline-flex;align-items:center}
      .live-tanks-table{font-size:12px}
      .live-tanks-table th,.live-tanks-table td{padding:8px 6px}
      .action-buttons{flex-direction:column}
      .security-buttons{flex-direction:column}
      .modal-btn{width:100%}
      .firebase-status{position:relative;top:auto;right:auto;margin:10px auto;display:block;text-align:center}
    }
  </style>
</head>
<body>
  <!-- Firebase Status Indicator -->
  <div id="firebaseStatus" class="firebase-status">üî• Firebase Connected</div>

  <!-- Security Modal -->
  <div id="securityModal" class="security-modal">
    <div class="security-modal-content">
      <div class="security-icon" id="securityIcon">‚ö†Ô∏è</div>
      <div class="security-title" id="securityTitle">Security Warning</div>
      <div class="security-text" id="securityText">We detected you trying to access developer tools.</div>
      <div class="attempt-counter" id="attemptCounter">Attempts: <span id="attemptCount">1</span>/3</div>
      <div class="security-buttons">
        <button class="modal-btn modal-btn-primary" onclick="acknowledgeWarning()">I Understand</button>
        <button class="modal-btn modal-btn-secondary" onclick="resetPage()">Reset Page</button>
        <button class="modal-btn modal-btn-danger" onclick="learnMore()">Learn More</button>
      </div>
    </div>
  </div>

  <!-- Access Denied -->
  <div id="accessDenied" class="access-denied" style="display:none">
    <div class="access-denied-content">
      <div class="access-denied-icon">üîí</div>
      <div class="access-denied-title">Login Required</div>
      <div class="access-denied-text">You need to login to access Live Tanks Management.<br>Please login with your KNPC credentials.</div>
      <button class="login-btn" onclick="goToLogin()">Go to Login</button>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent">
    <div class="nav-bar">
      <div class="nav-logo">Tank Tools</div>
      <div class="nav-links">
        <a class="nav-link" href="index.html">PBCR</a>
        <a class="nav-link" href="plcr.html">PLCR</a>
        <a class="nav-link" href="NMOGASBL.html">NMOGAS</a>
        <a class="nav-link active" href="live-tanks.html">üî¥ Live Tanks</a>
        <a class="nav-admin" href="dashboard.html" id="adminLink" style="display:none">üîê Dashboard</a>
      </div>
      <div class="nav-user" id="navUser">
        <div class="user-avatar" id="userAvatar">U</div>
        <div id="userName">User</div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <h1>üî¥ Live Tanks Management</h1>
        <p>Real-time tank monitoring and management system</p>
        <p id="currentTime" style="margin-top:10px;opacity:0.8"></p>
      </div>

      <div id="messageContainer"></div>

      <!-- Add Tank Section -->
      <div class="section">
        <div class="section-title">‚ûï Add New Tank</div>
        
        <form id="tankForm" onsubmit="addTank(event)">
          <div class="form-container">
            <div class="form-group">
              <label class="form-label">üè∑Ô∏è Tank Number:</label>
              <input type="text" class="form-input" id="tankNumber" placeholder="e.g. 225" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">üè≠ Section:</label>
              <select class="form-select" id="section" onchange="updateProductOptions()" required>
                <option value="">Select Section</option>
                <option value="pbcr">PBCR</option>
                <option value="washery">WASHERY</option>
                <option value="plcr">PLCR</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">üõ¢Ô∏è Product:</label>
              <select class="form-select" id="product" required>
                <option value="">Select Product</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">üìÖ Finish Date:</label>
              <input type="date" class="form-input" id="finishDate" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">‚è∞ Finish Time:</label>
              <input type="time" class="form-input" id="finishTime" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">üìù Notes (Optional):</label>
              <input type="text" class="form-input" id="notes" placeholder="Additional information">
            </div>
          </div>
          
          <div style="text-align:center;margin-top:20px">
            <button type="submit" class="btn btn-primary">üî¥ Add to Live Tanks</button>
            <button type="button" class="btn btn-secondary" onclick="clearForm()">üóëÔ∏è Clear Form</button>
          </div>
        </form>
      </div>

      <!-- Live Tanks Table -->
      <div class="section">
        <div class="section-title">üìä Active Live Tanks</div>
        
        <div id="tanksContainer">
          <div class="loading">
            <div class="loading-spinner"></div>
            <div>Loading tanks from Firebase...</div>
          </div>
        </div>
      </div>
    </div>

    <button id="darkModeButton" class="action-button" title="Dark Mode">üåô</button>

    <footer>
      By <a href="#" class="whatsapp-link" onclick="openWhatsApp(); return false;">Fahad - 17877</a> ‚Äì Live Tanks v1.0
      <br><small style="color:#999;font-size:10px;margin-top:5px;display:block">üì± WhatsApp: +965 55222550 | üî• Firebase Real-time</small>
    </footer>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs, addDoc, serverTimestamp, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Make Firebase functions globally available
    window.db = db;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.collection = collection;
    window.getDocs = getDocs;
    window.addDoc = addDoc;
    window.serverTimestamp = serverTimestamp;
    window.query = query;
    window.orderBy = orderBy;
    window.where = where;

    console.log('üî• Firebase Live Tanks initialized successfully!');
  </script>

  <script>
    // üîí Smart Security System - iPhone Optimized
    (function(){
      let attempts=0,modalOpen=false,isTyping=false,typingTimer=null;
      
      function initSecurity(){
        const isIPhone=/iPad|iPhone|iPod/.test(navigator.userAgent);
        
        ['focusin','focus','input','keydown','keyup','touchstart'].forEach(eventType=>{
          document.addEventListener(eventType,e=>{
            if(e.target.matches('input,textarea,select')){
              isTyping=true;
              clearTimeout(typingTimer);
              typingTimer=setTimeout(()=>isTyping=false,isIPhone?1500:800);
            }
          },true);
        });
        
        document.addEventListener('change',e=>{
          if(e.target.matches('input,textarea,select')){
            isTyping=true;
            clearTimeout(typingTimer);
            typingTimer=setTimeout(()=>isTyping=false,1000);
          }
        });
        
        document.addEventListener('contextmenu',e=>{
          if(isTyping||e.target.matches('input,textarea,select')||e.target.closest('input,textarea,select'))return;
          handleViolation('context-menu')(e);
        });
        
        document.addEventListener('selectstart',e=>{
          if(isTyping||e.target.matches('input,textarea,select')||e.target.closest('input,textarea,select'))return;
          handleViolation('text-selection')(e);
        });
        
        document.addEventListener('keydown',e=>{
          if(isTyping||e.target.matches('input,textarea,select')||e.target.closest('input,textarea,select'))return;
          const dangerous=[(e.ctrlKey&&e.key==='u'),(e.ctrlKey&&e.key==='s'),(e.ctrlKey&&e.shiftKey&&e.key==='I'),(e.key==='F12'),(e.ctrlKey&&e.shiftKey&&e.key==='C'),(e.ctrlKey&&e.shiftKey&&e.key==='J')];
          if(dangerous.some(c=>c))handleViolation('keyboard-shortcut')(e);
        });
        
        let devOpen=false;
        setInterval(()=>{
          if(isTyping)return;
          const threshold=160,wDiff=window.outerWidth-window.innerWidth,hDiff=window.outerHeight-window.innerHeight;
          if(wDiff>threshold||hDiff>threshold){
            if(!devOpen){devOpen=true;setTimeout(()=>{if(!isTyping)handleViolation('devtools-detected')()},500)}
          }else{devOpen=false}
        },isIPhone?5000:3000);
      }
      
      function handleViolation(type){
        return function(e){
          if(e&&e.preventDefault)e.preventDefault();
          attempts++;
          if(attempts===1)showWarning('first');
          else if(attempts===2)showWarning('second');
          else if(attempts>=3)showWarning('final');
          return false
        }
      }
      
      function showWarning(level){
        if(modalOpen)return;
        const modal=document.getElementById('securityModal'),icon=document.getElementById('securityIcon'),title=document.getElementById('securityTitle'),text=document.getElementById('securityText'),counter=document.getElementById('attemptCounter'),countSpan=document.getElementById('attemptCount');
        modalOpen=true;countSpan.textContent=attempts;
        
        if(level==='first'){
          icon.textContent='üëÄ';title.textContent='Security Notice';
          text.innerHTML='<p>We noticed you tried to access developer tools on Live Tanks Management.</p><p><strong>If this was accidental:</strong> No problem! Click "I Understand" to continue.</p>';
          counter.style.background='rgba(33,150,243,0.2)';counter.style.borderColor='rgba(33,150,243,0.5)';counter.style.color='#2196F3'
        }else if(level==='second'){
          icon.textContent='‚ö†Ô∏è';title.textContent='Security Warning';
          text.innerHTML='<p><strong>Second attempt detected on Live Tanks system.</strong></p><p>This system manages critical tank operations and real-time monitoring.</p>';
          counter.style.background='rgba(255,193,7,0.2)';counter.style.borderColor='rgba(255,193,7,0.5)';counter.style.color='#ffc107'
        }else{
          icon.textContent='üö´';title.textContent='Live Tanks Security Lock';
          text.innerHTML='<p><strong>Maximum attempts exceeded.</strong></p><p>Enhanced monitoring activated for Live Tanks system security.</p>';
          counter.style.background='rgba(244,67,54,0.2)';counter.style.borderColor='rgba(244,67,54,0.5)';counter.style.color='#f44336';
          setTimeout(()=>{if(attempts>=3)implementRestrictions()},5000)
        }
        modal.classList.add('show')
      }
      
      function implementRestrictions(){
        document.body.style.filter='blur(3px)';
        const overlay=document.createElement('div');
        overlay.innerHTML='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);color:white;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10000;text-align:center;padding:20px"><div style="font-size:4rem;margin-bottom:20px">üî¥</div><h2 style="color:#ff4444;margin-bottom:15px">Live Tanks Protected</h2><p style="margin-bottom:30px;max-width:500px;line-height:1.5">Security monitoring active for critical tank operations.</p><button onclick="window.location.reload()" style="padding:12px 24px;background:#ff4444;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold">üîÑ Reset System</button></div>';
        document.body.appendChild(overlay)
      }
      
      window.acknowledgeWarning=()=>{document.getElementById('securityModal').classList.remove('show');modalOpen=false};
      window.resetPage=()=>window.location.reload();
      window.learnMore=()=>{showMessage('üîí Live Tanks protects critical tank operations and real-time monitoring. Contact Fahad - 17877 for support.','info');document.getElementById('securityModal').classList.remove('show');modalOpen=false};
      initSecurity()
    })();

    // Live Tanks Application
    const WHATSAPP_NUMBER="96555222550";
    let currentUser=null;
    let allTanks=[];
    
    // Product options by section
    const productOptions = {
      pbcr: [
        'Light Naphtha',
        'Heavy Naphtha', 
        'Kerosene',
        'Gas Oil',
        'Fuel Oil',
        'LPG'
      ],
      washery: [
        'Washed Naphtha',
        'Washed Kerosene',
        'Washed Gas Oil',
        'Sulfur',
        'Caustic'
      ],
      plcr: [
        'Reformate',
        'Hydrogen',
        'LPG',
        'Fuel Gas',
        'Platformate'
      ]
    };

    // Core Functions
    window.addEventListener('load',()=>{
      console.log('üîÑ Live Tanks page loaded, checking login status...');
      setTimeout(checkLoginStatus, 100);
    });
    
    function checkLoginStatus(){
      console.log('üîç Live Tanks Login Check Started...');
      
      const session = sessionStorage.getItem('tanktools_session');
      const userData = localStorage.getItem('tanktools_current_user');
      
      if(session !== 'active' || !userData) {
        console.log('‚ùå Invalid session');
        showAccessDenied();
        return;
      }
      
      try {
        currentUser = JSON.parse(userData);
        console.log('‚úÖ User authenticated:', currentUser.username);
        initializeApp();
        logActivity('live_tanks_accessed', currentUser.username);
      } catch(error) {
        console.log('‚ùå Error parsing user data:', error);
        showAccessDenied();
      }
    }
    
    function showAccessDenied(){
      document.getElementById('mainContent').style.display='none';
      document.getElementById('accessDenied').style.display='flex';
    }
    
    window.goToLogin=()=>{
      sessionStorage.setItem('tanktools_redirect','live-tanks.html');
      window.location.href='login.html';
    };
    
    function initializeApp(){
      document.getElementById('mainContent').style.display='block';
      document.getElementById('accessDenied').style.display='none';
      
      loadUserInfo();
      setupDarkMode();
      updateCurrentTime();
      setInterval(updateCurrentTime, 60000);
      
      // Check for data from PBCR
      checkPBCRData();
      
      // Load existing tanks
      loadTanksFromFirebase();
      
      console.log('‚úÖ Live Tanks app initialized successfully');
    }
    
    function loadUserInfo(){
      if(!currentUser) return;
      
      const userNameElement = document.getElementById('userName');
      const userAvatarElement = document.getElementById('userAvatar');
      const adminLinkElement = document.getElementById('adminLink');
      
      if(userNameElement) {
        userNameElement.textContent = currentUser.username;
      }
      
      if(userAvatarElement) {
        userAvatarElement.textContent = (currentUser.fullName||currentUser.username).charAt(0).toUpperCase();
      }
      
      if(adminLinkElement && (currentUser.username==='fam030'||currentUser.role==='admin')) {
        adminLinkElement.style.display='inline-block';
      }
    }
    
    // Check for data sent from PBCR
    function checkPBCRData(){
      const pbcrData = sessionStorage.getItem('tanktools_live_tank_data');
      
      if(pbcrData) {
        try {
          const data = JSON.parse(pbcrData);
          console.log('üì• Received data from PBCR:', data);
          
          // Open PBCR add modal and fill with data
          openAddModal('PBCR');
          
          // Fill form with PBCR data
          document.getElementById('addTankNumber').value = data.tankNumber || '';
          document.getElementById('addFinishDate').value = data.finishDate || '';
          document.getElementById('addFinishTime').value = data.finishTime || '';
          
          // Set default product to LSFO (most common PBCR product)
          setTimeout(() => {
            document.getElementById('addProduct').value = 'LSFO';
          }, 100);
          
          showMessage('üì• Tank data received from PBCR! Please verify product type and save.', 'info');
          
          // Clear the session data
          sessionStorage.removeItem('tanktools_live_tank_data');
          
        } catch(error) {
          console.error('‚ùå Error parsing PBCR data:', error);
          sessionStorage.removeItem('tanktools_live_tank_data');
        }
      }
    }
    
    // Update product options based on selected section
    window.updateProductOptions = function() {
      const sectionSelect = document.getElementById('section');
      const productSelect = document.getElementById('product');
      const selectedSection = sectionSelect.value;
      
      // Clear existing options
      productSelect.innerHTML = '<option value="">Select Product</option>';
      
      if(selectedSection && productOptions[selectedSection]) {
        productOptions[selectedSection].forEach(product => {
          const option = document.createElement('option');
          option.value = product;
          option.textContent = product;
          productSelect.appendChild(option);
        });
      }
    };
    
    // Add tank to Firebase
    window.addTank = async function(event) {
      event.preventDefault();
      
      const tankNumber = document.getElementById('tankNumber').value.trim();
      const section = document.getElementById('section').value;
      const product = document.getElementById('product').value;
      const finishDate = document.getElementById('finishDate').value;
      const finishTime = document.getElementById('finishTime').value;
      const notes = document.getElementById('notes').value.trim();
      
      if(!tankNumber || !section || !product || !finishDate || !finishTime) {
        showMessage('‚ùå Please fill all required fields', 'error');
        return;
      }
      
      updateFirebaseStatus('saving', 'üíæ Adding tank...');
      
      try {
        const tankData = {
          tankNumber: tankNumber,
          section: section,
          product: product,
          finishDate: finishDate,
          finishTime: finishTime,
          notes: notes,
          status: 'live',
          addedBy: currentUser.username,
          addedAt: serverTimestamp(),
          lastModified: serverTimestamp()
        };
        
        await addDoc(collection(db, 'liveTanks'), tankData);
        
        showMessage('‚úÖ Tank added successfully to Live Tanks!', 'success');
        
        // Clear form
        clearForm();
        
        // Reload tanks
        loadTanksFromFirebase();
        
        // Log activity
        await addActivity('live_tank_added', currentUser.username);
        
        updateFirebaseStatus('', 'üî• Firebase Connected');
        
      } catch (error) {
        console.error('‚ùå Error adding tank:', error);
        showMessage('‚ùå Error adding tank: ' + error.message, 'error');
        updateFirebaseStatus('error', '‚ùå Save Failed');
        setTimeout(() => updateFirebaseStatus('', 'üî• Firebase Connected'), 3000);
      }
    };
    
    // Clear form
    window.clearForm = function() {
      document.getElementById('tankForm').reset();
      updateProductOptions();
    };
    
    // Load tanks from Firebase
    async function loadTanksFromFirebase(){
      updateFirebaseStatus('saving', 'üì• Loading tanks...');
      
      try {
        const tanksSnapshot = await getDocs(
          query(collection(db, 'liveTanks'), orderBy('addedAt', 'desc'))
        );
        
        allTanks = [];
        tanksSnapshot.forEach((doc) => {
          const tankData = { id: doc.id, ...doc.data() };
          allTanks.push(tankData);
        });
        
        displayTanks(allTanks);
        updateFirebaseStatus('', 'üî• Firebase Connected');
        
        console.log('‚úÖ Loaded', allTanks.length, 'tanks from Firebase');
        
      } catch (error) {
        console.error('‚ùå Error loading tanks:', error);
        showMessage('‚ùå Error loading tanks: ' + error.message, 'error');
        updateFirebaseStatus('error', '‚ùå Load Failed');
        setTimeout(() => updateFirebaseStatus('', 'üî• Firebase Connected'), 3000);
      }
    }
    
    // Display tanks in table
    function displayTanks(tanks) {
      const container = document.getElementById('tanksContainer');
      
      if (tanks.length === 0) {
        container.innerHTML = '<div class="loading">No live tanks found. Add your first tank above.</div>';
        return;
      }
      
      let html = `
        <table class="live-tanks-table">
          <thead>
            <tr>
              <th>Tank #</th>
              <th>Section</th>
              <th>Product</th>
              <th>Finish Date</th>
              <th>Finish Time</th>
              <th>Status</th>
              <th>Added By</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      tanks.forEach(tank => {
        const sectionClass = getSectionBadgeClass(tank.section);
        const statusClass = getStatusBadgeClass(tank.status);
        const finishDateTime = new Date(tank.finishDate + ' ' + tank.finishTime);
        const now = new Date();
        const isOverdue = finishDateTime < now;
        
        html += `
          <tr ${isOverdue ? 'style="background-color: rgba(255, 0, 0, 0.1);"' : ''}>
            <td><strong>${tank.tankNumber}</strong></td>
            <td><span class="status-badge ${sectionClass}">${tank.section.toUpperCase()}</span></td>
            <td>${tank.product}</td>
            <td>${tank.finishDate}</td>
            <td>${tank.finishTime}</td>
            <td><span class="status-badge ${statusClass}">${isOverdue ? 'OVERDUE' : tank.status.toUpperCase()}</span></td>
            <td>${tank.addedBy}</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn btn-warning" onclick="editTank('${tank.id}')" title="Edit Tank">‚úèÔ∏è</button>
                <button class="action-btn btn-danger" onclick="deleteTank('${tank.id}')" title="Delete Tank">üóëÔ∏è</button>
                <button class="action-btn btn-success" onclick="markFinished('${tank.id}')" title="Mark Finished">‚úÖ</button>
              </div>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    
    function getSectionBadgeClass(section) {
      const classMap = {
        'pbcr': 'badge-pbcr',
        'washery': 'badge-washery',
        'plcr': 'badge-plcr'
      };
      return classMap[section] || 'badge-pbcr';
    }
    
    function getStatusBadgeClass(status) {
      const classMap = {
        'live': 'badge-live',
        'finished': 'badge-finished'
      };
      return classMap[status] || 'badge-live';
    }
    
    // Delete tank
    window.deleteTank = async function(tankId) {
      if (!confirm('Are you sure you want to delete this tank?')) {
        return;
      }
      
      try {
        await deleteDoc(doc(db, 'liveTanks', tankId));
        showMessage('‚úÖ Tank deleted successfully!', 'success');
        loadTanksFromFirebase();
        await addActivity('live_tank_deleted', currentUser.username);
      } catch (error) {
        console.error('‚ùå Error deleting tank:', error);
        showMessage('‚ùå Error deleting tank: ' + error.message, 'error');
      }
    };
    
    // Mark tank as finished
    window.markFinished = async function(tankId) {
      try {
        await updateDoc(doc(db, 'liveTanks', tankId), {
          status: 'finished',
          finishedAt: serverTimestamp(),
          finishedBy: currentUser.username
        });
        showMessage('‚úÖ Tank marked as finished!', 'success');
        loadTanksFromFirebase();
        await addActivity('live_tank_finished', currentUser.username);
      } catch (error) {
        console.error('‚ùå Error updating tank:', error);
        showMessage('‚ùå Error updating tank: ' + error.message, 'error');
      }
    };
    
    // Edit tank (placeholder)
    window.editTank = function(tankId) {
      showMessage('üîß Edit functionality coming soon!', 'info');
    };
    
    // Firebase Status Indicator
    function updateFirebaseStatus(status, message) {
      const statusElement = document.getElementById('firebaseStatus');
      statusElement.className = `firebase-status ${status}`;
      statusElement.textContent = message;
    }
    
    // Add activity to Firebase
    async function addActivity(action, username) {
      try {
        await addDoc(collection(db, 'activities'), {
          action: action,
          username: username,
          timestamp: serverTimestamp(),
          ip: 'live-tanks',
          userAgent: navigator.userAgent.substring(0, 100)
        });
      } catch (error) {
        console.error('‚ùå Error adding activity:', error);
      }
    }
    
    // Update current time
    function updateCurrentTime() {
      const now = new Date();
      const timeString = now.toLocaleString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      document.getElementById('currentTime').textContent = timeString;
    }
    
    // Show message
    function showMessage(message, type) {
      const container = document.getElementById('messageContainer');
      container.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => container.innerHTML = '', 7000);
    }
    
    // Setup dark mode
    function setupDarkMode(){
      let isDarkMode=localStorage.getItem('darkMode')==='true';
      const darkModeButton=document.getElementById('darkModeButton');
      function updateColorMode(){
        if(isDarkMode){document.body.classList.add('dark-mode');darkModeButton.innerHTML='‚òÄÔ∏è'}
        else{document.body.classList.remove('dark-mode');darkModeButton.innerHTML='üåô'}
      }
      darkModeButton.addEventListener('click',()=>{isDarkMode=!isDarkMode;localStorage.setItem('darkMode',isDarkMode);updateColorMode()});
      updateColorMode()
    }
    
    // WhatsApp contact
    window.openWhatsApp=()=>{
      const message="ŸÖÿ±ÿ≠ÿ®ÿßÿå ÿ£ÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÉ ŸÖŸÜ ÿÆŸÑÿßŸÑ Live Tanks Management System";
      const whatsappURL=`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
      try{
        const newWindow=window.open(whatsappURL,'_blank','noopener,noreferrer');
        if(!newWindow)window.location.href=whatsappURL
      }catch{
        navigator.clipboard.writeText(whatsappURL).then(()=>alert(`ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®:\n${whatsappURL}`)).catch(()=>alert(`ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®:\n${whatsappURL}`))
      }
    };
    
    // Logout
    window.logout=()=>{
      logActivity('user_logout',currentUser.username);
      sessionStorage.removeItem('tanktools_session');
      localStorage.removeItem('tanktools_current_user');
      window.location.href='login.html';
    };
    
    function logActivity(action,username){
      const activities=JSON.parse(localStorage.getItem('tanktools_activities')||'[]');
      activities.unshift({id:Date.now(),action,username,timestamp:new Date().toISOString(),ip:'local',userAgent:navigator.userAgent.substring(0,100)});
      activities.splice(100);
      localStorage.setItem('tanktools_activities',JSON.stringify(activities))
    }
    
    console.log('%cüî¥ LIVE TANKS MANAGEMENT SYSTEM', 'color:red;font-size:20px;font-weight:bold');
    console.log('%cDeveloper: Fahad - 17877', 'color:green;font-size:16px');
    console.log('%cReal-time Tank Monitoring & Management', 'color:blue;font-size:14px');
  </script>
</body>
</html>