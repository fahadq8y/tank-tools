<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tank Tools</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="icon.png" type="image/png">
  <meta name="theme-color" content="#003366">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tank Tools">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;background-repeat:no-repeat;font-family:Arial,sans-serif;min-height:100vh;display:flex;justify-content:center;align-items:center;color:white}.container{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:40px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);width:100%;max-width:450px;text-align:center;position:relative;overflow:hidden}.container::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);transition:0.5s}.container:hover::before{left:100%}.logo{font-size:3rem;margin-bottom:10px;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:pulse 2s ease-in-out infinite}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}.subtitle{font-size:1.2rem;margin-bottom:30px;opacity:0.9;font-weight:300}.tab-container{display:flex;margin-bottom:30px;background:rgba(255,255,255,0.1);border-radius:10px;padding:5px}.tab{flex:1;padding:12px 20px;border:none;background:transparent;color:white;cursor:pointer;border-radius:8px;transition:all 0.3s ease;font-weight:500}.tab.active{background:linear-gradient(45deg,#4CAF50,#45a049);box-shadow:0 5px 15px rgba(76,175,80,0.3);transform:translateY(-2px)}.form-container{display:none}.form-container.active{display:block;animation:slideIn 0.5s ease}@keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.form-group{margin-bottom:20px;text-align:left}label{display:block;margin-bottom:8px;font-weight:500;color:rgba(255,255,255,0.9)}input{width:100%;padding:15px;border:none;border-radius:10px;background:rgba(255,255,255,0.9);color:#003366;font-size:16px;transition:all 0.3s ease;border:2px solid transparent;box-shadow:0 2px 5px rgba(0,0,0,0.3)}input::placeholder{color:rgba(0,51,102,0.6)}input:focus{outline:none;background:rgba(255,255,255,1);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}.username-container{display:flex;align-items:center;background:rgba(255,255,255,0.9);border-radius:10px;border:2px solid transparent;transition:all 0.3s ease;box-shadow:0 2px 5px rgba(0,0,0,0.3)}.username-container:focus-within{background:rgba(255,255,255,1);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}.username-input{background:transparent;border:none;padding:15px;flex:1;box-shadow:none;transform:none;color:#003366}.username-input:focus{background:transparent;border:none;box-shadow:none;transform:none}.email-suffix{padding:15px;color:#003366;font-weight:500;background:rgba(0,51,102,0.1);border-radius:0 8px 8px 0}.validation-message{margin-top:5px;font-size:12px;color:#ff6b6b;opacity:0;transition:opacity 0.3s ease}.validation-message.show{opacity:1}.validation-message.success{color:#4CAF50}.password-strength{margin-top:8px;height:4px;background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden}.password-strength-bar{height:100%;width:0%;transition:all 0.3s ease;border-radius:2px}.strength-weak{background:#ff6b6b;width:25%}.strength-fair{background:#ffa726;width:50%}.strength-good{background:#42a5f5;width:75%}.strength-strong{background:#4CAF50;width:100%}.btn{width:100%;padding:15px;border:none;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;transition:all 0.3s ease;margin-top:20px;position:relative;overflow:hidden}.btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}.btn-secondary{background:linear-gradient(45deg,#2196F3,#1976D2);color:white;margin-top:10px;font-size:14px;padding:10px}.btn-danger{background:linear-gradient(45deg,#f44336,#d32f2f);color:white;margin-top:10px;font-size:14px;padding:10px}.btn:hover{transform:translateY(-3px);box-shadow:0 15px 30px rgba(76,175,80,0.4)}.btn:disabled{background:#ccc;cursor:not-allowed;transform:none}.btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:0.5s}.btn:hover::before{left:100%}.forgot-password-link{color:#2196F3;text-decoration:none;font-size:14px;display:block;margin-top:15px;transition:all 0.3s ease}.forgot-password-link:hover{color:#1976D2;text-shadow:0 0 5px rgba(33,150,243,0.5)}.message{margin-top:15px;padding:12px;border-radius:8px;font-size:14px;opacity:0;transform:translateY(-10px);transition:all 0.3s ease}.message.show{opacity:1;transform:translateY(0)}.message.success{background:rgba(76,175,80,0.2);border:1px solid rgba(76,175,80,0.5);color:#4CAF50}.message.error{background:rgba(255,107,107,0.2);border:1px solid rgba(255,107,107,0.5);color:#ff6b6b}.message.info{background:rgba(33,150,243,0.2);border:1px solid rgba(33,150,243,0.5);color:#2196F3}.message.warning{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#ffc107}.footer{margin-top:30px;font-size:12px;opacity:0.7;text-align:center}.loading{display:none;margin-top:10px}.spinner{border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top:3px solid white;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.firebase-status{background:rgba(76,175,80,0.2);border:1px solid rgba(76,175,80,0.5);color:#4CAF50;padding:10px;border-radius:8px;margin-bottom:20px;font-size:13px;text-align:center}.forgot-container{display:none;text-align:center}.forgot-container.active{display:block;animation:slideIn 0.5s ease}.forgot-icon{font-size:4rem;margin-bottom:20px;color:#2196F3}.forgot-title{font-size:1.5rem;margin-bottom:15px;color:#2196F3}.forgot-text{margin-bottom:20px;opacity:0.8}.back-btn{background:transparent;border:1px solid rgba(255,255,255,0.3);color:white;padding:10px 20px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;margin-top:10px}.back-btn:hover{background:rgba(255,255,255,0.1)}.security-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;backdrop-filter:blur(5px)}.security-modal.show{display:flex;justify-content:center;align-items:center}.security-modal-content{background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;max-width:500px;width:90%;color:#003366;text-align:center;animation:modalSlideIn 0.5s ease}@keyframes modalSlideIn{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}.security-icon{font-size:3rem;margin-bottom:15px}.security-title{font-size:1.5rem;margin-bottom:15px;font-weight:bold}.security-text{margin-bottom:20px;line-height:1.5}.attempt-counter{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#f57c00;padding:10px;border-radius:8px;margin:15px 0;font-weight:bold}.security-buttons{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}.modal-btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s ease}.modal-btn-primary{background:#4CAF50;color:white}.modal-btn-secondary{background:#2196F3;color:white}.modal-btn-danger{background:#f44336;color:white}.modal-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.3)}@media (max-width:480px){.container{padding:30px 20px;margin:20px}.logo{font-size:2.5rem}.tab{padding:10px 15px;font-size:14px}.security-buttons{flex-direction:column}.modal-btn{width:100%}}
  </style>
</head>
<body>
  <div id="securityModal" class="security-modal">
    <div class="security-modal-content">
      <div class="security-icon" id="securityIcon">‚ö†Ô∏è</div>
      <div class="security-title" id="securityTitle">Security Warning</div>
      <div class="security-text" id="securityText">We detected you trying to access developer tools.</div>
      <div class="attempt-counter" id="attemptCounter">Attempts: <span id="attemptCount">1</span>/3</div>
      <div class="security-buttons">
        <button class="modal-btn modal-btn-primary" onclick="acknowledgeWarning()">I Understand</button>
        <button class="modal-btn modal-btn-secondary" onclick="resetPage()">Reset Page</button>
        <button class="modal-btn modal-btn-danger" onclick="learnMore()">Learn More</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="logo">üõ†Ô∏è Tank Tools</div>
    <div class="subtitle">Kuwait National Petroleum Company</div>
    <div class="firebase-status">üî• Firebase Cloud Database - Real-time & Secure</div>
    
    <div id="mainContainer">
      <div class="tab-container">
        <button class="tab active" onclick="switchTab('login')">Login</button>
        <button class="tab" onclick="switchTab('register')">Register</button>
      </div>

      <div id="loginForm" class="form-container active">
        <form onsubmit="handleLogin(event)">
          <div class="form-group">
            <label for="loginUsername">üë§ Username:</label>
            <div class="username-container">
              <input type="text" id="loginUsername" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6">
              <div class="email-suffix">@knpc.com</div>
            </div>
            <div class="validation-message" id="loginUsernameMsg"></div>
          </div>
          <div class="form-group">
            <label for="loginPassword">üîí Password:</label>
            <input type="password" id="loginPassword" placeholder="Enter your password" required>
          </div>
          <div class="form-group">
            <label><input type="checkbox" id="rememberMe" style="width:auto;margin-right:8px;">Remember me</label>
          </div>
          <button type="submit" class="btn btn-primary" id="loginBtn">üöÄ Login</button>
          <a href="#" class="forgot-password-link" onclick="showForgotPassword()">üîë Forgot Password?</a>
          <div class="loading" id="loginLoading"><div class="spinner"></div><div>Connecting to Firebase...</div></div>
        </form>
      </div>

      <div id="registerForm" class="form-container">
        <form onsubmit="handleRegister(event)">
          <div class="form-group">
            <label for="fullName">üë§ Full Name:</label>
            <input type="text" id="fullName" placeholder="Enter your full name" required minlength="3">
            <div class="validation-message" id="fullNameMsg"></div>
          </div>
          <div class="form-group">
            <label for="username">üìß Username (Email):</label>
            <div class="username-container">
              <input type="text" id="username" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6">
              <div class="email-suffix">@knpc.com</div>
            </div>
            <div class="validation-message" id="usernameMsg"></div>
          </div>
          <div class="form-group">
            <label for="password">üîí Password:</label>
            <input type="password" id="password" placeholder="Create a strong password" required minlength="8">
            <div class="password-strength"><div class="password-strength-bar" id="strengthBar"></div></div>
            <div class="validation-message" id="passwordMsg"></div>
          </div>
          <div class="form-group">
            <label for="confirmPassword">üîí Confirm Password:</label>
            <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
            <div class="validation-message" id="confirmPasswordMsg"></div>
          </div>
          <button type="submit" class="btn btn-primary" id="registerBtn">‚ú® Create Account</button>
          <div class="loading" id="registerLoading"><div class="spinner"></div><div>Creating account in Firebase...</div></div>
        </form>
      </div>
    </div>

    <div id="forgotContainer" class="forgot-container">
      <div class="forgot-icon">üîë</div>
      <div class="forgot-title">Reset Password</div>
      <div class="forgot-text">Enter your username to reset your password</div>
      <form onsubmit="handleForgotPassword(event)">
        <div class="form-group">
          <label for="forgotUsername">üë§ Username:</label>
          <div class="username-container">
            <input type="text" id="forgotUsername" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6">
            <div class="email-suffix">@knpc.com</div>
          </div>
        </div>
        <button type="submit" class="btn btn-secondary" id="resetBtn">üìß Send Reset Request</button>
        <button type="button" class="btn btn-danger" onclick="contactAdmin()" style="margin-top:10px;">üì± Contact Admin</button>
        <button type="button" class="back-btn" onclick="backToLogin()">Back to Login</button>
        <div class="loading" id="forgotLoading"><div class="spinner"></div><div>Processing request...</div></div>
      </form>
    </div>

    <div id="messageContainer"></div>
    <div class="footer"><strong>üî• Firebase Powered</strong><br>By <strong>Fahad - 17877</strong> | Version 4.0<br><small>Real-time cloud database</small></div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Global variables
    window.db = db;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.collection = collection;
    window.getDocs = getDocs;
    window.addDoc = addDoc;
    window.serverTimestamp = serverTimestamp;

    console.log('üî• Firebase initialized successfully!');
  </script>

  <script>
    // Security system (same as before)
    (function(){let attempts=0,modalOpen=false;function initSecurity(){document.addEventListener('contextmenu',handleViolation.bind(null,'context-menu'));document.addEventListener('selectstart',e=>{if(!e.target.matches('input,textarea'))handleViolation('text-selection')(e)});document.addEventListener('keydown',e=>{const dangerous=[(e.ctrlKey&&e.key==='u'),(e.ctrlKey&&e.key==='s'),(e.ctrlKey&&e.shiftKey&&e.key==='I'),(e.key==='F12'),(e.ctrlKey&&e.shiftKey&&e.key==='C'),(e.ctrlKey&&e.shiftKey&&e.key==='J'),(e.ctrlKey&&e.key==='c'&&!e.target.matches('input,textarea')),(e.ctrlKey&&e.key==='a'&&!e.target.matches('input,textarea'))];if(dangerous.some(c=>c))handleViolation('keyboard-shortcut')(e)});let devOpen=false;setInterval(()=>{const threshold=160,wDiff=window.outerWidth-window.innerWidth,hDiff=window.outerHeight-window.innerHeight;if(wDiff>threshold||hDiff>threshold){if(!devOpen){devOpen=true;handleViolation('devtools-detected')()}}else{devOpen=false}},2000)}function handleViolation(type){return function(e){if(e&&e.preventDefault)e.preventDefault();attempts++;if(attempts===1)showWarning('first');else if(attempts===2)showWarning('second');else if(attempts>=3)showWarning('final');return false}}function showWarning(level){if(modalOpen)return;const modal=document.getElementById('securityModal'),icon=document.getElementById('securityIcon'),title=document.getElementById('securityTitle'),text=document.getElementById('securityText'),counter=document.getElementById('attemptCounter'),countSpan=document.getElementById('attemptCount');modalOpen=true;countSpan.textContent=attempts;if(level==='first'){icon.textContent='üëÄ';title.textContent='Security Notice';text.innerHTML='<p>We noticed you tried to access developer tools.</p><p><strong>If this was accidental:</strong> No problem! Click "I Understand" to continue.</p>';counter.style.background='rgba(33,150,243,0.2)';counter.style.borderColor='rgba(33,150,243,0.5)';counter.style.color='#2196F3'}else if(level==='second'){icon.textContent='‚ö†Ô∏è';title.textContent='Security Warning';text.innerHTML='<p><strong>Second attempt detected.</strong></p><p>This system is protected for KNPC operations.</p>';counter.style.background='rgba(255,193,7,0.2)';counter.style.borderColor='rgba(255,193,7,0.5)';counter.style.color='#ffc107'}else{icon.textContent='üö´';title.textContent='Access Restricted';text.innerHTML='<p><strong>Maximum attempts exceeded.</strong></p>';counter.style.background='rgba(244,67,54,0.2)';counter.style.borderColor='rgba(244,67,54,0.5)';counter.style.color='#f44336';setTimeout(()=>{if(attempts>=3)implementRestrictions()},5000)}modal.classList.add('show')}function implementRestrictions(){document.body.style.filter='blur(5px)';const overlay=document.createElement('div');overlay.innerHTML='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);color:white;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10000;text-align:center;padding:20px"><h2 style="color:#f44336">Security Restricted</h2><p>Contact Fahad - 17877</p><button onclick="window.location.reload()" style="padding:12px 24px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer">üîÑ Refresh</button></div>';document.body.appendChild(overlay)}window.acknowledgeWarning=()=>{document.getElementById('securityModal').classList.remove('show');modalOpen=false};window.resetPage=()=>window.location.reload();window.learnMore=()=>{document.getElementById('securityModal').classList.remove('show');modalOpen=false};initSecurity()})();

    const WHATSAPP_ADMIN = "96555222550";

    // Firebase helper functions
    async function initializeUserData() {
      try {
        console.log('üîç Checking admin user...');
        
        // Check if admin user exists
        const adminDoc = await getDoc(doc(db, 'users', 'fam030'));
        if (!adminDoc.exists()) {
          console.log('‚ûï Creating admin user...');
          // Create admin user
          await setDoc(doc(db, 'users', 'fam030'), {
            username: 'fam030',
            email: 'fam030@knpc.com',
            fullName: 'Fahad Admin',
            password: btoa('admin123'), // Default password: admin123
            isActive: true,
            isAdmin: true,
            role: 'admin',
            createdAt: serverTimestamp(),
            lastLogin: null,
            id: 1
          });
          console.log('‚úÖ Admin user created with password: admin123');
          showMessage('‚úÖ Admin account created! Username: fam030, Password: admin123', 'success');
        } else {
          console.log('‚úÖ Admin user already exists');
        }

        // Initialize system stats if not exists
        const statsDoc = await getDoc(doc(db, 'system', 'stats'));
        if (!statsDoc.exists()) {
          await setDoc(doc(db, 'system', 'stats'), {
            totalUsers: 1,
            todayLogins: 0,
            lastUpdated: serverTimestamp()
          });
          console.log('‚úÖ System stats initialized');
        }
      } catch (error) {
        console.error('‚ùå Error initializing data:', error);
        showMessage('‚ö†Ô∏è Database initialization error: ' + error.message, 'error');
      }
    }

    async function addActivity(action, username = null) {
      try {
        await addDoc(collection(db, 'activities'), {
          action: action,
          username: username,
          timestamp: serverTimestamp(),
          ip: 'local',
          userAgent: navigator.userAgent.substring(0, 50) + '...'
        });
      } catch (error) {
        console.error('‚ùå Error adding activity:', error);
      }
    }

    async function updateStats() {
      try {
        const today = new Date().toDateString();
        const activitiesSnapshot = await getDocs(collection(db, 'activities'));
        const todayLogins = activitiesSnapshot.docs.filter(doc => {
          const data = doc.data();
          const activityDate = data.timestamp?.toDate()?.toDateString();
          return activityDate === today && data.action === 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ';
        }).length;

        const usersSnapshot = await getDocs(collection(db, 'users'));
        const totalUsers = usersSnapshot.size;

        await updateDoc(doc(db, 'system', 'stats'), {
          totalUsers: totalUsers,
          todayLogins: todayLogins,
          lastUpdated: serverTimestamp()
        });
      } catch (error) {
        console.error('‚ùå Error updating stats:', error);
      }
    }

    // Validation functions
    function validateUsername() {
      const username = document.getElementById('username').value;
      const msg = document.getElementById('usernameMsg');
      const pattern = /^[a-zA-Z]{3}[0-9]{3}$/;
      
      if (username.length === 0) {
        hideValidation(msg);
        return false;
      }
      
      if (!pattern.test(username)) {
        showValidation(msg, '‚ùå Must be 3 letters + 3 numbers', 'error');
        return false;
      }
      
      showValidation(msg, '‚úÖ Username format valid', 'success');
      return true;
    }

    function validateLoginUsername() {
      const username = document.getElementById('loginUsername').value;
      const msg = document.getElementById('loginUsernameMsg');
      const pattern = /^[a-zA-Z]{3}[0-9]{3}$/;
      
      if (username.length === 0) {
        hideValidation(msg);
        return false;
      }
      
      if (!pattern.test(username)) {
        showValidation(msg, '‚ùå Must be 3 letters + 3 numbers', 'error');
        return false;
      }
      
      hideValidation(msg);
      return true;
    }

    function validatePassword() {
      const password = document.getElementById('password').value;
      const msg = document.getElementById('passwordMsg');
      const strengthBar = document.getElementById('strengthBar');
      
      if (password.length === 0) {
        hideValidation(msg);
        strengthBar.className = 'password-strength-bar';
        return false;
      }
      
      let strength = 0;
      let issues = [];
      
      if (password.length >= 8) strength++; else issues.push('8+ characters');
      if (/[A-Z]/.test(password)) strength++; else issues.push('uppercase');
      if (/[a-z]/.test(password)) strength++; else issues.push('lowercase');
      if (/[0-9]/.test(password)) strength++; else issues.push('number');
      if (/[^A-Za-z0-9]/.test(password)) strength++; else issues.push('special');
      
      strengthBar.className = 'password-strength-bar';
      if (strength <= 2) strengthBar.classList.add('strength-weak');
      else if (strength === 3) strengthBar.classList.add('strength-fair');
      else if (strength === 4) strengthBar.classList.add('strength-good');
      else strengthBar.classList.add('strength-strong');
      
      if (strength < 3) {
        showValidation(msg, `‚ùå Need: ${issues.join(', ')}`, 'error');
        return false;
      }
      
      showValidation(msg, strength >= 4 ? '‚úÖ Strong password!' : '‚ö° Good password', 'success');
      return true;
    }

    function validateConfirmPassword() {
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const msg = document.getElementById('confirmPasswordMsg');
      
      if (confirmPassword.length === 0) {
        hideValidation(msg);
        return false;
      }
      
      if (password !== confirmPassword) {
        showValidation(msg, '‚ùå Passwords do not match', 'error');
        return false;
      }
      
      showValidation(msg, '‚úÖ Passwords match', 'success');
      return true;
    }

    function validateFullName() {
      const fullName = document.getElementById('fullName').value;
      const msg = document.getElementById('fullNameMsg');
      
      if (fullName.length === 0) {
        hideValidation(msg);
        return false;
      }
      
      if (fullName.length < 3) {
        showValidation(msg, '‚ùå Name must be at least 3 characters', 'error');
        return false;
      }
      
      showValidation(msg, '‚úÖ Valid name', 'success');
      return true;
    }

    function showValidation(element, message, type) {
      element.textContent = message;
      element.className = `validation-message show ${type}`;
    }

    function hideValidation(element) {
      element.className = 'validation-message';
    }

    // Main functions
    async function handleLogin(event) {
      event.preventDefault();
      
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const rememberMe = document.getElementById('rememberMe').checked;
      
      if (!validateLoginUsername()) {
        showMessage('‚ùå Please enter a valid username format', 'error');
        return;
      }
      
      if (!password) {
        showMessage('‚ùå Please enter your password', 'error');
        return;
      }
      
      showLoading('login', true);
      
      try {
        await new Promise(resolve => setTimeout(resolve, 1200));
        
        const userDoc = await getDoc(doc(db, 'users', username));
        
        if (!userDoc.exists()) {
          throw new Error('Invalid username or password');
        }
        
        const user = userDoc.data();
        
        console.log('üë§ User data:', user); // ŸÑŸÑÿ™ÿ¥ÿÆŸäÿµ
        console.log('üîç User active status:', user.isActive); // ŸÑŸÑÿ™ÿ¥ÿÆŸäÿµ
        
        if (user.password !== password && user.password !== btoa(password)) {
          throw new Error('Invalid username or password');
        }
        
        if (!user.isActive) {
          console.log('‚ùå Account not active, showing WhatsApp option'); // ŸÑŸÑÿ™ÿ¥ÿÆŸäÿµ
          
          // Clear any existing messages first
          document.getElementById('messageContainer').innerHTML = '';
          
          // Show clear activation message with a slight delay
          setTimeout(() => {
            const activationHTML = `
              <div style="background:rgba(255,193,7,0.15);border:2px solid rgba(255,193,7,0.6);border-radius:12px;padding:20px;margin:20px 0;text-align:center;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(255,193,7,0.2);" onclick="contactAdminWhatsAppLogin('${username}')" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(255,193,7,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 15px rgba(255,193,7,0.2)'">
                <div style="font-size:2.5rem;margin-bottom:10px;">‚è≥</div>
                <div style="font-size:1.3rem;font-weight:bold;color:#f57c00;margin-bottom:12px;">Account Not Activated</div>
                <div style="color:#f57c00;margin-bottom:15px;line-height:1.5;">
                  Your account <strong>${username}@knpc.com</strong> is pending admin approval.<br>
                  Click here to contact admin via WhatsApp for quick activation.
                </div>
                <div style="background:#25D366;color:white;padding:12px 24px;border-radius:8px;display:inline-flex;align-items:center;gap:8px;font-weight:bold;font-size:1rem;">
                  üì± Contact Admin via WhatsApp
                </div>
                <div style="margin-top:10px;font-size:0.85rem;color:#f57c00;opacity:0.8;">
                  üí° Usually activated within minutes!
                </div>
              </div>
            `;
            
            document.getElementById('messageContainer').innerHTML = activationHTML;
          }, 300);
          
          throw new Error('Account activation required - Click the message above to contact admin');
        }
        
        // Update last login
        await updateDoc(doc(db, 'users', username), {
          lastLogin: serverTimestamp()
        });
        
        // Add activity
        await addActivity('ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ', username);
        await updateStats();
        
        // Save session to localStorage only (Firebase handles the database)
        const sessionData = {
          id: user.id || Date.now(),
          username: user.username,
          fullName: user.fullName,
          email: user.email,
          role: user.role || 'user',
          loginTime: new Date().toISOString()
        };
        
        localStorage.setItem('tanktools_current_user', JSON.stringify(sessionData));
        sessionStorage.setItem('tanktools_session', 'active');
        
        if (rememberMe) {
          localStorage.setItem('tanktools_remember', JSON.stringify({
            username: username,
            rememberMe: true
          }));
        }
        
        showMessage('‚úÖ Login successful! Redirecting...', 'success');
        
        setTimeout(() => {
          if (user.username === 'fam030' || user.role === 'admin') {
            window.location.href = 'dashboard.html';
          } else {
            window.location.href = 'index.html';
          }
        }, 1500);
        
      } catch (error) {
        showMessage(`‚ùå ${error.message}`, 'error');
      } finally {
        showLoading('login', false);
      }
    }

    async function handleRegister(event) {
      event.preventDefault();
      
      const fullName = document.getElementById('fullName').value.trim();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      const isValidName = validateFullName();
      const isValidUsername = validateUsername();
      const isValidPassword = validatePassword();
      const isValidConfirm = validateConfirmPassword();
      
      if (!isValidName || !isValidUsername || !isValidPassword || !isValidConfirm) {
        showMessage('‚ùå Please fix all validation errors', 'error');
        return;
      }
      
      showLoading('register', true);
      
      try {
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Check if username exists in Firebase
        const existingUserQuery = await getDocs(collection(db, 'users'));
        const existingUsernames = [];
        existingUserQuery.forEach((doc) => {
          existingUsernames.push(doc.id);
        });
        
        if (existingUsernames.includes(username)) {
          throw new Error('Username already exists');
        }
        
        // Create new user (inactive by default)
        const newUser = {
          username: username,
          email: `${username}@knpc.com`,
          fullName: fullName,
          password: password,
          isActive: false, // Inactive until email verified
          isAdmin: false,
          createdAt: serverTimestamp(),
          lastLogin: null,
          id: Date.now(),
          emailVerificationToken: generateToken(), // Generate verification token
          emailSent: false
        };
        
        await setDoc(doc(db, 'users', username), newUser);
        
        // Add to email queue for sending
        await addDoc(collection(db, 'emailQueue'), {
          type: 'activation',
          to: newUser.email,
          username: username,
          fullName: fullName,
          token: newUser.emailVerificationToken,
          timestamp: serverTimestamp(),
          status: 'pending'
        });
        
        // Add activity
        await addActivity('ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ', username);
        await updateStats();
        
        showMessage('‚úÖ Account created! Activation email sent. Check your email or contact admin.', 'success');
        
        // Show WhatsApp option
        setTimeout(() => {
          showActivationOptions(username);
        }, 1500);
        
        setTimeout(() => {
          switchTab('login');
          document.getElementById('loginUsername').value = username;
        }, 6000);
        
      } catch (error) {
        showMessage(`‚ùå ${error.message}`, 'error');
      } finally {
        showLoading('register', false);
      }
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tab + 'Form').classList.add('active');
      clearMessages();
    }

    function showForgotPassword() {
      document.getElementById('mainContainer').style.display = 'none';
      document.getElementById('forgotContainer').classList.add('active');
      clearMessages();
    }

    function backToLogin() {
      document.getElementById('forgotContainer').classList.remove('active');
      document.getElementById('mainContainer').style.display = 'block';
      clearMessages();
    }

    function contactAdmin() {
      const message = "Hello, I need help with Tank Tools password reset. My username is: " + document.getElementById('forgotUsername').value + "@knpc.com";
      const whatsappURL = `https://wa.me/${WHATSAPP_ADMIN}?text=${encodeURIComponent(message)}`;
      
      try {
        const newWindow = window.open(whatsappURL, '_blank', 'noopener,noreferrer');
        if (!newWindow) window.location.href = whatsappURL;
        showMessage('üì± WhatsApp opened. Contact admin for password reset.', 'info');
      } catch (error) {
        showMessage('üì± Please contact admin via WhatsApp: +965 55222550', 'info');
      }
    }

    async function handleForgotPassword(event) {
      event.preventDefault();
      
      const username = document.getElementById('forgotUsername').value.trim();
      
      if (!/^[a-zA-Z]{3}[0-9]{3}$/.test(username)) {
        showMessage('‚ùå Please enter a valid username format', 'error');
        return;
      }
      
      showLoading('reset', true);
      
      try {
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        const userDoc = await getDoc(doc(db, 'users', username));
        if (!userDoc.exists()) {
          throw new Error('Username not found in our system');
        }
        
        await addActivity('ÿ∑ŸÑÿ® ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±', username);
        showMessage('üìß Reset request sent to admin.', 'info');
        
      } catch (error) {
        showMessage(`‚ùå ${error.message}`, 'error');
      } finally {
        showLoading('reset', false);
      }
    }

    function showLoading(form, show) {
      const btn = document.getElementById(form + 'Btn');
      const loading = document.getElementById(form + 'Loading');
      
      if (show) {
        btn.style.display = 'none';
        loading.style.display = 'block';
      } else {
        btn.style.display = 'block';
        loading.style.display = 'none';
      }
    }

    function showMessage(message, type) {
      const container = document.getElementById('messageContainer');
      container.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => container.querySelector('.message').classList.add('show'), 100);
      setTimeout(() => container.innerHTML = '', 7000);
    }

    function clearMessages() {
      document.getElementById('messageContainer').innerHTML = '';
      document.querySelectorAll('.validation-message').forEach(msg => msg.className = 'validation-message');
    }

    function loadSavedCredentials() {
      const saved = localStorage.getItem('tanktools_remember');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (data.rememberMe) {
            document.getElementById('loginUsername').value = data.username;
            document.getElementById('rememberMe').checked = true;
          }
        } catch (error) {
          console.log('Error loading saved credentials');
        }
      }
    }

    function checkExistingSession() {
      const session = sessionStorage.getItem('tanktools_session');
      const userData = localStorage.getItem('tanktools_current_user');
      
      if (session === 'active' && userData) {
        try {
          const user = JSON.parse(userData);
          showMessage('‚úÖ Active session found, redirecting...', 'success');
          setTimeout(() => {
            if (user.username === 'fam030' || user.role === 'admin') {
              window.location.href = 'dashboard.html';
            } else {
              window.location.href = 'index.html';
            }
          }, 1000);
        } catch (error) {
          sessionStorage.removeItem('tanktools_session');
          localStorage.removeItem('tanktools_current_user');
        }
      }
    }

    // Show activation options
    function showActivationOptions(username) {
      const activationHTML = `
        <div style="background:rgba(33,150,243,0.2);border:1px solid rgba(33,150,243,0.5);color:#2196F3;padding:20px;border-radius:12px;margin:20px 0;text-align:center;">
          <div style="font-size:1.2rem;font-weight:bold;margin-bottom:15px;">üéâ Account Created Successfully!</div>
          <div style="margin-bottom:20px;line-height:1.6;">
            Your account <strong>${username}@knpc.com</strong> is pending activation.<br>
            You have two options to get activated:
          </div>
          <div style="display:flex;gap:15px;justify-content:center;flex-wrap:wrap;">
            <button onclick="contactAdminWhatsApp('${username}')" style="background:#25D366;color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:bold;display:flex;align-items:center;gap:8px;transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
              üì± Contact Admin via WhatsApp
            </button>
            <button onclick="checkEmailActivation()" style="background:#4CAF50;color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:bold;display:flex;align-items:center;gap:8px;transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
              üìß Check Email Activation
            </button>
          </div>
          <div style="margin-top:15px;font-size:0.9rem;opacity:0.8;">
            üí° <strong>Tip:</strong> WhatsApp is the fastest way to get activated!
          </div>
        </div>
      `;
      
      document.getElementById('messageContainer').innerHTML = activationHTML;
    }

    // Contact admin via WhatsApp
    function contactAdminWhatsApp(username) {
      const message = `Hello Admin! üëã

I just registered a new account on Tank Tools:

üë§ Username: ${username}
üìß Email: ${username}@knpc.com
üïê Registration Time: ${new Date().toLocaleString()}

Could you please activate my account? Thank you! üôè

Tank Tools Registration System`;
      
      const whatsappURL = `https://wa.me/${WHATSAPP_ADMIN}?text=${encodeURIComponent(message)}`;
      
      try {
        const newWindow = window.open(whatsappURL, '_blank', 'noopener,noreferrer');
        if (!newWindow) {
          window.location.href = whatsappURL;
        }
        
        showMessage('üì± WhatsApp opened! Send the message to get activated quickly.', 'success');
        
        // Update user record that WhatsApp was used
        updateDoc(doc(db, 'users', username), {
          whatsappContactTime: serverTimestamp(),
          contactMethod: 'whatsapp'
        }).catch(console.error);
        
      } catch (error) {
        console.error('WhatsApp error:', error);
        showMessage('üì± Please manually contact admin via WhatsApp: +965 55222550', 'info');
      }
    }

    // Contact admin via WhatsApp from login
    function contactAdminWhatsAppLogin(username) {
      const message = `Hello Admin Fahad! üëã

I need account activation for Tank Tools:

üë§ Username: ${username}
üìß Email: ${username}@knpc.com
üö™ Login Attempt: ${new Date().toLocaleString()}
‚ö†Ô∏è Status: Account not activated

Please activate my account so I can access Tank Tools applications (PBCR, PLCR, NMOGAS).

Thank you! üôè

Tank Tools Login System`;
      
      const whatsappURL = `https://wa.me/${WHATSAPP_ADMIN}?text=${encodeURIComponent(message)}`;
      
      try {
        const newWindow = window.open(whatsappURL, '_blank', 'noopener,noreferrer');
        if (!newWindow) {
          window.location.href = whatsappURL;
        }
        
        // Update the message to show WhatsApp was opened
        const successHTML = `
          <div style="background:rgba(76,175,80,0.2);border:2px solid rgba(76,175,80,0.6);border-radius:12px;padding:20px;margin:20px 0;text-align:center;">
            <div style="font-size:2.5rem;margin-bottom:10px;">‚úÖ</div>
            <div style="font-size:1.2rem;font-weight:bold;color:#4CAF50;margin-bottom:12px;">WhatsApp Opened Successfully!</div>
            <div style="color:#4CAF50;margin-bottom:15px;line-height:1.5;">
              Message sent to admin with your account details.<br>
              Your account will be activated shortly.
            </div>
            <div style="background:#2196F3;color:white;padding:10px 20px;border-radius:8px;display:inline-block;font-weight:bold;">
              üîÑ Try Login Again in 2-3 Minutes
            </div>
          </div>
        `;
        
        document.getElementById('messageContainer').innerHTML = successHTML;
        
        // Record WhatsApp contact in Firebase
        try {
          updateDoc(doc(db, 'users', username), {
            whatsappContactTime: serverTimestamp(),
            contactMethod: 'whatsapp_login',
            lastContactReason: 'activation_request'
          });
        } catch (error) {
          console.log('Firebase update error:', error);
        }
        
      } catch (error) {
        console.error('WhatsApp error:', error);
        
        const errorHTML = `
          <div style="background:rgba(33,150,243,0.2);border:2px solid rgba(33,150,243,0.6);border-radius:12px;padding:20px;margin:20px 0;text-align:center;">
            <div style="font-size:2rem;margin-bottom:10px;">üì±</div>
            <div style="font-size:1.1rem;font-weight:bold;color:#2196F3;margin-bottom:12px;">Contact Admin Manually</div>
            <div style="color:#2196F3;margin-bottom:15px;">
              WhatsApp: <strong>+965 55222550</strong><br>
              Username: <strong>${username}</strong>
            </div>
            <div style="background:#f44336;color:white;padding:8px 16px;border-radius:6px;display:inline-block;font-size:0.9rem;">
              Request account activation
            </div>
          </div>
        `;
        
        document.getElementById('messageContainer').innerHTML = errorHTML;
      }
    }

    // Make functions globally available
    window.contactAdminWhatsApp = contactAdminWhatsApp;
    window.contactAdminWhatsAppLogin = contactAdminWhatsAppLogin;
    window.checkEmailActivation = checkEmailActivation;
    window.showActivationOptions = showActivationOptions;

    // Check email activation
    function checkEmailActivation() {
      showMessage('üìß Please check your email inbox and spam folder for the activation link. If not received, contact admin via WhatsApp.', 'info');
    }

    // Generate verification token
    function generateToken() {
      return Math.random().toString(36).substring(2) + Date.now().toString(36);
    }

    // Initialize when page loads
    window.addEventListener('load', async () => {
      // Wait for Firebase to initialize
      setTimeout(async () => {
        try {
          await initializeUserData();
          console.log('‚úÖ Firebase database ready!');
        } catch (error) {
          console.error('‚ùå Firebase initialization error:', error);
          showMessage('‚ö†Ô∏è Database connection issue. Please refresh the page.', 'warning');
        }
      }, 1000);
      
      loadSavedCredentials();
      checkExistingSession();
      
      // Add event listeners
      document.getElementById('username').addEventListener('input', validateUsername);
      document.getElementById('loginUsername').addEventListener('input', validateLoginUsername);
      document.getElementById('password').addEventListener('input', validatePassword);
      document.getElementById('confirmPassword').addEventListener('input', validateConfirmPassword);
      document.getElementById('fullName').addEventListener('input', validateFullName);
    });

    console.log('%cüî• TANK TOOLS - FIREBASE v4.0', 'color:orange;font-size:20px;font-weight:bold');
    console.log('%cDeveloper: Fahad - 17877', 'color:green;font-size:16px');
    console.log('%cPowered by Firebase Cloud Firestore', 'color:blue;font-size:14px');
  </script>
</body>
</html>