<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PBCR & WASHERY</title>
<link href="icon.png" rel="icon" type="image/png"/>
<script src="permissions.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;color:white;font-family:Arial,sans-serif;padding:20px;min-height:100vh}
.nav-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(0,0,0,0.5);border-radius:10px;margin-bottom:20px;flex-wrap:wrap}
.nav-logo{font-size:24px;font-weight:bold;color:white}
.nav-links{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.nav-link{color:white;text-decoration:none;padding:8px 16px;border-radius:8px;transition:all 0.3s ease;background:rgba(255,255,255,0.1);font-weight:500;border:1px solid rgba(255,255,255,0.2)}
.nav-link:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px)}
.nav-link.active{background:rgba(255,255,255,0.3);font-weight:bold;border:1px solid rgba(255,255,255,0.4)}
.nav-admin{background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366;font-weight:bold;border-radius:8px;padding:8px 16px;text-decoration:none;transition:all 0.3s ease;border:1px solid #FFA500;font-size:inherit}
.nav-user{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.1);padding:5px 15px;border-radius:20px}
.user-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(45deg,#4CAF50,#45a049);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px}
.logout-btn{background:rgba(255,0,0,0.2);border:1px solid rgba(255,0,0,0.5);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:12px}
.font-controls{display:flex;gap:5px;margin-right:10px}
.font-btn{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.3s ease;min-width:30px}
.font-btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-1px)}
input,select{background:rgba(255,255,255,0.9);border-radius:12px;border:none;color:#003366;box-shadow:0 2px 5px rgba(0,0,0,0.3);font-size:16px;margin:10px;padding:10px;width:250px;text-align:center}
.row{display:flex;justify-content:center;align-items:center;gap:8px;margin:10px 0;max-width:400px;margin-left:auto;margin-right:auto}
.row input,.row select{margin:0;flex:1;width:50%}
.result{margin-top:10px;font-weight:bold;color:#00ffff;text-align:center}
#tankTable{margin:auto;background:rgba(255,255,255,0.85);color:#003366;border-collapse:separate;border-spacing:0;border-radius:12px;overflow:hidden;min-width:300px}
#tankTable th{padding:10px;border-bottom:1px solid #003366}
.reminder-btn,.add-btn,.live-tanks-btn{padding:12px 20px;font-size:14px;border-radius:12px;background:white;color:#003366;border:none;cursor:pointer;margin:5px;transition:all 0.3s ease;font-weight:600}
.live-tanks-btn{background:linear-gradient(45deg,#ff4444,#ff6666);color:white;display:inline-flex;align-items:center;gap:8px}
.buttons-section{margin:20px 0;padding:15px;background:rgba(255,255,255,0.1);border-radius:15px;backdrop-filter:blur(10px)}
.button-row{display:flex;align-items:center;justify-content:center;gap:10px;margin:8px 0}
.action-btn{padding:12px 24px;font-size:14px;font-weight:600;border:none;border-radius:10px;cursor:pointer;transition:all 0.3s ease;display:inline-flex;align-items:center;gap:8px;width:180px;height:45px;justify-content:center}
.live-tanks-btn{background:linear-gradient(45deg,#ff4444,#ff6666);color:white;box-shadow:0 2px 8px rgba(255,68,68,0.3)}
.reminder-btn{background:linear-gradient(45deg,#4CAF50,#45a049);color:white;box-shadow:0 2px 8px rgba(76,175,80,0.3)}
.table-btn{background:linear-gradient(45deg,#2196F3,#1976D2);color:white;box-shadow:0 2px 8px rgba(33,150,243,0.3)}
.action-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.help-btn{background:linear-gradient(45deg,#FF9800,#F57C00);color:white;border:none;padding:10px;border-radius:50%;cursor:pointer;font-size:14px;transition:all 0.3s ease;display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;box-shadow:0 2px 6px rgba(255,152,0,0.3)}
.help-btn:hover{transform:translateY(-2px) scale(1.1);box-shadow:0 4px 10px rgba(255,152,0,0.4)}
.buttons-container{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;align-items:center;margin-top:15px}
.action-button{position:fixed;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.3);border:none;font-size:20px;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;top:10px;right:10px}
.access-denied{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url('background.jpg');background-size:cover;background-position:center;display:flex;justify-content:center;align-items:center;z-index:9999}
.access-denied-content{text-align:center;background:rgba(255,255,255,0.1);padding:40px;border-radius:20px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2)}
.access-denied-icon{font-size:5rem;color:#f44336;margin-bottom:20px}
.access-denied-title{font-size:2rem;color:#f44336;margin-bottom:15px}
.access-denied-text{font-size:1.2rem;margin-bottom:20px;opacity:0.8}
.login-btn{padding:12px 25px;background:linear-gradient(45deg,#4CAF50,#45a049);color:white;border:none;border-radius:10px;cursor:pointer;font-size:16px}
.lt-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;backdrop-filter:blur(5px)}
.lt-modal.show{display:flex;justify-content:center;align-items:center}
.lt-modal-content{background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;max-width:500px;width:90%;color:#003366}
.close-btn{background:none;border:none;font-size:28px;cursor:pointer;color:#666;font-weight:bold;float:right}
.form-group{margin-bottom:15px}
.form-row{margin-bottom:15px}
.form-label{display:block;margin-bottom:6px;font-weight:600;color:#003366;font-size:13px}
.form-input,.form-select{width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:13px}
.form-textarea{width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:13px;min-height:60px}
.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
.btn-secondary{background:linear-gradient(45deg,#6c757d,#5a6268);color:white}
.modal-buttons{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
@media (max-width:600px){input,select{width:90%!important}.row{max-width:350px}.nav-bar{flex-direction:column;gap:15px;padding:15px}.buttons-container{flex-direction:column}.live-tanks-btn{width:90%}.lt-modal-content{padding:15px;max-width:350px}.form-group{margin-bottom:12px}.form-row{margin-bottom:12px}.form-label{font-size:12px}.form-input,.form-select{padding:8px;font-size:12px}.btn{padding:8px 16px;font-size:12px}.modal-buttons{gap:8px;margin-top:15px}}
</style>
</head>
<body>
<div id="accessDenied" class="access-denied" style="display:none">
<div class="access-denied-content">
<div class="access-denied-icon">üîí</div>
<div class="access-denied-title">Login Required</div>
<div class="access-denied-text">You need to login to access PBCR & WASHERY application.</div>
<button class="login-btn" onclick="goToLogin()">Go to Login</button>
</div>
</div>
<div id="mainContent">
<div class="nav-bar">
<div class="nav-logo">Tank Tools</div>
<div class="nav-links">
<a class="nav-link active" href="index.html">PBCR</a>
<a class="nav-link" href="plcr.html">PLCR</a>
<a class="nav-link" href="NMOGASBL.html">NMOGAS</a>
<a class="nav-link" href="live-tanks.html" id="live-tanks-btn" style="display:none">üî¥ Live Tanks</a>
<a class="nav-admin" href="dashboard.html" id="adminLink" style="display:none">üîê Dashboard</a>
</div>
<div class="nav-user">
<div class="font-controls">
<button class="font-btn" onclick="decreaseFontSize()" title="ÿ™ÿµÿ∫Ÿäÿ± ÿßŸÑÿÆÿ∑">-</button>
<button class="font-btn" onclick="increaseFontSize()" title="ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑÿÆÿ∑">+</button>
</div>
<div class="user-avatar" id="userAvatar">U</div>
<div id="userName">User</div>
<button class="logout-btn" onclick="logout()">Logout</button>
</div>
</div>
<h2 style="text-align:center">PBCR & WASHERY</h2>
<div style="text-align:center;padding:20px">
<input id="tankInput" oninput="loadTank()" placeholder="Enter Tank Number" type="number"/>
<input id="level" oninput="calculate()" placeholder="Current Level (m)" type="number"/>
<div class="result" id="availablePumpable"></div>
<div class="result" id="currentUllage"></div>
<div class="row">
<input id="target" oninput="calculate()" placeholder="Target Value" type="number"/>
<select id="mode" onchange="calculate()">
<option value="pumpable">Pumpable</option>
<option value="ullage">Ullage</option>
<option value="level">Level</option>
</select>
</div>
<div class="result" id="valueDiff"></div>
<div class="result" id="levelEstimate"></div>
<div class="row">
<input id="flowrate" oninput="calculate()" placeholder="Flowrate" type="number"/>
<select id="flowUnit" onchange="calculate()">
<option value="bbl">bbl/hr</option>
<option value="m3">m¬≥/hr</option>
<option value="mtr">meter/hr</option>
</select>
</div>
<div class="result" id="output"></div>
<div class="buttons-section">
<div class="button-row">
<button onclick="openLTModal()" class="action-btn live-tanks-btn" id="add-to-live-tanks-btn" style="display:none">üî¥ Add to Live Tanks</button>
<button onclick="showLiveTanksHelp()" class="help-btn" title="About Live Tanks">‚ÑπÔ∏è</button>
</div>
<div class="button-row">
<a href="#" id="calendarLink" target="_blank">
<button class="action-btn reminder-btn">üìÖ Add Reminder</button>
</a>
<button onclick="showCalendarHelp()" class="help-btn" title="How to use Calendar Reminder">‚ÑπÔ∏è</button>
</div>
<div class="button-row">
<button onclick="addToTable()" class="action-btn table-btn">üìä Add to Table</button>
<button onclick="showTableHelp()" class="help-btn" title="About Personal Table">‚ÑπÔ∏è</button>
</div>
</div>
<h3 style="margin-top:40px">Your tanks finishing in current shift:</h3>
<table id="tankTable">
<thead><tr><th>Tank Number</th><th>Finish Date</th><th>Finish Time</th><th>Delete</th></tr></thead>
<tbody></tbody>
</table>
</div>
<button id="darkModeButton" class="action-button" title="Dark Mode">üåô</button>
</div>
<div id="ltModal" class="lt-modal">
<div class="lt-modal-content">
<button class="close-btn" onclick="closeLTModal()">&times;</button>
<h3>üî¥ Add to Live Tanks</h3>
<form id="ltForm">
<div class="form-group">
<label class="form-label">üè≠ Department:</label>
<select class="form-select" id="ltDept" onchange="updateLTProducts()" required>
<option value="">Select Department</option>
<option value="PBCR">PBCR</option>
<option value="WASHERY">WASHERY</option>
<option value="PLCR">PLCR</option>
</select>
</div>
<div class="form-row" style="display:flex;gap:10px">
<div class="form-group" style="flex:1">
<label class="form-label">üè∑Ô∏è Tank Number:</label>
<input type="text" class="form-input" id="ltTank" readonly style="background:#f5f5f5">
</div>
<div class="form-group" style="flex:1">
<label class="form-label">üõ¢Ô∏è Product Type:</label>
<select class="form-select" id="ltProduct" required>
<option value="">Select Product</option>
</select>
</div>
</div>
<div class="form-row" style="display:flex;gap:10px">
<div class="form-group" style="flex:1">
<label class="form-label">üìä Target Value:</label>
<input type="number" step="any" class="form-input" id="ltTargetValue" placeholder="Enter target value" required>
</div>
<div class="form-group" style="flex:1">
<label class="form-label">üéØ Target Type:</label>
<select class="form-select" id="ltTargetType" required>
<option value="">Select Target Type</option>
<option value="pumpable">Pumpable</option>
<option value="ullage">Ullage</option>
<option value="level">Level</option>
</select>
</div>
</div>
<div class="form-row" style="display:flex;gap:10px">
<div class="form-group" style="flex:1">
<label class="form-label">‚ö° Flow Rate:</label>
<input type="number" step="any" class="form-input" id="ltRate" placeholder="Rate" required>
</div>
<div class="form-group" style="flex:1">
<label class="form-label">üìè Rate Unit:</label>
<select class="form-select" id="ltRateUnit" required>
<option value="bbl">bbl/hr</option>
<option value="m3">m¬≥/hr</option>
<option value="mtr">meter/hr</option>
</select>
</div>
</div>
<div class="form-row" style="display:flex;gap:10px">
<div class="form-group" style="flex:1">
<label class="form-label">üìÖ Finish Date:</label>
<input type="text" class="form-input" id="ltDate" readonly style="background:#f5f5f5">
</div>
<div class="form-group" style="flex:1">
<label class="form-label">‚è∞ Finish Time:</label>
<input type="text" class="form-input" id="ltTime" readonly style="background:#f5f5f5">
</div>
</div>
<div class="form-group">
<label class="form-label">üìù Notes (Optional):</label>
<textarea class="form-textarea" id="ltNotes" placeholder="Additional information..."></textarea>
</div>
<div class="modal-buttons">
<button type="button" class="btn btn-secondary" onclick="closeLTModal()">‚ùå Cancel</button>
<button type="submit" class="btn btn-primary">üíæ Add to Live Tanks</button>
</div>
</form>
</div>
</div>
<script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';import{getFirestore,doc,getDoc,setDoc,updateDoc,collection,addDoc,serverTimestamp}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
const app=initializeApp({apiKey:"AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",authDomain:"tank-tools-knpc-c2d95.firebaseapp.com",projectId:"tank-tools-knpc-c2d95",storageBucket:"tank-tools-knpc-c2d95.firebasestorage.app",messagingSenderId:"510062594324",appId:"1:510062594324:web:b892fd02007a5ca2f0da01"});
window.db=getFirestore(app);window.doc=doc;window.getDoc=getDoc;window.setDoc=setDoc;window.addDoc=addDoc;window.serverTimestamp=serverTimestamp;window.collection=collection;
</script>
<script>
let currentUser=null,c=0,m=0,x=0,calcData=null;
const tanks={"225":{comment:12879,min:3.353,max:15.24},"226":{comment:12879,min:3.353,max:15.24},"227":{comment:11327,min:2,max:17.95},"253":{comment:10781,min:2,max:17.093},"254":{comment:12288,min:2,max:14.96},"255":{comment:12287,min:2,max:14.96},"256":{comment:12287,min:2,max:14.96},"260":{comment:2249,min:2,max:13},"272":{comment:7217,min:2,max:15.309},"273":{comment:4198,min:2,max:13.468},"274":{comment:4198,min:2,max:13.458},"275":{comment:9563,min:2,max:17.897},"276":{comment:7236,min:2,max:15.442},"277":{comment:4188,min:2,max:13.714},"278":{comment:9506,min:1.98,max:17.89},"279":{comment:4118,min:1.98,max:15.977},"301":{comment:7756,min:3.048,max:18.54},"302":{comment:7756,min:3.048,max:18.54},"303":{comment:6070,min:2.59,max:14.173},"304":{comment:6070,min:2.59,max:14.173},"305":{comment:7171,min:0.533,max:18.797},"450":{comment:3155,min:2,max:14.2},"451":{comment:930,min:2,max:13},"452":{comment:4587,min:2,max:13},"453":{comment:5067,min:2,max:17.8},"454":{comment:1653,min:2,max:11.36},"455":{comment:1654,min:2,max:11.36},"456":{comment:11574,min:2.68,max:13.41},"457":{comment:9697,min:5.4,max:16.45},"458":{comment:9697,min:5.4,max:16.45},"459":{comment:9466,min:2,max:14.35},"460":{comment:14213,min:2,max:17.65},"461":{comment:14213,min:2,max:17.653},"462":{comment:12354,min:2,max:16.46},"463":{comment:9578,min:2,max:17.89},"464":{comment:9578,min:2,max:17.889},"465":{comment:9572,min:2,max:17.89},"467":{comment:12375,min:2,max:17.771},"468":{comment:12375,min:2,max:17.771},"469":{comment:12375,min:2,max:17.771},"470":{comment:12375,min:2,max:17.77},"503":{comment:2888,min:2.13,max:10.97},"504":{comment:2888,min:2.13,max:10.97},"506":{comment:930,min:0.92,max:14.33},"507":{comment:413,min:2,max:6.5},"508":{comment:1130,min:1.67,max:12.65},"509":{comment:1130,min:1.67,max:12.65},"510":{comment:529,min:2,max:10.363},"511":{comment:4531,min:0.198,max:9},"512":{comment:2939,min:0.92,max:11.6},"514":{comment:2942,min:0.92,max:12},"515":{comment:2942,min:0.92,max:12},"520":{comment:4142,min:1.88,max:14.29},"521":{comment:4142,min:1.88,max:14.29},"522":{comment:11990,min:1.61,max:15.6},"531":{comment:12377,min:2,max:17.77},"532":{comment:12377,min:2,max:17.772},"533":{comment:12377,min:2,max:17.772},"534":{comment:12377,min:2,max:17.772},"600":{comment:9490,min:2,max:13.3},"601":{comment:9490,min:2,max:13.3},"602":{comment:9512,min:2,max:13.73},"603":{comment:11695,min:2,max:13.325},"605":{comment:12964,min:2,max:14.325},"608":{comment:1060,min:2,max:11.887},"620":{comment:11981,min:1.65,max:16.5},"621":{comment:11981,min:1.65,max:16.5},"622":{comment:5019,min:2,max:15.76},"623":{comment:5050,min:1.6,max:15.76},"633":{comment:412,min:2,max:6},"634":{comment:412,min:2,max:6},"651":{comment:6543,min:2,max:13.325},"652":{comment:6543,min:2,max:13.32},"661":{comment:12354,min:2,max:17.759},"662":{comment:5074,min:2,max:14.802},"663":{comment:1507,min:2,max:10.23},"664":{comment:7250,min:2,max:15.22},"665":{comment:7250,min:2,max:15.22},"667":{comment:12278,min:2,max:17.922},"668":{comment:16858,min:2,max:18.165},"669":{comment:16858,min:2,max:18.17},"670":{comment:16856,min:2,max:18.165},"671":{comment:12863,min:2,max:16.45},"672":{comment:13046,min:2,max:16.45},"703":{comment:12931,min:2,max:14.88},"705":{comment:12931,min:2,max:14.88},"725":{comment:1080,min:0.914,max:11.887},"751":{comment:12834,min:2,max:15.1},"752":{comment:12834,min:2,max:15.1},"753":{comment:12834,min:2,max:15.1},"754":{comment:12834,min:2,max:15.1},"755":{comment:12834,min:2,max:15.1},"756":{comment:12962,min:2,max:15.1},"757":{comment:10989,min:2,max:17.8},"761":{comment:20546,min:2,max:14.2},"762":{comment:20546,min:2,max:18.798},"820":{comment:16656,min:1.6,max:18.48},"821":{comment:16656,min:1.6,max:18.48},"822":{comment:16856,min:1.6,max:18.48},"831":{comment:11297,min:2,max:18.41},"832":{comment:11297,min:2,max:18.409},"833":{comment:7279,min:3.25,max:18.012},"834":{comment:7279,min:3.25,max:18.012},"835":{comment:7305,min:2,max:15.226},"836":{comment:7305,min:2,max:15.226},"900":{comment:2644,min:1.6,max:11.9},"901":{comment:2692,min:2,max:12.02},"760":{comment:20546,min:2,max:18.798},"702":{comment:12931,min:2,max:16.15},"758":{comment:20546,min:2,max:14.5},"759":{comment:20546,min:2,max:14.5}};
const products={"PBCR":["LSFO","EGO 10PPM","EGO 500PPM","RHN","PCNA","NMOGAS","OLMOGAS","ATK","ARDR","IC5","ISOM","SLOP"],"WASHERY":["MOGAS 98","MOGAS 95","MOGAS 91","GO","KERO","ATK","Slop"],"PLCR":["Heavy Oil","Light Product","Mixed Product","Refined Oil","Final Product","Blended Oil"]};
window.addEventListener('load',()=>setTimeout(checkLogin,100));
function checkLogin(){const s=sessionStorage.getItem('tanktools_session'),u=localStorage.getItem('tanktools_current_user');if(s!=='active'||!u){showAccess();return}try{currentUser=JSON.parse(u);if(!currentUser||!currentUser.username){showAccess();return}initApp()}catch{showAccess()}}
function showAccess(){document.getElementById('mainContent').style.display='none';document.getElementById('accessDenied').style.display='flex'}
window.goToLogin=()=>{sessionStorage.setItem('tanktools_redirect','index.html');window.location.href='login.html'};
function initApp(){document.getElementById('mainContent').style.display='block';document.getElementById('accessDenied').style.display='none';loadUser();loadData();setupDark()}
function loadUser(){if(!currentUser)return;document.getElementById('userName').textContent=currentUser.username;document.getElementById('userAvatar').textContent=(currentUser.fullName||currentUser.username).charAt(0).toUpperCase();if(currentUser.username==='fam030'||currentUser.role==='admin')document.getElementById('adminLink').style.display='inline-block';const roles=["admin","panel_operator","supervisor","section_head","operator","planning"];if(roles.includes(currentUser.role))document.getElementById('live-tanks-btn').style.display='inline-block'}
window.logout=()=>{sessionStorage.removeItem('tanktools_session');localStorage.removeItem('tanktools_current_user');window.location.href='login.html'};
window.loadTank=()=>{const id=document.getElementById("tankInput").value.trim();if(tanks[id]){c=tanks[id].comment;m=tanks[id].min;x=tanks[id].max}else{c=m=x=0}calculate()};
window.calculate=()=>{const level=parseFloat(document.getElementById("level").value||0),target=parseFloat(document.getElementById("target").value||0),flowRaw=parseFloat(document.getElementById("flowrate").value||0),unit=document.getElementById("flowUnit").value,mode=document.getElementById("mode").value;const available=document.getElementById("availablePumpable"),ullageDiv=document.getElementById("currentUllage"),levelEst=document.getElementById("levelEstimate"),valueDiff=document.getElementById("valueDiff"),output=document.getElementById("output"),calendar=document.getElementById("calendarLink");calcData=null;document.getElementById('add-to-live-tanks-btn').style.display='none';if(!c||isNaN(level)){available.innerText=ullageDiv.innerText=valueDiff.innerText=levelEst.innerText=output.innerHTML="";return}const availablePumpable=(level-m)*c,currentUllage=(x-level)*c;available.innerText=`Available Pumpable: ${availablePumpable.toFixed(2)} bbl`;ullageDiv.innerText=`Current Ullage: ${currentUllage.toFixed(2)} bbl`;if(!isNaN(target)){let estLevel=0;if(mode==="pumpable")estLevel=(target/c)+m;else if(mode==="ullage")estLevel=x-(target/c);else if(mode==="level")estLevel=target;const levelDiff=estLevel-level;let estText=`Level Estimate: ${estLevel.toFixed(2)} m\nLevel Difference: ${levelDiff.toFixed(2)} m`;if(estLevel>=x-0.5||estLevel<m){levelEst.style.color="#ff5555";estText+=`\nHigh Level = ${x.toFixed(2)} m`}else{levelEst.style.color="#00ffff"}levelEst.innerText=estText;let diff=0;if(mode==="pumpable"){diff=target-availablePumpable;valueDiff.innerText=`Difference: ${diff.toLocaleString()} bbl`}else if(mode==="ullage"){diff=currentUllage-target;valueDiff.innerText=`To leave ${target.toLocaleString()} bbl ullage, fill: ${diff.toLocaleString()} bbl`}else if(mode==="level"){const meters=level-target;diff=meters*c;valueDiff.innerText=`Level Difference: ${Math.abs(meters).toFixed(2)} m`}const flow=unit==="m3"?flowRaw*6.28:unit==="mtr"?flowRaw:flowRaw;let time=0;if(unit==="mtr"&&mode!=="level"){time=Math.abs(diff/c)/flowRaw}else if(mode==="level"&&unit==="mtr"){time=Math.abs(level-target)/flowRaw}else{time=Math.abs(diff)/flow}if(!isNaN(time)&&time>0){const hrs=Math.floor(time),mins=Math.round((time%1)*60),now=new Date(),finish=new Date(now.getTime()+time*3600000);let ft,fd;try{ft=finish.toLocaleTimeString('en-GB',{hour:"2-digit",minute:"2-digit",hour12:false});fd=finish.toLocaleDateString('en-GB')}catch{ft=`${finish.getHours().toString().padStart(2,'0')}:${finish.getMinutes().toString().padStart(2,'0')}`;fd=`${finish.getDate()}/${finish.getMonth()+1}/${finish.getFullYear()}`}output.innerHTML=`Time Needed: ${hrs} hr ${mins} min<br>Finish Time: ${ft}<br>Finish Date: ${fd}`;const s=new Date(finish.getTime()-600000),e=new Date(s.getTime()+900000);calendar.href=`https://calendar.google.com/calendar/render?action=TEMPLATE&text=Tank+${document.getElementById("tankInput").value||"Tank"}+Reminder&dates=${s.toISOString().replace(/[-:]|\.\d{3}/g,"")}/${e.toISOString().replace(/[-:]|\.\d{3}/g,"")}`;output.style.color=isSameShift(now,finish)?"red":"lightgreen";calcData={tankNumber:document.getElementById("tankInput").value,finishDate:`${finish.getFullYear()}-${String(finish.getMonth()+1).padStart(2,'0')}-${String(finish.getDate()).padStart(2,'0')}`,finishTime:ft};if(currentUser&&["admin","panel_operator"].includes(currentUser.role))document.getElementById('add-to-live-tanks-btn').style.display='inline-flex';
  // Log calculation activity
  if(currentUser && document.getElementById("tankInput").value) {
    logPBCRCalculation(document.getElementById("tankInput").value, hrs, mins, ft, fd);
  }
}}saveData()};
function isSameShift(now,finish){const getShift=h=>{const m=h.getHours()*60+h.getMinutes();return m>=360&&m<840?"morning":m>=840&&m<1320?"evening":"night"};const currentShift=getShift(now),finishShift=getShift(finish);if(currentShift!==finishShift)return false;if(currentShift==="night"){const nowHour=now.getHours(),finishHour=finish.getHours();if(nowHour>=0&&nowHour<6){if(finishHour>=0&&finishHour<6)return Math.floor((finish.getTime()-now.getTime())/(24*60*60*1000))<=1;else if(finishHour>=22)return Math.floor((finish.getTime()-now.getTime())/(24*60*60*1000))===0}else if(nowHour>=22){if(finishHour>=22)return now.toDateString()===finish.toDateString();else if(finishHour>=0&&finishHour<6)return Math.floor((finish.getTime()-now.getTime())/(24*60*60*1000))===1}return false}return now.toDateString()===finish.toDateString()}
window.openLTModal=()=>{if(!calcData){alert('‚ùå Please calculate tank finish time first!');return}
  // Fill basic data
  document.getElementById('ltTank').value=calcData.tankNumber;
  document.getElementById('ltDate').value=calcData.finishDate;
  document.getElementById('ltTime').value=calcData.finishTime;
  
  // Auto-fill target data from calculations
  const mode=document.getElementById('mode').value;
  const target=document.getElementById('target').value;
  const flowrate=document.getElementById('flowrate').value;
  const flowUnit=document.getElementById('flowUnit').value;
  
  // Set target type based on mode
  document.getElementById('ltTargetType').value=mode;
  
  // Set target value
  document.getElementById('ltTargetValue').value=target;
  
  // Set flow rate
  document.getElementById('ltRate').value=flowrate;
  document.getElementById('ltRateUnit').value=flowUnit;
  
  // Reset other fields
  document.getElementById('ltDept').value='';
  document.getElementById('ltProduct').innerHTML='<option value="">Select Product</option>';
  document.getElementById('ltNotes').value='';
  
  document.getElementById('ltModal').classList.add('show')
};
window.closeLTModal=()=>document.getElementById('ltModal').classList.remove('show');
window.updateLTProducts=()=>{const dept=document.getElementById('ltDept').value,sel=document.getElementById('ltProduct');sel.innerHTML='<option value="">Select Product</option>';if(dept&&products[dept])products[dept].forEach(p=>{const opt=document.createElement('option');opt.value=p;opt.textContent=p;sel.appendChild(opt)})};
document.getElementById('ltForm').addEventListener('submit',async function(e){e.preventDefault();const dept=document.getElementById('ltDept').value,tank=document.getElementById('ltTank').value,product=document.getElementById('ltProduct').value,targetValue=document.getElementById('ltTargetValue').value,targetType=document.getElementById('ltTargetType').value,rate=document.getElementById('ltRate').value,rateUnit=document.getElementById('ltRateUnit').value,date=document.getElementById('ltDate').value,time=document.getElementById('ltTime').value,notes=document.getElementById('ltNotes').value;if(!dept||!product){alert('‚ùå Please select department and product!');return}const currentLevel=parseFloat(document.getElementById('level').value)||null;try{await addDoc(collection(db,'liveTanks'),{department:dept,tankNumber:tank,product:product,targetValue:parseFloat(targetValue)||null,targetType:targetType||null,currentLevel:currentLevel,rate:parseFloat(rate)||null,rateUnit:rateUnit||null,addedBy:currentUser.username,userName:currentUser.fullName||currentUser.username,finishTime:time,finishDate:date,finishDateTime:new Date(date+' '+time),addedAt:serverTimestamp(),lastLevelUpdate:serverTimestamp(),status:'active',notes:notes,source:'PBCR_Calculator'});alert(`‚úÖ Tank ${tank} added to Live Tanks!`);closeLTModal()}catch(err){alert('‚ùå Error: '+err.message)}});
window.addToTable=()=>{const tankNum=document.getElementById("tankInput").value,output=document.getElementById("output").innerHTML;if(!tankNum||!output.includes("Finish Time"))return;const timeMatch=output.match(/Finish Time: (.*?)<br>/),dateMatch=output.match(/Finish Date: (.*?)($|<br>)/);if(!timeMatch||!dateMatch)return;const time=timeMatch[1].trim(),date=dateMatch[1].trim(),table=document.querySelector("#tankTable tbody"),newRowData={tankNum,date,time,finishDateTime:new Date(date+" "+time)};const existingRows=Array.from(table.rows).map(row=>({row:row,tankNum:row.cells[0].textContent,date:row.cells[1].textContent,time:row.cells[2].textContent,finishDateTime:new Date(row.cells[1].textContent+" "+row.cells[2].textContent)}));existingRows.push(newRowData);existingRows.sort((a,b)=>a.finishDateTime-b.finishDateTime);table.innerHTML='';existingRows.forEach(item=>{const row=table.insertRow();row.insertCell().textContent=item.tankNum;row.insertCell().textContent=item.date;row.insertCell().textContent=item.time;const cell4=row.insertCell(),delBtn=document.createElement("button");delBtn.innerHTML="üóëÔ∏è";delBtn.style.cssText="background:none;border:none;cursor:pointer;font-size:16px";delBtn.onclick=()=>{row.remove();saveData()};cell4.appendChild(delBtn)});saveData()};
async function saveData(){if(!currentUser)return;try{await setDoc(doc(db,'userTables',currentUser.username),{pbcrData:{tankInput:document.getElementById('tankInput').value,level:document.getElementById('level').value,target:document.getElementById('target').value,mode:document.getElementById('mode').value,flowrate:document.getElementById('flowrate').value,flowUnit:document.getElementById('flowUnit').value},pbcrTables:Array.from(document.querySelector('#tankTable tbody').rows).map(row=>({tankNum:row.cells[0].textContent,date:row.cells[1].textContent,time:row.cells[2].textContent}))},{merge:true})}catch{}}
async function loadData(){if(!currentUser)return;try{const doc=await getDoc(window.doc(db,'userTables',currentUser.username));if(doc.exists()){const data=doc.data();if(data.pbcrData){const d=data.pbcrData;document.getElementById('tankInput').value=d.tankInput||'';document.getElementById('level').value=d.level||'';document.getElementById('target').value=d.target||'';document.getElementById('mode').value=d.mode||'pumpable';document.getElementById('flowrate').value=d.flowrate||'';document.getElementById('flowUnit').value=d.flowUnit||'bbl';if(d.tankInput)loadTank()}if(data.pbcrTables){data.pbcrTables.forEach(item=>{const row=document.querySelector('#tankTable tbody').insertRow();row.insertCell().textContent=item.tankNum;row.insertCell().textContent=item.date;row.insertCell().textContent=item.time;const cell4=row.insertCell(),delBtn=document.createElement('button');delBtn.innerHTML='üóëÔ∏è';delBtn.style.cssText='background:none;border:none;cursor:pointer;font-size:16px';delBtn.onclick=()=>{row.remove();saveData()};cell4.appendChild(delBtn)})}}}catch{}}
function setupDark(){let dark=localStorage.getItem('darkMode')==='true';const btn=document.getElementById('darkModeButton');function update(){if(dark){document.body.style.background='linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url("background.jpg")';btn.innerHTML='‚òÄÔ∏è'}else{document.body.style.background='linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url("background.jpg")';btn.innerHTML='üåô'}}btn.addEventListener('click',()=>{dark=!dark;localStorage.setItem('darkMode',dark);update()});update()}
document.addEventListener('input',e=>{if(e.target.matches('#tankInput,#level,#target,#flowrate'))clearTimeout(window.saveTimeout),window.saveTimeout=setTimeout(saveData,2000)});
// Font size control functions
let currentFontSize = parseInt(localStorage.getItem('tanktools_font_size_index') || '16');

function increaseFontSize() {
  if (currentFontSize < 24) {
    currentFontSize += 2;
    applyFontSize();
    localStorage.setItem('tanktools_font_size_index', currentFontSize);
    showFontMessage(`üìà Font size increased to ${currentFontSize}px`);
  }
}

function decreaseFontSize() {
  if (currentFontSize > 12) {
    currentFontSize -= 2;
    applyFontSize();
    localStorage.setItem('tanktools_font_size_index', currentFontSize);
    showFontMessage(`üìâ Font size decreased to ${currentFontSize}px`);
  }
}

function applyFontSize() {
  const style = document.createElement('style');
  style.id = 'dynamic-font-style';
  
  const existingStyle = document.getElementById('dynamic-font-style');
  if (existingStyle) {
    existingStyle.remove();
  }
  
  style.textContent = `
    input, select { font-size: ${currentFontSize}px !important; }
    .result { font-size: ${currentFontSize}px !important; }
    #tankTable { font-size: ${currentFontSize - 2}px !important; }
    #tankTable th { font-size: ${currentFontSize - 1}px !important; }
    h2 { font-size: ${currentFontSize + 8}px !important; }
    .reminder-btn, .add-btn, .live-tanks-btn { font-size: ${currentFontSize - 2}px !important; }
  `;
  
  document.head.appendChild(style);
}

function showFontMessage(message) {
  const msgDiv = document.createElement('div');
  msgDiv.style.cssText = 'position:fixed;top:80px;right:20px;background:rgba(76,175,80,0.9);color:white;padding:10px 15px;border-radius:8px;font-size:12px;z-index:1000;animation:slideIn 0.3s ease';
  msgDiv.textContent = message;
  document.body.appendChild(msgDiv);
  setTimeout(() => msgDiv.remove(), 3000);
}

// Apply saved font size on page load
applyFontSize();

window.increaseFontSize = increaseFontSize;
window.decreaseFontSize = decreaseFontSize;

console.log('%cüî• PBCR Live Tanks Integration v4.2','color:green;font-size:16px;font-weight:bold');

// Calendar Help Function
function showCalendarHelp() {
  const userAgent = navigator.userAgent.toLowerCase();
  let platform = '';
  let storeIcon = '';
  let storeUrl = '';
  let storeName = '';
  
  if (/android/.test(userAgent)) {
    platform = 'Android';
    storeIcon = 'üì±';
    storeUrl = 'https://play.google.com/store/apps/details?id=com.google.android.calendar';
    storeName = 'Google Play Store';
  } else if (/iphone|ipad|ipod/.test(userAgent)) {
    platform = 'iOS';
    storeIcon = 'üçé';
    storeUrl = 'https://apps.apple.com/app/google-calendar/id909319292';
    storeName = 'App Store';
  } else if (/windows/.test(userAgent)) {
    platform = 'Windows';
    storeIcon = 'ü™ü';
    storeUrl = 'https://calendar.google.com/';
    storeName = 'Google Calendar Web';
  } else if (/mac/.test(userAgent)) {
    platform = 'Mac';
    storeIcon = 'üçé';
    storeUrl = 'https://apps.apple.com/app/google-calendar/id909319292';
    storeName = 'Mac App Store';
  } else {
    platform = 'Web Browser';
    storeIcon = 'üåê';
    storeUrl = 'https://calendar.google.com/';
    storeName = 'Google Calendar Web';
  }
  
  const message = `üìÖ How to use Calendar Reminder:\n\n1. Calculate your tank finish time\n2. Click "üìÖ Add Reminder" button\n3. This will open Google Calendar\n\n${storeIcon} For ${platform} users:\nIf you don't have Google Calendar installed, click below to download:\n\n${storeName}`;
  
  if (confirm(message + '\n\nClick OK to download Google Calendar now, or Cancel to continue.')) {
    window.open(storeUrl, '_blank');
  }
}

window.showCalendarHelp = showCalendarHelp;

// PBCR Calculation Activity Logging
async function logPBCRCalculation(tankNumber, hours, minutes, finishTime, finishDate) {
  if (!currentUser) return;
  try {
    const userIP = await fetch('https://api.ipify.org?format=json').then(r => r.json()).then(data => data.ip).catch(() => 'Unknown');
    const timestamp = new Date();
    const timeStr = timestamp.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
    const dateStr = timestamp.toLocaleDateString('en-GB');
    
    const detailedAction = `ÿ™ŸÖ ÿ≠ÿ≥ÿßÿ® Tank ${tankNumber} ŸÅŸä PBCR Calculator - ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©: ${hours}h ${minutes}m (ÿßŸÜÿ™Ÿáÿßÿ°: ${finishTime} - ${finishDate}) ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ${currentUser.username} ŸÅŸä ${timeStr} - ${dateStr}`;
    
    await addDoc(collection(db, 'activities'), {
      action: detailedAction,
      originalAction: 'pbcr_calculation',
      username: currentUser.username,
      tankNumber: tankNumber,
      calculationResult: `${hours}h ${minutes}m`,
      finishTime: finishTime,
      finishDate: finishDate,
      timestamp: serverTimestamp(),
      ip: userIP,
      userAgent: navigator.userAgent.substring(0, 100),
      page: 'pbcr-calculator'
    });
  } catch (error) {
    console.error('Error logging PBCR calculation:', error);
  }
}

// Live Tanks Help Function
function showLiveTanksHelp() {
  alert('üî¥ Add to Live Tanks:\n\nAdds your tank to the live monitoring system.\nAll users can see when your tank will finish.\nUseful for coordination between shifts and departments.\n\nNote: Requires panel operator or admin access.');
}

// Table Help Function  
function showTableHelp() {
  alert('üìä Add to Table:\n\nAdds tank to your personal table below.\nOnly you can see this table - it\'s private to your account.\nUseful for tracking your own tanks during the shift.\n\nYour personal reminder system.');
}

window.showLiveTanksHelp = showLiveTanksHelp;
window.showTableHelp = showTableHelp;
</script>

<footer>
  By <a href="#" class="whatsapp-link" onclick="window.open('https://wa.me/96555222550','_blank'); return false;">Fahad - 17877</a> ‚Äì Version v4.2
  <br><small style="color:#999;font-size:10px;margin-top:5px;display:block">üì± WhatsApp: +965 55222550</small>
</footer>

<style>
footer{margin-top:40px;color:#ccc;text-align:center}
.whatsapp-link{color:#25D366;text-decoration:none;font-weight:bold;transition:all 0.3s ease;cursor:pointer}
.whatsapp-link:hover{color:#128C7E;text-shadow:0 0 5px rgba(37,211,102,0.5);transform:scale(1.05)}
</style>

</body>
</html>