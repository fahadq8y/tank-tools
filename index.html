<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PBCR & WASHERY</title>
  <link href="icon.png" rel="icon" type="image/png"/>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#003366">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;color:white;font-family:Arial,sans-serif;padding:20px;text-align:center;min-height:100vh}
    .nav-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(0,0,0,0.5);border-radius:10px;margin-bottom:20px}
    .nav-logo{font-size:24px;font-weight:bold;color:white}
    .nav-links{display:flex;gap:20px}
    .nav-link{color:white;text-decoration:none;padding:5px 10px;border-radius:5px;transition:background-color 0.3s}
    .nav-link:hover{background:rgba(255,255,255,0.2)}
    .nav-link.active{background:rgba(255,255,255,0.3);font-weight:bold}
    .nav-admin{background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366;font-weight:bold;border-radius:8px;padding:8px 15px;text-decoration:none;transition:all 0.3s ease}
    .nav-user{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.1);padding:5px 15px;border-radius:20px;backdrop-filter:blur(10px)}
    .user-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(45deg,#4CAF50,#45a049);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px}
    .logout-btn{background:rgba(255,0,0,0.2);border:1px solid rgba(255,0,0,0.5);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:12px;transition:all 0.3s ease}
    input,select{background:rgba(255,255,255,0.9);border-radius:12px;border:none;color:#003366;box-shadow:0 2px 5px rgba(0,0,0,0.3);font-size:16px;margin:10px;padding:10px;width:250px}
    .row{display:flex;justify-content:center;align-items:center;gap:8px;margin:10px 0;max-width:400px;margin-left:auto;margin-right:auto}
    .row input,.row select{margin:0;flex:1;width:50%}
    .result{margin-top:10px;font-weight:bold;color:#00ffff}
    #tankTable{margin:auto;background:rgba(255,255,255,0.85);color:#003366;border-collapse:separate;border-spacing:0;border-radius:12px;overflow:hidden;min-width:300px}
    #tankTable th{padding:10px;border-bottom:1px solid #003366}
    .reminder-btn,.add-btn{padding:12px 40px;font-size:16px;border-radius:12px;background:white;color:#003366;border:none;cursor:pointer;margin:5px}
    .add-btn{padding:8px 20px;font-size:14px;background:rgba(255,255,255,0.8)}
    footer{margin-top:40px;color:#ccc;text-align:center}
    .whatsapp-link{color:#25D366;text-decoration:none;font-weight:bold;transition:all 0.3s ease;cursor:pointer}
    .whatsapp-link:hover{color:#128C7E;text-shadow:0 0 5px rgba(37,211,102,0.5);transform:scale(1.05)}
    .action-button{position:fixed;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.3);border:none;font-size:20px;color:white;box-shadow:0 2px 5px rgba(0,0,0,0.3);cursor:pointer;display:flex;align-items:center;justify-content:center;top:10px;right:10px}
    .dark-mode{background:linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url('background.jpg')!important}
    .dark-mode .result{color:#ffcc00!important}
    .dark-mode #tankTable{background:rgba(40,40,60,0.85)!important;color:#eee!important}
    .dark-mode #tankTable th{border-bottom:1px solid #555!important}
    .dark-mode input,.dark-mode select{background:rgba(50,50,70,0.9)!important;color:#eee!important}
    .access-denied{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url('background.jpg');background-size:cover;background-position:center;display:flex;justify-content:center;align-items:center;z-index:9999}
    .access-denied-content{text-align:center;background:rgba(255,255,255,0.1);padding:40px;border-radius:20px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2)}
    .access-denied-icon{font-size:5rem;color:#f44336;margin-bottom:20px}
    .access-denied-title{font-size:2rem;color:#f44336;margin-bottom:15px}
    .access-denied-text{font-size:1.2rem;margin-bottom:20px;opacity:0.8}
    .login-btn{padding:12px 25px;background:linear-gradient(45deg,#4CAF50,#45a049);color:white;border:none;border-radius:10px;cursor:pointer;font-size:16px;transition:all 0.3s ease;margin:5px}
    .security-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;backdrop-filter:blur(5px)}
    .security-modal.show{display:flex;justify-content:center;align-items:center}
    .security-modal-content{background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;max-width:500px;width:90%;color:#003366;text-align:center;animation:modalSlideIn 0.5s ease}
    @keyframes modalSlideIn{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}
    .security-icon{font-size:3rem;margin-bottom:15px}
    .security-title{font-size:1.5rem;margin-bottom:15px;font-weight:bold}
    .security-text{margin-bottom:20px;line-height:1.5}
    .attempt-counter{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#f57c00;padding:10px;border-radius:8px;margin:15px 0;font-weight:bold}
    .security-buttons{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .modal-btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s ease}
    .modal-btn-primary{background:#4CAF50;color:white}
    .modal-btn-secondary{background:#2196F3;color:white}
    .modal-btn-danger{background:#f44336;color:white}
    .modal-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.3)}
    @media (max-width:600px){input,select{width:90%!important}.row{flex-direction:row!important;justify-content:center;gap:5px;max-width:350px}.row input,.row select{width:50%!important;margin:0!important;flex:1}.nav-bar{flex-direction:column;gap:10px}.nav-links{order:1}.nav-user{order:2;width:100%;justify-content:space-between}.security-buttons{flex-direction:column}.modal-btn{width:100%}}
  </style>
</head>
<body>
  <!-- Security Modal -->
  <div id="securityModal" class="security-modal">
    <div class="security-modal-content">
      <div class="security-icon" id="securityIcon">‚ö†Ô∏è</div>
      <div class="security-title" id="securityTitle">Security Warning</div>
      <div class="security-text" id="securityText">We detected you trying to access developer tools.</div>
      <div class="attempt-counter" id="attemptCounter">Attempts: <span id="attemptCount">1</span>/3</div>
      <div class="security-buttons">
        <button class="modal-btn modal-btn-primary" onclick="acknowledgeWarning()">I Understand</button>
        <button class="modal-btn modal-btn-secondary" onclick="resetPage()">Reset Page</button>
        <button class="modal-btn modal-btn-danger" onclick="learnMore()">Learn More</button>
      </div>
    </div>
  </div>

  <!-- Access Denied -->
  <div id="accessDenied" class="access-denied" style="display:none">
    <div class="access-denied-content">
      <div class="access-denied-icon">üîí</div>
      <div class="access-denied-title">Login Required</div>
      <div class="access-denied-text">You need to login to access PBCR & WASHERY application.<br>Please login with your KNPC credentials.</div>
      <button class="login-btn" onclick="goToLogin()">Go to Login</button>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent">
    <div class="nav-bar">
      <div class="nav-logo">Tank Tools</div>
      <div class="nav-links">
        <a class="nav-link active" href="index.html">PBCR</a>
        <a class="nav-link" href="plcr.html">PLCR</a>
        <a class="nav-link" href="NMOGASBL.html">NMOGAS</a>
        <a class="nav-admin" href="dashboard.html" id="adminLink" style="display:none">üîê Dashboard</a>
      </div>
      <div class="nav-user" id="navUser">
        <div class="user-avatar" id="userAvatar">U</div>
        <div id="userName">User</div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <h2>PBCR & WASHERY (Version 3.0)</h2>
    
    <input id="tankInput" oninput="loadTank()" placeholder="Enter Tank Number" type="number"/><br/>
    <input id="level" oninput="calculate()" placeholder="Current Level (m)" type="number"/><br/>
    <div class="result" id="availablePumpable"></div>
    <div class="result" id="currentUllage"></div>
    
    <div class="row">
      <input id="target" oninput="calculate()" placeholder="Target Value" type="number"/>
      <select id="mode" onchange="calculate()">
        <option value="pumpable">Pumpable</option>
        <option value="ullage">Ullage</option>
        <option value="level">Level</option>
      </select>
    </div>
    <div class="result" id="valueDiff"></div>
    <div class="result" id="levelEstimate"></div>
    
    <div class="row">
      <input id="flowrate" oninput="calculate()" placeholder="Flowrate" type="number"/>
      <select id="flowUnit" onchange="calculate()">
        <option value="bbl">bbl/hr</option>
        <option value="m3">m¬≥/hr</option>
        <option value="mtr">meter/hr</option>
      </select>
    </div>
    
    <div class="result" id="output"></div>
    
    <div style="margin-top:20px;text-align:center">
      <div style="display:inline-flex;align-items:center;gap:8px">
        <a href="#" id="calendarLink" target="_blank">
          <button class="reminder-btn">Add Reminder</button>
        </a>
        <button onclick="openCalendarInfo()" style="padding:6px 10px;font-size:12px;border-radius:6px;background:rgba(255,165,0,0.9);color:#fff;font-weight:bold;border:1px solid #ff8c00;cursor:pointer" title="Compatible with Google Calendar">‚ùó</button>
      </div>
    </div>
    <div style="margin-top:10px;text-align:center">
      <button onclick="addToTable()" class="add-btn">Add to Table</button>
    </div>

    <h3 style="margin-top:40px">Tanks finishing in current shift:</h3>
    <table id="tankTable">
      <thead>
        <tr><th>Tank Number</th><th>Finish Date</th><th>Finish Time</th><th>Delete</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    
    <button id="darkModeButton" class="action-button" title="Dark Mode">üåô</button>
    
    <footer>
      By <a href="#" class="whatsapp-link" onclick="openWhatsApp(); return false;">Fahad - 17877</a> ‚Äì Version 3.0
      <br><small style="color:#999;font-size:10px;margin-top:5px;display:block">üì± WhatsApp: +965 55222550</small>
    </footer>
  </div>

  <script>
    // üîí Smart Security System - Compact Version
    (function(){
      let attempts=0,modalOpen=false;
      function initSecurity(){
        document.addEventListener('contextmenu',handleViolation.bind(null,'context-menu'));
        document.addEventListener('selectstart',e=>{if(!e.target.matches('input,textarea'))handleViolation('text-selection')(e)});
        document.addEventListener('keydown',e=>{
          const dangerous=[(e.ctrlKey&&e.key==='u'),(e.ctrlKey&&e.key==='s'),(e.ctrlKey&&e.shiftKey&&e.key==='I'),(e.key==='F12'),(e.ctrlKey&&e.shiftKey&&e.key==='C'),(e.ctrlKey&&e.shiftKey&&e.key==='J'),(e.ctrlKey&&e.key==='c'&&!e.target.matches('input,textarea')),(e.ctrlKey&&e.key==='a'&&!e.target.matches('input,textarea'))];
          if(dangerous.some(c=>c))handleViolation('keyboard-shortcut')(e)
        });
        let devOpen=false;
        setInterval(()=>{
          const threshold=160,wDiff=window.outerWidth-window.innerWidth,hDiff=window.outerHeight-window.innerHeight;
          if(wDiff>threshold||hDiff>threshold){if(!devOpen){devOpen=true;handleViolation('devtools-detected')()}}else{devOpen=false}
        },2000)
      }
      function handleViolation(type){
        return function(e){
          if(e&&e.preventDefault)e.preventDefault();
          attempts++;
          if(attempts===1)showWarning('first');
          else if(attempts===2)showWarning('second');
          else if(attempts>=3)showWarning('final');
          return false
        }
      }
      function showWarning(level){
        if(modalOpen)return;
        const modal=document.getElementById('securityModal'),icon=document.getElementById('securityIcon'),title=document.getElementById('securityTitle'),text=document.getElementById('securityText'),counter=document.getElementById('attemptCounter'),countSpan=document.getElementById('attemptCount');
        modalOpen=true;countSpan.textContent=attempts;
        if(level==='first'){
          icon.textContent='üëÄ';title.textContent='Security Notice';
          text.innerHTML='<p>We noticed you tried to access developer tools on PBCR system.</p><p><strong>If this was accidental:</strong> No problem! Click "I Understand" to continue.</p>';
          counter.style.background='rgba(33,150,243,0.2)';counter.style.borderColor='rgba(33,150,243,0.5)';counter.style.color='#2196F3'
        }else if(level==='second'){
          icon.textContent='‚ö†Ô∏è';title.textContent='Security Warning';
          text.innerHTML='<p><strong>Second attempt detected on PBCR application.</strong></p><p>This system is protected for KNPC operations. One more attempt will implement security measures.</p>';
          counter.style.background='rgba(255,193,7,0.2)';counter.style.borderColor='rgba(255,193,7,0.5)';counter.style.color='#ffc107'
        }else{
          icon.textContent='üö´';title.textContent='Security Lock Engaged';
          text.innerHTML='<p><strong>Maximum attempts exceeded on PBCR system.</strong></p><p>Additional monitoring activated. Use "Reset Page" to continue normally.</p>';
          counter.style.background='rgba(244,67,54,0.2)';counter.style.borderColor='rgba(244,67,54,0.5)';counter.style.color='#f44336';
          setTimeout(()=>{if(attempts>=3)implementRestrictions()},5000)
        }
        modal.classList.add('show')
      }
      function implementRestrictions(){
        document.body.style.filter='blur(3px)';
        const overlay=document.createElement('div');
        overlay.innerHTML='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);color:white;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10000;text-align:center;padding:20px"><div style="font-size:4rem;margin-bottom:20px">üõ°Ô∏è</div><h2 style="color:#FFD700;margin-bottom:15px">PBCR System Protected</h2><p style="margin-bottom:30px;max-width:500px;line-height:1.5">Enhanced security monitoring active for KNPC tank operations.</p><button onclick="window.location.reload()" style="padding:12px 24px;background:#FFD700;color:#003366;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold">üîÑ Reset System</button></div>';
        document.body.appendChild(overlay)
      }
      window.acknowledgeWarning=()=>{document.getElementById('securityModal').classList.remove('show');modalOpen=false;showMessage(attempts>=3?'‚ö†Ô∏è Enhanced monitoring active':'‚úÖ Continue normally','success')};
      window.resetPage=()=>window.location.reload();
      window.learnMore=()=>{showMessage('üîí This system protects critical KNPC tank data and operations. Contact Fahad - 17877 for support.','info');document.getElementById('securityModal').classList.remove('show');modalOpen=false};
      initSecurity()
    })();

    // Main Application - Compact Version
    const WHATSAPP_NUMBER="96555222550";
    let currentUser=null,c=0,m=0,x=0;
    
    // Tank data (compressed)
    const tanks={"225":{comment:12879,min:3.353,max:15.24},"226":{comment:12879,min:3.353,max:15.24},"227":{comment:11327,min:2,max:17.95},"253":{comment:10781,min:2,max:17.093},"254":{comment:12288,min:2,max:14.96},"255":{comment:12287,min:2,max:14.96},"256":{comment:12287,min:2,max:14.96},"260":{comment:2249,min:2,max:13},"272":{comment:7217,min:2,max:15.309},"273":{comment:4198,min:2,max:13.468},"274":{comment:4198,min:2,max:13.458},"275":{comment:9563,min:2,max:17.897},"276":{comment:7236,min:2,max:15.442},"277":{comment:4188,min:2,max:13.714},"278":{comment:9506,min:1.98,max:17.89},"279":{comment:4118,min:1.98,max:15.977},"301":{comment:7756,min:3.048,max:18.54},"302":{comment:7756,min:3.048,max:18.54},"303":{comment:6070,min:2.59,max:14.173},"304":{comment:6070,min:2.59,max:14.173},"305":{comment:7171,min:0.533,max:18.797},"450":{comment:3155,min:2,max:14.2},"451":{comment:930,min:2,max:13},"452":{comment:4587,min:2,max:13},"453":{comment:5067,min:2,max:17.8},"454":{comment:1653,min:2,max:11.36},"455":{comment:1654,min:2,max:11.36},"456":{comment:11574,min:2.68,max:13.41},"457":{comment:9697,min:5.4,max:16.45},"458":{comment:9697,min:5.4,max:16.45},"459":{comment:9466,min:2,max:14.35},"460":{comment:14213,min:2,max:17.65},"461":{comment:14213,min:2,max:17.653},"462":{comment:12354,min:2,max:16.46},"463":{comment:9578,min:2,max:17.89},"464":{comment:9578,min:2,max:17.889},"465":{comment:9572,min:2,max:17.89},"467":{comment:12375,min:2,max:17.771},"468":{comment:12375,min:2,max:17.771},"469":{comment:12375,min:2,max:17.771},"470":{comment:12375,min:2,max:17.77},"503":{comment:2888,min:2.13,max:10.97},"504":{comment:2888,min:2.13,max:10.97},"506":{comment:930,min:0.92,max:14.33},"507":{comment:413,min:2,max:6.5},"508":{comment:1130,min:1.67,max:12.65},"509":{comment:1130,min:1.67,max:12.65},"510":{comment:529,min:2,max:10.363},"511":{comment:4531,min:0.198,max:9},"512":{comment:2939,min:0.92,max:11.6},"514":{comment:2942,min:0.92,max:12},"515":{comment:2942,min:0.92,max:12},"520":{comment:4142,min:1.88,max:14.29},"521":{comment:4142,min:1.88,max:14.29},"522":{comment:11990,min:1.61,max:15.6},"531":{comment:12377,min:2,max:17.77},"532":{comment:12377,min:2,max:17.772},"533":{comment:12377,min:2,max:17.772},"534":{comment:12377,min:2,max:17.772},"600":{comment:9490,min:2,max:13.3},"601":{comment:9490,min:2,max:13.3},"602":{comment:9512,min:2,max:13.73},"603":{comment:11695,min:2,max:13.325},"605":{comment:12964,min:2,max:14.325},"608":{comment:1060,min:2,max:11.887},"620":{comment:11981,min:1.65,max:16.5},"621":{comment:11981,min:1.65,max:16.5},"622":{comment:5019,min:2,max:15.76},"623":{comment:5050,min:1.6,max:15.76},"633":{comment:412,min:2,max:6},"634":{comment:412,min:2,max:6},"651":{comment:6543,min:2,max:13.325},"652":{comment:6543,min:2,max:13.32},"661":{comment:12354,min:2,max:17.759},"662":{comment:5074,min:2,max:14.802},"663":{comment:1507,min:2,max:10.23},"664":{comment:7250,min:2,max:15.22},"665":{comment:7250,min:2,max:15.22},"667":{comment:12278,min:2,max:17.922},"668":{comment:16858,min:2,max:18.165},"669":{comment:16858,min:2,max:18.17},"670":{comment:16856,min:2,max:18.165},"671":{comment:12863,min:2,max:16.45},"672":{comment:13046,min:2,max:16.45},"703":{comment:12931,min:2,max:14.88},"705":{comment:12931,min:2,max:14.88},"725":{comment:1080,min:0.914,max:11.887},"751":{comment:12834,min:2,max:15.1},"752":{comment:12834,min:2,max:15.1},"753":{comment:12834,min:2,max:15.1},"754":{comment:12834,min:2,max:15.1},"755":{comment:12834,min:2,max:15.1},"756":{comment:12962,min:2,max:15.1},"757":{comment:10989,min:2,max:17.8},"761":{comment:20546,min:2,max:14.2},"762":{comment:20546,min:2,max:18.798},"820":{comment:16656,min:1.6,max:18.48},"821":{comment:16656,min:1.6,max:18.48},"822":{comment:16856,min:1.6,max:18.48},"831":{comment:11297,min:2,max:18.41},"832":{comment:11297,min:2,max:18.409},"833":{comment:7279,min:3.25,max:18.012},"834":{comment:7279,min:3.25,max:18.012},"835":{comment:7305,min:2,max:15.226},"836":{comment:7305,min:2,max:15.226},"900":{comment:2644,min:1.6,max:11.9},"901":{comment:2692,min:2,max:12.02},"760":{comment:20546,min:2,max:18.798},"702":{comment:12931,min:2,max:16.15},"758":{comment:20546,min:2,max:14.5},"759":{comment:20546,min:2,max:14.5}};

    // Core Functions
    window.addEventListener('load',()=>checkLoginStatus());
    
    function checkLoginStatus(){
      const session=sessionStorage.getItem('tanktools_session'),userData=localStorage.getItem('tanktools_current_user');
      if(session!=='active'||!userData){showAccessDenied();return}
      try{currentUser=JSON.parse(userData);initializeApp();logActivity('pbcr_accessed',currentUser.username)}catch{showAccessDenied()}
    }
    
    function showAccessDenied(){document.getElementById('mainContent').style.display='none';document.getElementById('accessDenied').style.display='flex'}
    
    window.goToLogin=()=>{sessionStorage.setItem('tanktools_redirect','index.html');window.location.href='login.html'};
    
    function initializeApp(){
      document.getElementById('mainContent').style.display='block';
      document.getElementById('accessDenied').style.display='none';
      loadUserInfo();loadDataFromLocalStorage();setupDarkMode()
    }
    
    function loadUserInfo(){
      if(!currentUser)return;
      document.getElementById('userName').textContent=currentUser.username;
      document.getElementById('userAvatar').textContent=(currentUser.fullName||currentUser.username).charAt(0).toUpperCase();
      if(currentUser.username==='fam030'||currentUser.role==='admin')document.getElementById('adminLink').style.display='inline-block'
    }
    
    window.logout=()=>{logActivity('user_logout',currentUser.username);sessionStorage.removeItem('tanktools_session');localStorage.removeItem('tanktools_current_user');window.location.href='login.html'};
    
    function showMessage(message,type){
      const div=document.createElement('div');
      div.innerHTML=message;
      div.style.cssText=`position:fixed;top:20px;right:20px;background:${type==='success'?'#4CAF50':type==='warning'?'#ff9800':'#2196F3'};color:white;padding:15px 20px;border-radius:8px;z-index:10000;max-width:400px;box-shadow:0 4px 12px rgba(0,0,0,0.3)`;
      document.body.appendChild(div);
      setTimeout(()=>div.remove(),5000)
    }
    
    window.loadTank=()=>{
      const id=document.getElementById("tankInput").value.trim();
      if(tanks[id]){c=tanks[id].comment;m=tanks[id].min;x=tanks[id].max}else{c=m=x=0}
      calculate()
    };
    
    function getAdjustedFlowrate(unit,raw){return unit==="m3"?raw*6.28:unit==="mtr"?raw:raw}
    
    window.calculate=()=>{
      const level=parseFloat(document.getElementById("level").value||0),target=parseFloat(document.getElementById("target").value||0),flowRaw=parseFloat(document.getElementById("flowrate").value||0),unit=document.getElementById("flowUnit").value,mode=document.getElementById("mode").value;
      const available=document.getElementById("availablePumpable"),ullageDiv=document.getElementById("currentUllage"),levelEst=document.getElementById("levelEstimate"),valueDiff=document.getElementById("valueDiff"),output=document.getElementById("output"),calendar=document.getElementById("calendarLink");
      if(!c||isNaN(level)){available.innerText=ullageDiv.innerText=valueDiff.innerText=levelEst.innerText=output.innerHTML="";return}
      const availablePumpable=(level-m)*c,currentUllage=(x-level)*c;
      available.innerText=`Available Pumpable: ${availablePumpable.toFixed(2)} bbl`;
      ullageDiv.innerText=`Current Ullage: ${currentUllage.toFixed(2)} bbl`;
      if(!isNaN(target)){
        let estLevel=0;
        if(mode==="pumpable")estLevel=(target/c)+m;
        else if(mode==="ullage")estLevel=x-(target/c);
        else if(mode==="level")estLevel=target;
        const levelDiff=estLevel-level;
        let estText=`Level Estimate: ${estLevel.toFixed(2)} m\nLevel Difference: ${levelDiff.toFixed(2)} m`;
        if(estLevel>=x-0.5||estLevel<m){levelEst.style.color="#ff5555";estText+=`\nHigh Level = ${x.toFixed(2)} m`}else{levelEst.style.color="#00ffff"}
        levelEst.innerText=estText;
        let diff=0;
        if(mode==="pumpable"){diff=target-availablePumpable;valueDiff.innerText=`Difference: ${diff.toLocaleString()} bbl`}
        else if(mode==="ullage"){diff=currentUllage-target;valueDiff.innerText=`To leave ${target.toLocaleString()} bbl ullage, fill: ${diff.toLocaleString()} bbl`}
        else if(mode==="level"){const meters=level-target;diff=meters*c;valueDiff.innerText=`Level Difference: ${Math.abs(meters).toFixed(2)} m`}
        const flow=getAdjustedFlowrate(unit,flowRaw);
        let time=0;
        if(unit==="mtr"&&mode!=="level"){const meterDiff=Math.abs(diff/c);time=meterDiff/flowRaw}
        else if(mode==="level"&&unit==="mtr"){const meterDiff=Math.abs(level-target);time=meterDiff/flowRaw}
        else{time=Math.abs(diff)/flow}
        if(!isNaN(time)&&time>0){
          const hrs=Math.floor(time),mins=Math.round((time%1)*60),now=new Date(),finish=new Date(now.getTime()+time*3600000),ft=finish.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),fd=finish.toLocaleDateString();
          output.innerHTML=`Time Needed: ${hrs} hr ${mins} min<br>Finish Time: ${ft}<br>Finish Date: ${fd}`;
          const s=new Date(finish.getTime()-600000),e=new Date(s.getTime()+900000),S=s.toISOString().replace(/[-:]|\.\d{3}/g,""),E=e.toISOString().replace(/[-:]|\.\d{3}/g,"");
          const tankNum=document.getElementById("tankInput").value||"Tank";
          calendar.href=`https://calendar.google.com/calendar/render?action=TEMPLATE&text=Tank+${tankNum}+Reminder&details=Tank+${tankNum}+Completion+Alert+-+PBCR+System&dates=${S}/${E}`;
          output.style.color=isSameShift(now,finish)?"red":"lightgreen"
        }
      }
      saveDataToLocalStorage()
    };
    
    window.addToTable=()=>{
      const tankNum=document.getElementById("tankInput").value,output=document.getElementById("output").innerHTML;
      if(!tankNum||!output.includes("Finish Time"))return;
      const timeMatch=output.match(/Finish Time: (.*?)<br>/),dateMatch=output.match(/Finish Date: (.*?)($|<br>)/);
      if(!timeMatch||!dateMatch)return;
      const time=timeMatch[1],date=dateMatch[1],table=document.querySelector("#tankTable tbody");
      
      // Create new row data
      const newRowData={tankNum,date,time,finishDateTime:new Date(date+" "+time)};
      
      // Get existing rows data
      const existingRows=Array.from(table.rows).map(row=>({
        row:row,
        tankNum:row.cells[0].textContent,
        date:row.cells[1].textContent,
        time:row.cells[2].textContent,
        finishDateTime:new Date(row.cells[1].textContent+" "+row.cells[2].textContent)
      }));
      
      // Add new row data to array
      existingRows.push(newRowData);
      
      // Sort by finish time (earliest first)
      existingRows.sort((a,b)=>a.finishDateTime-b.finishDateTime);
      
      // Clear table
      table.innerHTML='';
      
      // Rebuild table with sorted data
      existingRows.forEach(item=>{
        const row=table.insertRow();
        row.insertCell().textContent=item.tankNum;
        row.insertCell().textContent=item.date;
        row.insertCell().textContent=item.time;
        const cell4=row.insertCell(),delBtn=document.createElement("button");
        delBtn.innerHTML="üóëÔ∏è";delBtn.style.cssText="background:none;border:none;cursor:pointer;font-size:16px";
        delBtn.onclick=()=>{row.remove();saveDataToLocalStorage()};
        cell4.appendChild(delBtn);
        
        // Color coding based on shift
        const now=new Date();
        row.style.color=isSameShift(now,item.finishDateTime)?"red":"green";
      });
      
      saveDataToLocalStorage();logActivity('tank_calculation',currentUser.username)
    };
    
    function getShiftCode(hour,minute){
      const totalMins=hour*60+minute;
      return totalMins>=360&&totalMins<840?"morning":totalMins>=840&&totalMins<1320?"evening":"night"
    }
    
    function isSameShift(nowDate,finishDate){
      const currentShift=getShiftCode(nowDate.getHours(),nowDate.getMinutes()),finishShift=getShiftCode(finishDate.getHours(),finishDate.getMinutes());
      if(currentShift!==finishShift)return false;
      if(currentShift==="night"){
        const nowHour=nowDate.getHours(),finishHour=finishDate.getHours();
        if(nowHour>=0&&nowHour<6){
          if(finishHour>=0&&finishHour<6)return Math.floor((finishDate.getTime()-nowDate.getTime())/(24*60*60*1000))<=1;
          else if(finishHour>=22){const dayDiff=Math.floor((finishDate.getTime()-nowDate.getTime())/(24*60*60*1000));return dayDiff===-1||dayDiff===0}
        }else if(nowHour>=22){
          if(finishHour>=22)return nowDate.toDateString()===finishDate.toDateString();
          else if(finishHour>=0&&finishHour<6)return Math.floor((finishDate.getTime()-nowDate.getTime())/(24*60*60*1000))===1
        }
        return false
      }
      return nowDate.toDateString()===finishDate.toDateString()
    }
    
    function sortAndColorTable(){
      const table=document.querySelector("#tankTable tbody"),rows=Array.from(table.rows),now=new Date();
      rows.sort((a,b)=>new Date(a.cells[1].textContent+" "+a.cells[2].textContent)-new Date(b.cells[1].textContent+" "+b.cells[2].textContent));
      rows.forEach(row=>{
        const finishDate=new Date(row.cells[1].textContent+" "+row.cells[2].textContent);
        row.style.color=isSameShift(now,finishDate)?"red":"green";
        table.appendChild(row)
      })
    }
    
    function saveDataToLocalStorage(){
      const data={tankInput:document.getElementById('tankInput').value,level:document.getElementById('level').value,target:document.getElementById('target').value,mode:document.getElementById('mode').value,flowrate:document.getElementById('flowrate').value,flowUnit:document.getElementById('flowUnit').value};
      localStorage.setItem('pbcrData',JSON.stringify(data));
      const table=document.getElementById('tankTable'),rows=Array.from(table.getElementsByTagName('tbody')[0].rows);
      const tableData=rows.map(row=>({tankNum:row.cells[0].textContent,date:row.cells[1].textContent,time:row.cells[2].textContent}));
      localStorage.setItem('pbcrTableData',JSON.stringify(tableData))
    }
    
    function loadDataFromLocalStorage(){
      const dataStr=localStorage.getItem('pbcrData');
      if(dataStr){
        const data=JSON.parse(dataStr);
        document.getElementById('tankInput').value=data.tankInput||'';
        document.getElementById('level').value=data.level||'';
        document.getElementById('target').value=data.target||'';
        document.getElementById('mode').value=data.mode||'pumpable';
        document.getElementById('flowrate').value=data.flowrate||'';
        document.getElementById('flowUnit').value=data.flowUnit||'bbl';
        if(data.tankInput)loadTank()
      }
      const tableDataStr=localStorage.getItem('pbcrTableData');
      if(tableDataStr){
        const tableData=JSON.parse(tableDataStr),tbody=document.querySelector('#tankTable tbody');
        
        // Sort table data by finish time before loading
        tableData.sort((a,b)=>new Date(a.date+" "+a.time)-new Date(b.date+" "+b.time));
        
        tableData.forEach(item=>{
          const row=tbody.insertRow();
          row.insertCell().textContent=item.tankNum;
          row.insertCell().textContent=item.date;
          row.insertCell().textContent=item.time;
          const cell4=row.insertCell(),delBtn=document.createElement('button');
          delBtn.innerHTML='üóëÔ∏è';delBtn.style.cssText='background:none;border:none;cursor:pointer;font-size:16px';
          delBtn.onclick=()=>{row.remove();saveDataToLocalStorage()};
          cell4.appendChild(delBtn);
          
          // Color coding
          const now=new Date(),finishDate=new Date(item.date+" "+item.time);
          row.style.color=isSameShift(now,finishDate)?"red":"green";
        });
      }
    }
    
    function setupDarkMode(){
      let isDarkMode=localStorage.getItem('darkMode')==='true';
      const darkModeButton=document.getElementById('darkModeButton');
      function updateColorMode(){
        if(isDarkMode){document.body.classList.add('dark-mode');darkModeButton.innerHTML='‚òÄÔ∏è'}
        else{document.body.classList.remove('dark-mode');darkModeButton.innerHTML='üåô'}
      }
      darkModeButton.addEventListener('click',()=>{isDarkMode=!isDarkMode;localStorage.setItem('darkMode',isDarkMode);updateColorMode()});
      updateColorMode()
    }
    
    window.openWhatsApp=()=>{
      const message="ŸÖÿ±ÿ≠ÿ®ÿßÿå ÿ£ÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÉ ŸÖŸÜ ÿÆŸÑÿßŸÑ ÿ™ÿ∑ÿ®ŸäŸÇ PBCR & WASHERY",whatsappURL=`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
      try{const newWindow=window.open(whatsappURL,'_blank','noopener,noreferrer');if(!newWindow)window.location.href=whatsappURL}
      catch{navigator.clipboard.writeText(whatsappURL).then(()=>alert(`ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®:\n${whatsappURL}`)).catch(()=>alert(`ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®:\n${whatsappURL}`))}
    };
    
    window.openCalendarInfo=()=>{
      const userAgent=navigator.userAgent||navigator.vendor||window.opera;
      let calendarURL='',deviceType='';
      
      if(/iPad|iPhone|iPod/.test(userAgent)&&!window.MSStream){
        calendarURL='https://apps.apple.com/app/google-calendar/id909319292';
        deviceType='iOS'
      }else if(/android/i.test(userAgent)){
        calendarURL='https://play.google.com/store/apps/details?id=com.google.android.calendar';
        deviceType='Android'
      }else{
        calendarURL='https://calendar.google.com';
        deviceType='Desktop'
      }
      
      let message='üóìÔ∏è ÿ≤ÿ± ÿßŸÑÿ±ŸäŸÖÿßŸäŸÜÿØÿ± ŸÖÿ™ŸàÿßŸÅŸÇ ŸÖÿπ Google Calendar\n\n';
      
      if(deviceType==='iOS'){
        message+='üì± ŸÑÿ¨Ÿáÿßÿ≤ŸÉ ÿßŸÑÿ¢ŸäŸÅŸàŸÜ:\nŸÇŸÖ ÿ®ÿ™ÿ≠ŸÖŸäŸÑ Google Calendar ŸÖŸÜ App Store ÿ£ŸàŸÑÿßŸã\nÿ´ŸÖ ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ≤ÿ± "Add Reminder"\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÅÿ™ÿ≠ App Store ÿßŸÑÿ¢ŸÜÿü'
      }else if(deviceType==='Android'){
        message+='üì± ŸÑÿ¨Ÿáÿßÿ≤ŸÉ ÿßŸÑÿ£ŸÜÿØÿ±ŸàŸäÿØ:\nŸÇŸÖ ÿ®ÿ™ÿ≠ŸÖŸäŸÑ Google Calendar ŸÖŸÜ Play Store ÿ£ŸàŸÑÿßŸã\nÿ´ŸÖ ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ≤ÿ± "Add Reminder"\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÅÿ™ÿ≠ Play Store ÿßŸÑÿ¢ŸÜÿü'
      }else{
        message+='üíª ŸÑÿ¨Ÿáÿßÿ≤ ÿßŸÑŸÉŸÖÿ®ŸäŸàÿ™ÿ±:\nÿ≥ŸäŸÅÿ™ÿ≠ Google Calendar ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠\nÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ≤ÿ± "Add Reminder" ÿπÿßÿØŸä\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÅÿ™ÿ≠ Google Calendar ÿßŸÑÿ¢ŸÜÿü'
      }
      
      if(confirm(message)){
        try{
          const newWindow=window.open(calendarURL,'_blank','noopener,noreferrer');
          if(!newWindow)window.location.href=calendarURL
        }catch{
          window.location.href=calendarURL
        }
      }
    };
    
    function logActivity(action,username){
      const activities=JSON.parse(localStorage.getItem('tanktools_activities')||'[]');
      activities.unshift({id:Date.now(),action,username,timestamp:new Date().toISOString(),ip:'local',userAgent:navigator.userAgent.substring(0,100)});
      activities.splice(100);
      localStorage.setItem('tanktools_activities',JSON.stringify(activities))
    }
    
    // Auto-save and PWA
    document.addEventListener('input',e=>{if(e.target.matches('#tankInput,#level,#target,#flowrate'))saveDataToLocalStorage()});
    if('serviceWorker'in navigator)window.addEventListener('load',()=>navigator.serviceWorker.register('/sw.js'));
    
    console.log('%cüîí PBCR SYSTEM - UPDATED VERSION','color:red;font-size:16px;font-weight:bold');
    console.log('%cDeveloper: Fahad - 17877','color:green;font-size:14px');
  </script>
</body>
</html>