<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NMOGAS Blender</title>
  <link href="icon.png" rel="icon" type="image/png"/>
  
  <!-- PWA Meta Tags -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#003366">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('background.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
      color: white;
      font-family: Arial, sans-serif;
      padding: 10px;
      text-align: center;
      margin: 0;
      min-height: 100vh;
    }

    /* Navigation Bar */
    .nav-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .nav-logo {
      font-size: 18px;
      font-weight: bold;
      color: white;
    }

    .nav-links {
      display: flex;
      gap: 10px;
    }

    .nav-link {
      color: white;
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 5px;
      transition: background-color 0.3s;
      font-size: 14px;
    }

    .nav-link:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .nav-link.active {
      background-color: rgba(255, 255, 255, 0.3);
      font-weight: bold;
    }

    .nav-admin {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      color: #003366;
      font-weight: bold;
      border-radius: 8px;
      padding: 8px 15px;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .nav-admin:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
    }

    .nav-user {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 12px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      font-size: 12px;
    }

    .user-avatar {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: linear-gradient(45deg, #4CAF50, #45a049);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
    }

    .logout-btn {
      background: rgba(255, 0, 0, 0.2);
      border: 1px solid rgba(255, 0, 0, 0.5);
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: rgba(255, 0, 0, 0.4);
    }

    h2 {
      font-size: 1.2rem;
      margin: 10px 0;
    }

    input, select {
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      border: none;
      color: #003366;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      font-size: 12px;
      margin: 2px;
      padding: 4px;
      max-width: 100px;
    }

    label {
      font-weight: bold;
      margin: 5px;
      font-size: 14px;
    }

    .table-container {
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
      margin: 10px auto;
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 5px;
    }

    table {
      margin: auto;
      background: rgba(255, 255, 255, 0.9);
      color: #003366;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 8px;
      overflow: hidden;
      font-size: 11px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      width: 98%;
      min-width: 300px;
      table-layout: fixed;
    }

    th, td {
      padding: 6px 4px;
      border-bottom: 1px solid #003366;
      text-align: center;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    th {
      background: #003366;
      color: white;
      font-weight: bold;
      font-size: 11px;
    }

    th:nth-child(1), td:nth-child(1) { width: 10%; }
    th:nth-child(2), td:nth-child(2) { width: 10%; }
    th:nth-child(3), td:nth-child(3) { width: 11%; }
    th:nth-child(4), td:nth-child(4) { width: 20%; }
    th:nth-child(5), td:nth-child(5) { width: 20%; }
    th:nth-child(6), td:nth-child(6) { width: 8%; }
    th:nth-child(7), td:nth-child(7) { width: 8%; }
    th:nth-child(8), td:nth-child(8) { width: 13%; }

    select {
      font-size: 10px;
      padding: 3px;
    }

    .ok {
      background: #e0ffe0;
      font-weight: bold;
      color: #060;
    }

    .error {
      background: #ffe0e0;
      font-weight: bold;
      color: #900;
    }

    .off {
      background: #f0f0f0;
      font-weight: bold;
      color: #777;
    }

    footer {
      margin-top: 20px;
      color: #ccc;
      text-align: center;
      font-size: 12px;
    }

    .whatsapp-link {
      color: #25D366;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .whatsapp-link:hover {
      color: #128C7E;
      text-shadow: 0 0 5px rgba(37, 211, 102, 0.5);
      transform: scale(1.05);
    }

    .action-button {
      position: fixed;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      border: none;
      font-size: 18px;
      color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #darkModeButton {
      top: 10px;
      right: 10px;
    }

    .dark-mode {
      background: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), url('background.jpg') !important;
    }

    .dark-mode table {
      background: rgba(40, 40, 60, 0.85) !important;
      color: #eee !important;
    }

    .dark-mode td {
      border-bottom: 1px solid #555 !important;
      color: #eee !important;
    }

    .dark-mode input, .dark-mode select {
      background-color: rgba(50, 50, 70, 0.9) !important;
      color: #eee !important;
    }

    .dark-mode .ok {
      background: #205020 !important;
      color: #8f8 !important;
    }

    .dark-mode .error {
      background: #502020 !important;
      color: #f88 !important;
    }

    .dark-mode .off {
      background: #404040 !important;
      color: #aaa !important;
    }

    .dark-mode #totalPercentDisplay {
      color: #fff !important;
    }

    .dark-mode .whatsapp-link {
      color: #25D366 !important;
    }

    .dark-mode .whatsapp-link:hover {
      color: #128C7E !important;
    }

    /* Access Denied Screen */
    .access-denied {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('background.jpg');
      background-size: cover;
      background-position: center;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .access-denied-content {
      text-align: center;
      background: rgba(255, 255, 255, 0.1);
      padding: 40px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .access-denied-icon {
      font-size: 5rem;
      color: #f44336;
      margin-bottom: 20px;
    }

    .access-denied-title {
      font-size: 2rem;
      color: #f44336;
      margin-bottom: 15px;
    }

    .access-denied-text {
      font-size: 1.2rem;
      margin-bottom: 20px;
      opacity: 0.8;
    }

    .login-btn {
      padding: 12px 25px;
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      margin: 5px;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }

    /* Mobile Responsive */
    @media (max-width: 440px) {
      input[type="number"] {
        width: 40px;
        padding: 4px 2px;
      }

      .table-container {
        padding: 2px;
      }

      table {
        font-size: 10px;
        width: 99%;
      }

      th, td {
        padding: 4px 2px;
      }

      select {
        font-size: 9px;
        padding: 2px;
        width: 90%;
      }

      th:nth-child(1), td:nth-child(1) { width: 9%; }
      th:nth-child(2), td:nth-child(2) { width: 8%; }
      th:nth-child(3), td:nth-child(3) { width: 11%; }
      th:nth-child(4), td:nth-child(4) { width: 19%; }
      th:nth-child(5), td:nth-child(5) { width: 19%; }
      th:nth-child(6), td:nth-child(6) { width: 8%; }
      th:nth-child(7), td:nth-child(7) { width: 8%; }
      th:nth-child(8), td:nth-child(8) { width: 18%; }

      .nav-bar {
        flex-direction: column;
        gap: 5px;
      }

      .nav-links {
        order: 1;
      }

      .nav-user {
        order: 2;
        width: 100%;
        justify-content: space-between;
      }
    }

    @media (max-height: 500px) {
      .nav-bar {
        padding: 4px;
      }

      h2 {
        margin: 5px 0;
        font-size: 1rem;
      }

      label {
        display: inline-block;
      }
    }
  </style>
</head>

<body>
  <!-- Access Denied Screen (hidden by default) -->
  <div id="accessDenied" class="access-denied" style="display: none;">
    <div class="access-denied-content">
      <div class="access-denied-icon">üîí</div>
      <div class="access-denied-title">Login Required</div>
      <div class="access-denied-text">
        You need to login to access NMOGAS Blender.<br>
        Please login with your KNPC credentials.
      </div>
      <button class="login-btn" onclick="goToLogin()">Go to Login</button>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent">
    <!-- ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÜŸÇŸÑ -->
    <div class="nav-bar">
      <div class="nav-logo">Tank Tools</div>
      <div class="nav-links">
        <a class="nav-link" href="index.html">PBCR</a>
        <a class="nav-link" href="plcr.html">PLCR</a>
        <a class="nav-link active" href="NMOGASBL.html">NMOGAS</a>
        <a class="nav-admin" href="dashboard.html" id="adminLink" style="display: none;">üîê Dashboard</a>
      </div>
      <div class="nav-user" id="navUser">
        <div class="user-avatar" id="userAvatar">U</div>
        <div id="userName">User</div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <h2>NMOGAS Blender (V 3.0)</h2>

    <!-- ŸÖÿπÿØŸÑ ÿßŸÑŸÖÿ≤ÿ¨ ÿßŸÑŸÉŸÑŸä -->
    <div style="margin: 10px 0;">
      <label>Total Rate (m¬≥/hr): <input type="number" id="totalRate" value="1350" min="0" /></label>
    </div>

    <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖÿ≤ÿ¨ -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>LOOP</th>
            <th>%</th>
            <th>Rate</th>
            <th>Tank</th>
            <th>Pump</th>
            <th>Min</th>
            <th>Max</th>
            <th>Status</th>
          </tr>
          <tr>
            <th>Total %</th>
            <th id="totalPercentDisplay" colspan="7" style="background: #eef; color: #003366;">0%</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸàÿßÿ¨Ÿáÿ© -->
    <button id="darkModeButton" class="action-button" title="Dark Mode">üåô</button>

    <footer>
      By <a href="#" class="whatsapp-link" onclick="openWhatsApp(); return false;">Fahad - 17877</a> ‚Äì Version 3.0
      <br>
      <small style="color: #999; font-size: 10px; margin-top: 5px; display: block;">
        üì± WhatsApp: +965 55222550
      </small>
    </footer>
  </div>

  <script>
    // üîí Enhanced Security Protection
    (function(){
      'use strict';
      
      // ÿ≠ŸÖÿßŸäÿ© ÿ¥ÿßŸÖŸÑÿ© ÿ∂ÿØ ÿßŸÑŸÜÿ≥ÿÆ ŸàÿßŸÑŸÅÿ≠ÿµ
      document.addEventListener('contextmenu', e => e.preventDefault());
      document.addEventListener('selectstart', e => e.preventDefault());
      document.addEventListener('keydown', e => {
        if (e.ctrlKey && (e.key === 'u' || e.key === 's' || e.key === 'a' || e.key === 'c' || e.key === 'v') || e.key === 'F12') {
          e.preventDefault();
        }
      });
      
      // ŸÉÿ¥ŸÅ ÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ±
      setInterval(() => {
        if (window.outerWidth - window.innerWidth > 160 || window.outerHeight - window.innerHeight > 160) {
          document.body.innerHTML = '<div style="color:red;text-align:center;margin-top:50px;font-size:20px;">‚ö†Ô∏è ÿ∫Ÿäÿ± ŸÖÿ≥ŸÖŸàÿ≠ ÿ®ŸÅÿ™ÿ≠ ÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ±<br>ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÖÿ≠ŸÖŸä ÿ®ÿ≠ŸÇŸàŸÇ ÿ≠ÿµÿ±Ÿäÿ©<br><br>System by Fahad - 17877</div>';
        }
      }, 500);
      
      const WHATSAPP_NUMBER = "96555222550";
      let currentUser = null;

      // Check login status on page load
      window.addEventListener('load', () => {
        checkLoginStatus();
      });

      // Check if user is logged in
      function checkLoginStatus() {
        const session = sessionStorage.getItem('tanktools_session');
        const userData = localStorage.getItem('tanktools_current_user');
        
        if (session !== 'active' || !userData) {
          showAccessDenied();
          return;
        }
        
        try {
          currentUser = JSON.parse(userData);
          initializeApp();
          logActivity('nmogas_accessed', currentUser.username);
        } catch (error) {
          showAccessDenied();
        }
      }

      // Show access denied screen
      function showAccessDenied() {
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('accessDenied').style.display = 'flex';
      }

      // Go to login page
      window.goToLogin = function() {
        sessionStorage.setItem('tanktools_redirect', 'NMOGASBL.html');
        window.location.href = 'login.html';
      };

      // Initialize app after login verification
      function initializeApp() {
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('accessDenied').style.display = 'none';
        
        loadUserInfo();
        initializeBlender();
        setupDarkMode();
        loadDataFromLocalStorage();
      }

      // Load user information
      function loadUserInfo() {
        if (!currentUser) return;
        
        document.getElementById('userName').textContent = currentUser.username;
        
        const firstLetter = (currentUser.fullName || currentUser.username).charAt(0).toUpperCase();
        document.getElementById('userAvatar').textContent = firstLetter;
        
        // Show admin link for fam030 or admin role
        if (currentUser.username === 'fam030' || currentUser.role === 'admin') {
          document.getElementById('adminLink').style.display = 'inline-block';
          console.log('NMOGAS Admin link shown for user:', currentUser.username, 'Role:', currentUser.role);
        } else {
          console.log('NMOGAS Admin link hidden for user:', currentUser.username, 'Role:', currentUser.role);
        }
      }

      // Logout function
      window.logout = function() {
        logActivity('user_logout', currentUser.username);
        sessionStorage.removeItem('tanktools_session');
        localStorage.removeItem('tanktools_current_user');
        window.location.href = 'login.html';
      };

      // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≤ÿ¨ ÿßŸÑŸÖÿ¥ŸÅÿ±ÿ©
      const blendingData = {
        "720": [
          {tank: "TK-61-275", pump: "P-61-309 A/B", min: 133.8, max: 446, tankShort: "275", pumpShort: "309"}, 
          {tank: "TK-61-277", pump: "P-61-309 A/B", min: 133.8, max: 446, tankShort: "277", pumpShort: "309"}
        ], 
        "721": [
          {tank: "TK-61-276", pump: "P-61-310", min: 107.1, max: 357, tankShort: "276", pumpShort: "310"}
        ], 
        "722": [
          {tank: "TK-61-221/254", pump: "P-61-308 A/B", min: 231.6, max: 772, tankShort: "221/254", pumpShort: "308"}
        ], 
        "723": [
          {tank: "TK-61-272", pump: "P-61-113 B", min: 70.5, max: 235, tankShort: "272", pumpShort: "113 B"}, 
          {tank: "TK-61-273", pump: "P-61-113 B", min: 70.5, max: 235, tankShort: "273", pumpShort: "113 B"}, 
          {tank: "TK-61-274", pump: "P-61-113 B", min: 70.5, max: 235, tankShort: "274", pumpShort: "113 B"}, 
          {tank: "TK-61-275", pump: "P-61-113 B", min: 70.5, max: 235, tankShort: "275", pumpShort: "113 B"}, 
          {tank: "TK-61-277", pump: "P-61-113 B", min: 70.5, max: 235, tankShort: "277", pumpShort: "113 B"}, 
          {tank: "TK-61-272", pump: "P-61-115", min: 65.1, max: 150, tankShort: "272", pumpShort: "115"}, 
          {tank: "TK-61-273", pump: "P-61-115", min: 65.1, max: 150, tankShort: "273", pumpShort: "115"}, 
          {tank: "TK-61-274", pump: "P-61-115", min: 65.1, max: 150, tankShort: "274", pumpShort: "115"}
        ], 
        "724": [
          {tank: "TK-61-274", pump: "P-61-173 A/B", min: 122.4, max: 180, tankShort: "274", pumpShort: "173"}, 
          {tank: "TK-61-277", pump: "P-61-173 A/B", min: 122.4, max: 180, tankShort: "277", pumpShort: "173"}, 
          {tank: "TK-61-278", pump: "P-61-173 A/B", min: 122.4, max: 180, tankShort: "278", pumpShort: "173"}, 
          {tank: "TK-61-279", pump: "P-61-173 A/B", min: 122.4, max: 180, tankShort: "279", pumpShort: "173"}
        ], 
        "725": [
          {tank: "TK-61-272", pump: "P-61-118 A/B", min: 34.5, max: 115, tankShort: "272", pumpShort: "118"}, 
          {tank: "TK-61-273", pump: "P-61-118 A/B", min: 34.5, max: 115, tankShort: "273", pumpShort: "118"}, 
          {tank: "TK-61-274", pump: "P-61-118 A/B", min: 34.5, max: 115, tankShort: "274", pumpShort: "118"}, 
          {tank: "TK-61-274", pump: "P-61-172 A/B", min: 26.1, max: 87, tankShort: "274", pumpShort: "172"}, 
          {tank: "TK-61-277", pump: "P-61-172 A/B", min: 26.1, max: 87, tankShort: "277", pumpShort: "172"}, 
          {tank: "TK-61-278", pump: "P-61-172 A/B", min: 26.1, max: 87, tankShort: "278", pumpShort: "172"}, 
          {tank: "TK-61-279", pump: "P-61-172 A/B", min: 26.1, max: 87, tankShort: "279", pumpShort: "172"}
        ], 
        "726": [
          {tank: "V-61-301/2", pump: "P-61-305 A/B", min: 60, max: 200, tankShort: "301/2", pumpShort: "305"}
        ], 
        "727": [
          {tank: "TK-61-303/4", pump: "P-61-307 A/B", min: 185.1, max: 617, tankShort: "303/4", pumpShort: "307"}
        ]
      };

      function initializeBlender() {
        const body = document.getElementById("tableBody");
        Object.keys(blendingData).sort().forEach(loopId => {
          body.appendChild(createRow(loopId));
        });

        document.getElementById("totalRate").addEventListener("input", () => {
          document.querySelectorAll("#tableBody tr").forEach(row => {
            const percentInput = row.querySelector(".percent");
            const event = new Event('input', {bubbles: true});
            percentInput.dispatchEvent(event);
          });
        });
      }

      function createRow(loopId) {
        const row = document.createElement("tr");
        row.dataset.loop = loopId;

        const loopCell = document.createElement("td");
        loopCell.textContent = loopId;
        row.appendChild(loopCell);

        const percentCell = document.createElement("td");
        const percentInput = document.createElement("input");
        percentInput.type = "number";
        percentInput.value = 0;
        percentInput.min = 0;
        percentInput.max = 100;
        percentInput.className = "percent";
        percentInput.style.width = "90%";
        percentCell.appendChild(percentInput);
        row.appendChild(percentCell);

        const rateCell = document.createElement("td");
        rateCell.className = "rateCell";
        rateCell.textContent = "-";
        row.appendChild(rateCell);

        const tankCell = document.createElement("td");
        const tankSelect = document.createElement("select");
        tankSelect.style.width = "95%";
        
        const tanks = [...new Set(blendingData[loopId].map(e => ({value: e.tank, text: e.tankShort})))];
        tanks.forEach(tank => {
          const opt = document.createElement("option");
          opt.value = tank.value;
          opt.textContent = tank.text;
          tankSelect.appendChild(opt);
        });
        tankCell.appendChild(tankSelect);
        row.appendChild(tankCell);

        const pumpCell = document.createElement("td");
        const pumpSelect = document.createElement("select");
        pumpSelect.style.width = "95%";
        pumpCell.appendChild(pumpSelect);
        row.appendChild(pumpCell);

        const minCell = document.createElement("td");
        minCell.className = "minCell";
        row.appendChild(minCell);

        const maxCell = document.createElement("td");
        maxCell.className = "maxCell";
        row.appendChild(maxCell);

        const statusCell = document.createElement("td");
        statusCell.className = "statusCell";
        row.appendChild(statusCell);

        function updatePumpOptions() {
          const selectedTank = tankSelect.value;
          const pumps = blendingData[loopId].filter(e => e.tank === selectedTank);
          pumpSelect.innerHTML = "";
          pumps.forEach((p, i) => {
            const opt = document.createElement("option");
            opt.value = i;
            opt.textContent = p.pumpShort;
            pumpSelect.appendChild(opt);
          });
          updateStatus();
        }

        function updateStatus() {
          const total = parseFloat(document.getElementById("totalRate").value) || 0;
          const percent = parseFloat(percentInput.value) || 0;
          const loopRate = +(total * percent / 100).toFixed(2);
          rateCell.textContent = loopRate;

          if (percent === 0) {
            minCell.textContent = "-";
            maxCell.textContent = "-";
            statusCell.textContent = "O/C";
            statusCell.className = "statusCell off";
          } else {
            const selectedTank = tankSelect.value;
            const pumpIndex = pumpSelect.value;
            const validPumps = blendingData[loopId].filter(e => e.tank === selectedTank);
            const selectedPump = validPumps[pumpIndex];

            if (selectedPump) {
              minCell.textContent = selectedPump.min;
              maxCell.textContent = selectedPump.max;
              if (loopRate >= selectedPump.min && loopRate <= selectedPump.max) {
                statusCell.textContent = "OK";
                statusCell.className = "statusCell ok";
              } else {
                statusCell.textContent = "Out of range";
                statusCell.className = "statusCell error";
              }
            } else {
              minCell.textContent = "-";
              maxCell.textContent = "-";
              statusCell.textContent = "-";
              statusCell.className = "statusCell";
            }
          }

          updateTotalPercentDisplay();
        }

        percentInput.addEventListener("input", () => {
          updateStatus();
          saveDataToLocalStorage();
          logActivity('nmogas_calculation', currentUser.username);
        });
        tankSelect.addEventListener("change", () => {
          updatePumpOptions();
          saveDataToLocalStorage();
        });
        pumpSelect.addEventListener("change", () => {
          updateStatus();
          saveDataToLocalStorage();
        });

        updatePumpOptions(); 
        return row;
      }

      function updateTotalPercentDisplay() {
        const percentInputs = document.querySelectorAll(".percent");
        let totalPercent = 0;
        percentInputs.forEach(input => {
          totalPercent += parseFloat(input.value) || 0;
        });
        const display = document.getElementById("totalPercentDisplay");
        if (display) {
          display.textContent = totalPercent.toFixed(1) + "%";

          if (totalPercent > 100) {
            display.style.backgroundColor = "#ffe0e0";
            display.style.color = "#d00";
          } else if (totalPercent < 100) {
            display.style.backgroundColor = "#eef";
            display.style.color = "#003366";
          } else {
            display.style.backgroundColor = "#e0ffe0";
            display.style.color = "#060";
          }
        }
      }

      function saveDataToLocalStorage() {
        const data = {
          totalRate: document.getElementById("totalRate").value,
          rows: []
        };

        document.querySelectorAll("#tableBody tr").forEach(row => {
          const loopId = row.dataset.loop;
          const percent = row.querySelector(".percent").value;
          const tankSelect = row.querySelector("select:nth-of-type(1)");
          const pumpSelect = row.querySelector("select:nth-of-type(2)");

          data.rows.push({
            loopId,
            percent,
            tankIndex: tankSelect.selectedIndex,
            pumpIndex: pumpSelect.selectedIndex
          });
        });

        localStorage.setItem('nmogasData', JSON.stringify(data));
      }

      function loadDataFromLocalStorage() {
        const savedData = localStorage.getItem('nmogasData');
        if (savedData) {
          const data = JSON.parse(savedData);

          document.getElementById("totalRate").value = data.totalRate || 1350;

          if (data.rows && data.rows.length > 0) {
            const rows = document.querySelectorAll("#tableBody tr");
            data.rows.forEach((rowData, index) => {
              if (index < rows.length) {
                const row = rows[index];
                const percentInput = row.querySelector(".percent");
                const tankSelect = row.querySelector("select:nth-of-type(1)");

                percentInput.value = rowData.percent || 0;

                if (tankSelect.options.length > rowData.tankIndex) {
                  tankSelect.selectedIndex = rowData.tankIndex || 0;

                  const event = new Event('change');
                  tankSelect.dispatchEvent(event);

                  const pumpSelect = row.querySelector("select:nth-of-type(2)");
                  if (pumpSelect.options.length > rowData.pumpIndex) {
                    pumpSelect.selectedIndex = rowData.pumpIndex || 0;
                  }
                }

                const inputEvent = new Event('input', {bubbles: true});
                percentInput.dispatchEvent(inputEvent);
              }
            });
          }

          updateTotalPercentDisplay();
        }
      }

      function setupDarkMode() {
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        const darkModeButton = document.getElementById('darkModeButton');

        function updateColorMode() {
          if (isDarkMode) {
            document.body.classList.add('dark-mode');
            darkModeButton.innerHTML = '‚òÄÔ∏è';
          } else {
            document.body.classList.remove('dark-mode');
            darkModeButton.innerHTML = 'üåô';
          }
        }

        darkModeButton.addEventListener('click', () => {
          isDarkMode = !isDarkMode;
          localStorage.setItem('darkMode', isDarkMode);
          updateColorMode();
        });

        updateColorMode();
      }

      window.openWhatsApp = function() {
        const message = "ŸÖÿ±ÿ≠ÿ®ÿßÿå ÿ£ÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÉ ŸÖŸÜ ÿÆŸÑÿßŸÑ ÿ™ÿ∑ÿ®ŸäŸÇ NMOGAS Blender";
        const whatsappURL = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
        
        try {
          const newWindow = window.open(whatsappURL, '_blank', 'noopener,noreferrer');
          if (!newWindow) window.location.href = whatsappURL;
        } catch (error) {
          navigator.clipboard.writeText(whatsappURL).then(() => {
            alert(`ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®:\n${whatsappURL}\n\nÿßŸÑÿµŸÇ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑŸÑÿ™ŸàÿßÿµŸÑ`);
          }).catch(() => {
            alert(`ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®:\n${whatsappURL}\n\nÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸàÿßŸÑÿµŸÇŸá ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠`);
          });
        }
      };

      // Log activity function
      function logActivity(action, username) {
        const activities = JSON.parse(localStorage.getItem('tanktools_activities') || '[]');
        
        activities.unshift({
          id: Date.now(),
          action,
          username,
          timestamp: new Date().toISOString(),
          ip: 'local',
          userAgent: navigator.userAgent.substring(0, 100)
        });
        
        activities.splice(100);
        localStorage.setItem('tanktools_activities', JSON.stringify(activities));
      }

      // Auto-save setup
      let saveTimeout;
      const autoSave = () => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveDataToLocalStorage, 2000);
      };

      document.getElementById("totalRate").addEventListener("input", autoSave);
      
    })();
    
    console.log('%cüîí NMOGAS BLENDER - PROTECTED', 'color:red;font-size:20px;font-weight:bold;');
    console.log('%cDeveloper: Fahd - 17877', 'color:green;font-size:16px;');
    console.log('%cPROTECTED NMOGAS SYSTEM - LOGIN REQUIRED', 'color:blue;font-size:14px;');
  </script>
</body>
</html>